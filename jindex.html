<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Simponi Kharisma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Icon & Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- html2canvas (hanya sekali, pilih versi terbaru yang stabil) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- jsPDF & plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Favicon utama -->
  <link rel="icon" type="image/png" href="icons/logo.png">

  <!-- IndexedDB -->
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

  <!-- PWA manifest & meta -->
  <meta name="theme-color" content="#2b6cb0">
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

  <!-- iOS Support -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-title" content="Simponi Kharisma">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>

  
  <style>
    :root {
      --primary-color: #1a73e8;
      --primary-light: #e8f0fe;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 16px;
      --box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --card-gradient: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      --hover-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      padding: 16px;
    }

    /* Header modern dengan gradient biru */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding: 14px 18px;
      background: linear-gradient(135deg, #1a73e8 0%, #3f51b5 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-logo-img {
      height: 42px;
      width: 42px;
      border-radius: 10px;
      object-fit: contain;
      background: white;
      padding: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    .logout-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 8px 14px;
      color: white;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* Grid Layout Modern - 2 kolom, 4 baris dengan warna penuh */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .grid-item {
      border-radius: var(--border-radius);
      padding: 20px 12px;
      text-align: center;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      position: relative;
      overflow: hidden;
      color: white;
    }

    .grid-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--item-color-1), var(--item-color-2));
      z-index: -1;
      transition: var(--transition);
    }

    .grid-item:hover::before {
      transform: scale(1.05);
    }

    .grid-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    /* Bordir melingkar pada ikon */
	.grid-item i {
	  font-size: 2rem;
	  margin-bottom: 10px;
	  filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
	  transition: var(--transition);
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  width: 50px;
	  height: 50px;
	  border-radius: 50%;
	  background: rgba(255, 255, 255, 0.2);
	  backdrop-filter: blur(5px);
	  border: 2px solid rgba(255, 255, 255, 0.3);
	  box-shadow: 
		inset 0 0 10px rgba(255, 255, 255, 0.3),
		0 0 15px rgba(0, 0, 0, 0.2);
	}

	.grid-item:hover i {
	  transform: scale(1.15);
	  background: rgba(255, 255, 255, 0.25);
	  border-color: rgba(255, 255, 255, 0.5);
	  box-shadow: 
		inset 0 0 15px rgba(255, 255, 255, 0.4),
		0 0 20px rgba(0, 0, 0, 0.3);
	}

    .grid-item span {
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      transition: var(--transition);
    }

    /* Warna khusus untuk setiap item */
    .grid-item[data-module="guru"] {
      --item-color-2: #4caf50;
      --item-color-1: #2e7d32;
    }

    .grid-item[data-module="penasehat"] {
      --item-color-2: #9c27b0;
      --item-color-1: #6a1b9a;
    }

    .grid-item[data-module="santri"] {
      --item-color-2: #2196f3;
      --item-color-1: #1565c0;
    }

    .grid-item[data-module="absensi"] {
      --item-color-2: #ff9800;
      --item-color-1: #ef6c00;
    }

    .grid-item[data-module="pelanggaran"] {
      --item-color-2: #f44336;
      --item-color-1: #ad2323;
    }

    .grid-item[data-module="inventaris"] {
      --item-color-2: #607d8b;
      --item-color-1: #37474f;
    }

    .grid-item[data-module="info"] {
      --item-color-2: #795548;
      --item-color-1: #4e342e;
    }

    .grid-item[data-module="nilai"] {
      --item-color-2: #00bcd4;
      --item-color-1: #00838f;
    }
	
	.grid-item[data-module="pendaftaran"] {
	  --item-color-1: #807a26;
	  --item-color-2: #bdb439;
	}
	
	.grid-item[data-module="harian"] {
		  --item-color-1: #822144;
		  --item-color-2: #c22f65;
		}


    /* Responsive adjustments */
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .app-header {
        padding: 12px 14px;
        margin-bottom: 20px;
      }
      
      .app-logo-img {
        height: 38px;
        width: 38px;
      }
      
      .app-title {
        font-size: 1.2rem;
      }
      
      .logout-btn {
        padding: 7px 12px;
        font-size: 0.85rem;
      }
      
      .grid-container {
        gap: 14px;
      }
      
      .grid-item {
        padding: 18px 10px;
        min-height: 110px;
      }
      
      .grid-item i {
        font-size: 1.8rem;
        margin-bottom: 8px;
		width: 45px;
		height: 45px;
      }
      
      .grid-item span {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 350px) {
      .grid-container {
        gap: 12px;
      }
      
      .grid-item {
        padding: 16px 8px;
        min-height: 100px;
      }
      
      .grid-item i {
        font-size: 1.7rem;
		width: 40px;
		height: 40px;
      }
      
      .grid-item span {
        font-size: 0.8rem;
      }
    }

    /* Efek Ripple untuk grid items */
    .ripple-effect {
      position: absolute;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.4);
      transform: scale(0);
      animation: ripple 0.6s linear;
    }

    @keyframes ripple {
      to {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    /* Module containers */
    .module-container { 
      display: none; 
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }
    
    .module-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tab navigation */
    .tab-nav {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab-item {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab-item.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Back button */
    .back-button {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      color: var(--primary-color);
      cursor: pointer;
      font-weight: 500;
    }

    .back-button i {
      margin-right: 8px;
    }

    /* Filter Container */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: center;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      font-weight: 600;
      color: #444;
      margin-bottom: 0.4rem;
      display: block;
    }
    
    .filter-group input, .filter-group select {
      width: 100%;
      padding: 0.6rem 0.9rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
      background: #fefefe;
    }

    /* Santri Cards */
    .santri-card {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-image: linear-gradient(to bottom, #a7c7e7, #F5F5F5);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      max-width: 380px;
      width: 100%;
      margin: 5px auto;
    }
    
    .santri-info {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 5px;
    }
    
    .photo {
      flex-shrink: 0;
      height: 130px;
      width: 100px;
      object-fit: cover;
      border-radius: 5px;
      border: 1px solid #ddd;
      display: block;
    }

    .info {
      font-size: 13px; 
      line-height: 1.2; 
      color: #000; 
      flex-grow: 1; 
      padding-right: 5px;
    }

    .info p, .info h3 {
      display: grid;
      grid-template-columns: 95px 2px auto;
      gap: 5px;
      margin: 2px 0;
    }

    .info h3 {
      color: #1a73e8;
      margin-bottom: 5px;
    }
    
	.status-badge {
	  position: absolute;
	  top: 8px;
	  right: 8px;
	  background: rgba(220, 53, 69, 0.95); /* merah danger */
	  color: #fff;
	  font-size: 12px;
	  font-weight: bold;
	  padding: 6px 12px;
	  border-radius: 12px;
	  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
	  z-index: 5;
	  text-align: center;
	  line-height: 1.3;
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	}

	.status-badge .exit-date {
	  font-size: 11px;
	  font-weight: normal;
	  margin-top: 2px;
	}

	/* Efek abu-abu dengan overlay */
	.santri-card.tidak-aktif::after {
	  content: "";
	  position: absolute;
	  inset: 0;
	  background: rgba(200, 200, 200, 0.4); /* lapisan abu-abu semi transparan */
	  z-index: 2; /* di atas isi, tapi di bawah badge */
	  pointer-events: none;
	}
    
    .santri-card.tidak-aktif {
      filter: grayscale(80%);
      opacity: 0.85;
    }
    
    .santri-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 123, 255, 0.6);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .santri-card.active {
      border: 3px solid rgb(0, 0, 139);
      box-shadow: 0 0 10px 5px rgba(0, 123, 255, 0.5);
      animation: borderAnimation 1.5s infinite;
    }
    
    @keyframes borderAnimation {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5); }
      50% { box-shadow: 0 0 10px 5px rgba(0, 123, 255, 0.7); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5); }
    }

    /* Unit Group */
    .unit-group { width: 100%; }
    
    .unit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary-color);
      color: white;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
    }
    
    .unit-name { flex: 1; }
    
    .unit-total {
      font-weight: normal;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .triangle {
      display: inline-block;
      margin-right: 8px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid white;
      transition: transform 0.3s ease;
    }
    
    .unit-header.collapsed .triangle { transform: rotate(-90deg); }
    
    .unit-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 5px;
      padding: 5px 0;
    }
    
    .unit-cards.hidden { display: none; }

    

    /* Loading indicators */
    #loadingIndicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #f1f1f1;
      z-index: 1000;
      display: none;
    }
    
    #loadingIndicator .progress {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.3s;
    }
    
    #loading-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: rgba(255,255,255,0.9);
      position: fixed;
      inset: 0;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 6px solid #ddd;
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error and popup messages */
    .error-message {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: var(--danger-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      z-index: 1000;
      display: none;
      box-shadow: var(--box-shadow);
    }
    
    .popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s;
      box-shadow: var(--box-shadow);
    }


    
	
	.logolembaga {
	  width: 100%;
	  height: auto;
	  object-fit: contain;
	  background-color: #f8f9fa;
	  padding: 0;
	  border-bottom: 1px solid #e9ecef;
	}
	
	/* Pagination */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 1.5rem 0;
  padding: 0.5rem;
  background-color: white;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}
.pagination-info { font-size: 0.9rem; }
.pagination-controls {
  display: flex;
  gap: 0.5rem;
}

/* Tombol lebih cantik */
button {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  border: none;
  border-radius: 30px;
  padding: 0.6rem 1.2rem;
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}
button:hover {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

/* Tombol aktif (current page) */
button.active {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: #000;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
  transform: scale(1.1);
}

/* Efek klik pada tombol */
button:active {
  transform: scale(0.95);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: transform 0.1s ease;
}

/* Tombol khusus untuk pagination controls */
.pagination-controls button {
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

/* Tombol navigasi (sebelumnya/berikutnya) */
.pagination-controls button:first-child,
.pagination-controls button:last-child {
  min-width: 80px;
  padding: 0.6rem 1.2rem;
}

/* Responsive untuk mode portrait (â‰¤600px) */
@media (max-width: 600px) {
  .pagination {
    flex-direction: column;   /* âœ… ditumpuk ke bawah */
    gap: 0.5rem;
    align-items: center;      /* center semua */
    padding: 0.8rem;
  }

  .pagination-info {
    font-size: 0.8rem;        /* sedikit lebih kecil */
    text-align: center;
  }

  .pagination-controls {
    flex-wrap: wrap;          /* tombol bisa pindah baris kalau sempit */
    justify-content: center;
    gap: 0.4rem;
  }

  .pagination-controls button {
    min-width: 35px;
    height: 35px;
    font-size: 0.8rem;
  }

  /* Tombol navigasi (prev/next) lebih ramping di portrait */
  .pagination-controls button:first-child,
  .pagination-controls button:last-child {
    min-width: 70px;
    padding: 0.5rem 0.8rem;
    font-size: 0.8rem;
  }
}

/* --- Container scroll kalau kepanjangan --- */
.data-table-container {
  overflow-x: auto;
  margin-top: 16px;
}

/* --- Base table --- */
.data-table {
  border-collapse: separate;
  border-spacing: 0;
  table-layout: auto;
  width: max-content;   /* melebar sesuai isi */
  min-width: 100%;      /* minimal penuh layar */
  background-color: white;
  box-shadow: var(--box-shadow);
}

/* --- Cell umum --- */
.data-table th,
.data-table td {
  padding: 0.75rem;
  text-align: left;
  border: 1px solid #e6e6e6;
  background: #fff;
  font-size: 13px;
  vertical-align: middle;

  white-space: normal;      /* biar kata turun */
  word-break: break-word;
  line-height: 1.3;
}

/* --- Sticky header (biru + teks putih) --- */
.data-table th {
  position: sticky;
  top: 0;
  background-color: #1a73e8;
  color: #fff;
  font-weight: 600;
  z-index: 12;
  text-align: center;
  cursor: pointer;
}

/* --- Sticky left Nama --- */
.data-table th.nama,
.data-table td.nama {
  position: sticky;
  left: 0;
  z-index: 20;
  background: #fff;
  text-align: left;
  padding-left: 10px;
  min-width: 140px;
  max-width: 300px;
}

.data-table th.nama {
  z-index: 25;
  background: #1a73e8;
  color: #fff;
  text-align:center
}

/* --- Foto --- */
.data-table td:nth-child(2) img {
  width: 60px;
  height: 80px;
  object-fit: cover;
  border-radius: 2px;
  display: block;
  margin: auto;
}

/* --- Sorting indicator --- */
.sortable {
  position: relative;
  padding-right: 24px;
}

.sort-indicator {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  color: #fff;              /* âœ… indikator putih */
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sortable.sorted .sort-indicator { opacity: 1; }
.sortable.sorted-asc .sort-indicator::after { content: "â–²"; }
.sortable.sorted-desc .sort-indicator::after { content: "â–¼"; }

/* --- State sorted: tetap header biru, teks putih --- */
.sorted {
  background-color: #1a73e8 !important;
  color: #fff !important;
  font-weight: bold;
}

/* --- Android portrait: kolom diperkecil, wrap --- */
@media screen and (max-width: 768px) and (orientation: portrait) {
  .data-table td:nth-child(2){   
    width: 50px;
    text-align: left;
  }  
  .data-table th:nth-child(2) {
    width: 50px;
    text-align: center;
  }
  .data-table td:nth-child(2) img {
    width: 45px;
    height: 65px;
  }
  .data-table th.nama,
  .data-table td.nama {
    min-width: 80px;
    max-width: 120px;
  }
  .data-table th,
  .data-table td {
    max-width: 100px;
    font-size: 12px;
  }
}


/* Styling Absensi Table per Santri */
#absensi-container .santri-box {
  border: 2px solid #1a73e8;       /* bordir biru */
  border-radius: 12px;             /* kotak santri tetap melengkung */
  padding: 15px;
  margin-bottom: 25px;
  background: #ffffff;
  box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);

  /* Tambahan untuk PDF A5 */
  page-break-after: always;        /* setiap santri-box pindah halaman */
  max-height: 194mm;               /* biar nggak melewati 1 halaman */
  box-sizing: border-box;
  overflow: hidden;                /* kalau isi lebih tinggi, sembunyikan */
}


/* Table umum */
#absensi-container table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
  margin: auto;
}

/* Header atas (nama, kelas, unit) */
#absensi-container table thead tr:first-child th {
  background: #1a73e8;
  color: white;
  font-size: 13px;
  text-align: center;
  border: 1px solid #1a73e8;
  /* ðŸ”¹ Hapus sudut melengkung */
  border-radius: 0;
}

/* Foto baris */
#absensi-container table thead tr:nth-child(2) td {
  text-align: center;
  padding: 10px;
}

/* Header bulan (No, Bulan, Sakit, Izin, Tanpa Izin) */
#absensi-container table thead tr:nth-child(3) th {
  background: #e3f0ff;
  font-weight: bold;
  text-align: center;
  border: 1px solid #1a73e8;
}

/* Sel isi tabel */
#absensi-container table tbody td {
  border: 1px solid #cce0ff;
  padding: 6px;
  font-size: 13px;
}


/* Sel isi tabel */
#absensi-container table tbody td {
  border: 1px solid #cce0ff;
  padding: 6px;
  font-size: 13px;
  text-align: center; /* default semua tetap center */
}



/* ======== MODUL NILAI (namespace .nilai-*) ======== */

/* Tab navigasi */
.nilai-tabs,
.nilai-graph-tabs {
  display: flex;
  gap: 0.7rem;
  margin: 0.7rem 0 0.7rem;
  flex-wrap: wrap;
}
.nilai-tab,
.nilai-graph-tab {
  background: #fff;
  border: 1px solid #cfe0ff;
  color: #1a73e8;
  padding: 0.55rem 1rem;
  border-radius: 0.7rem;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s ease;
  font-weight: 500;
}
.nilai-tab:hover:not(.active),
.nilai-graph-tab:hover:not(.active) {
  background: #e8f0fe; /* biru terang saat hover */
}
.nilai-tab.active,
.nilai-graph-tab.active {
  background: #1a73e8;
  color: #fff;
  border-color: #1a73e8;
}

.nilai-tab-content {
  display: none;
}
.nilai-tab-content.active {
  display: block;
}

/* Filter bar */
.nilai-filter-row {
  display: flex;
  gap: 0.7rem;
  flex-wrap: wrap;
  align-items: end;
  background: #fff;
  padding: 0.7rem;
  border-radius: 0.7rem;
  box-shadow: var(--box-shadow);
}
.nilai-filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}
.nilai-filter-group label {
  font-size: 0.7rem;
  font-weight: 500;
  color: #1a73e8; /* biru seragam */
}
.nilai-filter-group input,
.nilai-filter-group select {
  border: 1px solid #e2e8f0;
  border-radius: 0.7rem;
  padding: 0.55rem 0.7rem;
  min-width: 12rem; /* ~180px */
  font-size: 0.7rem;
  transition: border-color 0.2s;
}
.nilai-filter-group input:focus,
.nilai-filter-group select:focus {
  outline: none;
  border-color: #1a73e8;
}

/* Chart header */
.nilai-chart-header {
  text-align: center;
  font-weight: bold;
  font-size: 0.8rem;
  color: #1a73e8;
  margin: 0.5rem 0.7rem 0.5rem;
  padding-bottom: 0.4rem;
  border-bottom: 2px solid #1a73e8;
}

/* Chart container */
.nilai-chart-container {
  margin-top: 0.5rem;
}


/* === Tampilan kartu per siswa === */
.nilai-list-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 16px;
}

.nilai-card {
  border: 1px solid #e6e6e6;
  border-radius: 12px;
  background: #fff;
  box-shadow: var(--box-shadow);
  overflow: hidden;
  transition: transform .2s, box-shadow .2s;
}


.nilai-card-header {
  background: #1a73e8;
  color: #fff;
  padding: 12px 16px;
  font-weight: bold;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.nilai-card-header span {
  font-size: 0.85rem;
  font-weight: normal;
  opacity: .95;
}

.nilai-card-body {
  padding: 12px 14px;
  overflow-x: auto;
}

.nilai-subtable {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.nilai-subtable th,
.nilai-subtable td {
  border: 1px solid #f0f0f0;
  padding: 6px 10px;
}
.nilai-subtable th {
  background: #f8fafc;
  font-weight: 600;
  text-align: center; /* header center */
}
.nilai-subtable td:first-child {
  text-align: center; /* kolom No */
  width: 50px;
}
.nilai-subtable td:last-child {
  text-align: center; /* kolom Nilai */
  font-weight: 500;
  width: 80px;
}
.nilai-subtable td:nth-child(2) {
  text-align: left; /* Mata Pelajaran */
}

/* Grafik */
.nilai-chart-container {
  width: 100%;
  max-width: 1100px;
  margin: 20px auto 0;
}
.nilai-chart-container canvas {
  width: 100%;
  height: auto;
  min-height: 500px;   /* tinggi dasar */
}


/* Pagination */
.nilai-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  margin: 20px 0;
  flex-wrap: wrap;
}
.nilai-pagination button {
  border: 1px solid #d1d5db;
  background: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: .85rem;
  transition: all .2s;
}
.nilai-pagination button:hover:not(:disabled) {
  background: #f3f4f6;
}
.nilai-pagination button.active {
  background: #1a73e8;
  color: #fff;
  border-color: #1a73e8;
}
.nilai-pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .nilai-card-header {
    font-size: .95rem;
  }
  .nilai-card-header span {
    font-size: 0.8rem;
  }
  .nilai-filter-group input,
  .nilai-filter-group select {
    min-width: 140px;
  }
}

.nilai-total {
  font-weight: bold;
  background: #fff;
  padding: 2px 6px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  color: #1a73e8;
  display: inline-block;
}

.nilai-separator {
  font-weight: bold;
  color: #fff;       /* putih, sama dengan background header */
  margin: 0 4px;     /* kasih jarak kanan-kiri */
}

/* Container pagination Nilai */
.nilai-pagination {
  display: flex;
  flex-direction: column; /* info di atas, tombol di bawah */
  justify-content: center;
  align-items: center;
  margin: 1.5rem 0;
  gap: 0.6rem;
}

/* Info teks di atas tombol */
.nilai-pagination .pagination-info {
  font-size: 0.85rem;
  text-align: center;
  color: #444;
  font-weight: 500;
}

/* Kontrol tombol */
.nilai-pagination .pagination-controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
}

/* Tombol pagination */
.nilai-pagination button {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  border: none;
  border-radius: 30px;
  padding: 0.6rem 1.2rem;
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}

/* Hover */
.nilai-pagination button:hover:not(:disabled):not(.active) {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

/* Aktif (halaman sekarang) */
.nilai-pagination button.active {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: #000;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
  transform: scale(1.1);
}

/* Disabled */
.nilai-pagination button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Titik-titik (...) */
.nilai-pagination span {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 30px;
  height: 40px;
  font-size: 1rem;
  font-weight: bold;
  color: #555;
}

/* ================= Responsive Android kecil (â‰¤600px) ================= */
@media (max-width: 600px) {
  .nilai-pagination {
    gap: 0.4rem;
    margin: 1rem 0;
  }

  .nilai-pagination .pagination-info {
    font-size: 0.75rem;
  }

  .nilai-pagination button {
    min-width: 32px;
    height: 34px;
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
  }

  .nilai-pagination button:first-child,
  .nilai-pagination button:last-child {
    min-width: 60px;
    font-size: 0.7rem;
    padding: 0.4rem 0.6rem;
  }

  .nilai-pagination span {
    min-width: 20px;
    height: 34px;
    font-size: 0.75rem;
  }
}
/* Footer dengan container putih dan tulisan biru kecil rata kiri */
.app-footer {
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
  padding: 10px 14px;
  margin-top: 18px;
  text-align: left;
}

.app-footer img {
  height: 20px;
  margin: 3px 6px 3px 0;
  vertical-align: middle;
}

/* Responsive adjustments untuk footer */
@media (max-width: 480px) {
  .app-footer {
    padding: 8px 12px;
    margin-top: 15px;
  }
  .app-footer img {
    height: 18px;
    margin: 2px 4px 2px 0;
  }
}

/* ==== Scroll khusus grafik nilai ==== */
.nilai-chart-scroll-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth di Android/iOS */
}



.nilai-chart-scroll-inner canvas {
  width: 100%;
  height: auto;
  min-height: 500px;
}

/* Responsive untuk layar kecil */
@media (max-width: 600px) {
  .nilai-chart-scroll-inner {
    min-width: 400px; /* lebih panjang biar ada scrollbar horizontal */
  }
}

@media (max-width: 600px) {
  .nilai-chart-header {
    font-size: 12px;    
	margin-top: 5px;
  }
}

/* ===== Styling label tambahan di Chart (kelas & unit) ===== */
.nilai-label-secondary {
  color: #6b7280;       /* abu-abu */
  font-size: 0.75rem;
  font-style: italic;
  font-weight: normal;
}

/* ===== Styling label utama (nama santri) ===== */
.nilai-label-primary {
  color: #000;
  font-size: 0.9rem;
  font-weight: bold;
}

.user-info-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 10px 14px;
  margin: -10px 0 15px 0;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.user-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 2px solid #1a73e8;
  object-fit: cover;
}

.user-details {
  display: flex;
  flex-direction: column;
  line-height: 1.3;
}

#userRoleText {
  font-size: 0.8rem;
  font-weight: 600;
  color: #1a73e8;
}


#userEmail {
  font-size: 0.8rem;
  color: #555;
}

.logout-btn {
  background: #e53935;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s;
}

.logout-btn:hover {
  background: #c62828;
}

/* ===== Modal Form Admin ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-box {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  width: 95%;
  max-width: 480px;
  padding: 20px;
  animation: fadeInScale 0.3s ease;
}

.modal-box h3 {
  margin-bottom: 15px;
  color: #1a73e8;
  font-size: 1.2rem;
  text-align: center;
}

.modal-box form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.modal-box label {
  font-weight: 600;
  font-size: 0.9rem;
  color: #333;
}

.modal-box input,
.modal-box select,
.modal-box textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border 0.2s, box-shadow 0.2s;
}

.modal-box input:focus,
.modal-box select:focus,
.modal-box textarea:focus {
  outline: none;
  border-color: #1a73e8;
  box-shadow: 0 0 0 3px rgba(26,115,232,0.25);
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 15px;
}

.modal-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: background 0.2s, transform 0.2s;
}

.modal-btn.save {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  color: #fff;
}

.modal-btn.save:hover {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
}

.modal-btn.cancel {
  background: #ddd;
  color: #333;
}

.modal-btn.cancel:hover {
  background: #ccc;
}

/* Animasi modal */
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Overlay gelap */
.crud-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

/* Kotak modal */
.crud-modal-content {
  background: #fff;
  margin: 30px auto;
  padding: 20px;
  border-radius: 10px;
  width: 95%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  animation: crud-fadeIn 0.3s ease;
}

/* Animasi */
@keyframes crud-fadeIn {
  from {opacity: 0; transform: scale(0.95);}
  to {opacity: 1; transform: scale(1);}
}

/* Tombol close (X) */
.crud-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
}
.crud-close:hover {
  color: #000;
}

/* Form styling */
.crud-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.crud-form label {
  font-weight: bold;
  font-size: 14px;
}

.crud-form input, 
.crud-form select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

/* Tombol aksi */
.crud-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap; /* biar rapi di layar kecil */
}

.crud-btn-save {
  flex: 1;
  padding: 10px;
  background: #28a745;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
.crud-btn-save:hover {
  background: #218838;
}

.crud-btn-cancel {
  flex: 1;
  padding: 10px;
  background: #dc3545;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
.crud-btn-cancel:hover {
  background: #c82333;
}

/* Responsif untuk layar kecil */
@media (max-width: 600px) {
  .crud-modal-content {
    margin: 10px;
    padding: 15px;
    width: 95%;
    max-height: 85vh;
  }
  .crud-form label {
    font-size: 13px;
  }
  .crud-btn-save, .crud-btn-cancel {
    font-size: 14px;
    padding: 8px;
  }
}

/* CSS di style.css
.highlight-row {
  animation: highlightFade 3s ease forwards;
}
@keyframes highlightFade {
  0%   { background-color: #fff3cd; }
  100% { background-color: transparent; }
}

.autocomplete-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
}

.autocomplete-list {
  position: absolute;
  background: #fff;
  border: 1px solid #ccc;
  max-height: 180px;
  overflow-y: auto;
  z-index: 9999;
  width: 100%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.autocomplete-item {
  padding: 6px 10px;
  cursor: pointer;
}

.autocomplete-item:hover {
  background: #e6f0ff;
}

.toast-message {
  min-width: 220px;
  background-color: #4CAF50;
  color: #fff;
  text-align: center;
  border-radius: 8px;
  padding: 12px;
  position: fixed;
  z-index: 99999; /* pastikan > loading-screen (1000) */
  left: 50%;
  bottom: 40px;
  transform: translateX(-50%);
  font-size: 15px;
  opacity: 0;
  transition: opacity 0.25s, transform 0.25s;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.toast-message.show { opacity: 1; transform: translateX(-50%) translateY(-8px); }
.toast-message.error { background-color: #e53935; }

.non-aktif-group .unit-header {
  background-color: #f8d7da;  /* merah muda lembut */
  border: 1px solid #f5c2c7;
  color: #842029;
}

.non-aktif-group .unit-header .unit-name {
  font-weight: bold;
}

.spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid #fff;
  border-top: 2px solid #1a73e8;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 6px;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

..laporan-alasan {
  margin-top: 12px;
  border: 1px solid #cce0ff; /* border utama seragam */
  width: 100%;
  border-collapse: collapse;
  background: #fff;
}

.laporan-alasan th {
  background: #e6f0ff; /* biru muda untuk header */
  text-align: center;
  font-weight: bold;
  border: 1px solid #cce0ff; /* seragam */
  padding: 6px;
}

.laporan-alasan td {
  border: 1px solid #cce0ff; /* seragam */
  padding: 6px;
  text-align: left;
  background: #fff;
}

.laporan-alasan td:first-child,
.laporan-alasan th:first-child {
  white-space: nowrap; /* kolom Bulan auto saja */
}
/* === Layout cetak Absensi (1 kartu per halaman, margin 8-2-8-2) === */
.absensi-print-container {
  padding: 8mm 2mm;   /* atas-bawah 8mm, kanan-kiri 2mm */
  box-sizing: border-box;
}

.absensi-print-container .santri-box {
  width: 95%;               /* kecilkan sedikit biar muat A5 */
  margin: 0 auto 6mm auto;  /* auto = center kanan-kiri */
  page-break-after: always; /* 1 kartu = 1 halaman */
  page-break-inside: avoid;
  font-size: 0.85em;        /* perkecil font supaya pas */
  box-sizing: border-box;
}

/* ðŸ”¹ Tabel di dalam cetakan absensi */
.absensi-print-container table {
  width: 95%;              /* lebih kecil, biar ada ruang kanan-kiri */
  margin-left: auto;       /* center kanan */
  margin-right: auto;      /* center kiri */
  border-collapse: collapse;
  table-layout: auto;      /* kolom ikut isi */
}
/* Styling khusus untuk mode cetak / PDF A5 */
@media print {
  #absensi-container table {
    width: 95%;              /* lebih kecil, ada ruang kananâ€“kiri */
    margin-left: auto;       /* center horizontal */
    margin-right: auto;
  }
}



/* ======================================
   ðŸ“Š WRAPPER UNTUK SCROLL HORIZONTAL
   ====================================== */
.data-table-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 8px;
}

/* ======================================
   ðŸ“Š TABEL DALAM KARTU
   ====================================== */
.best-students-card .data-table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  min-width: 700px;
}

.best-students-card .data-table th,
.best-students-card .data-table td {
  border: 1px solid #e0e5f0;
  padding: 8px 12px;
  font-size: 14px;
  vertical-align: middle;
  white-space: nowrap;
}

/* ðŸ”¹ Default rata kiri */
.best-students-card .data-table th,
.best-students-card .data-table td {
  text-align: left;
}

/* ðŸ”¹ Default rata kiri */
.best-students-card .data-table th {
  text-align: center;
}

/* ðŸ”¸ Angka di tengah */
.best-students-card .data-table td[data-type="number"],
.best-students-card .data-table th[data-type="number"],
.best-students-card .data-table td.number,
.best-students-card .data-table th.number {
  text-align: center;
}

/* ðŸ”¹ Header tabel tegas */
.best-students-card .data-table th {
  font-weight: 700;
  text-transform: capitalize;
  letter-spacing: 0.3px;
  border-bottom: 2px solid #ccc;
}

/* Baris selang-seling */
.best-students-card .data-table tr:nth-child(even) {
  background: #fdfdff;
}

/* Hover baris */
.best-students-card .data-table tr:hover {
  background: #eef4ff;
  transition: background 0.25s;
}

/* ======================================
   ðŸ“± ANDROID RESPONSIVE TABLE (SCROLL + WRAP + CENTER HEADER)
   ====================================== */
@media (max-width: 768px) {
  /* ðŸ”¹ Wrapper tabel bisa digeser */
  .data-table-wrapper {
    display: block;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    max-width: 100%;
  }

  /* ðŸ”¹ Tabel fleksibel */
  .best-students-card .data-table {
    width: max-content;
    min-width: 600px;
    border-collapse: collapse;
    table-layout: auto;
  }

  /* ðŸ”¹ Header tabel rata tengah */
  .best-students-card .data-table th {
    text-align: center !important;
    background: #f2f5fb;
    font-weight: 600;
    white-space: normal !important;
    word-break: break-word;
    padding: 8px 10px;
  }

  /* ðŸ”¹ Isi tabel wrap teks panjang */
  .best-students-card .data-table td {
    white-space: normal !important;
    word-break: break-word !important;
    overflow-wrap: anywhere;
    text-overflow: clip;
    vertical-align: middle;
    font-size: 13px;
    padding: 6px 8px;
    text-align: left; /* default rata kiri */
  }

  /* ðŸ”¹ Kolom angka (rata tengah) */
  .best-students-card .data-table td[data-type="number"],
  .best-students-card .data-table td.number {
    text-align: center !important;
  }

  /* ðŸ”¹ Kolom Nama Lebih Lebar */
  .best-students-card .data-table th:nth-child(2),
  .best-students-card .data-table td:nth-child(2) {
    min-width: 130px;
    max-width: 230px;
  }

  /* ðŸ”¹ Scrollbar Android yang halus */
  .data-table-wrapper::-webkit-scrollbar {
    height: 6px;
  }
  .data-table-wrapper::-webkit-scrollbar-thumb {
    background: #c8d1e0;
    border-radius: 3px;
  }

  /* ðŸ”¹ Header tetap terlihat jelas */
  .best-students-card .data-table tr:nth-child(even) {
    background: #fdfdff;
  }

  /* ðŸ”¹ Petunjuk visual (bayangan halus sisi kanan saat scroll) */
  .data-table-wrapper {
    position: relative;
  }
  .data-table-wrapper::after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 20px;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(to right, transparent, rgba(0,0,0,0.08));
  }
}

.modal {
  position: fixed; top:0; left:0; width:100%; height:100%;
  display: none; align-items:center; justify-content:center;
  background: rgba(0,0,0,0.4); z-index: 999;
}
.modal-content {
  background:white; padding:20px; border-radius:12px; width:360px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2);
}
.modal-content label { display:block; margin-top:10px; font-weight:bold; }
.modal-content input, select, textarea { width:100%; padding:6px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
.modal-actions { margin-top:15px; text-align:right; }
.modal-actions button { margin-left:5px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }


.pdf-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 6px 14px;
  border: none;
  border-radius: 6px;
  background-color: #1976d2;
  color: #fff;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}
.pdf-btn:hover:not(.loading) {
  background-color: #1565c0;
}
.pdf-btn.loading {
  pointer-events: none;
  opacity: 0.8;
}

.pdf-btn .spinner {
  display: none;
  width: 16px;
  height: 16px;
  border: 2px solid #fff;
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}
.pdf-btn.loading .spinner {
  display: inline-block;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ==========================
   âœ¨ ABSENSI CHART MODAL
   ========================== */

/* Overlay utama */
#absensiChartModal.modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(8px);
  animation: fadeIn 0.3s ease-out;
  overflow-y: auto;
  padding: 20px 0;
}

/* Konten utama modal */
#absensiChartModal .modal-content {
  width: 95%;
  max-width: 900px;
  margin: 60px auto;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  padding: 0;
  box-shadow:
    0 20px 40px rgba(0, 0, 0, 0.15),
    0 8px 16px rgba(0, 0, 0, 0.1);
  animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  position: relative;
  border: 1px solid #e2e8f0;
  overflow: visible;
}

/* Header */
.modal-header {
  background: linear-gradient(135deg, #b00020 0%, #d00020 100%);
  padding: 20px 30px;
  color: white;
  border-radius: 16px 16px 0 0;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Judul */
.modal-header h3 {
  margin: 0;
  font-weight: 700;
  font-size: 1.4rem;
  color: white;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  text-align: center;
}

/* Tombol Close */
#absensiChartModal .close-btn {
  position: absolute;
  top: 12px;
  right: 14px;
  font-size: 26px;
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  background: rgba(255, 255, 255, 0.15);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

#absensiChartModal .close-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.1);
}

/* Isi modal */
.modal-body {
  padding: 25px 30px;
  overflow-x: auto;
  overflow-y: visible;
  -webkit-overflow-scrolling: touch;
}

/* Kontainer Chart */
.chart-container {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  margin: 0 auto;
  box-shadow:
    0 4px 6px -1px rgba(0, 0, 0, 0.05),
    0 2px 4px -1px rgba(0, 0, 0, 0.03);
  border: 1px solid #f1f5f9;
  min-width: 800px;
}

#absensiChartCanvas {
  width: 100% !important;
  height: 450px !important;
  min-width: 760px;
}

/* Ringkasan di bawah chart */
.absensi-trend-summary {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 10px;
  padding: 16px 20px;
  margin-top: 20px;
  border: 1px solid #e2e8f0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
}

.absensi-trend-summary .flex {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
  align-items: center;
}

.absensi-trend-summary span {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #475569;
  font-weight: 500;
  white-space: nowrap;
}

.absensi-trend-summary strong {
  color: #1e293b;
  font-weight: 700;
}

/* Warna legenda */
.absensi-trend-summary .w-3 {
  width: 14px;
  height: 14px;
  border-radius: 3px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* ==========================
   ðŸ§¾ TABEL TREND
   ========================== */
.table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-top: 20px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

#absensi-merah-trend-module .trend-table {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

#absensi-merah-trend-module .trend-table th,
#absensi-merah-trend-module .trend-table td {
  padding: 10px 8px;
  border: 1px solid #f1f5f9;
  text-align: center;
  color: #475569;
  white-space: nowrap;
}

#absensi-merah-trend-module .trend-table thead th {
  background: #f3f6fb;
  font-weight: 700;
}

/* Warna status */
.trend-cell-merah {
  background: rgba(255, 107, 107, 0.15) !important;
  color: #b91c1c !important;
  font-weight: 700;
}

.trend-cell-baru {
  background: rgba(255, 107, 107, 0.08) !important;
  color: #ef4444 !important;
  font-weight: 600;
}

.trend-cell-masih {
  background: rgba(201, 42, 42, 0.12) !important;
  color: #c92a2a !important;
  font-weight: 700;
}

.trend-cell-membaik {
  background: rgba(64, 192, 87, 0.1) !important;
  color: #166534 !important;
  font-weight: 600;
}

/* Foto santri */
#absensi-merah-trend-module .trend-table img {
  width: 42px;
  height: 42px;
  object-fit: cover;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  transition: all 0.3s ease;
}

#absensi-merah-trend-module .trend-table img:hover {
  transform: scale(1.05);
  border-color: #94a3b8;
}

/* Catatan kecil */
.small-note {
  font-size: 12px;
  color: #64748b;
  margin-top: 8px;
  text-align: center;
  font-style: italic;
  padding: 8px 16px;
  background: #f8fafc;
  border-radius: 6px;
  border-left: 3px solid #94a3b8;
}

/* ==========================
   ðŸ“± RESPONSIVE DESIGN
   ========================== */
@media (max-width: 1024px) {
  .chart-container { min-width: 700px; }
  #absensiChartCanvas { min-width: 680px; }
}

@media (max-width: 768px) {
  #absensiChartModal.modal { padding: 10px 5px; }

  #absensiChartModal .modal-content {
    width: 98%;
    margin: 0 auto;
  }

  .modal-header {
    padding: 16px 20px;
  }

  .modal-header h3 {
    font-size: 1.2rem;
    text-align: left;
    padding-right: 50px;
  }

  .modal-body {
    padding: 16px 15px;
  }

  .chart-container {
    min-width: 650px;
    padding: 15px;
  }

  #absensiChartCanvas {
    height: 380px !important;
    min-width: 620px;
  }

  .absensi-trend-summary { min-width: 600px; }

  .absensi-trend-summary .flex {
    flex-direction: column;
    gap: 10px;
  }
}

@media (max-width: 480px) {
  .modal-header h3 { font-size: 1.1rem; }
  #absensiChartModal .close-btn {
    top: 8px;
    right: 10px;
    width: 32px;
    height: 32px;
    font-size: 22px;
  }

  .chart-container {
    min-width: 530px;
    padding: 12px;
  }

  #absensiChartCanvas {
    height: 320px !important;
    min-width: 500px;
  }

  .table-container { min-width: 550px; }

  #absensi-merah-trend-module .trend-table th,
  #absensi-merah-trend-module .trend-table td {
    font-size: 10px;
    padding: 6px 4px;
  }

  #absensi-merah-trend-module .trend-table img {
    width: 34px;
    height: 34px;
  }
}

/* ==========================
   âœ¨ Animations & Scrollbar
   ========================== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    transform: translateY(50px) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

/* Scrollbar halus */
.modal-body::-webkit-scrollbar,
.table-container::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.modal-body::-webkit-scrollbar-track,
.table-container::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb,
.table-container::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover,
.table-container::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Indikator geser di HP */
@media (max-width: 768px) {
  .modal-body::before {
    content: 'ðŸ’¡ Geser ke kanan/kiri untuk melihat lebih banyak';
    display: block;
    text-align: center;
    font-size: 12px;
    color: #64748b;
    background: #f1f5f9;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 3px solid #3b82f6;
  }
}

/* supaya header dan grafik bisa digeser bersama */
#absensiChartModal .modal-content {
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  padding-top: 1.5rem; /* jarak antara header & grafik */
  position: relative;
}


/* tombol close warna merah muda & hover merah tua */
#absensiChartModal .close-btn {
  background: #fca5a5;   /* merah muda */
  color: white;
}
#absensiChartModal .close-btn:hover {
  background: #b91c1c;   /* merah tua */
}

#absensiChartModal h3 {
  color: #b91c1c; /* merah tua elegan */
  text-align: center;
  margin-bottom: 0.5rem;
}

.trend-cell-baru {
  background-color: #ff6b6b;  /* merah muda */
  color: #000;
}
.trend-cell-masih {
  background-color: #c92a2a;  /* merah tua */
  color: #000;
}
.trend-cell-membaik {
  background-color: #40c057;  /* hijau */
  color: #000;
}

/* ==== fix posisi X di pojok kanan atas saat potrait ==== */
@media (max-width: 768px) and (orientation: portrait) {
  #absensiChartModal .close-btn {
    position: fixed !important;
    top: 10px;
    right: 10px;
    z-index: 9999;
    transform: translate(0, 0);
    background: #fca5a5; /* merah muda */
    color: white;
    transition: all 0.3s ease;
  }

  #absensiChartModal .close-btn:hover {
    background: #b91c1c; /* merah tua */
  }
}

/* Inventaris tabs */
.inventaris-tabs { display:flex; gap:0.6rem; margin-bottom:0.8rem; }
.inventaris-tab {
  background:#fff;
  border:1px solid #cfe0ff;
  color:#1a73e8;
  padding:0.45rem 0.9rem;
  border-radius:0.6rem;
  cursor:pointer;
  font-weight:600;
}
.inventaris-tab:hover:not(.active) { background:#e8f0fe; }
.inventaris-tab.active {
  background:#1a73e8;
  color:#fff;
  border-color:#1a73e8;
}
.inventaris-tab-content { display:none; }
.inventaris-tab-content.active { display:block; }

.app-footer {
  background: #ffffff;                     /* putih */
  padding: 1rem 0.75rem;                   /* jarak dalam */
  border-radius: 16px;                     /* biar mengikuti style app */
  box-shadow: 0 4px 20px rgba(0,0,0,0.05); /* shadow halus */
  display: flex;
  justify-content: center;                 /* center kananâ€“kiri */
  align-items: center;
  flex-wrap: wrap;                         /* biar responsif */
  gap: 0.75rem;                            /* jarak antar badge */
  margin-top: 1.5rem;
}

@media (max-width: 480px) {
  .app-footer {
    padding: 0.75rem;
    gap: 0.5rem;
  }
}

/* ===== Checkbox Group â€“ Responsive & Device Safe ===== */
.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 16px;
  max-height: 160px;
  overflow-y: auto;
  padding: 8px 4px;

  /* mobile scroll smooth */
  -webkit-overflow-scrolling: touch;
}

/* label jadi area klik besar & konsisten */
.checkbox-group label {
  display: inline-flex;
  align-items: center;
  gap: 6px;

  font-size: 13px;
  line-height: 1.4;
  cursor: pointer;

  white-space: nowrap;
  user-select: none;
}

/* checkbox konsisten lintas device */
.checkbox-group input[type="checkbox"] {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

/* ===== Mobile ===== */
@media (max-width: 600px) {
  .checkbox-group {
    gap: 8px 12px;
    max-height: 200px;
  }

  .checkbox-group label {
    font-size: 14px; /* lebih terbaca di HP */
  }

  .checkbox-group input[type="checkbox"] {
    width: 18px;
    height: 18px;
  }
}

/* ===== Desktop besar ===== */
@media (min-width: 1200px) {
  .checkbox-group {
    max-height: 140px;
  }
}

/* ===============================
   CONTAINER LUAR (KELAS & UNIT)
================================ */
#filterKelas,
#filterUnit,
#filterUnitPenasehat {
  display: flex;
  flex-wrap: wrap;
  gap: 10px 16px;
  padding: 12px;
  margin-top: 6px;
  background: #f4faff;
  border: 1.5px solid #cfe8ff;
  border-radius: 14px;
  max-height: 160px;
  overflow-y: auto;
}


/* Scrollbar halus (opsional) */
#filterKelas::-webkit-scrollbar,
#filterUnit::-webkit-scrollbar {
  width: 6px;
}
#filterKelas::-webkit-scrollbar-thumb,
#filterUnit::-webkit-scrollbar-thumb {
  background: #c7def5;
  border-radius: 6px;
}

/* ===============================
   WRAPPER
================================ */
.bulat-checkbox-wrapper {
  display: inline-flex;
}

/* ===============================
   HIDE CHECKBOX ASLI
================================ */
.bulat-checkbox {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}


/* ===============================
   LABEL (ICON | TEXT)
================================ */
.bulat-checkbox-label {
  display: grid;
  grid-template-columns: auto 1fr;
  align-items: center;
  column-gap: 8px;

  cursor: pointer;
  padding: 4px 0;
  user-select: none;
}

/* ===============================
   BULATAN CHECK
================================ */
.bulat-checkbox-icon {
  width: 18px;
  height: 18px;
  border: 2px solid #9aa0a6;
  border-radius: 50%;
  background: transparent;

  display: grid;
  place-items: center;
  transition: all 0.25s ease;
}

/* ===============================
   CHECKMARK SVG
================================ */
.bulat-checkmark {
  width: 12px;
  height: 12px;
  stroke: #fff;
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 24;
  stroke-dashoffset: 24;
  transition: stroke-dashoffset 0.3s ease;
}

/* ===============================
   TEXT
================================ */
.bulat-checkbox-text {
  font-size: 0.85rem;
  font-weight: 500;
  color: #333;

  line-height: 1.2;
  margin: 0;
  padding: 0;
}

/* ===============================
   CHECKED STATE
================================ */
.bulat-checkbox:checked + .bulat-checkbox-label .bulat-checkbox-icon {
  background: #2196f3;
  border-color: #2196f3;
}

.bulat-checkbox:checked + .bulat-checkbox-label .bulat-checkmark {
  stroke-dashoffset: 0;
}

.bulat-checkbox:checked + .bulat-checkbox-label .bulat-checkbox-text {
  color: #1976d2;
}

/* ===============================
   HOVER (DESKTOP)
================================ */
@media (hover: hover) {
  .bulat-checkbox-label:hover .bulat-checkbox-icon {
    border-color: #2196f3;
  }
}

/* ===============================
   MOBILE
================================ */
@media (max-width: 768px) {
  #filterKelas,
  #filterUnit {
    padding: 10px;
    gap: 8px 14px;
    max-height: 140px;
  }

  .bulat-checkbox-icon {
    width: 17px;
    height: 17px;
  }

  .bulat-checkbox-text {
    font-size: 0.8rem;
  }
}
@media (max-width: 768px) {
  .bulat-checkbox-label {
    padding: 6px 2px;
  }
}

/* Pembatas Semester */
.tr-semester-divider td {
  background: linear-gradient(90deg, #2563eb, #3b82f6);
  color: #fff;
  font-weight: bold;
  text-align: center;
  padding: 8px;
  letter-spacing: 1px;
}


  </style>
</head>
<body>
  <div id="loadingIndicator"><div class="progress"></div></div>
  <div id="loading-screen"><div class="loading-spinner"></div><p>Memuat data...</p></div>
  <div id="error-message" class="error-message"></div>

   <!-- Main Grid View -->
<div id="main-grid">
  <!-- ðŸ”¹ Header Atas -->
  <div class="app-header">
    <div class="app-header-left">
      <img src="icons/logo.png" alt="Logo" class="app-logo-img">
      <span class="app-title">Simponi Kharisma</span>
    </div>
  </div>

<!-- ðŸ”¹ User Info Bar -->
<div class="user-info-bar">
  <div class="user-left">      
    <div class="user-details">
  <span id="userRoleText">User</span>
  <span id="userEmail">-</span>
</div>

  </div>
  <button class="logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Logout
  </button>
</div>

    <div class="grid-container">
      <div class="grid-item" data-module="guru">
        <i class="material-icons">supervisor_account</i>
        <span>Mustahiq</span>
      </div>
      <div class="grid-item" data-module="penasehat">
        <i class="material-icons">diversity_3</i>
        <span>Penasehat</span>
      </div>
      <div class="grid-item" data-module="santri">
        <i class="material-icons">school</i>
        <span>Siswa</span>
      </div>
	   <div class="grid-item" data-module="pendaftaran" onclick="window.location.href='pendaftaran.html'">
		<i class="material-icons">add_to_queue</i>
		<span>Pendaftaran</span>
	  </div>
	  <div class="grid-item" data-module="harian" onclick="window.location.href='nadhom.html'">
		<i class="material-icons">list_alt</i>
		<span>Harian</span>
	  </div>
      <div class="grid-item" data-module="absensi">
        <i class="material-icons">event_available</i>
        <span>Absensi</span>
      </div>
      <div class="grid-item" data-module="nilai">
        <i class="material-icons">grading</i>
        <span>Nilai</span>
      </div>      
	  <div class="grid-item" data-module="inventaris">
	  <i class="material-icons">inventory_2</i>
	  <span>Inventaris</span>
	</div>
	<div class="grid-item" data-module="pelanggaran">
	  <i class="material-icons">report_problem</i>
	  <span>Pelanggaran</span>
	</div>
	<div class="grid-item" data-module="info">
        <i class="material-icons">info</i>
        <span>Informasi</span>
      </div>
    </div>
  </div>
  

  <!-- ================== SANTRI MODULE ================== -->
<div id="santri-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  
  <h2>Data Siswa</h2>
  
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <div class="tab-item active" data-tab="kartu">Tampilan Kartu</div>
    <div class="tab-item" data-tab="data">Data Lengkap</div>
  </div>
  
  <!-- Filter Section -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="searchNama">Cari Nama:</label>
      <input id="searchNama" placeholder="Cari Nama Santri..." oninput="filterSantri()">
    </div>
    
    <div class="filter-group">
  <label>Kelas:</label>
  <div id="filterKelas" class="checkbox-group"></div>
</div>

<div class="filter-group">
  <label>Unit Ndalem:</label>
  <div id="filterUnit" class="checkbox-group"></div>
</div>

  </div>

  <!-- Tab Content: Kartu -->
  <div id="tab-kartu" class="tab-content active">
    <div id="santri-container"></div>
  </div>
  
  <!-- Tab Content: Data Lengkap -->
  <div id="tab-data" class="tab-content">
    <!-- Admin Tools khusus Data Lengkap -->
    <div class="admin-tools">
      <button class="admin-only" onclick="openAddSantri()">âž• Tambah</button>
      <!-- Ganti tombol -->
		<button id="btnSantriPDF" class="admin-only" onclick="handleDownloadSantri('pdf')">
		  â¬‡ï¸ Download Full
		</button>
		<button id="btnSantriCustom" class="admin-only" onclick="handleDownloadSantri('pdfcustom')">
		  â¬‡ï¸ Laporan Ndalem
		</button>


    </div>

    <!-- Table -->
    <div class="data-table-container">
      <div id="santri-table-container"></div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <div id="paginationInfo" class="pagination-info">Menampilkan 0 data</div>
      <div id="paginationControls" class="pagination-controls"></div>
    </div>
  </div>
</div>

<!-- ========== MODAL FORM SANTRI (POPUP CRUD) ========== -->
<div id="santriModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closeSantriModal()">&times;</span>
    <h2 id="santriModalTitle">Tambah/Edit Santri</h2>
    
    <form id="santriForm" class="crud-form">
      <input type="hidden" id="santriId">

      <label>Nama Lengkap *</label>
	  <input type="text" id="Nama_Lengkap" list="listNama" required>
	  <datalist id="listNama"></datalist>

      <label>Kelas</label>
      <select id="Kelas"></select>

	  <label>Bagian</label>
	  <input type="text" id="Bagian" list="listBagian">
	  <datalist id="listBagian"></datalist>

      <label>Stambuk</label>
      <input type="text" id="Stambuk">

      <label>Stambuk Ndalem</label>
      <input type="text" id="Stambuk_Ndalem">

      <label>Unit Ndalem</label>
      <select id="Unit_Ndalem"></select>

      <label>Kode Unit</label>
      <input type="text" id="Kode_Unit">

	  <label>Asal Daerah</label>
	  <input type="text" id="Asal_Daerah" list="listDaerah">
	  <datalist id="listDaerah"></datalist>

	  <label>Himpunan</label>
	  <input type="text" id="Himpunan" list="listHimpunan">
	  <datalist id="listHimpunan"></datalist>

	  <label>Kamar</label>
	  <input type="text" id="Kamar" list="listKamar">
	  <datalist id="listKamar"></datalist>

      <label>Tgl Lahir</label>
      <input type="date" id="Tgl_Lahir">

      <label>Mulai Ngabdi</label>
	  <input type="date" id="Mulai_Ngabdi">

      <label>Tgl Keluar</label>
      <input type="date" id="Tgl_Keluar">

      <label>Status</label>
      <select id="Status">
        <option value="aktif">aktif</option>
        <option value="tidak aktif">tidak aktif</option>
      </select>

      <label>Posisi Tugas</label>
      <input type="text" id="Posisi_Tugas">

      <label>Jam Tugas</label>
      <input type="text" id="Jam_Tugas">

      <label>Shift</label>
      <input type="text" id="Shift">

      <label>Foto (URL)</label>
      <input type="text" id="Foto" oninput="previewFoto()">

      <div style="margin:10px 0;">
        <img id="fotoPreview" src="" alt="Preview Foto" style="max-height:120px;display:none;">
      </div>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closeSantriModal()">âŒ Batal</button>
      </div>
    </form>
  </div>
</div>


 <!-- Absensi Module - PERBAIKAN STRUKTUR -->
  <div id="absensi-module" class="module-container">
    <div class="back-button" onclick="showMainGrid()">
      <i class="material-icons">arrow_back</i>
      <span>Kembali ke Menu Utama</span>
    </div>
    
    <h2>Data Absensi</h2>
    
    <div class="admin-tools">
	  <button class="admin-only" onclick="openAddAbsensi()">âž• Tambah</button>

	  <button onclick="showAbsensiMerahTrendModule()">ðŸ”Ž Detail Absen Merah</button>


	  <!-- Dropdown Download -->
	  <div class="admin-only" style="display:inline-block; position:relative;">
		<button onclick="toggleAbsensiDownloadMenu()">â¬‡ï¸ Download â–¼</button>
		<div id="absensiDownloadMenu" style="display:none; position:absolute; background:white; border:1px solid #ccc; border-radius:6px; min-width:180px; z-index:1000; padding:5px;">		  
		  <a href="#" onclick="downloadAbsensiPDF(); hideAbsensiDownloadMenu()">ðŸ“‘ Download PDF</a><br>
		  <a href="#" onclick="downloadAbsensiPNG(); hideAbsensiDownloadMenu()">ðŸ“¸ Download PNG</a>
		</div>
	  </div>
	</div>	
    
    <div class="filter-row">
      <div class="filter-group">
        <label for="absensiSearchNama">Cari Nama:</label>
        <input id="absensiSearchNama" placeholder="Cari Nama Santri..." oninput="loadAbsensiData()">
      </div>
      
      <div class="filter-group">
        <label for="absensiSearchKelas">Kelas:</label>
        <select id="absensiSearchKelas" onchange="loadAbsensiData()">
          <option value="semua">Semua Kelas</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="absensiSearchUnit">Unit Ndalem:</label>
        <select id="absensiSearchUnit" onchange="loadAbsensiData()">
          <option value="semua">Semua Unit</option>
        </select>
      </div>
    </div>
    
    <label style="margin-right:10px;">
	  <input type="checkbox" id="filterMerahCheckbox" onchange="loadAbsensiData()"> 
	  ðŸ”´ Absen Merah
	</label>

	<!-- â¬‡ï¸ Dropdown bulan di kanan -->
	<select id="absensiSearchBulan" onchange="loadAbsensiData()" style="padding:4px 6px;">
	  <option value="semua">Semua Bulan</option>
	</select>

    
    <div id="absensi-container" style="margin-top: 20px;"></div>
    
    <!-- Kontrol Pagination -->
    <div id="absensiPaginationControls" style="margin-top: 20px; text-align:center;"></div>
  </div> <!-- Penutup yang benar untuk absensi-module -->
  
	<!-- Popup Modal Grafik Absensi -->
	<div id="absensiChartModal" class="modal">
	  <div class="modal-content">
		<span class="close-btn" onclick="closeAbsensiChart()">&times;</span>
		<h3 style="text-align:center">Grafik Absensi Merah per Bulan</h3>
		
		<div id="absensiChartCanvas" style="width:100%;height:420px;"></div>
	  </div>
	</div>

<!-- Absensi Merah - Trend Detail (HALAMAN) -->
<div id="absensi-merah-trend-module" class="module-container" style="display:none;">
  <div class="back-button" onclick="hideAbsensiMerahTrendModule()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Absensi</span>
  </div>

  <h2>Analisis & Progres Absen Merah</h2>

  <div class="admin-tools" style="margin-bottom:8px;">   
    <button onclick="openAbsensiChart()">ðŸ“Š Lihat Grafik</button> <!-- tetap buka chart popup -->
	<button class="admin-only" id="btnDownloadAbsensiMerahPDF" onclick="handleDownloadAbsensiMerahPDF()">
  â¬‡ï¸ Download
</button>

  </div>

  <div style="margin:8px 0;">
    <input id="trendSearch" placeholder="Cari Nama / Unit Ndalem ..." oninput="renderAbsensiMerahTrend(1)" style="padding:6px; min-width:260px;" />
    <label style="margin-left:12px;">
      <input type="checkbox" id="trendOnlyMasihMerah" onchange="renderAbsensiMerahTrend(1)"> Masih merah terakhir
    </label>
  </div>

  <div id="absensiMerahTrendContainer" style="margin-top:12px; overflow:auto;"></div>

  <div id="absensiMerahTrendPagination" style="margin-top:14px; text-align:center;"></div>
</div>


  
 <div id="guru-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Mustahiq</h2>

  <!-- Filter -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="guruSearchNama">Cari Nama:</label>
      <input id="guruSearchNama" placeholder="Cari Nama Guru..." oninput="filterGuru()">
    </div>
    <div class="filter-group">
      <label for="guruFilterKelas">Filter Kelas:</label>
      <select id="guruFilterKelas" onchange="filterGuru()">
        <option value="">Semua</option>
      </select>
    </div>
  </div>

  <!-- Tabel -->
  <div class="data-table-container">
    <table class="data-table" id="guru-table"></table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div id="guruPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="guruPaginationControls" class="pagination-controls"></div>
  </div>
</div>


 <div id="penasehat-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Penasehat</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddPenasehat()">âž• Tambah</button>
    <button class="admin-only" onclick="downloadPenasehatPDF()">â¬‡ï¸ Download PDF</button>
  </div>

  <!-- Filter -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="penasehatSearchNama">Cari Nama:</label>
      <input id="penasehatSearchNama" placeholder="Cari Nama Penasehat..." oninput="filterPenasehat()">
    </div>
  </div>

<div class="filter-group">
  <label>Unit Ndalem:</label>
  <div id="filterUnitPenasehat" class="checkbox-group"></div>
</div>

  <!-- Tabel -->
  <div class="data-table-container">
    <table class="data-table" id="penasehat-table"></table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div id="penasehatPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="penasehatPaginationControls" class="pagination-controls"></div>
  </div>
</div>

<!-- ========== TAMBAH PENASEHAT ========== -->
<div id="penasehatAddModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closePenasehatAddModal()">&times;</span>
    <h2>Tambah Penasehat</h2>

    <form id="penasehatAddForm" class="crud-form">
      <label>Nama Lengkap</label>
      <input type="text" id="add_Nama" required>

      <label>Organisasi</label>
      <input type="text" id="add_Status_Penasehat">

      <label>Pengajar</label>
      <input type="text" id="add_Status_Pengajar">

      <label>Kode Unit</label>
      <input type="text" id="add_Kode_Unit">

      <label>Mutakhorijin</label>
      <input type="text" id="add_Mutakhorijin">

      <label>Nomor HP</label>
      <input type="text" id="add_Hp">

      <label>Mulai Ngabdi</label>
      <input type="date" id="add_Mulai_Ngabdi">

      <label>ID Penasehat</label>
      <input type="text" id="add_id_penasehat" placeholder="(otomatis jika kosong)">

      <label>Status</label>
      <select id="add_Status">
        <option value="">-- pilih status --</option>
        <option value="aktif">aktif</option>
        <option value="tidak">tidak</option>
      </select>

      <label>Status Bisyaroh</label>
      <select id="add_Status_Bisyaroh">
        <option value="">-- pilih status bisyaroh --</option>
        <option value="dapat">dapat</option>
        <option value="tidak">tidak</option>
      </select>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closePenasehatAddModal()">âŒ Batal</button>
      </div>
    </form>
  </div>
</div>

<!-- ========== EDIT PENASEHAT ========== -->
<div id="penasehatEditModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closePenasehatEditModal()">&times;</span>
    <h2>Edit Penasehat</h2>

    <form id="penasehatEditForm" class="crud-form">
      <input type="hidden" id="edit_id">

      <label>Nama Lengkap</label>
      <input type="text" id="edit_Nama" required>

      <label>Organisasi</label>
      <input type="text" id="edit_Status_Penasehat">

      <label>Pengajar</label>
      <input type="text" id="edit_Status_Pengajar">

      <label>Kode Unit</label>
      <input type="text" id="edit_Kode_Unit">

      <label>Mutakhorijin</label>
      <input type="text" id="edit_Mutakhorijin">

      <label>Nomor HP</label>
      <input type="text" id="edit_Hp">

      <label>Mulai Ngabdi</label>
      <input type="date" id="edit_Mulai_Ngabdi">

      <label>ID Penasehat</label>
      <input type="text" id="edit_id_penasehat">

      <label>Status</label>
      <select id="edit_Status">
        <option value="">-- pilih status --</option>
        <option value="aktif">aktif</option>
        <option value="tidak">tidak</option>
      </select>

      <label>Status Bisyaroh</label>
      <select id="edit_Status_Bisyaroh">
        <option value="">-- pilih status bisyaroh --</option>
        <option value="dapat">dapat</option>
        <option value="tidak">tidak</option>
      </select>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Update</button>
        <button type="button" class="crud-btn-cancel" onclick="closePenasehatEditModal()">âŒ Batal</button>
      </div>
    </form>
  </div>
</div>



<div id="nilai-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>

  <h2>Data Nilai</h2>
  
  <div class="admin-tools">
  <button class="admin-only" onclick="openAddNilai()">âž• Tambah</button>

  <!-- ðŸ”½ Dropdown download -->
<select id="downloadFormat" class="admin-only">
  <option value="pdf">â¬‡ï¸ Download PDF</option>
  <option value="html">â¬‡ï¸ Download HTML</option>    
</select>
<button id="btnNilaiDownload" class="admin-only" onclick="handleDownloadNilai()">
  Download
</button>
</div>



  <!-- Tab utama -->
  <div class="nilai-tabs">
    <button class="nilai-tab active" data-nilai-tab="kelas">Tabel</button>
    <button class="nilai-tab" data-nilai-tab="grafik">Grafik</button>
  </div>

  <!-- TAB: KELAS -->
  <div id="nilai-tab-kelas" class="nilai-tab-content active">
    <div class="nilai-filter-row">
      <div class="nilai-filter-group">
        <label for="nilaiSearchNama">Cari Nama:</label>
        <input id="nilaiSearchNama" placeholder="Ketik namaâ€¦" />
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchKelas">Kelas:</label>
        <select id="nilaiSearchKelas">
          <option value="semua">Semua Kelas</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchUnit">Unit Ndalem:</label>
        <select id="nilaiSearchUnit">
          <option value="semua">Semua Unit</option>
        </select>
      </div>
      <!-- Tambahan -->
      <div class="nilai-filter-group">
        <label for="nilaiSearchSemester">Semester:</label>
        <select id="nilaiSearchSemester">
          <option value="semua">Semua</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchTahun">Tahun Ajaran:</label>
        <select id="nilaiSearchTahun">
          <option value="semua">Semua</option>
        </select>
      </div>
    </div>  

    <div class="nilai-list-container" id="nilai-list"></div>
  </div>

  <!-- TAB: GRAFIK -->
  <div id="nilai-tab-grafik" class="nilai-tab-content">
    <div class="nilai-graph-tabs">
      <button class="nilai-graph-tab active" data-graph="kelas">Top Kelas</button>
      <button class="nilai-graph-tab" data-graph="unit">Top Unit Ndalem</button>
      <button class="nilai-graph-tab" data-graph="individu">Top Nama</button>
    </div>	

    <!-- Tambahan filter grafik -->
    <div class="nilai-filter-row">
      <div class="nilai-filter-group">
        <label for="nilaiGraphSemester">Semester:</label>
        <select id="nilaiGraphSemester">
          <option value="semua">Semua</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiGraphTahun">Tahun Ajaran:</label>
        <select id="nilaiGraphTahun">
          <option value="semua">Semua</option>
        </select>
      </div>
    </div>
	
	<!-- âœ… Header grafik dipisah -->
  <div class="nilai-chart-header" id="nilai-chart-header">
    Semester - | Tahun Ajaran -
  </div>

    <div class="nilai-chart-container">
      <div class="nilai-chart-scroll-wrapper">
        <div class="nilai-chart-scroll-inner">
          <canvas id="nilai-chart"></canvas>
        </div>
      </div>
    </div>
  </div> <!-- âœ… tutup nilai-tab-grafik -->
</div> <!-- âœ… tutup nilai-module -->

<!-- INVENTARIS MODULE -->
<div id="inventaris-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>

  <h2>Data Inventaris</h2>

  <!-- TAB MENU -->
  <div class="inventaris-tabs-row" style="margin:10px 0;">
    <div class="inventaris-tabs">
      <button class="inventaris-tab active" data-inventaris-tab="kendaraan">Kendaraan</button>
      <button class="inventaris-tab" data-inventaris-tab="handphone">Handphone</button>
    </div>
  </div>

  <!-- ================= TAB KENDARAAN ================= -->
  <div id="inventaris-tab-kendaraan" class="inventaris-tab-content active">

    <!-- Buttons khusus admin -->
    <div class="admin-tools-kendaraan admin-only">
      <button onclick="openAddInventaris()">âž• Tambah Kendaraan</button>

      <button class="pdf-btn" onclick="handleDownloadInventarisKendaraan(this)">
        â¬‡ï¸ <span>Download PDF</span>
        <span class="spinner"></span>
      </button>
    </div>
	
	    <!-- â¬‡ï¸ Ringkasan taruh di sini -->
  <div id="inventaris-summary" 
       style="margin:10px 0; padding:8px; background:#f9f9f9; border:1px solid #ddd; border-radius:6px;">
    <!-- Ringkasan inventaris akan muncul di sini via JS -->
  </div>  
  
  <!-- ðŸ” Filter Kendaraan -->
<div style="margin-bottom:10px;">
  <input id="searchKendaraan" type="text" placeholder="Cari nama, unit, merk, atau nopol..."
         oninput="applyFilterKendaraan()" 
         style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
</div>



    <div id="inventaris-table-container" class="inventaris-scroll">
      <div class="inventaris-scroll-inner">
        <table id="inventaris-table" class="simple-table inventaris-table"></table>
      </div>
      <div id="paginationControls"></div>
    </div>
  </div>

  <!-- ================= TAB HANDPHONE ================= -->
  <div id="inventaris-tab-handphone" class="inventaris-tab-content">

    <!-- Buttons khusus admin -->
    <div class="admin-tools-hp admin-only">
      <button onclick="openAddInventarisHP()">âž• Tambah Handphone</button>

      <button class="pdf-btn" onclick="handleDownloadInventarisHP(this)">
        â¬‡ï¸ <span>Download PDF</span>
        <span class="spinner"></span>
      </button>
    </div>
	
	<!-- ðŸ” Filter Handphone -->
<div style="margin-bottom:10px;margin-top:10px;">
  <input id="searchHP" type="text" placeholder="Cari nama, unit, merk, atau IMEI..."
         oninput="applyFilterHP()"
         style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc;">
</div>


    <div id="inventaris-hp-table-container" class="inventaris-scroll">
      <div class="inventaris-scroll-inner">
        <table id="inventaris-hp-table" class="simple-table inventaris-table"></table>
      </div>
      <div id="paginationControlsHP"></div>
    </div>
  </div>
</div>


  


<!-- ========== MODAL FORM INVENTARIS (CRUD) ========== -->
<div id="inventarisModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closeInventarisModal()">&times;</span>
    <h2 id="inventarisModalTitle">Tambah/Edit Inventaris</h2>

    <form id="inventarisForm" class="crud-form">
      <input type="hidden" id="inventarisId">

      <label>Unit Ndalem</label>
      <!-- dropdown yang akan diisi oleh loadUnitOptions -->
      <select id="Kode_Unit_inventaris" required></select>
      <input type="hidden" id="Nama_Unit">

      <label>Jenis Kendaraan</label>
      <input type="text" id="Jenis_Kendaraan">

      <label>Merk</label>
      <input type="text" id="Merk">

      <label>NOPOL</label>
      <input type="text" id="NOPOL">
	  
	  <label>Tahun</label>
      <input type="text" id="Tahun_Produksi">

      <label>Penanggung Jawab</label>
      <select id="Penanggung_Jawab" required>
        <option value="">-- Pilih Penanggung Jawab --</option>
      </select>

      <label>Keterangan</label>
      <select id="Keterangan" required>
        <option value="">-- Pilih Keterangan --</option>
        <option value="Layak">Layak</option>
        <option value="Tidak Layak">Tidak Layak</option>
      </select>

      <label>STNK</label>
      <select id="STNK" required>
        <option value="">-- Pilih STNK --</option>
        <option value="Hidup">Hidup</option>
        <option value="Mati">Mati</option>
        <option value="Hilang">Tidak Ada</option>
      </select>

      <label>BPKB</label>
      <select id="BPKB" required>
        <option value="">-- Pilih BPKB --</option>
        <option value="Ndalem">Ndalem</option>
        <option value="Unit">Unit</option>
		<option value="Tidak Ada">Tidak Ada</option>
      </select>

      <label>Tanggal Pajak</label>
      <input type="date" id="Update_Tgl">

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closeInventarisModal()">âŒ Batal</button>
      </div>
    </form>
  </div>
</div>

<!-- ========== MODAL FORM INVENTARIS HP (CRUD) ========== -->
<div id="inventarisHpModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closeInventarisHpModal()">&times;</span>
    <h2 id="inventarisHpModalTitle">Tambah/Edit Handphone</h2>

    <form id="inventarisHpForm" class="crud-form">
      <input type="hidden" id="inventarisHpId">

      <label>Unit Ndalem</label>
	  <select id="Kode_Unit_hp" required></select>
	  <input type="hidden" id="Nama_Unit_hp">


      <label>Merk HP</label>
      <input type="text" id="Merk_hp" required>

      <label>IMEI</label>
      <input type="text" id="IMEI_hp" required>

      <label>No. Kontak</label>
      <input type="text" id="No_Kontak_hp" required>

      <label>Penanggung Jawab</label>
      <select id="Penanggung_Jawab_hp" required>
        <option value="">-- Pilih Penanggung Jawab --</option>
      </select>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closeInventarisHpModal()">âŒ Batal</button>
      </div>
    </form>
  </div>
</div>

<!-- ===================== MODUL PELANGGARAN ===================== -->
<div id="pelanggaran-module" class="module-container">
  <!-- Tombol Kembali -->
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>

  <h2>Data Pelanggaran</h2>

  <!-- Tombol Admin -->
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddPelanggaran()">âž• Tambah</button>
    <button class="admin-only pdf-btn" onclick="handleDownloadPelanggaran(this)">â¬‡ï¸ <span>Download PDF</span>
	  <span class="spinner"></span>
	</button>
  </div>
  
  <!-- Ringkasan Pelanggaran -->
<div id="pelanggaran-summary"
     style="margin:10px 0; padding:10px; border-radius:8px;
            background: linear-gradient(to bottom, #fdecea, #f8d7da);
            border:1px solid #f5c2c7; color:#842029;
            font-weight:500; text-align:center;">
  <!-- Ringkasan akan dimuat lewat JS -->
</div>

  <!-- Tabel Data Pelanggaran -->
  <div class="simple-table-container">
    <table class="simple-table" id="pelanggaran-table">
      <thead>
        <tr>
          <th>Nama Lengkap</th>
          <th>Jenis Pelaku</th>
          <th>Unit Ndalem</th>
          <th>Takziran</th>
		  <th>Jenis Takziran</th>
          <th>Tanggal</th>
          <th>Pelanggaran</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        <!-- Diisi otomatis oleh JS -->
      </tbody>
    </table>
  </div>

  <!-- Modal Tambah Pelanggaran -->
  <div id="addPelanggaranModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="tutupModal()">&times;</span>
      <h3>Tambah Pelanggaran</h3>

      <label>Jenis Pelaku:</label>
      <select id="jenisPelaku" onchange="togglePelakuFields()">
        <option value="">-- Pilih Jenis Pelaku --</option>
        <option value="santri">Santri</option>
        <option value="penasehat">Penasehat</option>
      </select>

      <div id="santriField" style="display:none">
        <label>Santri:</label>
        <select id="santriSelect"></select>
      </div>

      <div id="penasehatField" style="display:none">
        <label>Penasehat:</label>
        <select id="penasehatSelect"></select>
      </div>
	  
	  <label>Takziran:</label>
      <input type="text" id="isiTakziran" placeholder="Takziran">

      <label>Jenis Takziran:</label>
		<select id="jenisTakziran" required>
		  <option value="">-- Pilih Jenis Takziran --</option>
		  <option value="Ringan">Ringan</option>
		  <option value="Sedang">Sedang</option>
		  <option value="Berat">Berat</option>
		</select>


      <label>Tanggal:</label>
      <input type="date" id="tanggalPelanggaran">

      <label>Pelanggaran:</label>
      <textarea id="isiPelanggaran" placeholder="Deskripsi pelanggaran"></textarea>

      <button onclick="simpanPelanggaran()">ðŸ’¾ Simpan</button>
    </div>
  </div>
</div>

<!-- ===================== MODUL INFORMASI ===================== -->
<div id="info-module" class="module-container">
  <!-- Tombol Kembali -->
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>

  <h2>Data Informasi</h2>

  <!-- Tombol Admin -->
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddInfo()">âž• Tambah</button>  
  </div>

  <!-- ðŸ”¹ Filter Pencarian -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="infoSearchIsi">Cari Informasi:</label>
      <input id="infoSearchIsi" placeholder="Cari isi informasi..." oninput="filterInfo()">
    </div>
  </div>

  <!-- ðŸ”¹ Daftar Informasi -->
  <div class="data-table-container">
    <table class="data-table" id="info-table"></table>
  </div>

  <!-- ðŸ”¹ Pagination -->
  <div class="pagination">
    <div id="infoPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="infoPaginationControls" class="pagination-controls"></div>
  </div>
</div>

<!-- ===== MODAL FORM INFORMASI ===== -->
<div id="infoModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closeInfoModal()">&times;</span>
    <h3 id="infoModalTitle">Tambah Informasi</h3>

    <form id="infoForm" class="crud-form" onsubmit="saveInfo(event)">
      <input type="hidden" id="infoId">

      <label>Tanggal</label>
      <input type="date" id="infoTanggal" required>

      <label>Jenis Informasi</label>
      <input type="text" id="infoJenis" placeholder="Contoh: Pengumuman, Kegiatan..." required>

      <label>Isi Informasi</label>
      <textarea id="infoIsi" rows="4" placeholder="Tulis isi informasi..." required></textarea>

      <label>Penulis</label>
      <input type="text" id="infoPenulis" required>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">ðŸ’¾ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closeInfoModal()">Batal</button>
      </div>
    </form>
  </div>
</div>


<!-- Modal Edit Laporan (Admin) -->
<div id="editLaporanModal" class="modal" style="display:none; z-index:2500;">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="editLaporanTitle">
    <h3 id="editLaporanTitle" style="text-align:center; color:#b00020;">Edit Laporan Absensi (Admin)</h3>

    <input type="hidden" id="editLaporanId" value="">
    <input type="hidden" id="editLaporanStambuk" value="">
    <input type="hidden" id="editLaporanBulan" value="">

    <label for="editLaporanAlasan">Alasan</label>
    <textarea id="editLaporanAlasan" rows="4" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>

    <label for="editLaporanPenanganan" style="margin-top:8px;">Penanganan</label>
    <textarea id="editLaporanPenanganan" rows="4" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>

    <div class="modal-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
      <button class="modal-btn cancel" onclick="closeEditLaporanModal()">Batal</button>
      <button class="modal-btn save" id="saveEditLaporanBtn" onclick="updateLaporan()" style="min-width:110px;">Simpan</button>
    </div>
  </div>
</div>

</body>
  <script>
   
document.addEventListener("DOMContentLoaded", () => {
  const userRole = localStorage.getItem("userRole") || "user";

  supabaseClient.auth.getUser().then(({ data }) => {
    if (data.user) {
      // Role ditampilkan di atas
      document.getElementById("userRoleText").textContent =
        (userRole === "admin") ? "Admin" : "User";

      // Email ditampilkan di bawah
      document.getElementById("userEmail").textContent = data.user.email;
    }
  });
});

  
  const userRole = localStorage.getItem("userRole") || "user";

document.addEventListener("DOMContentLoaded", () => {
  if (userRole === "admin") {
    document.querySelectorAll(".admin-only").forEach(btn => btn.style.display = "inline-block");
  } else {
    document.querySelectorAll(".admin-only").forEach(btn => btn.style.display = "none");
  }
});

  
 

    // Konfigurasi Supabase
    const SUPABASE_URL = "https://oflkibeaesvwzdzyvdfy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbGtpYmVhZXN2d3pkenl2ZGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDIyOTQsImV4cCI6MjA3MDQxODI5NH0.MMcdx7g54R9kqFdfkDPP57gNPCnxGLKWHhexTAcJ2io";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
	
    
    // Variabel global
	const pageSize = 50;
	let allSantriData = [];	
	let allPenasehatData = [];
	let penasehatCurrentPage = 1;
	const penasehatRowsPerPage = 50;
	let penasehatFiltered = [];
	let allGuruData = [];
	let guruFiltered = [];
	let guruCurrentPage = 1;
	const guruRowsPerPage = 50;
	let allInfoData = [];
	let infoFiltered = [];
	let infoCurrentPage = 1;
	const infoRowsPerPage = 50;
	let santriDict = {};            // dictionary: key = Stambuk

	// NILAI (baru, pola absensi1)
	let nilaiFiltered = [];
	let nilaiCurrentPage = 1;
	const NILAI_PAGE_SIZE = 10;
	let nilaiDict = {};
	let nilaiChartInstance = null;
	let lastActiveData = [];        // untuk download
	let lastEditedId = null;        // simpan id terakhir ditambah/diubah
	let lastFilteredData = [];      // simpan hasil filter terakhir
	let currentSortColumn = null;
	let sortDirection = 'asc';
	let allNilaiData = [];
	let nilaiSortedAll = [];
	let nilaiDropdownDict = {}; // â¬…ï¸ KHUSUS UNTUK DROPDOWN (LENGKAP)



	// ABSENSI
	const ABSENSI_PAGE_SIZE = 20;   // jumlah baris per halaman	
	let absensiCurrentPage = 1;
	let absensiDict = null;
	let absensiFilteredSantri = [];



    
    const kelasOrder = [
      'V Ibtidaiyah', 'VI Ibtidaiyah',
      'I Tsanawiyah', 'II Tsanawiyah', 'III Tsanawiyah', 
      'I Aliyah', 'II Aliyah', 'III Aliyah',
      "I-II Ma'had Aly", "III-IV Ma'had Aly", "V-VI Ma'had Aly", "I'dadiyah I", "I'dadiyah II", "I'dadiyah III"
    ];
	
	const kelasOrderGuru = [
	  'I Ibtidaiyah', 'II Ibtidaiyah', 'III Ibtidaiyah', 'IV Ibtidaiyah', 'V Ibtidaiyah', 'VI Ibtidaiyah',
	  'I Tsanawiyah', 'II Tsanawiyah', 'III Tsanawiyah', 
	  'I Aliyah', 'II Aliyah', 'III Aliyah',
	  "I-II Ma'had Aly", "III-IV Ma'had Aly", "V-VI Ma'had Aly"
	];

	
	// =============================
	// Bulan untuk absensi (urutan tetap)
	// =============================
	const bulanAbsensi = [
	  "Syawal", "Dzulqo'dah", "Dzulhijjah",
	  "Muharam", "Shofar", "Robi'ul Awal", "Robi'ul Akhir",
	  "Jumadal Ula", "Jumadal Tsaniyah", "Rajab", "Sya'ban"
	];

	// Saat halaman selesai dimuat, isi dropdown bulan secara awal
	document.addEventListener("DOMContentLoaded", () => {
	  const bulanSelect = document.getElementById("absensiSearchBulan");
	  if (!bulanSelect) return;
	  isiDropdownBulan(bulanSelect, bulanAbsensi);
	});

	// =============================
	// Fungsi untuk memperbarui dropdown bulan kapan pun
	// =============================
	function isiDropdownBulan(dropdown, daftarAktif = []) {
	  // simpan pilihan sebelumnya agar tidak hilang
	  const prevSelected = dropdown.value || 'semua';

	  // jika sedang difokus, tunda pembaruan agar tidak menutup dropdown
	  if (document.activeElement === dropdown) return;

	  // gunakan bulan master jika tersedia, fallback ke daftarAktif, lalu fallback ke bulanAbsensi utama
	  const sumber = (Array.isArray(window.absensiBulanMaster) && window.absensiBulanMaster.length)
		? Array.from(new Set(window.absensiBulanMaster))
		: (Array.isArray(daftarAktif) && daftarAktif.length ? Array.from(new Set(daftarAktif)) : Array.from(bulanAbsensi));

	  // urutkan sesuai urutan master bulanAbsensi
	  const ordered = bulanAbsensi.filter(b => sumber.includes(b));

	  // jika bulan sebelumnya tidak ada di ordered, tambahkan sementara supaya tetap terlihat
	  if (prevSelected !== 'semua' && !ordered.includes(prevSelected)) {
		ordered.unshift(prevSelected);
	  }

	  // isi ulang dropdown
	  dropdown.innerHTML = '<option value="semua">Semua Bulan</option>';
	  ordered.forEach(b => {
		const opt = document.createElement('option');
		opt.value = b;
		opt.textContent = b;
		dropdown.appendChild(opt);
	  });

	  // kembalikan pilihan sebelumnya jika masih ada
	  if (Array.from(dropdown.options).some(o => o.value === prevSelected)) {
		dropdown.value = prevSelected;
	  } else {
		dropdown.value = 'semua';
	  }
	}




    // Inisialisasi
    document.addEventListener('DOMContentLoaded', async () => {
      // Setup grid item clicks dengan efek ripple
      document.querySelectorAll('.grid-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Efek ripple
          const ripple = document.createElement('span');
          ripple.classList.add('ripple-effect');
          const rect = this.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          const x = e.clientX - rect.left - size/2;
          const y = e.clientY - rect.top - size/2;
          
          ripple.style.width = ripple.style.height = `${size}px`;
          ripple.style.left = `${x}px`;
          ripple.style.top = `${y}px`;
          this.appendChild(ripple);
          
          // Hapus ripple setelah animasi selesai
          setTimeout(() => {
            ripple.remove();
          }, 600);
          
          // Buka modul
          const module = item.dataset.module;
          showModule(module);
        });
      });
      
      // Setup tab clicks
      document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs
          document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab
          tab.classList.add('active');
          const tabName = tab.dataset.tab;
          document.getElementById(`tab-${tabName}`).classList.add('active');
          
          // If data tab is selected, render the table
          if (tabName === 'data') {
            renderFullTable(allSantriData);
			// Urut default: Masa Khidmah (Zâ€“A)
			currentSortColumn = 'Masa Khidmah';
			sortDirection = 'asc';
			sortTableBy('Masa Khidmah');

          }
        });
      });
      
      // Load initial data
      await loadInitialData();
    });
    


function showModule(moduleName) {
  // Sembunyikan grid utama
  document.getElementById('main-grid').style.display = 'none';

  // Sembunyikan semua modul
  document.querySelectorAll('.module-container').forEach(module => {
    module.classList.remove('active');
  });

  // Tampilkan modul yang dipilih
  const moduleElement = document.getElementById(`${moduleName}-module`);
  if (moduleElement) {
    moduleElement.classList.add('active');

    if (moduleName === 'santri') {
      renderSantriCards(allSantriData);
    } else if (moduleName === 'absensi') {
      loadAbsensiData();
    } else if (moduleName === 'inventaris') {
	  bindInventarisTabs();
      loadInventaris();
    } else if (moduleName === 'pelanggaran') {
      loadPelanggaran();
    } else if (moduleName === 'nilai') {
      initNilaiModule();

      // --- Tambahkan binding tab Nilai & Grafik setiap kali modul dibuka ---
      document.querySelectorAll('.nilai-tab').forEach(tab => {
        tab.onclick = function () {
          document.querySelectorAll('.nilai-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.nilai-tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('nilai-tab-' + tab.dataset.nilaiTab).classList.add('active');
          if (tab.dataset.nilaiTab === 'kelas') {
            loadNilaiData(1);
          } else if (tab.dataset.nilaiTab === 'grafik') {
            renderNilaiChart('kelas');
          }
        };
      });
      document.querySelectorAll('.nilai-graph-tab').forEach(tab => {
        tab.onclick = function () {
          document.querySelectorAll('.nilai-graph-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          renderNilaiChart(tab.dataset.graph);
        };
      });
    } else if (moduleName === 'penasehat') {
      loadPenasehat();
    } else if (moduleName === 'guru') {
      loadGuru();
    } else if (moduleName === 'info') {
      loadInfo();
    }
  }
}


    
    // Fungsi untuk kembali ke grid utama
    function showMainGrid() {
      // Sembunyikan semua modul
      document.querySelectorAll('.module-container').forEach(module => {
        module.classList.remove('active');
      });
      
      // Tampilkan grid utama
      document.getElementById('main-grid').style.display = 'block';
    }
    
  // 1) Load initial data (master santri) â€” hanya santri AKTIF
async function loadInitialData() {
  showLoading(true);
  try {
    const { data: santriData, error: santriError } = await supabaseClient
      .from('santri_kharisma')
      .select(`
        *,
        Mulai_Ngabdi,
        ngaji (
          id,
          tempat_ngaji,
          Kelas_ngaji
        )
      `)
      

    if (santriError) throw santriError;

    // ðŸ”’ aman: yang masuk memori & cache hanya AKTIF
    allSantriData = santriData || [];
    await saveToDB('santri_kharisma', allSantriData);

    // absensi hanya pastikan store ada (tanpa fetch besar)
    await saveToDB('absensi1', []);

    renderCheckboxFilters(allSantriData);
    populateSuggestions();
    initSantriAutocomplete();

  } catch (err) {
    console.warn("Gagal load Supabase, fallback IndexedDB:", err);

    // fallback offline
    const cachedSantri = await getFromDB('santri_kharisma');
    if (cachedSantri.length) {
      // ðŸ”’ extra safety: offline pun hanya aktif
      allSantriData = cachedSantri.filter(s => s.Status === 'aktif');
    }

    const cachedAbsensi = await getFromDB('absensi1');
    if (cachedAbsensi.length) allAbsensiData = cachedAbsensi;

    if (!allSantriData.length && !allAbsensiData.length) {
      showError("Tidak ada data offline tersimpan. Silakan online dahulu.");
    } else {
      renderCheckboxFilters(allSantriData);
    }
  } finally {
    showLoading(false);
  }
}


function sortByKelasOrder(list, order) {
  return [...list].sort((a, b) => {
    const ia = order.indexOf(a);
    const ib = order.indexOf(b);

    if (ia === -1 && ib === -1) return a.localeCompare(b);
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });
}



function renderCheckboxFilters(data) {
  const kelasSet = new Set();
  const unitSet  = new Set();

  data.forEach(s => {
    if (s.Kelas) kelasSet.add(s.Kelas);
    if (s.Unit_Ndalem) unitSet.add(s.Unit_Ndalem);
  });

  const kelasDiv = document.getElementById("filterKelas");
  const unitDiv  = document.getElementById("filterUnit");

  // simpan state centang
  const checkedKelas = Array.from(
    kelasDiv.querySelectorAll('input:checked')
  ).map(cb => cb.value);

  const checkedUnit = Array.from(
    unitDiv.querySelectorAll('input:checked')
  ).map(cb => cb.value);

  kelasDiv.innerHTML = "";
  unitDiv.innerHTML  = "";

  // ==== KELAS (URUT KHUSUS) ====
  const kelasList = sortByKelasOrder(
    [...kelasSet],
    kelasOrder
  );

  kelasList.forEach(k => {
    const checked = checkedKelas.includes(k) ? 'checked' : '';
    kelasDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${k}" ${checked} onchange="filterSantri()">
        ${k}
      </label>
    `;
  });

  // ==== UNIT (ALFABET) ====
  [...unitSet].sort((a, b) => a.localeCompare(b, 'id')).forEach(u => {
    const checked = checkedUnit.includes(u) ? 'checked' : '';
    unitDiv.innerHTML += `
      <label>
        <input type="checkbox" value="${u}" ${checked} onchange="filterSantri()">
        ${u}
      </label>
    `;
  });
}



async function renderSantriCards(list) {
  showLoading(true);
  await new Promise(resolve => requestAnimationFrame(resolve));
  try {
    const container = document.getElementById('santri-container');
    container.innerHTML = '';

    // ðŸ”¹ Pisahkan data
    const aktifList    = list.filter(s => s.Status !== 'tidak aktif');
    const nonAktifList = list.filter(s => s.Status === 'tidak aktif');

    // === Render aktif per unit (sama seperti sebelumnya) ===
    aktifList.sort((a, b) => {
      const unitCompare = (a.Unit_Ndalem || '').localeCompare(b.Unit_Ndalem || '');
      if (unitCompare !== 0) return unitCompare;
      const kelasA = kelasOrder.indexOf(a.Kelas) === -1 ? 999 : kelasOrder.indexOf(a.Kelas);
      const kelasB = kelasOrder.indexOf(b.Kelas) === -1 ? 999 : kelasOrder.indexOf(b.Kelas);
      if (kelasA !== kelasB) return kelasA - kelasB;
      return (a.Nama_Lengkap || '').localeCompare(b.Nama_Lengkap || '');
    });

    const groupedByUnit = {};
    aktifList.forEach(s => {
      const unit = s.Unit_Ndalem || 'Tidak Diketahui';
      if (!groupedByUnit[unit]) groupedByUnit[unit] = [];
      groupedByUnit[unit].push(s);
    });

    for (const unit in groupedByUnit) {
      const unitDiv = document.createElement('div');
      unitDiv.className = 'unit-group';

      const unitHeader = document.createElement('div');
      unitHeader.className = 'unit-header';
      unitHeader.innerHTML = `
        <span class="triangle"></span>
        <span class="unit-name">${unit}</span>
        <span class="unit-total">${groupedByUnit[unit].length} santri</span>
      `;
      unitHeader.onclick = () => toggleUnit(unitHeader);

      const unitCards = document.createElement('div');
      unitCards.className = 'unit-cards';
      groupedByUnit[unit].forEach(s => unitCards.appendChild(createSantriCard(s)));

      unitDiv.appendChild(unitHeader);
      unitDiv.appendChild(unitCards);
      container.appendChild(unitDiv);
    }

    // === Tambahkan TOGGLE khusus Santri Tidak Aktif di bawah ===
    if (nonAktifList.length) {
      const toggleDiv = document.createElement('div');
      toggleDiv.className = 'unit-group non-aktif-group';

      const header = document.createElement('div');
      header.className = 'unit-header non-aktif-header';
      header.innerHTML = `
        <span class="triangle"></span>
        <span class="unit-name">Santri Tidak Aktif</span>
        <span class="unit-total">${nonAktifList.length} santri</span>
      `;
      header.onclick = () => toggleUnit(header);

      const body = document.createElement('div');
      body.className = 'unit-cards hidden'; // default tertutup

      nonAktifList.forEach(s => body.appendChild(createSantriCard(s)));

      toggleDiv.appendChild(header);
      toggleDiv.appendChild(body);
      container.appendChild(toggleDiv);
    }

  } catch (err) {
    console.error("Gagal render kartu santri:", err);
  } finally {
    showLoading(false);
  }
}



function formatTanggalIndo(tanggalStr) {
  if (!tanggalStr) return '';
  const d = new Date(tanggalStr);
  if (isNaN(d)) return tanggalStr; // fallback kalau tidak valid

  const tgl = String(d.getDate()).padStart(2, '0');
  const bln = String(d.getMonth() + 1).padStart(2, '0');
  const thn = d.getFullYear();

  return `${tgl}/${bln}/${thn}`;
}

function createSantriCard(santri) {
  const card = document.createElement('div');
  card.className = `santri-card ${santri.Status === 'tidak aktif' ? 'tidak-aktif' : ''}`;
  
  // Klik biasa untuk select santri (tetap jalan)
  card.onclick = () => selectSantri(santri, card);

  const imgUrl = santri.Foto || 'img/placeholder.png';
  const tglKeluarFormatted = formatTanggalIndo(santri.Tgl_Keluar);

  card.innerHTML = `
    <img src="https://i.imgur.com/ZzF73E3.png" class="logolembaga" alt="Logo Lembaga">
    <div class="santri-info">
      <img class="photo"
           src="${imgUrl}"
           alt="${santri.Nama_Lengkap || 'Santri'}"
           onerror="this.src='img/placeholder.png'">
      <div class="info">
        <h3><span>Nama</span>: <span>${santri.Nama_Lengkap || '-'}</span></h3>
        <p><span>Kelas</span>: <span>${santri.Kelas || '-'}</span></p>
        <p><span>Bagian</span>: <span>${santri.Bagian || '-'}</span></p>
        <p><span>Stambuk</span>: <span>${santri.Stambuk || '-'}</span></p>
        <p><span>Asal</span>: <span>${santri.Asal_Daerah || '-'}</span></p>
        <p><span>Kamar</span>: <span>${santri.Kamar || '-'}</span></p>
        <p><span>Unit Ndalem</span>: <span>${santri.Unit_Ndalem || '-'}</span></p>
      </div>
    </div>
    ${
      santri.Status === 'tidak aktif'
        ? `
          <div class="status-badge">
            <div>TIDAK AKTIF</div>
            ${tglKeluarFormatted ? `<div class="exit-date">${tglKeluarFormatted}</div>` : ''}
          </div>
        `
        : ''
    }
  `;

  // ==== FITUR DOUBLE TAP UNTUK SCREENSHOT (KHUSUS HP) ====
  let lastTap = 0;
  card.addEventListener('touchend', function(e) {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;

    if (tapLength < 500 && tapLength > 0) {
      // Double tap terdeteksi!
      e.preventDefault(); // cegah aksi klik biasa
      e.stopPropagation(); // agar tidak trigger selectSantri

      screenshotCard(card, santri.Nama_Lengkap || 'santri');
    }
    lastTap = currentTime;
  });

  // Opsional: double click di desktop (mouse)
  card.addEventListener('dblclick', function(e) {
    e.preventDefault();
    screenshotCard(card, santri.Nama_Lengkap || 'santri');
  });

  return card;
}



    function toggleUnit(header) {
      header.classList.toggle('collapsed');
      const cards = header.nextElementSibling;
      cards.classList.toggle('hidden');
    }
  
  function getCheckedValues(containerId) {
  return [...document.querySelectorAll(`#${containerId} input:checked`)]
    .map(cb => cb.value);
}

async function screenshotCard(cardElement, namaSantri) {
  try {
    // Indikator loading
    const originalCursor = cardElement.style.cursor;
    cardElement.style.cursor = 'wait';

    const canvas = await html2canvas(cardElement, {
      scale: 4,                  // Kualitas tinggi untuk HP retina
      useCORS: true,             // Agar gambar eksternal (logo Imgur) ikut kecapture
      backgroundColor: '#ffffff',
      logging: false             // Matikan log debug
    });

    // Kembalikan cursor
    cardElement.style.cursor = originalCursor;

    // Convert canvas ke Blob (untuk share & download)
    canvas.toBlob(async function(blob) {
      const file = new File([blob], `Kartu_${namaSantri.replace(/[^a-zA-Z0-9]/g, '_')}.png`, {
        type: 'image/png'
      });

      // Cek apakah browser support Web Share API
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        // Support share file (kebanyakan HP Android + beberapa iOS)
        try {
          await navigator.share({
            title: `Kartu Santri - ${namaSantri}`,
            text: `Kartu identitas santri ${namaSantri}`,
            files: [file]
          });
          // Jika berhasil share, tidak perlu download otomatis
          return;
        } catch (shareErr) {
          console.warn("Share dibatalkan atau gagal, fallback ke download:", shareErr);
          // Lanjut ke download jika user cancel atau error
        }
      }

      // FALLBACK: Jika tidak support share file (misal desktop atau browser lama)
      // Atau user cancel share â†’ otomatis download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Notifikasi sukses
      alert(`âœ… Kartu ${namaSantri} berhasil di-download!`);
    }, 'image/png');

  } catch (err) {
    console.error("Gagal screenshot:", err);
    alert("âŒ Gagal mengambil screenshot kartu.");
  }
}

// ========== FILTER ==========
function filterSantri() {
  const searchTerm =
    document.getElementById('searchNama')?.value.toLowerCase() || '';

  // ambil kelas tercentang
  const selectedKelas = Array.from(
    document.querySelectorAll('#filterKelas input[type="checkbox"]:checked')
  ).map(cb => cb.value);

  // ambil unit tercentang
  const selectedUnit = Array.from(
    document.querySelectorAll('#filterUnit input[type="checkbox"]:checked')
  ).map(cb => cb.value);

  lastFilteredData = allSantriData.filter(s => {
    // ðŸ”¹ nama
    const namaMatch =
      !searchTerm ||
      s.Nama_Lengkap?.toLowerCase().includes(searchTerm);

    // ðŸ”¹ kelas
    const kelasMatch =
      selectedKelas.length === 0 ||
      selectedKelas.includes(s.Kelas);

    // ðŸ”¹ unit
    const unitMatch =
      selectedUnit.length === 0 ||
      selectedUnit.includes(s.Unit_Ndalem);

    return namaMatch && kelasMatch && unitMatch;
  });

  // render sesuai tab aktif
  const activeTab =
    document.querySelector('.tab-item.active')?.dataset.tab;

  if (activeTab === 'kartu') {
    renderSantriCards(lastFilteredData);
  } else {
    renderFullTable(lastFilteredData);
  }

  // ðŸ”¹ urutkan (tetap seperti sebelumnya)
  currentSortColumn = 'Masa Khidmah';
  sortDirection = 'asc';
  sortTableBy('Masa Khidmah');
}



	// ===== Helper: hitung jumlah bulan sejak `start` sampai sekarang =====
function monthsSince(startDate) {
  if (!startDate || isNaN(startDate)) return null; // null = tidak valid
  const now = new Date();
  let years = now.getFullYear() - startDate.getFullYear();
  let months = now.getMonth() - startDate.getMonth();
  if (now.getDate() < startDate.getDate()) months -= 1;
  if (months < 0) { years -= 1; months += 12; }
  return years * 12 + months; // bisa 0, >0
}

// ===== Hitung Masa Khidmah (tampil) =====
function calculateMasaKhidmah(mulaiValue) {
  if (!mulaiValue) return 'Belum terdata'; // sesuai permintaan

  const start = (mulaiValue instanceof Date) ? mulaiValue : new Date(mulaiValue);
  if (isNaN(start)) return 'Belum terdata';

  const totalMonths = monthsSince(start);
  if (totalMonths === null) return 'Belum terdata';
  if (totalMonths <= 0) return '< 1 bln';

  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;

  if (years > 0 && months > 0) return `${years} th, ${months} bln`; // pakai koma
  if (years > 0) return `${years} th`;
  return `${months} bln`;
}

// ===== Hitung Usia (tampil, mirip Masa Khidmah) =====
function calculateUsia(tglLahirValue) {
  if (!tglLahirValue) return 'Belum terdata';

  const born = (tglLahirValue instanceof Date) ? tglLahirValue : new Date(tglLahirValue);
  if (isNaN(born)) return 'Belum terdata';

  const totalMonths = monthsSince(born);
  if (totalMonths === null) return 'Belum terdata';
  if (totalMonths <= 0) return '< 1 bln';

  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;

  if (years > 0 && months > 0) return `${years} th, ${months} bln`;
  if (years > 0) return `${years} th`;
  return `${months} bln`;
}


// ========== SORT TABLE ==========
function sortTableBy(column) {
  if (currentSortColumn === column) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortColumn = column;
    sortDirection = 'asc';
  }

const fieldMap = {
  'Nama': 'Nama_Lengkap',
  'Kelas': 'Kelas',
  'Bagian': 'Bagian',
  'Tempat Ngaji': 'ngaji.tempat_ngaji',
  'Kelas Ngaji': 'ngaji.Kelas_ngaji',
  'Asal Daerah': 'Asal_Daerah',
  'Kamar': 'Kamar',
  'Unit Ndalem': 'Unit_Ndalem',
  'Posisi Tugas': 'Posisi_Tugas',
  'Shift': 'Shift',
  'Jam Tugas': 'Jam_Tugas',
  'Usia': 'Tgl_Lahir',
  'Masa Khidmah': 'Mulai_Ngabdi'
};

  const field = fieldMap[column];
  if (!field) return;

  if (!lastFilteredData.length) lastFilteredData = [...allSantriData];
  
  const getValue = (obj, path) => {
	  return path.split('.').reduce((o, k) => (o ? o[k] : null), obj);
	};


  lastFilteredData.sort((a, b) => {
    const rawA = getValue(a, field);
	const rawB = getValue(b, field);


    if (field === 'Kelas') {
      const idxA = kelasOrder.indexOf(rawA) === -1 ? 999 : kelasOrder.indexOf(rawA);
      const idxB = kelasOrder.indexOf(rawB) === -1 ? 999 : kelasOrder.indexOf(rawB);
      return sortDirection === 'asc' ? idxA - idxB : idxB - idxA;
    }
	
	if (field === 'Tgl_Lahir') {
	  const dateA = rawA ? new Date(rawA) : null;
	  const dateB = rawB ? new Date(rawB) : null;
	  // monthsSince(born) => jumlah bulan sejak lahir (lebih besar = lebih tua)
	  const monthsA = (dateA && !isNaN(dateA)) ? monthsSince(dateA) : null;
	  const monthsB = (dateB && !isNaN(dateB)) ? monthsSince(dateB) : null;

	  if (monthsA === null && monthsB === null) return 0;
	  if (monthsA === null) return sortDirection === 'asc' ? -1 : 1;
	  if (monthsB === null) return sortDirection === 'asc' ? 1 : -1;

	  // ascending = dari yang paling muda (nilai bulan kecil) ke paling tua (nilai besar)
	  return sortDirection === 'asc' ? monthsA - monthsB : monthsB - monthsA;
	}


    if (field === 'Mulai_Ngabdi') {
      const dateA = rawA ? new Date(rawA) : null;
      const dateB = rawB ? new Date(rawB) : null;
      const monthsA = (dateA && !isNaN(dateA)) ? monthsSince(dateA) : null;
      const monthsB = (dateB && !isNaN(dateB)) ? monthsSince(dateB) : null;

      if (monthsA === null && monthsB === null) return 0;
      if (monthsA === null) return sortDirection === 'asc' ? -1 : 1;
      if (monthsB === null) return sortDirection === 'asc' ? 1 : -1;

      return sortDirection === 'asc' ? monthsA - monthsB : monthsB - monthsA;
    }

    const valA = (rawA ?? '').toString().toLowerCase();
    const valB = (rawB ?? '').toString().toLowerCase();
    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  renderFullTable(lastFilteredData);

  // update indikator panah
  document.querySelectorAll('th.sortable').forEach(th => {
    th.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
  });
  const activeTh = document.querySelector(`th.sortable[data-column="${column}"]`);
  if (activeTh) {
    activeTh.classList.add('sorted');
    activeTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
  }
}


// Ambil data terakhir yang sudah difilter + diurutkan
// ========== HELPER EXPORT DATA ==========
function getExportData() {
  // Ambil dataset hasil filter terakhir kalau ada
  let exportData = (typeof lastFilteredData !== "undefined" && lastFilteredData.length)
    ? lastFilteredData
    : allSantriData;

  // Filter hanya santri aktif
  return exportData.filter(s => s.Status && s.Status.toLowerCase() === "aktif");
}


// ========== SANTRI TABLE FUNCTIONS ==========
async function renderFullTable(data, page = 1) {
  showLoading(true); // ðŸ”¹ tampilkan loader
  try {
    const container = document.getElementById('santri-table-container');
    container.innerHTML = '';

    const activeData = data.filter(s => s.Status && s.Status.toLowerCase() === 'aktif');
    const totalRecords = activeData.length;
    const totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
    const start = (page - 1) * pageSize;
    const end = Math.min(start + pageSize, totalRecords);
    const paginatedData = activeData.slice(start, end);

    const table = document.createElement('table');
    table.className = 'data-table';

    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = [
      'No','Foto','Nama','Kelas','Bagian',
      'Asal Daerah','Himpunan','Kamar','Unit Ndalem',
      'Posisi Tugas','Shift','Jam Tugas','Usia','Masa Khidmah','Tempat Ngaji','Kelas Ngaji'
    ];
    if (userRole === "admin") headers.push("Aksi");

    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.classList.add('sortable');
      th.dataset.column = h;
      if (h === 'Nama') th.classList.add('nama'); // âœ… sticky Nama
      if (h !== 'Aksi') th.onclick = () => sortTableBy(h);

      const indicator = document.createElement('span');
      indicator.className = 'sort-indicator';
      th.appendChild(indicator);
      headerRow.appendChild(th);
    });

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    paginatedData.forEach((santri, idx) => {
      const tr = document.createElement('tr');
      const imgUrl = santri.Foto || 'https://i.imgur.com/WyCoOTv.png';

      tr.innerHTML = `
        <td>${start + idx + 1}</td>
        <td><img src="${imgUrl}" alt="${santri.Nama_Lengkap || 'Santri'}"></td>
        <td class="nama">${santri.Nama_Lengkap || '-'}</td>
        <td>${santri.Kelas || '-'}</td>
        <td>${santri.Bagian || '-'}</td>
        <td>${santri.Asal_Daerah || '-'}</td>
        <td>${santri.Himpunan || '-'}</td>
        <td>${santri.Kamar || '-'}</td>
        <td>${santri.Unit_Ndalem || '-'}</td>
        <td>${santri.Posisi_Tugas || '-'}</td>
        <td>${santri.Shift || '-'}</td>
        <td>${santri.Jam_Tugas || '-'}</td>
		<td>${calculateUsia(santri.Tgl_Lahir)}</td>
        <td>${calculateMasaKhidmah(santri.Mulai_Ngabdi)}</td>
		<td>${santri.ngaji?.tempat_ngaji || '-'}</td>
		<td>${santri.ngaji?.Kelas_ngaji || '-'}</td>
      `;

      if (userRole === "admin") {
        const td = document.createElement("td");
        td.innerHTML = `
          <button onclick="openEditSantri(${santri.id})">âœï¸ Edit</button>
         
        `;
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    container.appendChild(table);

    document.getElementById('paginationInfo').textContent =
      totalRecords === 0 ? 'Menampilkan 0 data' :
      `Menampilkan ${start + 1} - ${end} dari ${totalRecords} data`;

    updatePaginationControls(totalPages, page, activeData);
  } catch (err) {
    console.error("Gagal render tabel santri:", err);
  } finally {
    showLoading(false); // ðŸ”¹ pastikan loader dimatikan
  }
}


	
	function updatePaginationControls(totalPages, currentPage, data) {
  const paginationControls = document.getElementById('paginationControls');
  paginationControls.innerHTML = '';

  if (totalPages <= 1) return;

  // Prev button
  if (currentPage > 1) {
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Sebelumnya';
    prevBtn.onclick = () => renderFullTable(data, currentPage - 1);
    paginationControls.appendChild(prevBtn);
  }

  // Page numbers (max 5 tampil)
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }

  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    if (i === currentPage) pageBtn.classList.add('active');
    pageBtn.onclick = () => renderFullTable(data, i);
    paginationControls.appendChild(pageBtn);
  }

  // Next button
  if (currentPage < totalPages) {
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Berikutnya';
    nextBtn.onclick = () => renderFullTable(data, currentPage + 1);
    paginationControls.appendChild(nextBtn);
  }
}

function populateAbsensiDropdowns() {
  const kelasDropdown = document.getElementById('absensiSearchKelas');
  const unitDropdown  = document.getElementById('absensiSearchUnit');
  const bulanDropdown = document.getElementById('absensiSearchBulan');
  if (!kelasDropdown || !unitDropdown || !bulanDropdown) return;

  // =================== KELAS ===================
  const kelasSet = new Set();
  (allSantriData || []).forEach(s => { if (s.Kelas) kelasSet.add(s.Kelas); });
  const sortedKelas = Array.from(kelasSet).sort((a, b) => {
    const ia = kelasOrder.indexOf(a);
    const ib = kelasOrder.indexOf(b);
    return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
  });

  const prevKelas = kelasDropdown.value || 'semua';
  kelasDropdown.innerHTML = '<option value="semua">Semua Kelas</option>';
  sortedKelas.forEach(k => {
    const count = allSantriData.filter(s => s.Kelas === k).length;
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = `${k} (${count})`;
    kelasDropdown.appendChild(opt);
  });
  if (Array.from(kelasDropdown.options).some(o => o.value === prevKelas)) {
    kelasDropdown.value = prevKelas;
  }

  // =================== UNIT ===================
  const unitSet = new Set();
  (allSantriData || []).forEach(s => { if (s.Unit_Ndalem) unitSet.add(s.Unit_Ndalem); });
  const sortedUnits = Array.from(unitSet).sort();

  const prevUnit = unitDropdown.value || 'semua';
  unitDropdown.innerHTML = '<option value="semua">Semua Unit</option>';
  sortedUnits.forEach(u => {
    const count = allSantriData.filter(s => s.Unit_Ndalem === u).length;
    const opt = document.createElement('option');
    opt.value = u;
    opt.textContent = `${u} (${count})`;
    unitDropdown.appendChild(opt);
  });
  if (Array.from(unitDropdown.options).some(o => o.value === prevUnit)) {
    unitDropdown.value = prevUnit;
  }

  // =================== BULAN ===================
  // gunakan bulan master jika ada (tidak boleh dipangkas oleh mode merah)
  const prevSelected = bulanDropdown.value || 'semua';
  if (document.activeElement === bulanDropdown) return; // jika sedang memilih, biarkan agar tidak tertutup

  const sumberBulan = Array.isArray(window.absensiBulanMaster) && window.absensiBulanMaster.length
    ? Array.from(window.absensiBulanMaster)
    : Array.from(bulanAbsensi);

  // urutkan mengikuti master bulanAbsensi
  const orderedBulan = bulanAbsensi.filter(b => sumberBulan.includes(b));

  // jika prevSelected tidak ada pada ordered, tambahkan supaya tetap terlihat
  if (prevSelected !== 'semua' && !orderedBulan.includes(prevSelected)) {
    orderedBulan.unshift(prevSelected);
  }

  bulanDropdown.innerHTML = '<option value="semua">Semua Bulan</option>';
  orderedBulan.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b;
    opt.textContent = b;
    bulanDropdown.appendChild(opt);
  });

  if (Array.from(bulanDropdown.options).some(o => o.value === prevSelected)) {
    bulanDropdown.value = prevSelected;
  } else {
    bulanDropdown.value = 'semua';
  }
}

async function fetchAbsensiForStambuks(stambukList = []) {
  if (!Array.isArray(stambukList) || stambukList.length === 0) return {};
  try {
    const { data, error } = await supabaseClient
      .from('absensi1')
      .select('stambuk, bulan, tahun_ajaran, sakit, izin, tanpa_izin')
      .in('stambuk', stambukList)
      .order('tahun_ajaran', { ascending: true })
      .order('bulan', { ascending: true });

    if (error) {
      console.error('fetchAbsensiForStambuks error', error);
      return {};
    }

    const dict = {};
    const bulanSet = new Set();
    for (const rec of (data || [])) {
      const key = String(rec.stambuk ?? '').trim();
      if (!key) continue;
      if (!dict[key]) dict[key] = [];
      dict[key].push({
        bulan: rec.bulan ?? '-',
        tahun_ajaran: rec.tahun_ajaran ?? '-',
        sakit: Number(rec.sakit ?? 0),
        izin: Number(rec.izin ?? 0),
        tanpaIzin: Number(rec.tanpa_izin ?? 0)
      });
      if (rec.bulan) bulanSet.add(rec.bulan);
    }
    // Simpan bulan unik ke global master (union, jangan pangkas)
    window.absensiBulanMaster = Array.from(new Set([...(window.absensiBulanMaster || []), ...Array.from(bulanSet)]));
    return dict;
  } catch (err) {
    console.error('fetchAbsensiForStambuks caught', err);
    return {};
  }
}

// === Event Listener Filter Absensi ===
document.addEventListener('DOMContentLoaded', () => {
  const namaInput   = document.getElementById('absensiSearchNama');
  const kelasSelect = document.getElementById('absensiSearchKelas');
  const unitSelect  = document.getElementById('absensiSearchUnit');
  const merahCheck  = document.getElementById('filterMerahCheckbox');
  const bulanSelect = document.getElementById('absensiSearchBulan'); // <-- tambah ini

  if (namaInput) {
    namaInput.addEventListener('input', () => loadAbsensiData(1));
  }
  if (kelasSelect) {
    kelasSelect.addEventListener('change', () => loadAbsensiData(1));
  }
  if (unitSelect) {
    unitSelect.addEventListener('change', () => loadAbsensiData(1));
  }
  if (merahCheck) {
    merahCheck.addEventListener('change', () => loadAbsensiData(1));
  }
  if (bulanSelect) {                     // <-- dan ini
    bulanSelect.addEventListener('change', () => loadAbsensiData(1));
  }
});


// helper: index bulan sesuai order client (fallback besar kalau tidak ditemui)
function bulanOrderIndex(bulan) {
  if (!bulan) return 999;
  if (Array.isArray(window.bulanAbsensi) && window.bulanAbsensi.length) {
    const idx = window.bulanAbsensi.indexOf(bulan);
    return idx === -1 ? 999 : idx;
  }
  return 999;
}

async function fetchAbsensiMerahRpc({ nama = null, kelas = null, unit = null, tahun_ajaran = null, limit_rows = 2000, offset_rows = 0 } = {}) {
  try {
    const params = {
      nama_filter: nama || null,
      kelas_filter: kelas || null,
      unit_filter: unit || null,
      tahun_ajaran_filter: tahun_ajaran || null,
      limit_rows,
      offset_rows
    };

    const { data, error } = await supabaseClient.rpc('get_absensi_merah', params);

    if (error) {
      console.error('fetchAbsensiMerahRpc RPC error', error);
      return {};
    }

    const dict = {};
    const bulanSet = new Set();
    for (const rec of (data || [])) {
      const rawStambuk = rec.stambuk ?? rec.Stambuk ?? '';
      const key = normStambuk(String(rawStambuk));
      if (!key) continue;

      if (!dict[key]) dict[key] = [];

      const bulanVal = rec.bulan ?? rec.Bulan ?? '-';
      const tahunVal = rec.tahun_ajaran ?? rec.tahunAjaran ?? rec.Tahun_Ajaran ?? '-';
      const tanpa = Number(rec.tanpa_izin ?? rec.tanpaIzin ?? 0);

      dict[key].push({
        bulan: bulanVal,
        tahun_ajaran: tahunVal,
        sakit: Number(rec.sakit ?? 0),
        izin: Number(rec.izin ?? 0),
        tanpaIzin: tanpa,
        bulan_index: Number(rec.bulan_index ?? bulanOrderIndex(bulanVal))
      });

      if (bulanVal) bulanSet.add(bulanVal);
    }

    // sort setiap list: tahun_ajaran asc, bulan_index asc
    Object.keys(dict).forEach(k => {
      dict[k].sort((a,b) => {
        if ((a.tahun_ajaran||'') !== (b.tahun_ajaran||'')) return (a.tahun_ajaran||'').localeCompare(b.tahun_ajaran||'');
        return (a.bulan_index || 999) - (b.bulan_index || 999);
      });
    });

    // update bulan master (union) â€” jangan mengganti dropdown langsung
    window.absensiBulanMaster = Array.from(new Set([...(window.absensiBulanMaster || []), ...Array.from(bulanSet)]));

    // jangan kurangi bulan aktif global di sini â€” opsi bulan tetap lengkap
    return dict;
  } catch (err) {
    console.error('fetchAbsensiMerahRpc caught', err);
    return {};
  }
}

async function loadAbsensiData(page = 1) {
  showLoading(true);
  try {
    absensiCurrentPage = page;
    const filterMerah   = !!document.getElementById('filterMerahCheckbox')?.checked;
    const searchRaw     = (document.getElementById('absensiSearchNama')?.value || '').trim();
    const searchTerm    = searchRaw.toLowerCase();
    const selectedKelas = (document.getElementById('absensiSearchKelas')?.value) || 'semua';
    const selectedUnit  = (document.getElementById('absensiSearchUnit')?.value) || 'semua';
    const selectedBulan = (document.getElementById('absensiSearchBulan')?.value) || 'semua';

    // ==============================
    // FILTER SANTRI AKTIF
    // ==============================
    let filtered = (allSantriData || []).filter(s => {
      if (!s.Status || String(s.Status).toLowerCase() !== 'aktif') return false;
      const namaMatch  = (s.Nama_Lengkap || '').toLowerCase().includes(searchTerm);
      const kelasMatch = selectedKelas === 'semua' || s.Kelas === selectedKelas;
      const unitMatch  = selectedUnit === 'semua' || s.Unit_Ndalem === selectedUnit;
      return namaMatch && kelasMatch && unitMatch;
    });

    // urutkan kelas berdasarkan urutan di kelasOrder
    filtered.sort((a, b) => {
      const ia = kelasOrder.indexOf(a.Kelas);
      const ib = kelasOrder.indexOf(b.Kelas);
      if (ia === -1 && ib === -1) return (a.Kelas || '').localeCompare(b.Kelas || '');
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    });

    // ==============================
    // MODE MERAH
    // ==============================
    let santriToRender = filtered;
    let absensiDict = {};

    if (filterMerah) {
      absensiDict = await fetchAbsensiMerahRpc({
        nama: searchRaw || null,
        kelas: selectedKelas === 'semua' ? null : selectedKelas,
        unit: selectedUnit === 'semua' ? null : selectedUnit,
        tahun_ajaran: null,
        limit_rows: 5000,
        offset_rows: 0
      });

      // Jika user memilih bulan spesifik, hanya tampilkan data merah untuk bulan itu.
      // Namun dropdown bulan TETAP menampilkan semua bulan master (tidak dipangkas).
      if (selectedBulan !== 'semua') {
        // filter absensiDict agar hanya berisi records pada bulan yang dipilih dan tanpaIzin tinggi
        const filteredDict = {};
        Object.entries(absensiDict).forEach(([stambuk, records]) => {
          const bulanMatch = records.filter(r => r.bulan === selectedBulan && r.tanpaIzin >= 3);
          if (bulanMatch.length) filteredDict[stambuk] = bulanMatch;
        });
        absensiDict = filteredDict;
      }

      // simpan dict merah di global (untuk export / referensi)
      window.absensiDictMerah = absensiDict;

      // santri yang punya merah
      const redStambuks = new Set(Object.keys(absensiDict || {}).map(k => normStambuk(k)));
      santriToRender = filtered.filter(s => redStambuks.has(normStambuk(s.Stambuk)));

      const totalRecords = santriToRender.length;
      const totalPages = Math.max(1, Math.ceil(totalRecords / ABSENSI_PAGE_SIZE));
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      const start = (page - 1) * ABSENSI_PAGE_SIZE;
      const santriPage = santriToRender.slice(start, start + ABSENSI_PAGE_SIZE);

      renderAbsensiTablePage(santriPage, page, ABSENSI_PAGE_SIZE, absensiDict, totalPages, totalRecords);
    }
    // ==============================
    // MODE NORMAL
    // ==============================
    else {
      const totalRecords = filtered.length;
      const totalPages = Math.max(1, Math.ceil(totalRecords / ABSENSI_PAGE_SIZE));
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      const start = (page - 1) * ABSENSI_PAGE_SIZE;
      const santriPage = filtered.slice(start, start + ABSENSI_PAGE_SIZE);

      const stambukList = santriPage.map(s => normStambuk(s.Stambuk)).filter(x => x);
      absensiDict = await fetchAbsensiForStambuks(stambukList);

      // filter berdasarkan bulan jika dipilih
      if (selectedBulan !== 'semua') {
        Object.keys(absensiDict).forEach(k => {
          absensiDict[k] = (absensiDict[k] || []).filter(r => r.bulan === selectedBulan);
          if (!absensiDict[k].length) delete absensiDict[k];
        });
      }

      // jangan pangkas dropdown bulan di sini â€” populateAbsensiDropdowns akan menggunakan bulan master
      window.absensiDictMerah = null; // kosongkan mode merah
      populateAbsensiDropdowns(); // pastikan dropdown diperbarui (tetap lengkap)
      renderAbsensiTablePage(santriPage, page, ABSENSI_PAGE_SIZE, absensiDict, totalPages, totalRecords);
    }
  } catch (err) {
    console.error("Gagal load absensi:", err);
  } finally {
    showLoading(false);
  }
}


// ==========================================
// fetchLaporanMerah: ambil laporan merah sesuai bulan filter
// ==========================================
async function fetchLaporanMerah(stambuk) {
  try {
    const selectedBulan = (document.getElementById('absensiSearchBulan')?.value) || 'semua';

    let query = supabaseClient
      .from('absensi_merah_laporan')
      .select('bulan, alasan, penanganan')
      .eq('stambuk', stambuk);

    // ðŸ”¹ jika dropdown bulan dipilih, filter juga di query
    if (selectedBulan !== 'semua') {
      query = query.eq('bulan', selectedBulan);
    }

    const { data, error } = await query;
    if (error) throw error;

    console.log("Laporan untuk", stambuk, "bulan:", selectedBulan, data);
    return data || [];
  } catch (err) {
    console.error('fetchLaporanMerah error', err);
    return [];
  }
}

// ==========================================
// renderAbsensiTablePage (bagian laporan diperbaiki)
// ==========================================
function renderAbsensiTablePage(
  santriList = [],
  page = 1,
  pageSize = 20,
  absensiDict = {},
  totalPages = 1,
  totalRecords = null
) {
  const container = document.getElementById('absensi-container');
  const paginationTarget = document.getElementById('absensiPaginationControls');
  if (!container) return;
  container.innerHTML = '';
  if (paginationTarget) paginationTarget.innerHTML = '';

  if (!santriList.length) {
    container.innerHTML = `<div style="text-align:center; padding:18px;">Tidak ada data santri</div>`;
    if (paginationTarget) {
      paginationTarget.innerHTML = `<div style="text-align:center; padding:8px;">Halaman ${page} dari ${totalPages}</div>`;
    }
    return;
  }

  const placeholderImg = "https://i.imgur.com/WyCoOTv.png";

  for (let i = 0; i < santriList.length; i++) {
    const santri = santriList[i];
    const stambuk = normStambuk(santri.Stambuk);
    let absensi = absensiDict[stambuk] || [];
    const absensiMap = {};
    absensi.forEach(a => absensiMap[a.bulan] = a);

    const bulanAktif = bulanAbsensi.filter(b => Object.keys(absensiMap).includes(b));

    const absensiHtml = bulanAktif.length
      ? bulanAktif.map((bulan, idx) => {
          const a = absensiMap[bulan] || { sakit: 0, izin: 0, tanpaIzin: 0 };
          return `
            <tr>              
              <td style="text-align:left;">${bulan}</td>
              <td>${a.sakit}</td>
              <td>${a.izin}</td>
              <td class="${a.tanpaIzin >= 3 ? 'merah' : ''}">${a.tanpaIzin}</td>
            </tr>
          `;
        }).join('')
      : '<tr><td colspan="5">Belum ada data absensi</td></tr>';

    const realImg = santri.Foto || placeholderImg;

    const box = document.createElement('div');
    box.className = 'santri-box';
    box.innerHTML = `
      <!-- Identitas Santri -->
      <table style="width:100%; margin-bottom:5px; border-collapse:collapse; text-align:center; border:1px solid #cce0ff;">
        <thead>
          <tr>
            <th style="border:1px solid #cce0ff;">No</th>
            <th style="border:1px solid #cce0ff;">Foto</th>
            <th style="border:1px solid #cce0ff;">Nama</th>
            <th style="border:1px solid #cce0ff;">Kls</th>
            <th style="border:1px solid #cce0ff;">Bag</th>
            <th style="border:1px solid #cce0ff;">Unit</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${(page - 1) * pageSize + i + 1}</td>
            <td>
              <img 
                src="${placeholderImg}" 
                data-src="${realImg}" 
                style="width:55px; height:70px; object-fit:cover; border:1px solid #cce0ff; border-radius:4px; display:block; margin:auto;"
                class="lazy-absensi-foto"
              >
            </td>
            <td style="text-align:left;">${santri.Nama_Lengkap ?? '-'}</td>
            <td>${santri.Kelas ?? '-'}</td>
            <td>${santri.Bagian ?? '-'}</td>
            <td>${santri.Unit_Ndalem ?? '-'}</td>
          </tr>
        </tbody>
      </table>

      <!-- Absensi -->
      <table style="width:100%; border-collapse:collapse; text-align:center; border:1px solid #cce0ff;">
        <thead>
          <tr>			
            <th style="border:1px solid #cce0ff;">Bulan</th>
            <th style="border:1px solid #cce0ff;">Sakit</th>
            <th style="border:1px solid #cce0ff;">Izin</th>
            <th style="border:1px solid #cce0ff;">Tanpa Izin</th>
          </tr>
        </thead>
        <tbody>${absensiHtml}</tbody>
      </table>
    `;


    // --- ðŸ”¹ Laporan merah sesuai filter bulan aktif ---
   fetchLaporanMerah(stambuk).then((laporan) => {
      if (laporan.length) {
        const laporanDiv = document.createElement('div');
        // kirim stambuk agar tombol Edit menerima nilai yang benar
        laporanDiv.innerHTML = renderLaporanTable(laporan, stambuk);
        box.appendChild(laporanDiv);
        // container khusus agar kita bisa update setelah edit
        laporanDiv.className = 'laporan-container';
        laporanDiv.dataset.stambuk = stambuk;
        laporanDiv.innerHTML = renderLaporanTable(laporan, stambuk);
        // pasang listener tombol Edit (hindari inline onclick agar kutipan tidak rusak)
        attachEditLaporanListeners(laporanDiv);
        box.appendChild(laporanDiv);
      }
    });



    container.appendChild(box);

    // ðŸ”¹ Lazy-load foto asli
    const imgEl = box.querySelector(".lazy-absensi-foto");
    const realSrc = imgEl.dataset.src;
    const tempImg = new Image();
    tempImg.onload = () => { imgEl.src = realSrc; };
    tempImg.onerror = () => { imgEl.src = placeholderImg; };
    tempImg.src = realSrc;
  }

  // --- Pagination ---
  if (paginationTarget) {
    paginationTarget.innerHTML = '';
    paginationTarget.className = 'pagination';

    const info = document.createElement('div');
    info.className = 'pagination-info';
    const totalRecordsCount = Number.isInteger(totalRecords)
      ? totalRecords
      : (allSantriData || []).filter(s => s.Status && String(s.Status).toLowerCase() === 'aktif').length;
    const startIdx = (page - 1) * pageSize + 1;
    const endIdx = Math.min(page * pageSize, totalRecordsCount);
    info.textContent = `Menampilkan ${startIdx} - ${endIdx} dari ${totalRecordsCount} data (Halaman ${page} dari ${totalPages})`;
    paginationTarget.appendChild(info);

    const controls = document.createElement('div');
    controls.className = 'pagination-controls';

    if (page > 1) {
      const prev = document.createElement('button');
      prev.textContent = 'â¬…ï¸ Sebelumnya';
      prev.onclick = () => loadAbsensiData(page - 1);
      controls.appendChild(prev);
    }

    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    for (let i = startPage; i <= endPage; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      if (i === page) btn.classList.add('active');
      btn.onclick = () => loadAbsensiData(i);
      controls.appendChild(btn);
    }

    if (page < totalPages) {
      const next = document.createElement('button');
      next.textContent = 'Berikutnya âž¡ï¸';
      next.onclick = () => loadAbsensiData(page + 1);
      controls.appendChild(next);
    }

    paginationTarget.appendChild(controls);
  }

  // CSS merah tetap
  if (!document.getElementById('absensi-merah-style')) {
    const style = document.createElement('style');
    style.id = 'absensi-merah-style';
    style.textContent = `
      .merah {
        background-color: #ffcccc !important;
        color: #cc0000 !important;
        font-weight: bold;
      }
    `;
    document.head.appendChild(style);
  }
}



// === Toggle Dropdown Menu Absensi ===
function toggleAbsensiDownloadMenu() {
  const menu = document.getElementById('absensiDownloadMenu');
  menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
}
function hideAbsensiDownloadMenu() {
  document.getElementById('absensiDownloadMenu').style.display = 'none';
}

// === Helper: Ambil filter aktif ===
function getAbsensiFilters() {  
  const kelas = document.getElementById("absensiSearchKelas").value || "semua";
  const unit = document.getElementById("absensiSearchUnit").value || "semua";
  const merah = document.getElementById("filterMerahCheckbox").checked ? "Absen Merah" : "Semua";
  const bulan = document.getElementById("absensiSearchBulan")?.value || "semua";
  return { kelas, unit, merah, bulan };
}


function wrapAbsensiContent(innerHTML) {
  // âœ… ambil semua filter termasuk bulan
  let { kelas, unit, merah, bulan } = getAbsensiFilters();
  const now = new Date().toLocaleString("id-ID");

  if (!kelas || kelas.toLowerCase() === "semua") kelas = "";
  if (!unit  || unit.toLowerCase() === "semua")  unit  = "";
  if (!merah || merah.toLowerCase() === "semua") merah = "";
  if (!bulan || bulan.toLowerCase() === "semua") bulan = "";

  const wrappedContent = innerHTML.replace(
    /<div class="santri-box">/g,
    '<div class="santri-box laporan-box">'
  );

  // âœ… bikin blok filterHTML secara berurutan
  let filterHTML = "";
  if (kelas || unit || merah || bulan) {
    filterHTML = `<div class="filters">`;
    if (kelas) filterHTML += `<p><b>Kelas:</b> ${kelas}</p>`;
    if (unit)  filterHTML += `<p><b>Unit:</b> ${unit}</p>`;
    if (bulan) filterHTML += `<p><b>Bulan:</b> ${bulan}</p>`;
    if (merah) filterHTML += `<p><b>Status:</b> ${merah}</p>`;
    filterHTML += `</div>`;
  }

  return `
  <!DOCTYPE html>
  <html lang="id">
  <head>
    <meta charset="UTF-8">
    <title>Laporan Absensi</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f9f9f9;
        font-size: 10px;
      }

      .container {
        width: 148mm;
        margin: 0 auto;
        padding: 10mm;
        background: #fff;
        box-sizing: border-box;
      }

      .kop { position: relative; margin-bottom:10px; }
      .kop img {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width:50px;
        height:auto;
      }
      .identitas { text-align:center; }
      .identitas h1 { margin:0; font-size:16px; color:#003366; }
      .identitas h2 { margin:0; font-size:12px; }
      .identitas p { margin:0; font-size:9px; font-style:italic; }
      hr { border:0; border-top:2px solid #000; margin:10px 0; }

      .header { text-align:center; margin:5px 0; }
      .header h1 { font-size:13px; margin:4px 0; }

      .filters { margin:8px 0; font-size:9px; }

      .laporan-box {
        border:1px solid #1a73e8;
        border-radius:6px;
        padding:6px;
        margin:8px 0;
        background:#fff;
      }

      table, .laporan-table {
        border-collapse: collapse;
        width: 100% !important;
        font-size: 10px;
        margin-top: 5px;
        margin-bottom: 5px;
      }

      thead th {
        background: #1a73e8;
        color: #fff;
        padding: 6px 8px;
        text-align: center;
        border: 1px solid #cce0ff;
      }

      td {
        border: 1px solid #cce0ff;
        padding: 4px;
        text-align: center;
      }

      td img {
        display: block;
        margin: auto;
        width: 26px;
        height: 34px;
        object-fit: cover;
        border: 1px solid #1a73e8;
      }

      .footer {
        text-align:right;
        margin-top:8px;
        font-size:8px;
        color:#555;
        font-style:italic;
      }

      .merah {
        background:#ffcccc !important;
        color:#b30000 !important;
        font-weight:bold !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="kop">
        <img src="https://i.imgur.com/Irgu32G.png" alt="Logo">
        <div class="identitas">
          <h1>KHUDAMA' KHARISMA</h1>
          <h2>Pondok Pesantren Lirboyo Kota Kediri Jawa Timur</h2>
          <p>Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri</p>
        </div>
      </div>
      <hr>

      <div class="header"><h1>LAPORAN ABSENSI</h1></div>
      ${filterHTML}

      ${wrappedContent}
      
	  <div class="footer">Admin â€“ Simponi Kharisma â€“ ${now}</div>
    </div>
  </body>
  </html>`;
}



// === Timestamp sesuai perangkat ===
function filterDateTimestamp() {
  const d = new Date();
  const YYYY = d.getFullYear();
  const MM = String(d.getMonth() + 1).padStart(2, "0");
  const DD = String(d.getDate()).padStart(2, "0");
  const hh = String(d.getHours()).padStart(2, "0");
  const mi = String(d.getMinutes()).padStart(2, "0");
  const ss = String(d.getSeconds()).padStart(2, "0");
  return `${YYYY}-${MM}-${DD}_${hh}-${mi}-${ss}`;
}

// === Nama file seragam untuk semua modul ===
function getExportFileName(prefix, ext, filters = {}) {
  const kelas = (filters.kelas || "").replace(/\s+/g, "_");
  const unit  = (filters.unit  || "").replace(/\s+/g, "_");
  const merah = (filters.merah || "").replace(/\s+/g, "_");
  const tahun = (filters.tahun || "").replace(/\s+/g, "_");
  const semes = (filters.semester || "").replace(/\s+/g, "_");

  let parts = [prefix];
  if (kelas && kelas.toLowerCase() !== "semua") parts.push(kelas);
  if (unit  && unit.toLowerCase() !== "semua") parts.push(unit);
  if (merah && merah.toLowerCase() !== "semua") parts.push(merah);
  if (tahun && tahun.toLowerCase() !== "semua") parts.push(tahun);
  if (semes && semes.toLowerCase() !== "semua") parts.push(semes);

  parts.push(filterDateTimestamp());
  return parts.join("_") + "." + ext;
}



function renderLaporanTable(laporan = [], stambuk = '', isExport = false) {
  if (!Array.isArray(laporan) || laporan.length === 0) return '';
  const isAdmin = (localStorage.getItem('userRole') === 'admin');

  // Jika sedang export (PDF/HTML/PNG), sembunyikan kolom Aksi
  const showAksi = isAdmin && !isExport;

  return `
    <table style="width:100%; border-collapse:collapse; margin-top:8px; border:1px solid #cce0ff;">
      <thead style="background:#e3f0ff;">
        <tr>
          <th style="border:1px solid #cce0ff; padding:6px;">Bulan</th>
          <th style="border:1px solid #cce0ff; padding:6px;">Alasan</th>
          <th style="border:1px solid #cce0ff; padding:6px;">Penanganan</th>
          ${showAksi ? '<th style="border:1px solid #cce0ff; padding:6px;">Aksi</th>' : ''}
        </tr>
      </thead>
      <tbody>
        ${laporan.map(r => `
          <tr>
            <td style="border:1px solid #cce0ff; padding:6px;">${r.bulan}</td>
            <td style="border:1px solid #cce0ff; padding:6px; text-align:left;">${r.alasan || '-'}</td>
            <td style="border:1px solid #cce0ff; padding:6px; text-align:left;">${r.penanganan || '-'}</td>
            ${
              showAksi
                ? `<td style="border:1px solid #cce0ff; text-align:center;">
                    <button
                      class="edit-laporan-btn"
                      data-id="${r.id ?? ''}"
                      data-stambuk="${String(stambuk).replace(/"/g, '&quot;')}"
                      data-bulan="${String(r.bulan || '').replace(/"/g, '&quot;')}"
                      style="padding:4px 8px; border-radius:6px; border:none; cursor:pointer;"
                    >âœï¸ Edit</button>
                   </td>`
                : ''
            }
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}


// ===============================
// Fungsi utama render absensi HTML
// ===============================
async function renderAllAbsensiHTML() {
  const santriList = getAllFilteredAbsensiSantri();

  // Urutkan dari kelas terendah ke tertinggi
  santriList.sort((a, b) => {
    const ia = kelasOrder.indexOf(a.Kelas);
    const ib = kelasOrder.indexOf(b.Kelas);
    if (ia === -1 && ib === -1) return (a.Kelas || '').localeCompare(b.Kelas || '');
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });

  // Ambil absensiDict untuk semua stambuk
  let absensiDict = {};
  const stambukList = santriList.map(s => normStambuk(s["Stambuk"])).filter(x => x);
  const filterMerah = !!document.getElementById('filterMerahCheckbox')?.checked;
  if (filterMerah && window.absensiDictMerah) {
    absensiDict = window.absensiDictMerah || {};
  } else {
    absensiDict = await fetchAbsensiForStambuks(stambukList);
  }

  let html = '';
  for (let i = 0; i < santriList.length; i++) {
    const santri = santriList[i];
    const stambuk = normStambuk(santri["Stambuk"]); // casing disamakan
    const absensi = absensiDict[stambuk] || [];
    const absensiMap = {};
    absensi.forEach(a => absensiMap[a.bulan] = a);

    const bulanAktif = bulanAbsensi.filter(b => Object.keys(absensiMap).includes(b));
    const absensiHtml = bulanAktif.length
      ? bulanAktif.map(bulan => {
          const a = absensiMap[bulan] || { sakit: 0, izin: 0, tanpaIzin: 0 };
          return `
            <tr>
              <td style="text-align:left; border:1px solid #cce0ff; padding:6px;">${bulan}</td>
              <td style="border:1px solid #cce0ff; padding:6px;">${a.sakit}</td>
              <td style="border:1px solid #cce0ff; padding:6px;">${a.izin}</td>
              <td style="border:1px solid #cce0ff; padding:6px;" class="${a.tanpaIzin >= 3 ? 'merah' : ''}">${a.tanpaIzin}</td>
            </tr>
          `;
        }).join('')
      : '<tr><td colspan="4" style="border:1px solid #cce0ff; padding:6px;">Belum ada data absensi</td></tr>';

    const realImg = santri.Foto || "https://i.imgur.com/WyCoOTv.png";

    // === Laporan Merah ===
    let laporanHtml = '';
    const laporan = await fetchLaporanMerah(stambuk);
    if (laporan && laporan.length) {
      laporanHtml = renderLaporanTable(laporan, stambuk, true); // true = mode export, sembunyikan kolom aksi
    }

    html += `
      <div class="santri-box laporan-box" style="margin:0 auto 20px;">
        <table style="width:100%; margin-bottom:5px; border-collapse:collapse; text-align:center; border:1px solid #cce0ff;">
          <thead style="background:#e3f0ff;">
            <tr>
              <th>No</th><th>Foto</th><th>Nama</th><th>Kls</th><th>Bag</th><th>Unit</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${i + 1}</td>
              <td><img src="${realImg}" style="width:55px; height:70px; object-fit:cover; border:1px solid #cce0ff; border-radius:4px; display:block; margin:auto;"></td>
              <td style="text-align:left;">${santri.Nama_Lengkap ?? '-'}</td>
              <td>${santri.Kelas ?? '-'}</td>
              <td>${santri.Bagian ?? '-'}</td>
              <td>${santri.Unit_Ndalem ?? '-'}</td>
            </tr>
          </tbody>
        </table>

        <table style="width:100%; border-collapse:collapse; text-align:center; border:1px solid #cce0ff;">
          <thead style="background:#e3f0ff;">
            <tr><th>Bulan</th><th>Sakit</th><th>Izin</th><th>Tanpa Izin</th></tr>
          </thead>
          <tbody>${absensiHtml}</tbody>
        </table>

        ${laporanHtml}
      </div>
    `;
  }

  return html;
}

// ===============================
// Modal edit laporan
// ===============================

async function openEditLaporanModal(id, stambuk, bulan) {
  if (!stambuk || !bulan) {
    alert("Data tidak valid: stambuk/bulan kosong.");
    return;
  }

  // pastikan konsisten lower-case untuk tabel laporan_absensi
  stambuk = normStambuk(stambuk);

  // Pastikan data laporan ada
  let { data: existing } = await supabaseClient
    .from("laporan_absensi")
    .select("id, alasan, penanganan")
    .eq("stambuk", stambuk)
    .eq("bulan", bulan)
    .limit(1)
    .maybeSingle();

  // Jika belum ada, buat otomatis
  if (!existing) {
    const { data: inserted, error: insertErr } = await supabaseClient
      .from("laporan_absensi")
      .insert([{ stambuk, bulan }])
      .select()
      .maybeSingle();

    if (insertErr) {
      console.error("Gagal membuat laporan baru:", insertErr);
      alert("Gagal membuat laporan baru di database.");
      return;
    }
    existing = inserted;
  }

  const alasan = existing?.alasan || "";
  const penanganan = existing?.penanganan || "";

  const modal = document.createElement("div");
  modal.className = "modal-overlay";
  modal.innerHTML = `
    <div class="modal-content" style="background:white; padding:20px; border-radius:10px; max-width:400px; margin:auto;">
      <h3>Edit Laporan Pelanggaran</h3>
      <p><b>Stambuk:</b> ${stambuk}</p>
      <p><b>Bulan:</b> ${bulan}</p>
      <label>Alasan:</label><br>
      <textarea id="editAlasan" style="width:100%; height:60px;">${alasan}</textarea><br>
      <label>Penanganan:</label><br>
      <textarea id="editPenanganan" style="width:100%; height:60px;">${penanganan}</textarea><br><br>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="saveEditLaporanBtn" style="padding:6px 12px;">ðŸ’¾ Simpan</button>
        <button id="cancelEditLaporanBtn" style="padding:6px 12px;">âŒ Batal</button>
      </div>
    </div>
  `;
  Object.assign(modal.style, {
    position: "fixed",
    inset: 0,
    background: "rgba(0,0,0,0.4)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: 9999,
  });
  document.body.appendChild(modal);

  // pasang listener dengan argumen terikat â€” menghindari masalah escape/kuote
  modal.querySelector('#saveEditLaporanBtn')?.addEventListener('click', () => updateLaporan(stambuk, bulan));
  modal.querySelector('#cancelEditLaporanBtn')?.addEventListener('click', () => modal.remove());
}

async function updateLaporan(stambuk, bulan) {
  const alasan = document.getElementById("editAlasan").value.trim();
  const penanganan = document.getElementById("editPenanganan").value.trim();

  if (!stambuk || !bulan) return alert("Data tidak valid (stambuk/bulan kosong).");

  const { error } = await supabaseClient
    .from("laporan_absensi")
    .upsert([{ stambuk, bulan, alasan, penanganan }], { onConflict: ['stambuk', 'bulan'] });

  if (error) {
    console.error("updateLaporan error:", error);
    alert("âŒ Gagal menyimpan laporan: " + error.message);
  } else {
    alert("âœ… Laporan berhasil diperbarui!");
    document.querySelector(".modal-overlay")?.remove();

    // ambil data terbaru untuk stambuk ini dan update semua container terkait di DOM
    try {
      const fresh = await fetchLaporanMerah(stambuk);
      document.querySelectorAll(`.laporan-container[data-stambuk="${stambuk}"]`).forEach(el => {
        el.innerHTML = renderLaporanTable(fresh, stambuk);
        attachEditLaporanListeners(el);
      });
    } catch (e) {
      console.warn("Gagal refresh view laporan lokal:", e);
      // fallback: reload seluruh view absensi
      await loadAbsensiData?.();
    }

    await refreshAbsensiView?.();
  }
}

// Pasang listener untuk tombol Edit laporan (dipanggil setiap kali HTML laporan disisipkan)
function attachEditLaporanListeners(root = document) {
  const container = (root instanceof Element) ? root : document;
  container.querySelectorAll('.edit-laporan-btn').forEach(btn => {
    // pastikan tidak menambahkan listener ganda â€” gunakan onclick (menimpa handler sebelumnya)
    btn.onclick = (e) => {
      const id = btn.dataset.id || '';
      const st = btn.dataset.stambuk || '';
      const bl = btn.dataset.bulan || '';
      openEditLaporanModal(id, st, bl);
    };
  });
}

function getAllFilteredAbsensiSantri() {
  const filterMerah   = !!document.getElementById('filterMerahCheckbox')?.checked;
  const searchRaw     = (document.getElementById('absensiSearchNama')?.value || '').trim();
  const searchTerm    = searchRaw.toLowerCase();
  const selectedKelas = (document.getElementById('absensiSearchKelas')?.value) || 'semua';
  const selectedUnit  = (document.getElementById('absensiSearchUnit')?.value) || 'semua';

  let filtered = (allSantriData || []).filter(s => {
    if (!s.Status || String(s.Status).toLowerCase() !== 'aktif') return false;
    const namaMatch  = (s.Nama_Lengkap || '').toLowerCase().includes(searchTerm);
    const kelasMatch = selectedKelas === 'semua' || s.Kelas === selectedKelas;
    const unitMatch  = selectedUnit === 'semua' || s.Unit_Ndalem === selectedUnit;
    return namaMatch && kelasMatch && unitMatch;
  });

  // Jika filter merah, hanya santri yang punya absen merah
  if (filterMerah && window.absensiDictMerah) {
    const redStambuks = new Set(Object.keys(window.absensiDictMerah || {}).map(normStambuk));
    filtered = filtered.filter(s => redStambuks.has(normStambuk(s.Stambuk)));
  }
  return filtered;
}

async function downloadAbsensiPDF() {
  try {  	
    const content = await renderAllAbsensiHTML();
    let html = wrapAbsensiContent(content);

    const container = document.createElement("div");
    container.innerHTML = html;
    document.body.appendChild(container);

    container.style.background = "#fff";
    container.style.display = "block";
    container.style.margin = "0 auto";
    container.style.width = "148mm";   // lebar fix A5
    container.style.maxWidth = "148mm";

    // Tunggu semua gambar selesai load
    await Promise.all(
      Array.from(container.querySelectorAll("img")).map(
        img =>
          new Promise(res => {
            if (img.complete && img.naturalHeight > 0) return res();
            img.onload = res;
            img.onerror = res;
          })
      )
    );

    // Render ke canvas dulu
    const canvas = await html2canvas(container, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL("image/jpeg", 1.0);

    // hitung ukuran gambar biar full A5 width
    const pdfWidth = 148; // mm
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width; // proporsional

    // buat PDF dengan ukuran custom: lebarnya 148mm, tingginya sesuai konten
    const pdf = new jspdf.jsPDF("p", "mm", [pdfWidth, pdfHeight]);
    pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);

    pdf.save(getExportFileName("Absensi", "pdf", getAbsensiFilters()));
    container.remove();
  } catch (err) {
    console.error("downloadAbsensiPDF error:", err);
    alert("âŒ Gagal membuat PDF, cek console log.");
  }
}


async function downloadAbsensiPNG() { 
  const content = await renderAllAbsensiHTML();
  let html = `<div class="absensi-print-container">${content}</div>`;
  html = wrapAbsensiContent(html);

  const container = document.createElement("div");
  container.innerHTML = html;
  document.body.appendChild(container);
  container.style.position = "absolute";
  container.style.left = "-9999px";
  container.style.background = "#fff";
  container.style.width = "100%";

  await Promise.all(
    Array.from(container.querySelectorAll("img")).map(img =>
      new Promise(res => {
        if (img.complete && img.naturalHeight > 0) return res();
        img.onload = res;
        img.onerror = res;
      })
    )
  );

  const canvas = await html2canvas(container, { scale: 3, useCORS: true });
  canvas.toBlob(blob => {
    // ðŸ”¹ pakai getExportFileName
    saveAs(blob, getExportFileName("Absensi", "png", getAbsensiFilters()));
    container.remove();
  }, "image/png");
}



// ========== UTILITY FUNCTIONS ==========
    function showLoading(show) {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      if (show) {
        loadingScreen.style.display = 'flex';
        loadingIndicator.style.display = 'block';
        setTimeout(() => {
          document.querySelector('#loadingIndicator .progress').style.width = '70%';
        }, 100);
      } else {
        loadingScreen.style.display = 'none';
        document.querySelector('#loadingIndicator .progress').style.width = '100%';
        setTimeout(() => {
          loadingIndicator.style.display = 'none';
          document.querySelector('#loadingIndicator .progress').style.width = '0%';
        }, 300);
      }
    }
    
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

/* ====== UTIL: CSS untuk table Inventaris & Pelanggaran ====== */
(function ensureSimpleTableStylesOnce() {
  if (document.getElementById('simple-table-styles')) return;
  const style = document.createElement('style');
  style.id = 'simple-table-styles';
  style.textContent = `
    .simple-table-container { 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch; 
      width: 100%;
    }

    .simple-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      table-layout: auto;   /* âœ… fleksibel, biar bisa wrap */
    }

    /* Header */
    /* ===== Sticky header untuk semua tabel NON-inventaris ===== */
	.simple-table:not(.inventaris-table) thead th {
	  position: sticky;
	  top: 0;
	  z-index: 1;
      background: #1a73e8;
      color: #fff;
      text-align: center;
    }

    .simple-table th,
    .simple-table td {
      border: 1px solid #e6e6e6;
      padding: .6rem .7rem;
      font-size: 13px;      
      vertical-align: middle;

      /* âœ… Kata tunggal tidak pecah, tapi frasa 2 kata bisa turun */
      white-space: normal;
      word-break: keep-all;
      overflow-wrap: break-word;
    }

    /* Hover effect */
    .simple-table tbody tr:hover {
      background: #f9f9f9;
    }

    /* Kolom pertama (No) kecil saja */
    .simple-table th:nth-child(1),
    .simple-table td:nth-child(1) {
      width: 50px;
      text-align: center;
    }
	
	/* Kolom Unit Ndalem sticky */
	.simple-table th:nth-child(2),
	.simple-table td:nth-child(2) {
	  position: sticky;
	  left: 0;
	  z-index: 2;
	  min-width: 140px;   /* biar nyaman dibaca */
	  background: #fff;   /* isi tabel putih */
	  text-align: left;
	}

	/* Header Unit Ndalem tetap biru */
	.simple-table thead th:nth-child(2) {
	  background: #1a73e8; 
	  text-align: center;
	  color: #fff;
	  z-index: 3;   /* lebih tinggi daripada body cell */
	}

	/* === Ringkasan Pelanggaran (desktop default) === */
	#pelanggaran-summary {
	  font-size: 15px;
	  font-weight: 500;
	  margin-bottom: 8px;
	}
	
	/* === Versi Android / layar kecil === */
	@media (max-width: 768px) {
	  #pelanggaran-summary {
	    font-size: 13px; /* ðŸ”¹ Lebih kecil di HP */
	    line-height: 1.4;
	  }
	}

	
    /* âœ… Tambahan: khusus layar kecil */
    @media (max-width: 768px) {
      .simple-table {
        min-width: 600px; /* biar tabel bisa digeser kalau penuh */
      }
    }
	/* ===== HANYA Inventaris yang bisa geser ===== */
	.inventaris-scroll {
	  width: 100%;
	  position: relative;
	}

	.inventaris-scroll-inner {
	  overflow-x: auto;
	  -webkit-overflow-scrolling: touch;
	}

	.inventaris-scroll table {
	  width: 100%;
	}

	/* ===== Sticky header KHUSUS inventaris (paling atas dari semua modul) ===== */
	.inventaris-table thead th {	  
	  background: #1a73e8;
	  color: #fff;
	}


	/* Layar kecil */
	@media (max-width: 768px) {
	  .inventaris-scroll-inner {
		overflow-x: auto;
	  }

	  .inventaris-scroll table {
		min-width: 900px;
	  }
	}
	
	

  `;
  document.head.appendChild(style);
})();

(function ensureInventarisSummaryStylesOnce() {
  if (document.getElementById('inventaris-summary-styles')) return;
  const style = document.createElement('style');
  style.id = 'inventaris-summary-styles';
  style.textContent = `
    #inventaris-summary {
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6;
    }
    #inventaris-summary strong {
      color: #1a73e8;
    }
  `;
  document.head.appendChild(style);
})();

(function ensurePelanggaranTableStylesOnce() {
  if (document.getElementById('pelanggaran-table-styles')) return;
  const style = document.createElement('style');
  style.id = 'pelanggaran-table-styles';
  style.textContent = `
    /* ===== Header tabel pelanggaran merah gradasi senada ===== */
    #pelanggaran-table thead th {
      background: linear-gradient(to bottom, #e53935, #c62828) !important;
      color: #fff !important;
      text-align: center;
    }

    /* ===== Kolom kedua (Jenis Pelaku) sticky ===== */
    #pelanggaran-table th:nth-child(2),
    #pelanggaran-table td:nth-child(2) {
      position: sticky;
      left: 0;
      z-index: 2;
      min-width: 140px;
      background: #fff; /* isi tetap putih */
      text-align: left;
    }

    /* Header kolom sticky tetap merah */
    #pelanggaran-table thead th:nth-child(2) {
      background: linear-gradient(to bottom, #e53935, #c62828) !important;
      color: #fff !important;
      z-index: 3;
    }
  `;
  document.head.appendChild(style);
})();


/* ====== HELPER UNTUK FORMAT TANGGAL ====== */
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d)) return '-';
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

let santriList = [];
let penasehatList = [];
let allUnitData = [];

// ====== MODAL ======
async function openAddPelanggaran() {
  showLoading(true);
  await loadReferensiUnit();
  await loadSantriList();
  await loadPenasehatList();
  document.getElementById('addPelanggaranModal').style.display = 'flex';
  showLoading(false);
}

function tutupModal() {
  document.getElementById('addPelanggaranModal').style.display = 'none';
}

function togglePelakuFields() {
  const jenis = document.getElementById('jenisPelaku').value;
  document.getElementById('santriField').style.display = jenis === 'santri' ? 'block' : 'none';
  document.getElementById('penasehatField').style.display = jenis === 'penasehat' ? 'block' : 'none';
}

// ====== LOAD DATA ======
async function loadSantriList() {
  if (santriList.length > 0) return;
  const { data, error } = await supabaseClient
    .from('santri_kharisma')
    .select('Stambuk, Nama_Lengkap, Unit_Ndalem')
    .order('Nama_Lengkap', { ascending: true });
  if (error) return console.error(error);

  santriList = data;
  const sel = document.getElementById('santriSelect');
  sel.innerHTML = '<option value="">-- Pilih Santri --</option>';
  data.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.Stambuk;
    opt.textContent = s.Nama_Lengkap;
    sel.appendChild(opt);
  });
}

async function loadPenasehatList() {
  if (penasehatList.length > 0) return;
  const { data, error } = await supabaseClient
    .from('penasehat')
    .select('id_penasehat, Nama, Kode_Unit')
    .order('Nama', { ascending: true });
  if (error) return console.error(error);

  penasehatList = data;
  const sel = document.getElementById('penasehatSelect');
  sel.innerHTML = '<option value="">-- Pilih Penasehat --</option>';
  data.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id_penasehat;
    opt.textContent = p.Nama;
    sel.appendChild(opt);
  });
}

async function loadReferensiUnit() {
  if (allUnitData.length > 0) return;
  const { data, error } = await supabaseClient
    .from('referensi_unit_ndalem')
    .select('Kode_Unit, Nama_Unit')
    .order('Nama_Unit', { ascending: true });
  if (error) return console.error(error);

  allUnitData = data;
}

// ====== GET KODE UNIT ======
function getKodeUnit() {
  const jenis = document.getElementById('jenisPelaku').value;
  if (jenis === 'santri') {
    const stambuk = document.getElementById('santriSelect').value;
    const s = santriList.find(x => x.Stambuk === stambuk);
    if (!s) return '';
    const ref = allUnitData.find(u => u.Nama_Unit === s.Unit_Ndalem);
    return ref ? ref.Kode_Unit : '';
  } else if (jenis === 'penasehat') {
    const sel = document.getElementById('penasehatSelect');
    const pen = penasehatList.find(p => p.id_penasehat === sel.value);
    return pen ? pen.Kode_Unit : '';
  }
  return '';
}

// ====== SIMPAN ======
async function simpanPelanggaran() {
  const jenis = document.getElementById('jenisPelaku').value;
  const tanggal = document.getElementById('tanggalPelanggaran').value;
  const pelanggaran = document.getElementById('isiPelanggaran').value.trim();
  const takziran = document.getElementById('isiTakziran').value.trim();
  const jenisTakziran = document.getElementById('jenisTakziran').value.trim();
  const kodeUnit = getKodeUnit();

  if (!jenis || !pelanggaran || !tanggal || !kodeUnit) {
    alert("Harap lengkapi semua field dan pastikan pelaku dipilih dengan benar!");
    return;
  }

  const insertData = {
    Tanggal: tanggal,
    Pelanggaran: pelanggaran,
	Takziran: isiTakziran,
    Jenis_Takziran: jenisTakziran,
    Kode_Unit: kodeUnit
  };

  if (jenis === 'santri') insertData.Stambuk = document.getElementById('santriSelect').value;
  else if (jenis === 'penasehat') insertData.Id_Penasehat = document.getElementById('penasehatSelect').value;

  const { error } = await supabaseClient.from('pelanggaran').insert([insertData]);
  if (error) {
    alert("âŒ Gagal menyimpan: " + error.message);
    console.error(error);
  } else {
    alert("âœ… Pelanggaran berhasil ditambahkan!");
    tutupModal();
    loadPelanggaran();
  }
}

async function loadPelanggaran() {
  showLoading(true);
  try {
    if (!allUnitData || allUnitData.length === 0) await loadReferensiUnit();

    const { data, error } = await supabaseClient
      .from('pelanggaran')
      .select(`
        id,
        Tanggal,
        Pelanggaran,
		Takziran,
        Jenis_Takziran,
        Kode_Unit,
        Stambuk,
        Id_Penasehat,
        santri:Stambuk (Nama_Lengkap, Unit_Ndalem),
        penasehat:Id_Penasehat (Nama)
      `)
      .order('Tanggal', { ascending: true });

    if (error) throw error;

    const mapped = (data || []).map(row => {
      let namaUnit = '-';
      const ref = allUnitData.find(u => u.Kode_Unit === row.Kode_Unit);
      if (ref) namaUnit = ref.Nama_Unit;
      else if (row.santri?.Unit_Ndalem) namaUnit = row.santri.Unit_Ndalem;

      return {
        id: row.id,
        Nama_Pelaku: row.santri?.Nama_Lengkap || row.penasehat?.Nama || '-',
        Jenis_Pelaku: row.santri ? 'Santri' : row.penasehat ? 'Penasehat' : '-',
        Unit: namaUnit,
		Takziran: row.Takziran || '-',
        Jenis_Takziran: row.Jenis_Takziran || '-',
        Tanggal: row.Tanggal,
        Pelanggaran: row.Pelanggaran || '-'
      };
    });

    const userRole = localStorage.getItem("userRole") || "user";

    const cols = [
      { key: 'Nama_Pelaku', label: 'Nama Lengkap' },
      { key: 'Jenis_Pelaku', label: 'Jenis Pelaku' },
      { key: 'Unit', label: 'Unit Ndalem' },
	  { key: 'Takziran', label: 'Takziran' },
      { key: 'Jenis_Takziran', label: 'Jenis Takziran' },
      { key: 'Tanggal', label: 'Tanggal', format: v => formatDate(v) },
      { key: 'Pelanggaran', label: 'Pelanggaran' }
    ];

    // ðŸ”¹ Tambahkan kolom aksi hanya untuk admin
    if (userRole === "admin") {
	  cols.push({
		key: "Aksi",
		label: "Aksi",
		format: (v, row) => {
		  const safeRow = encodeURIComponent(JSON.stringify(row));
		  return `
			<button class="crud-btn-save" onclick="handleEditPelanggaran(${row.id})">âœï¸</button>
			<button class="crud-btn-cancel" onclick="deletePelanggaran(${row.id})">ðŸ—‘ï¸</button>
		  `;
		}
	  });
	}
	
	// === Hitung Ringkasan Pelanggaran ===
	let ringan = 0, sedang = 0, berat = 0;
	mapped.forEach(r => {
	  const jenis = (r.Jenis_Takziran || '').toLowerCase();
	  if (jenis === 'ringan') ringan++;
	  else if (jenis === 'sedang') sedang++;
	  else if (jenis === 'berat') berat++;
	});

	const total = mapped.length;
	const summaryHTML = `
	  <b>Ringkasan Pelanggaran:</b><br>
	  Total Kasus: ${total} | 
	  <span>Ringan: ${ringan}</span> | 
	  <span>Sedang: ${sedang}</span> | 
	  <span>Berat: ${berat}</span>
	`;
	document.getElementById('pelanggaran-summary').innerHTML = summaryHTML;



    renderTable("pelanggaran-table", mapped, cols);

  } catch (err) {
    console.error("Gagal load pelanggaran:", err);
  } finally {
    showLoading(false);
  }
}

function handleEditPelanggaran(id) {
  console.log("DEBUG: buka edit pelanggaran ID =", id);
  if (!id) {
    showToast("ID pelanggaran tidak valid", true);
    return;
  }
  editPelanggaran(parseInt(id));
}


// Fungsi Edit
async function editPelanggaran(id) {
  const { data, error } = await supabaseClient
    .from('pelanggaran')
    .select(`
      id, Tanggal, Pelanggaran, Takziran, Jenis_Takziran, Kode_Unit, Stambuk, Id_Penasehat
    `)
    .eq('id', id)
    .single();

  if (error) return alert("âŒ Gagal load data untuk edit");

  // Prefill modal
  document.getElementById('isiTakziran').value = data.Takziran || '';
  document.getElementById('jenisTakziran').value = data.Jenis_Takziran || '';
  document.getElementById('tanggalPelanggaran').value = data.Tanggal || '';
  document.getElementById('isiPelanggaran').value = data.Pelanggaran || '';

  if (data.Stambuk) {
    document.getElementById('jenisPelaku').value = 'santri';
    togglePelakuFields();
    await loadSantriList();
    document.getElementById('santriSelect').value = data.Stambuk;
  } else if (data.Id_Penasehat) {
    document.getElementById('jenisPelaku').value = 'penasehat';
    togglePelakuFields();
    await loadPenasehatList();
    document.getElementById('penasehatSelect').value = data.Id_Penasehat;
  }

  // Tombol update
  const btn = document.querySelector('#addPelanggaranModal button');
  btn.textContent = 'ðŸ’¾ Update';
  btn.onclick = () => updatePelanggaran(id);

  document.getElementById('addPelanggaranModal').style.display = 'flex';
}

// Fungsi Update
async function updatePelanggaran(id) {
  const jenis = document.getElementById('jenisPelaku').value;
  const tanggal = document.getElementById('tanggalPelanggaran').value;
  const pelanggaran = document.getElementById('isiPelanggaran').value.trim();
  const takziran = document.getElementById('isiTakziran').value.trim();
  const jenisTakziran = document.getElementById('jenisTakziran').value.trim();
  const kodeUnit = getKodeUnit(); // ambil dari dropdown atau logic

  const updateData = { Tanggal: tanggal, Pelanggaran: pelanggaran, Takziran: takziran, Jenis_Takziran: jenisTakziran, Kode_Unit: kodeUnit };
  if (jenis === 'santri') updateData.Stambuk = document.getElementById('santriSelect').value;
  else if (jenis === 'penasehat') updateData.Id_Penasehat = document.getElementById('penasehatSelect').value;

  const { error } = await supabaseClient.from('pelanggaran').update(updateData).eq('id', id);

  if (error) alert("âŒ Gagal update: " + error.message);
  else {
    alert("âœ… Pelanggaran berhasil diperbarui!");
    tutupModal();
    loadPelanggaran();
  }
}


/* === Hapus Pelanggaran === */
async function deletePelanggaran(id) {
  if (!id) return showToast("ID Pelanggaran tidak valid", true);
  if (!confirm("Yakin hapus data pelanggaran ini?")) return;

  try {
    const { error } = await supabaseClient
      .from("pelanggaran")
      .delete()
      .eq("id", id);

    if (error) throw error;

    // hapus cache IndexedDB (jika ada)
    try {
      const db = await dbPromise;
      const tx = db.transaction("pelanggaran", "readwrite");
      tx.objectStore("pelanggaran").delete(id);
      await tx.done;
    } catch (e) {
      console.warn("IndexedDB delete pelanggaran gagal:", e);
    }

    showToast("Data pelanggaran berhasil dihapus");
    loadPelanggaran();
  } catch (err) {
    console.error("Gagal hapus pelanggaran:", err);
    showToast("Gagal hapus data pelanggaran", true);
  }
}

// ========================== DOWNLOAD PDF INVENTARIS (FINAL CENTER ICON + BOLD LABEL) ==========================
async function downloadInventarisPDF(tab) {
  const { jsPDF } = window.jspdf;
  const marginX = 36;
  const doc = new jsPDF({ unit: "pt", format: "a4", compress: true });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let cursorY = 25;

  try {
    // === Fungsi untuk mendapatkan sumber data berdasarkan tab ===
    function getPDFSource(tab) {
      if (tab === "kendaraan") return {
        table: document.getElementById("inventaris-table"),
        filename: "Inventaris_Kendaraan"
      };
      if (tab === "handphone") return {
        table: document.getElementById("inventaris-hp-table"),
        filename: "Inventaris_Handphone"
      };
      return { table: null, filename: "Inventaris" };
    }

    const { table, filename } = getPDFSource(tab);
    
    if (!table) {
      showToast("Tabel tidak ditemukan", true);
      return;
    }

    // === Header Logo ===
    try {
      const logoUrl = "https://i.imgur.com/Irgu32G.png";
      const resp = await fetch(logoUrl);
      if (resp.ok) {
        const blob = await resp.blob();
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
        doc.addImage(base64, "PNG", marginX, 25, 34, 34);
      }
    } catch (e) {
      console.warn("Logo gagal dimuat:", e);
    }

    // === Header Teks ===
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("KHUDAMA' KHARISMA", pageWidth / 2, 30, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Pondok Pesantren Lirboyo Kota Kediri Jawa Timur", pageWidth / 2, 44, { align: "center" });

    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02", pageWidth / 2, 56, { align: "center" });

    doc.setLineWidth(0.7);
    doc.line(marginX, 64, pageWidth - marginX, 64);

    // Judul disesuaikan dengan jenis inventaris
    const judul = tab === "kendaraan" ? "LAPORAN DATA INVENTARIS KENDARAAN" : "LAPORAN DATA INVENTARIS HANDPHONE";
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(judul, pageWidth / 2, 82, { align: "center" });

    cursorY = 115;

    // === Ambil Data dari Tabel HTML ===
    const headers = Array.from(table.querySelectorAll("thead th"))
      .map(th => th.innerText.trim())
      .filter(h => h.toLowerCase() !== "aksi");

    const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
      Array.from(tr.querySelectorAll("td"))
        .map(td => td.innerText.trim())
        .filter((_, i) => headers[i]?.toLowerCase() !== "aksi")
    );

    const totalData = rows.length;
    if (totalData === 0) {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(11);
      doc.text("Tidak ada data inventaris untuk dicetak.", pageWidth / 2, cursorY + 30, { align: "center" });
      doc.save(`${filename}_${new Date().toISOString().slice(0, 10)}.pdf`);
      return;
    }

    // === Hitung Ringkasan (Disesuaikan dengan jenis inventaris) ===
    let ringkasan = {};
    let parts = [];

    if (tab === "kendaraan") {
      // Ringkasan khusus untuk kendaraan
      const colIndex = {
        Keterangan: headers.findIndex(h => h.toLowerCase().includes("keterangan")),
        STNK: headers.findIndex(h => h.toLowerCase().includes("stnk")),
        BPKB: headers.findIndex(h => h.toLowerCase().includes("bpkb"))
      };
      
      function hitungFrekuensi(index) {
        if (index === -1) return {};
        const count = {};
        rows.forEach(r => {
          const val = (r[index] || "-").trim();
          count[val] = (count[val] || 0) + 1;
        });
        return count;
      }
      
      ringkasan = {
        Keterangan: hitungFrekuensi(colIndex.Keterangan),
        STNK: hitungFrekuensi(colIndex.STNK),
        BPKB: hitungFrekuensi(colIndex.BPKB)
      };

      const ket = ringkasan.Keterangan || {};
      const stnk = ringkasan.STNK || {};
      const bpkb = ringkasan.BPKB || {};

      parts = [
        `Keterangan: Layak: ${ket["Layak"] || 0}, Tidak Layak: ${ket["Tidak Layak"] || 0}`,
        `STNK: Hidup: ${stnk["Hidup"] || 0}, Mati: ${stnk["Mati"] || 0}, Tidak Ada: ${stnk["Tidak Ada"] || 0}`,
        `BPKB: Ndalem: ${bpkb["Ndalem"] || 0}, Unit: ${bpkb["Unit"] || 0}, Tidak Ada: ${bpkb["Tidak Ada"] || 0}`
      ];

    } else if (tab === "handphone") {
	  // Cari indeks kolom
	  const colIndex = {
		Unit: headers.findIndex(h => h.toLowerCase().includes("unit")),
		Merk: headers.findIndex(h => h.toLowerCase().includes("merk")),
		PJ: headers.findIndex(h => h.toLowerCase().includes("penanggung")),
	  };

	  function hitungFrekuensi(index) {
		if (index === -1) return {};
		const count = {};
		rows.forEach(r => {
		  const val = (r[index] || "-").trim();
		  count[val] = (count[val] || 0) + 1;
		});
		return count;
	  }

	  const unit = hitungFrekuensi(colIndex.Unit);
	  const merk = hitungFrekuensi(colIndex.Merk);
	  const pj = hitungFrekuensi(colIndex.PJ);

	  
	}


    // === Box Gradasi Biru ===
    const boxHeight = 70;
    const boxWidth = pageWidth - marginX * 2;
    const boxY = cursorY;
    const gradientSteps = 25;
    for (let i = 0; i < gradientSteps; i++) {
      const ratio = i / gradientSteps;
      const r = 220 + (240 - 220) * ratio;
      const g = 230 + (250 - 230) * ratio;
      const b = 255;
      doc.setFillColor(r, g, b);
      doc.rect(marginX, boxY + (i * (boxHeight / gradientSteps)), boxWidth, boxHeight / gradientSteps, "F");
    }

    // === Ikon dan Total sejajar tengah ===
    let iconBase64 = null;
    const iconW = 25, iconH = 25;
    try {
      const iconUrl = "https://i.imgur.com/hGH2XEl.png";
      const resp = await fetch(iconUrl);
      if (resp.ok) {
        const blob = await resp.blob();
        iconBase64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }
    } catch (e) {
      console.warn("Ikon gagal dimuat:", e);
    }

    const labelText = "Total Inventaris:";
    const totalText = `${totalData} item`;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(25, 118, 210);

    const totalLineW = doc.getTextWidth(labelText + " " + totalText);
    const startX = (pageWidth - (totalLineW + iconW + 8)) / 2;
    const yCenter = boxY + boxHeight / 2 - 9;

    if (iconBase64)
      doc.addImage(iconBase64, "PNG", startX, yCenter - iconH / 1.5, iconW, iconH);

    doc.text(labelText + " " + totalText, startX + iconW + 4, yCenter + 3);

    // === Render Detail Ringkasan ===
    doc.setFontSize(9);
    doc.setTextColor(25, 118, 210);

    let detailY = yCenter + 20;
    const boldLabels = parts.flatMap(part => {
      const label = part.split(":")[0] + ":";
      return label;
    });
    const maxWidth = pageWidth - marginX * 2 - 20;

    // --- Buat baris hasil gabungan kategori, tapi pisahkan jika terlalu panjang ---
    let currentLine = "";
    let lines = [];

    parts.forEach((p, i) => {
      const candidate = currentLine ? currentLine + " | " + p : p;
      if (doc.getTextWidth(candidate) > maxWidth) {
        lines.push(currentLine.trim());
        currentLine = p;
      } else {
        currentLine = candidate;
      }
    });
    if (currentLine) lines.push(currentLine.trim());

    // --- Tulis tiap baris (rata tengah + label bold) ---
    lines.forEach(line => {
      const words = line.split(" ");
      const lineWidth = words.reduce((w, t) => w + doc.getTextWidth(t + " "), 0);
      let lineX = (pageWidth - lineWidth) / 2;

      words.forEach(word => {
        const isBold = boldLabels.some(label => word.startsWith(label.replace(":", "")));
        doc.setFont("helvetica", isBold ? "bold" : "normal");
        doc.text(word, lineX, detailY, { baseline: "middle" });
        lineX += doc.getTextWidth(word + " ");
      });

      detailY += 12;
    });

    cursorY = boxY + boxHeight + (lines.length > 1 ? 35 : 25);

    // === Render Tabel ===
	let columnStyles = {};

	// === Kendaraan: kolom 1 & 6 rata kiri ===
	if (tab === "kendaraan") {
	  columnStyles = {
		1: { halign: "left" },  // kolom 1
		6: { halign: "left" }   // kolom 6
	  };
	}

	// === Handphone: kolom 1 & 5 rata kiri ===
	if (tab === "handphone") {
	  columnStyles = {
		1: { halign: "left" },  // kolom 1
		5: { halign: "left" }   // kolom 5
	  };
	}

	doc.autoTable({
	  startY: cursorY,
	  head: [headers],
	  body: rows,
	  theme: "grid",
	  headStyles: { 
		fillColor: [26, 115, 232],
		textColor: 255,
		fontStyle: "bold",
		halign: "center" // HEADER TETAP TENGAH
	  },
	  styles: { 
		fontSize: 9,
		cellPadding: 4,
		halign: "center", // default sel tengah
		valign: "middle"
	  },
	  columnStyles: columnStyles, // â† aturan khusus per kolom
	  margin: { left: marginX, right: marginX },
	  showHead: "everyPage",
	  pageBreak: "auto",
	  rowPageBreak: "avoid"
	});


    // === Footer ===
    const footerText = `Admin â€“ Simponi Kharisma â€“ ${new Date().toLocaleString("id-ID")}`;
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text(footerText, pageWidth - marginX, pageHeight - 30, { align: "right" });

    // === Simpan PDF ===
    doc.save(`${filename}_${new Date().toISOString().slice(0, 10)}.pdf`);
  } catch (err) {
    console.error("Error downloadInventarisPDF:", err);
    showToast("Gagal membuat PDF Inventaris", true);
  }
}



// ========================== DOWNLOAD PDF PELANGGARAN ==========================
async function downloadPelanggaranPDF() {
  const { jsPDF } = window.jspdf;
  const marginX = 36;
  const doc = new jsPDF({ unit: "pt", format: "a4", compress: true });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let cursorY = 25;

  try {
    // === Header Logo ===
    try {
      const logoUrl = "https://i.imgur.com/Irgu32G.png";
      const resp = await fetch(logoUrl);
      if (resp.ok) {
        const blob = await resp.blob();
        const base64 = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
        doc.addImage(base64, "PNG", marginX, 25, 34, 34);
      }
    } catch (e) {
      console.warn("Logo gagal dimuat:", e);
    }

    // === Judul Dokumen ===
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("KHUDAMA' KHARISMA", pageWidth / 2, 30, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("Pondok Pesantren Lirboyo Kota Kediri Jawa Timur", pageWidth / 2, 44, { align: "center" });

    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02", pageWidth / 2, 56, { align: "center" });

    doc.setLineWidth(0.7);
    doc.line(marginX, 64, pageWidth - marginX, 64);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("LAPORAN DATA PELANGGARAN", pageWidth / 2, 82, { align: "center" });

    cursorY = 110;

    // === Ambil Data Tabel ===
    const table = document.getElementById("pelanggaran-table");
    const headers = Array.from(table.querySelectorAll("thead th"))
      .map(th => th.innerText.trim())
      .filter(h => h.toLowerCase() !== "aksi");

    const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
      Array.from(tr.querySelectorAll("td"))
        .map(td => td.innerText.trim())
        .filter((_, i) => headers[i]?.toLowerCase() !== "aksi")
    );

    if (rows.length === 0) {
      doc.setFont("helvetica", "italic");
      doc.setFontSize(11);
      doc.text("Tidak ada data pelanggaran untuk dicetak.", pageWidth / 2, cursorY + 30, { align: "center" });
      return doc.save("Laporan_Pelanggaran_Kharisma.pdf");
    }
	
	// === RINGKASAN PELANGGARAN (GRADASI MERAH) ===
	// Hitung jumlah tiap jenis takziran berdasarkan kolom "Jenis_Takziran"
	const totalData = rows.length;

	let ringan = 0, sedang = 0, berat = 0;

	// Temukan indeks kolom Jenis_Takziran di tabel header
	const takziranIndex = headers.findIndex(h => h.replace(/\s+/g, "_").toLowerCase() === "jenis_takziran".toLowerCase());

	if (takziranIndex >= 0) {
	  rows.forEach(r => {
		const jenis = (r[takziranIndex] || "").trim().toLowerCase();
		if (jenis === "ringan") ringan++;
		else if (jenis === "sedang") sedang++;
		else if (jenis === "berat") berat++;
	  });
	} else {
	  console.warn("âš ï¸ Kolom 'Jenis_Takziran' tidak ditemukan di header tabel pelanggaran.");
	}



	const boxHeight = 56;
	const boxWidth = pageWidth - marginX * 2;
	const boxY = cursorY;

	// Gradasi merah lembut
	const gradientSteps = 25;
	for (let i = 0; i < gradientSteps; i++) {
	  const ratio = i / gradientSteps;
	  const r = 255;
	  const g = 230 + (205 - 230) * ratio; // dari pink muda ke pink terang
	  const b = 230 + (210 - 230) * ratio;
	  doc.setFillColor(r, g, b);
	  doc.rect(marginX, boxY + (i * (boxHeight / gradientSteps)), boxWidth, boxHeight / gradientSteps, "F");
	}

	// Ikon merah
	let iconBase64 = null;
	const iconW = 35, iconH = 35;
	try {
	  const iconUrl = "https://i.imgur.com/A4VY8a6.png"; // ikon peringatan merah
	  const resp = await fetch(iconUrl);
	  if (resp.ok) {
		const blob = await resp.blob();
		iconBase64 = await new Promise((resolve) => {
		  const reader = new FileReader();
		  reader.onloadend = () => resolve(reader.result);
		  reader.readAsDataURL(blob);
		});
	  }
	} catch (e) {
	  console.warn("Ikon gagal dimuat:", e);
	}

	// Teks ringkasan
	doc.setFont("helvetica", "bold");
	doc.setFontSize(12);
	doc.setTextColor(183, 28, 28); // merah tua

	const labelText = "Total Pelanggaran:";
	const totalText = `${totalData} kasus`;
	const yCenter = boxY + boxHeight / 2 - 2; 

	// Posisi horizontal
	const labelW = doc.getTextWidth(labelText);
	const totalW = doc.getTextWidth(totalText);
	const totalWidth = iconW + 8 + labelW + totalW;
	const startX = (pageWidth - totalWidth) / 2;

	if (iconBase64) doc.addImage(iconBase64, "PNG", startX, yCenter - iconH / 1.5, iconW, iconH);
	let textX = startX + iconW + 4;
	doc.text(labelText, textX, yCenter + 3);
	textX += labelW + 4;
	doc.text(totalText, textX, yCenter + 3);

	// Baris bawah: rincian jenis
	doc.setFont("helvetica", "normal");
	doc.setFontSize(11);
	doc.setTextColor(97, 17, 17);
	const detailText = `Ringan: ${ringan} | Sedang: ${sedang} | Berat: ${berat}`;
	doc.text(detailText, pageWidth / 2, yCenter + 20, { align: "center" });

	cursorY = boxY + boxHeight + 20;


    // === Render Tabel ===
	 doc.autoTable({
	  startY: cursorY,
	  head: [headers],
	  body: rows,
	  theme: "grid",
	  headStyles: { fillColor: [220, 53, 69], textColor: 255, fontStyle: "bold" },
	  styles: { fontSize: 9, cellPadding: 4, halign: "center", valign: "middle" },
	  margin: { left: marginX, right: marginX },
	  showHead: "everyPage",
	  pageBreak: "auto",
	  rowPageBreak: "avoid",
	  didParseCell: function (data) {
		// Rata kiri untuk kolom "Nama Pelaku" dan "Pelanggaran"
		if (data.section === "body") {
		  const colName = headers[data.column.index].toLowerCase();
		  if (colName.includes("nama") || colName.includes("pelanggaran")) {
			data.cell.styles.halign = "left";
		  }
		}
	  }
	});


    const finalY = doc.lastAutoTable.finalY + 20;

    // === Footer ===
    const footerText = `Admin â€“ Simponi Kharisma â€“ ${new Date().toLocaleString("id-ID")}`;
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text(footerText, pageWidth - marginX, pageHeight - 30, { align: "right" });

    doc.save(`Laporan_Pelanggaran_${new Date().toISOString().slice(0, 10)}.pdf`);
  } catch (err) {
    console.error("Error downloadPelanggaranPDF:", err);
    showToast("Gagal membuat PDF Pelanggaran", true);
  }
}

async function handleDownloadInventaris(btn) {
  btn.classList.add("loading");
  const textEl = btn.querySelector("span");
  if (textEl) textEl.textContent = "Membuat PDF...";
  try {
    await downloadInventarisPDF();
  } finally {
    btn.classList.remove("loading");
    if (textEl) textEl.textContent = "Download PDF";
  }
}

async function handleDownloadPelanggaran(btn) {
  btn.classList.add("loading");
  const textEl = btn.querySelector("span");
  if (textEl) textEl.textContent = "Membuat PDF...";
  try {
    await downloadPelanggaranPDF();
  } finally {
    btn.classList.remove("loading");
    if (textEl) textEl.textContent = "Download PDF";
  }
}


// Load master santri (dipanggil sekali pada initNilaiModule)
async function loadSantri() {
  // pastikan ambil Status juga
  const rows = await fetchAllRows("santri_kharisma", "Stambuk, Nama_Lengkap, Kelas, Unit_Ndalem, Status");
  allSantriData = rows || [];
  // (opsional) simpan ke indexeddb jika Anda pakai saveToDB
  try { await saveToDB && saveToDB('santri_kharisma', allSantriData); } catch(e){}
  console.log("âœ… allSantriData terisi:", allSantriData.length);
}

// FILTERS: dropdown & input
function initNilaiFilters() {
  const kelasSelect = document.getElementById('nilaiSearchKelas');
  const unitSelect  = document.getElementById('nilaiSearchUnit');
  const namaInput   = document.getElementById('nilaiSearchNama');

  // Kelas: gunakan kelasOrder jika ada, fallback ambil unique dari master
  kelasSelect.innerHTML = '<option value="semua">Semua Kelas</option>' +
    (Array.isArray(kelasOrder) ? kelasOrder.map(k => `<option value="${k}">${k}</option>`).join('') :
      Array.from(new Set((allSantriData||[]).map(s=>s.Kelas).filter(Boolean))).map(k=>`<option value="${k}">${k}</option>`).join(''));

  // Unit: dari master santri aktif
  const units = Array.from(new Set((allSantriData || [])
    .filter(s => String(s.Status || '').toLowerCase() === 'aktif')
    .map(s => s.Unit_Ndalem)
    .filter(Boolean)
  )).sort();
  unitSelect.innerHTML = '<option value="semua">Semua Unit</option>' + units.map(u => `<option value="${u}">${u}</option>`).join('');

  // Event â†’ kalau filter berubah, langsung reload data
  [kelasSelect, unitSelect].forEach(el => el.onchange = () => loadNilaiData(1));
  namaInput.oninput = () => loadNilaiData(1);
}

async function initNilaiModule() {
  try {
    showLoading(true);
    await loadSantri();               // master santri
    try { await saveToDB && saveToDB('nilai1', []); } catch(e) {}

    initNilaiFilters();               // isi dropdown kelas/unit
    await loadNilaiData(1);           // â¬…ï¸ loadNilaiData sekarang fetch semua nilai aktif
    initSemesterTahunDropdowns();     // isi semester/tahun dari nilaiDict yg sudah lengkap
    bindNilaiTabs();                  // tab Tabel/Grafik
    renderNilaiChart("kelas");        // tampilkan grafik default
  } catch (err) {
    console.error("initNilaiModule error:", err);
    showError("Gagal memuat modul Nilai: " + (err.message || err));
  } finally {
    showLoading(false);
  }
}

// Bind tab (menggunakan markup yang ada: .nilai-tab & .nilai-graph-tab)
function bindNilaiTabs() {
  // tab utama (Tabel / Grafik)
  document.querySelectorAll('.nilai-tab').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.nilai-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.nilai-tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      const id = `nilai-tab-${btn.dataset.nilaiTab}`;
      document.getElementById(id)?.classList.add('active');
      // bila user pilih tab tabel -> reload page 1
      if (btn.dataset.nilaiTab === 'kelas') {
        // default behaviour: load tabel (kelas tab contains tabel view)
        loadNilaiData(1);
      } else if (btn.dataset.nilaiTab === 'grafik') {
        renderNilaiChart('kelas');
      }
    };
  });
  // sub-tab grafik (kelas/unit/individu)
  document.querySelectorAll('.nilai-graph-tab').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.nilai-graph-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderNilaiChart(btn.dataset.graph || 'kelas');
    };
  });
}

// helper untuk ganti tampilan tab aktif
function setActiveNilaiTab(mode) {
  ["kelas","unit","individu"].forEach(m => {
    const btn = document.getElementById(`nilai-tab-btn-${m}`);
    if (btn) {
      if (m === mode) btn.classList.add("active");
      else btn.classList.remove("active");
    }
  });
}

// Helper normalisasi stambuk
function normStambuk(x) {
  return String(x ?? '').trim().replace(/^0+/, '').toLowerCase();
}

async function fetchNilaiForStambuksBatched(stambukList = []) {
  if (!Array.isArray(stambukList) || stambukList.length === 0) return {};
  const dict = {};
  const CHUNK = 200; // lebih aman daripada 500

  // normalisasi + dedupe
  const normList = Array.from(new Set(
    stambukList.map(s => normStambuk(s)).filter(Boolean)
  ));

  // jika kosong langsung return
  if (!normList.length) return dict;

  for (let i = 0; i < normList.length; i += CHUNK) {
    const chunk = normList.slice(i, i + CHUNK);
    try {
      const { data, error } = await supabaseClient
        .from('nilai1')
        .select('stambuk, mata_pelajaran, semester, tahun_ajaran, nilai')
        .in('stambuk', chunk);

      if (error) {
        console.error("fetchNilaiForStambuksBatched error:", error);
        continue;
      }

      (data || []).forEach(row => {
        const key = normStambuk(row.stambuk);
        if (!dict[key]) dict[key] = [];
        dict[key].push({
          ...row,
          stambuk: key,
          nilai: toNumber(row.nilai)
        });
      });
    } catch (err) {
      console.error("fetchNilaiForStambuksBatched exception:", err);
    }
  }

  return dict;
}


// ----- fallback helper: fetchAllRows (gunakan hati-hati; jangan pakai untuk tabel sangat besar) -----
async function fetchAllRows(table, columns = '*', pageSize = 1000) {
  let all = [];
  let from = 0;
  while (true) {
    const { data, error } = await supabaseClient
      .from(table)
      .select(columns)
      .range(from, from + pageSize - 1);
    if (error) throw error;
    all = all.concat(data || []);
    if (!data || data.length < pageSize) break;
    from += pageSize;
  }
  return all;
}

async function loadNilaiData(page = 1) {
  showLoading(true);
  try {
    // ambil filter dari UI
    const keyword   = (document.getElementById('nilaiSearchNama')?.value || '').trim();
    const kelas     = document.getElementById('nilaiSearchKelas')?.value || 'semua';
    const unit      = document.getElementById('nilaiSearchUnit')?.value || 'semua';
    const semFilter = document.getElementById("nilaiSearchSemester")?.value || "semua";
    const thFilter  = document.getElementById("nilaiSearchTahun")?.value || "semua";

    // ðŸ”¹ panggil RPC untuk ambil rata-rata & jumlah mapel
    const rpcData = await fetchNilaiAggByRpc(
      keyword || null,
      thFilter === 'semua' ? null : thFilter,
      semFilter === 'semua' ? null : semFilter,
      2000,
      0
    );

    // ðŸ”¹ isi dictionary dari hasil RPC (pakai normStambuk supaya konsisten)
    nilaiDict = {};
    (rpcData || []).forEach(r => {
      const key = normStambuk(r.stambuk);
      nilaiDict[key] = {
        Rerata: Number(r.rata_rata || 0),
        Jumlah: Number(r.total_nilai || 0),
        NilaiList: [] // detail diisi nanti
      };
    });

    // ðŸ”¹ gabungkan RPC + metadata santri
    let students = (rpcData || []).map(r => {
      const meta = (allSantriData || []).find(s => s.Stambuk === r.stambuk) || {};
      return {
        Stambuk: r.stambuk,
        Nama_Lengkap: meta.Nama_Lengkap || r.nama_lengkap || "-",
        Kelas: meta.Kelas || r.kelas || "-",
        Bagian: meta.Bagian || r.bagian || "-",
        Unit_Ndalem: meta.Unit_Ndalem || r.unit_ndalem || "-",
        Jumlah: Number(r.total_nilai || 0),
        Rerata: Number(r.rata_rata || 0),
        NilaiList: []
      };
    });

    // ðŸ”¹ filter tambahan dari UI (kelas & unit)
    students = students
      .filter(s => (kelas === "semua" || s.Kelas === kelas))
      .filter(s => (unit === "semua" || s.Unit_Ndalem === unit));

    // ðŸ”¹ sort: rata-rata desc, jumlah desc, lalu nama
    students.sort((a, b) => {
      if (b.Rerata !== a.Rerata) return b.Rerata - a.Rerata;
      if (b.Jumlah !== a.Jumlah) return b.Jumlah - a.Jumlah;
      return (a.Nama_Lengkap || "").localeCompare(b.Nama_Lengkap || "");
    });

    // ðŸ”¹ pagination
    nilaiSortedAll = students;
    const totalPages = Math.max(1, Math.ceil(students.length / NILAI_PAGE_SIZE));
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    nilaiCurrentPage = page;

    const start = (page - 1) * NILAI_PAGE_SIZE;
    const pageSantri = students.slice(start, start + NILAI_PAGE_SIZE);

    // ðŸ”¹ ambil detail nilai untuk stambuk di halaman ini
    const stambukList = Array.from(new Set(
      pageSantri.map(s => (s.Stambuk || s.stambuk || '').toString()).filter(Boolean)
    )).map(normStambuk);

    try {
      const detailsDict = await fetchNilaiForStambuksBatched(stambukList);

      pageSantri.forEach(s => {
  const key = normStambuk(s.Stambuk || s.stambuk || '');

  // âœ… 1ï¸âƒ£ DEFINISIKAN rows DULU
  const rows = detailsDict[key] || [];

  // âœ… 2ï¸âƒ£ SIMPAN DATA LENGKAP UNTUK DROPDOWN
  nilaiDropdownDict[key] = rows.map(r => ({
    semester: r.semester,
    tahun_ajaran: r.tahun_ajaran
  }));

  // âœ… 3ï¸âƒ£ FILTER KHUSUS UNTUK TABEL
  const filtered = rows.filter(r =>
    (thFilter === 'semua' || String(r.tahun_ajaran) == String(thFilter)) &&
    (semFilter === 'semua' || String(r.semester) == String(semFilter))
  );

  const mapped = filtered.map(r => ({
    mapel: r.mata_pelajaran || r.Mata_Pelajaran || r.mapel || '',
    nilai: isFinite(r.nilai) ? Number(r.nilai) : toNumber(r.nilai),
    semester: r.semester,
    tahun_ajaran: r.tahun_ajaran
  }));

  nilaiDict[key] = nilaiDict[key] || {
    Rerata: Number(s.Rerata || 0),
    Jumlah: Number(s.Jumlah || 0),
    NilaiList: []
  };

  nilaiDict[key].NilaiList = mapped;
  s.NilaiList = mapped;
});



      console.log("Nilai detail fetched for page:", stambukList.length, "keys:", Object.keys(detailsDict).length);
    } catch (err) {
      console.error("Gagal ambil detail mapel untuk stambuk:", err);
    }

    // ðŸ”¹ render tabel
    renderNilaiTable(pageSantri, nilaiDict, page, totalPages);

    // ðŸ”¹ simpan untuk export
    lastActiveData = pageSantri.map(s => ({ ...s }));

    // ðŸ”¹ refresh dropdown semester/tahun
    initSemesterTahunDropdowns();

  } catch (err) {
    console.error("loadNilaiData error:", err);
    showError("Gagal memuat data Nilai: " + (err.message || err));
  } finally {
    showLoading(false);
  }
}


function renderNilaiTable(santriList = [], nilaiDictLocal = {}, page = 1, totalPages = 1) {
  const list = document.getElementById('nilai-list');
  if (!list) return;
  list.innerHTML = "";

  // Group & render per siswa (kartu)
  const grouped = new Map();
  for (const s of santriList) {
    const key = String(s.Stambuk || '').trim();
    if (!grouped.has(key)) {
      grouped.set(key, {
        Stambuk: key,
        Nama_Lengkap: s.Nama_Lengkap || "-",
        Kelas: s.Kelas || "-",
        Bagian: s.Bagian || "-",
        Unit_Ndalem: s.Unit_Ndalem || "-",
        Jumlah: s.Jumlah ?? 0,
        Rerata: s.Rerata ?? 0,
        NilaiList: s.NilaiList || []
      });
    }
  }

  const students = Array.from(grouped.values());

  // âœ… sort rata-rata desc, lalu jumlah desc, lalu nama
  students.sort((a,b) => {
    if (b.Rerata !== a.Rerata) return b.Rerata - a.Rerata;
    if (b.Jumlah !== a.Jumlah) return b.Jumlah - a.Jumlah;
    return (a.Nama_Lengkap || '').localeCompare(b.Nama_Lengkap || '');
  });

  // render kartu
  students.forEach(s => {
  const card = document.createElement("div");
  card.className = "nilai-card";

  // =========================
  // 1ï¸âƒ£ LOGIC PEMBATAS SEMESTER
  // =========================
  const semFilter = document.getElementById("nilaiSearchSemester")?.value || "semua";
let rowsHtml = "";

// pisahkan semester
const sem1 = (s.NilaiList || []).filter(n => String(n.semester) === "1");
const sem2 = (s.NilaiList || []).filter(n => String(n.semester) === "2");

if (semFilter === "semua") {

  // =====================
  // ðŸ”µ SEMESTER 1
  // =====================
  if (sem1.length) {
    rowsHtml += `
      <tr class="tr-semester-divider">
        <td colspan="3">SEMESTER 1</td>
      </tr>
    `;
  }

  let no1 = 1;
  sem1.forEach(n => {
    rowsHtml += `
      <tr>
        <td>${no1++}</td>
        <td>${escapeHtml(n.mapel)}</td>
        <td style="text-align:center">${n.nilai}</td>
      </tr>
    `;
  });

  // =====================
  // ðŸ”µ SEMESTER 2
  // =====================
  if (sem2.length) {
    rowsHtml += `
      <tr class="tr-semester-divider">
        <td colspan="3">SEMESTER 2</td>
      </tr>
    `;
  }

  let no2 = 1; // ðŸ” reset nomor
  sem2.forEach(n => {
    rowsHtml += `
      <tr>
        <td>${no2++}</td>
        <td>${escapeHtml(n.mapel)}</td>
        <td style="text-align:center">${n.nilai}</td>
      </tr>
    `;
  });

} else {
  // =====================
  // MODE NORMAL (tanpa pembatas)
  // =====================
  let no = 1;
  (s.NilaiList || []).forEach(n => {
    rowsHtml += `
      <tr>
        <td>${no++}</td>
        <td>${escapeHtml(n.mapel)}</td>
        <td style="text-align:center">${n.nilai}</td>
      </tr>
    `;
  });
}


  // =========================
  // 2ï¸âƒ£ HTML CARD
  // =========================
  const html = `
    <div class="nilai-card-header">
      ${escapeHtml(s.Nama_Lengkap)}
      <span>
        Kelas: ${escapeHtml(s.Kelas)} |
        Bagian: ${escapeHtml(s.Bagian)} |
        Unit: ${escapeHtml(s.Unit_Ndalem)}
      </span>
      <span>
        <span class="nilai-total">Jumlah: ${Math.round(s.Jumlah || 0)}</span>
        <span class="nilai-separator">|</span>
        <span class="nilai-total">Rata-rata: ${(s.Rerata || 0).toFixed(2)}</span>
      </span>
    </div>

    <div class="nilai-card-body">
      <table class="nilai-subtable">
        <thead>
          <tr><th>No.</th><th>Mata Pelajaran</th><th>Nilai</th></tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
  `;

  card.innerHTML = html;
  list.appendChild(card);
});


  // pagination UI
  renderNilaiPagination(page, totalPages);
}


function escapeHtml(s) {
  return String(s === undefined || s === null ? '' : s)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}


// Pagination (memanggil loadNilaiData untuk pergantian halaman)
function renderNilaiPagination(page, totalPages) {
  const containerId = "nilai-pagination";
  let container = document.getElementById(containerId);
  const target = document.getElementById("nilai-tab-kelas") || document.getElementById("nilai-section") || document.body;
  if (!container) {
    container = document.createElement("div");
    container.id = containerId;
    container.className = "nilai-pagination";
    target.appendChild(container);
  }
  container.innerHTML = "";

  if (!totalPages || totalPages <= 1) {
    const info = document.createElement("div");
    info.className = "pagination-info";
    info.textContent = `Halaman ${nilaiCurrentPage} dari ${totalPages || 1}`;
    container.appendChild(info);
    return;
  }

  const total = (nilaiSortedAll || nilaiFiltered || []).length;
  const startIdx = Math.min(total, (nilaiCurrentPage - 1) * NILAI_PAGE_SIZE + 1);
  const endIdx = Math.min(total, nilaiCurrentPage * NILAI_PAGE_SIZE);

  const info = document.createElement("div");
  info.className = "pagination-info";
  info.textContent = `Menampilkan ${startIdx} - ${endIdx} dari ${total} data`;
  container.appendChild(info);

  const controls = document.createElement("div");
  controls.className = "pagination-controls";
  container.appendChild(controls);

  const prevBtn = document.createElement("button");
  prevBtn.textContent = "â€¹ Prev";
  prevBtn.disabled = (nilaiCurrentPage === 1);
  prevBtn.onclick = () => loadNilaiData(Math.max(1, nilaiCurrentPage - 1));
  controls.appendChild(prevBtn);

  for (let i=1;i<=totalPages;i++) {
    if (i > 2 && i < totalPages-1 && Math.abs(i - nilaiCurrentPage) > 2) {
      if (controls.lastChild?.textContent !== "...") {
        const dots = document.createElement("span"); dots.textContent = "..."; controls.appendChild(dots);
      }
      continue;
    }
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === nilaiCurrentPage) btn.classList.add("active");
    btn.onclick = () => loadNilaiData(i);
    controls.appendChild(btn);
  }

  const nextBtn = document.createElement("button");
  nextBtn.textContent = "Next â€º";
  nextBtn.disabled = (nilaiCurrentPage === totalPages);
  nextBtn.onclick = () => loadNilaiData(Math.min(totalPages, nilaiCurrentPage + 1));
  controls.appendChild(nextBtn);
}

document.addEventListener("DOMContentLoaded", () => {
  // listener filter nilai
  ["nilaiSearchNama", "nilaiSearchKelas", "nilaiSearchUnit", "nilaiSearchSemester", "nilaiSearchTahun"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("change", () => {
          showLoading(true);      // tampilkan loading langsung
          loadNilaiData(1);       // panggil ulang load data (halaman 1)
        });
      }
    });
});


// Daftarkan plugin sekali saja setelah load Chart.js dan datalabels
Chart.register(ChartDataLabels);

async function renderNilaiChart(mode = 'kelas') {
  const canvas = document.getElementById('nilai-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (nilaiChartInstance) {
    try { nilaiChartInstance.destroy(); } catch (e) {}
    nilaiChartInstance = null;
  }

  // ðŸ”¹ Ambil filter grafik
  const sem = document.getElementById("nilaiGraphSemester")?.value || "semua";
  const th  = document.getElementById("nilaiGraphTahun")?.value || "semua";

  // ðŸ”¹ Update header
  const headerEl = document.getElementById("nilai-chart-header");
  if (headerEl) {
    const semText = sem === "semua" ? "Semua Semester" : `Semester ${sem}`;
    const thText  = th === "semua" ? "Semua Tahun Ajaran" : `Tahun Ajaran ${th}`;
    headerEl.textContent = `${semText} | ${thText}`;
  }

  // ðŸ”¹ Tinggi canvas
  canvas.style.minHeight =
    mode === 'individu' ? "900px" :
    mode === 'unit'     ? "1400px" :
                          "500px";

  showLoading(true);
  try {
    // ===============================
    // ðŸ”¹ QUERY VIEW + FILTER DROPDOWN
    // ===============================
    let q = supabaseClient
      .from('nilai_rata_kharisma')
      .select('*');

    if (sem !== "semua") q = q.eq('semester', sem);
    if (th  !== "semua") q = q.eq('tahun_ajaran', th);

    const { data, error } = await q.order('rata_rata', { ascending: false });
    if (error) throw error;

    let labels = [];
    let values = [];

    // ===============================
    // ðŸ‘¤ MODE INDIVIDU
    // ===============================
    if (mode === 'individu') {
      const arr = (data || []).slice(0, 20).map((d, i) => ({
        nama: d.nama_lengkap,
        kelas: d.kelas || '-',
        unit: d.unit_ndalem || '-',
        avg: Number(d.rata_rata || 0),
        idx: i + 1
      }));

      labels = arr.map(d => [
        `${d.idx}. ${d.nama}`,
        `${d.kelas} - ${d.unit}`
      ]);
      values = arr.map(d => Number(d.avg.toFixed(2)));
    }

    // ===============================
    // ðŸ« MODE KELAS
    // ===============================
    else if (mode === 'kelas') {
      const map = new Map();
      (data || []).forEach(d => {
        const k = d.kelas || '-';
        if (!map.has(k)) map.set(k, { sum: 0, count: 0 });
        const o = map.get(k);
        o.sum += Number(d.rata_rata || 0);
        o.count++;
      });

      const arr = Array.from(map.entries())
        .map(([k, v]) => ({ k, avg: v.count ? v.sum / v.count : 0 }))
        .sort((a, b) => b.avg - a.avg);

      labels = arr.map((d, i) => `${i + 1}. ${d.k}`);
      values = arr.map(d => Number(d.avg.toFixed(2)));
    }

    // ===============================
    // ðŸ  MODE UNIT
    // ===============================
    else if (mode === 'unit') {
      const map = new Map();
      (data || []).forEach(d => {
        const u = d.unit_ndalem || '-';
        if (!map.has(u)) map.set(u, { sum: 0, count: 0 });
        const o = map.get(u);
        o.sum += Number(d.rata_rata || 0);
        o.count++;
      });

      const arr = Array.from(map.entries())
        .map(([u, v]) => ({ u, avg: v.count ? v.sum / v.count : 0 }))
        .sort((a, b) => b.avg - a.avg);

      labels = arr.map((d, i) => `${i + 1}. ${d.u}`);
      values = arr.map(d => Number(d.avg.toFixed(2)));
    }

    // ===============================
    // ðŸ“Š RENDER CHART
    // ===============================
    nilaiChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Rata-rata Nilai',
          data: values,
          backgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          datalabels: {
            anchor: 'end',
            align: 'end',
            offset: -35,
            clamp: true,
            color: '#3b82f6',
            backgroundColor: '#fff',
            borderRadius: 4,
            padding: 4,
            font: { size: 11, weight: 'bold' },
            formatter: v => Number(v ?? 0).toFixed(2)
          }
        },
        scales: {
          y: {
            ticks: {
              autoSkip: false,
              font: { size: 10 }
            }
          }
        }
      }
    });

  } catch (err) {
    console.error("renderNilaiChart error:", err);
  } finally {
    showLoading(false);
  }
}

// ðŸ”¹ Pasang event listener untuk dropdown grafik



// Helper: ambil data agregat nilai via RPC Supabase
async function fetchNilaiAggByRpc(namaFilter = null, tahunAjaran = null, semester = null, limit = 100, offset = 0) {
  try {
    const { data, error } = await supabaseClient.rpc('get_rata_rata_santri_unit', {
      nama_filter: namaFilter,
      tahun_ajaran_filter: tahunAjaran,
      semester_filter: semester,
      limit_rows: limit,
      offset_rows: offset
    });
    if (error) {
      console.error("RPC error:", error);
      return [];
    }
    return data || [];
  } catch (err) {
    console.error("fetchNilaiAggByRpc failed:", err);
    return [];
  }
}

function toNumber(x) {
  if (typeof x === 'number') return isFinite(x) ? x : 0;
  if (typeof x === 'string') {
    const n = parseFloat(x.replace(',', '.'));
    return isFinite(n) ? n : 0;
  }
  return 0;
}

function initSemesterTahunDropdowns() {
  const semesterSet = new Set();
  const tahunSet = new Set();

  // isi dari nilaiDict (yang sudah lengkap dari stambuk aktif)
  for (const k of Object.keys(nilaiDropdownDict || {})) {
    const rows = nilaiDropdownDict[k] || [];
    rows.forEach(r => {
      if (r.semester) semesterSet.add(r.semester);
      if (r.tahun_ajaran) tahunSet.add(r.tahun_ajaran);
    });
  }

  // helper untuk mengisi select tetapi RESTORE pilihan sebelumnya jika masih tersedia
  const fillSelectPreserve = (id, arr, defaultLabel = 'semua') => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const prev = sel.value;           // simpan pilihan sebelumnya (bisa undefined)
    // rebuild options
    sel.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = defaultLabel;
    optAll.textContent = defaultLabel;
    sel.appendChild(optAll);

    // urutkan supaya tampil konsisten
    arr = Array.from(new Set(arr)).filter(v => v !== undefined && v !== null);
    arr.sort((a, b) => String(a).localeCompare(String(b)));
    arr.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });

    // restore previous value kalau masih ada, kalau tidak set ke default
    if (prev && Array.from(sel.options).some(o => o.value === prev)) {
      sel.value = prev;
    } else {
      sel.value = defaultLabel;
    }
  };

  // isi semua select (tabel + grafik)
  fillSelectPreserve("nilaiSearchSemester", Array.from(semesterSet));
  fillSelectPreserve("nilaiGraphSemester", Array.from(semesterSet));
  fillSelectPreserve("nilaiSearchTahun", Array.from(tahunSet));
  fillSelectPreserve("nilaiGraphTahun", Array.from(tahunSet));

  // pasang listener grafik hanya sekali (hindari double-binding)
  if (!window._nilaiSemesterTahunBound) {
    window._nilaiSemesterTahunBound = true;
    document.getElementById("nilaiGraphSemester")?.addEventListener("change", () => {
      const active = document.querySelector('.nilai-graph-tab.active')?.dataset.graph || 'kelas';
      renderNilaiChart(active);
    });
    document.getElementById("nilaiGraphTahun")?.addEventListener("change", () => {
      const active = document.querySelector('.nilai-graph-tab.active')?.dataset.graph || 'kelas';
      renderNilaiChart(active);
    });
  }
}



	function getFilteredData() {
	  const semFilter = document.getElementById("nilaiSearchSemester")?.value || "semua";
	  const thFilter  = document.getElementById("nilaiSearchTahun")?.value || "semua";

	  const result = [];
		for (const k of Object.keys(nilaiDropdownDict || {})) {
		  const rows = nilaiDropdownDict[k] || [];
		  rows.forEach(r => {
			const semVal = r.semester;
			const thVal  = r.tahun_ajaran;
			if ((semFilter === "semua" || semVal == semFilter) &&
				(thFilter === "semua" || thVal == thFilter)) {
			  result.push(r);
			}
		  });
		}
		return result;

	}

async function loadPenasehat() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('penasehat')
      .select('id, Nama, Status_Penasehat, Status_Pengajar, Kode_Unit, Mutakhorijin, Mulai_Ngabdi, Hp, Status, id_penasehat, Status_Bisyaroh, referensi_unit_ndalem(Nama_Unit)')
      .eq('Status', 'aktif') // ðŸ”¹ hanya ambil penasehat aktif
      .order('Mulai_Ngabdi', { ascending: true });

    if (error) throw error;

    allPenasehatData = data;
    penasehatFiltered = allPenasehatData;
	renderUnitPenasehatCheckbox(allPenasehatData); // âœ… WAJIB

    // Simpan ke IndexedDB
    await saveToDB('penasehat', data);

    renderPenasehatTable();
  } catch (err) {
    console.warn("Gagal load penasehat dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('penasehat');
    if (cached.length > 0) {
      // ðŸ”¹ Jika data offline, filter juga yang aktif
      const aktifOnly = cached.filter(item => item.Status === 'aktif');
      allPenasehatData = aktifOnly;
      penasehatFiltered = aktifOnly;
	  renderUnitPenasehatCheckbox(allPenasehatData);
      renderPenasehatTable();
    } else {
      showError("Tidak ada data Penasehat offline.");
    }
  } finally {
    showLoading(false);
  }
}

// ========== FILTER ==========
function filterPenasehat() {
  const searchTerm =
    document.getElementById('penasehatSearchNama')?.value.toLowerCase() || '';

  const selectedUnit = Array.from(
    document.querySelectorAll('#filterUnitPenasehat input[type="checkbox"]:checked')
  ).map(cb => cb.value);

  penasehatFiltered = allPenasehatData.filter(p => {
    // ðŸ”¹ nama
    const namaMatch =
      !searchTerm ||
      p.Nama?.toLowerCase().includes(searchTerm);

    // ðŸ”¹ unit (KONSISTEN)
    const unitMatch =
      selectedUnit.length === 0 ||
      selectedUnit.includes(p.Kode_Unit);

    return namaMatch && unitMatch;
  });

  penasehatCurrentPage = 1;
  renderPenasehatTable();
}



function renderPenasehatTable() {
  const table = document.getElementById("penasehat-table");
  table.innerHTML = "";

  const header = `
    <thead>
      <tr>
        <th>No.</th>
        <th class="nama">Nama</th>
        <th>Organisasi</th>
        <th>Pengajar</th>
        <th>Unit Ndalem</th>
        <th>Mutakhorijin</th>
        <th>Masa Khidmah</th>
        <th>Hp</th>
        ${userRole === "admin" ? "<th>Aksi</th>" : ""}
      </tr>
    </thead>
  `;

  const start = (penasehatCurrentPage - 1) * penasehatRowsPerPage;
  const end = start + penasehatRowsPerPage;
  const pageData = penasehatFiltered.slice(start, end);

  let rows = "";
  pageData.forEach((p, i) => {
    const masa = calculateMasaKhidmah(p.Mulai_Ngabdi);
    const hpLink = p.Hp ? `<a href="https://wa.me/${p.Hp.replace(/\D/g, "")}" target="_blank">${p.Hp}</a>` : "-";

    const aksi = userRole === "admin"
      ? `
        <td style="text-align:center;">
           <button class="crud-btn-save" data-id="${p.id}" onclick="handleEditPenasehat(this)">âœï¸</button>
		  <button class="crud-btn-cancel" onclick='deletePenasehat("${p.id}")'>ðŸ—‘ï¸</button>
		</td>
      `
      : "";

    rows += `
      <tr>
        <td>${start + i + 1}</td>
        <td class="nama">${p.Nama || "-"}</td>
        <td>${p.Status_Penasehat || "-"}</td>
        <td>${p.Status_Pengajar || "-"}</td>
        <td>${p.referensi_unit_ndalem?.Nama_Unit || p.Kode_Unit || "-"}</td>
        <td>${p.Mutakhorijin || "-"}</td>
        <td>${masa}</td>
        <td>${hpLink}</td>
        ${aksi}
      </tr>
    `;
  });

  table.innerHTML = header + `<tbody>${rows}</tbody>`;
  updatePenasehatPagination();
}

// ========== TAMBAH ==========
function openAddPenasehat() {
  document.getElementById("penasehatAddForm").reset();
  document.getElementById("penasehatAddModal").style.display = "block";
}

function closePenasehatAddModal() {
  document.getElementById("penasehatAddModal").style.display = "none";
}

document.getElementById("penasehatAddForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const data = {
    Nama: document.getElementById("add_Nama").value.trim(),
    Status_Penasehat: document.getElementById("add_Status_Penasehat").value,
    Status_Pengajar: document.getElementById("add_Status_Pengajar").value,
    Kode_Unit: document.getElementById("add_Kode_Unit").value,
    Mutakhorijin: document.getElementById("add_Mutakhorijin").value,
    Hp: document.getElementById("add_Hp").value,
    Mulai_Ngabdi: document.getElementById("add_Mulai_Ngabdi").value || null,
    id_penasehat: document.getElementById("add_id_penasehat").value || `PNSH-${Date.now().toString().slice(-6)}`,
    Status: document.getElementById("add_Status").value,
    Status_Bisyaroh: document.getElementById("add_Status_Bisyaroh").value,
  };

  try {
    const { error } = await supabaseClient.from("penasehat").insert([data]);
    if (error) throw error;
    showToast("âœ… Penasehat baru ditambahkan!");
    closePenasehatAddModal();
    await loadPenasehat();
  } catch (err) {
    console.error(err);
    showToast("âŒ Gagal menambah penasehat.", true);
  }
});


// ========== EDIT ==========
function handleEditPenasehat(btn) {
  const id = btn.getAttribute("data-id");
  if (!id) return;
  openEditPenasehat(id);
}

function openEditPenasehat(id) {
  const p = allPenasehatData.find(x => String(x.id) === String(id));
  if (!p) return alert("âŒ Data tidak ditemukan");

  const set = (field, val) => document.getElementById("edit_" + field).value = val || "";

  set("id", p.id);
  set("Nama", p.Nama);
  set("Status_Penasehat", p.Status_Penasehat);
  set("Status_Pengajar", p.Status_Pengajar);
  set("Kode_Unit", p.Kode_Unit);
  set("Mutakhorijin", p.Mutakhorijin);
  set("Hp", p.Hp);
  set("Mulai_Ngabdi", p.Mulai_Ngabdi ? String(p.Mulai_Ngabdi).slice(0,10) : "");
  set("id_penasehat", p.id_penasehat);
  set("Status", p.Status);
  set("Status_Bisyaroh", p.Status_Bisyaroh);

  document.getElementById("penasehatEditModal").style.display = "block";
}

function closePenasehatEditModal() {
  document.getElementById("penasehatEditModal").style.display = "none";
}

document.getElementById("penasehatEditForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = document.getElementById("edit_id").value;
  const data = {
    Nama: document.getElementById("edit_Nama").value.trim(),
    Status_Penasehat: document.getElementById("edit_Status_Penasehat").value,
    Status_Pengajar: document.getElementById("edit_Status_Pengajar").value,
    Kode_Unit: document.getElementById("edit_Kode_Unit").value,
    Mutakhorijin: document.getElementById("edit_Mutakhorijin").value,
    Hp: document.getElementById("edit_Hp").value,
    Mulai_Ngabdi: document.getElementById("edit_Mulai_Ngabdi").value || null,
    id_penasehat: document.getElementById("edit_id_penasehat").value,
    Status: document.getElementById("edit_Status").value,
    Status_Bisyaroh: document.getElementById("edit_Status_Bisyaroh").value,
  };

  try {
    const { error } = await supabaseClient.from("penasehat").update(data).eq("id", id);
    if (error) throw error;
    showToast("âœ… Data penasehat diperbarui!");
    closePenasehatEditModal();
    await loadPenasehat();
  } catch (err) {
    console.error(err);
    showToast("âŒ Gagal memperbarui data.", true);
  }
});



// ===========================
//  HAPUS DATA
// ===========================
async function deletePenasehat(id) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  const { error } = await supabaseClient.from("penasehat").delete().eq("id", id);
  if (error) {
    showToast("âŒ Gagal menghapus data: " + error.message, true);
  } else {
    showToast("âœ… Data berhasil dihapus!");
    await loadPenasehat();
  }
}


function updatePenasehatPagination() {
  const totalPages = Math.ceil(penasehatFiltered.length / penasehatRowsPerPage);
  const info = document.getElementById('penasehatPaginationInfo');
  const controls = document.getElementById('penasehatPaginationControls');
  info.textContent = `Menampilkan ${penasehatFiltered.length} data (Halaman ${penasehatCurrentPage} dari ${totalPages})`;

  controls.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === penasehatCurrentPage) btn.classList.add('active');
    btn.onclick = () => { penasehatCurrentPage = i; renderPenasehatTable(); };
    controls.appendChild(btn);
  }
}

function renderUnitPenasehatCheckbox(data) {
  const container = document.getElementById("filterUnitPenasehat");
  if (!container) return;

  // Map: Kode_Unit -> Nama_Unit
  const unitMap = new Map();

  data.forEach(p => {
    if (!p.Kode_Unit) return;

    const namaUnit =
      p.referensi_unit_ndalem?.Nama_Unit || p.Kode_Unit;

    unitMap.set(p.Kode_Unit, namaUnit);
  });

  // ðŸ”¹ ubah ke array & URUTKAN BERDASARKAN NAMA UNIT
  const sortedUnits = Array.from(unitMap.entries())
    .sort((a, b) =>
      a[1].localeCompare(b[1], 'id', { sensitivity: 'base' })
    );

  container.innerHTML = "";

  sortedUnits.forEach(([kodeUnit, namaUnit]) => {
    const label = document.createElement("label");
    label.style.display = "flex";
    label.style.alignItems = "center";
    label.style.gap = "4px";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = kodeUnit;     // ðŸ”¹ FILTER = KODE
    cb.checked = false;      // ðŸ”¹ DEFAULT TANPA CEKLIS
    cb.onchange = filterPenasehat;

    label.appendChild(cb);
    label.append(" " + namaUnit); // ðŸ”¹ TAMPIL = NAMA (SUDAH TERURUT)

    container.appendChild(label);
  });
}


function getSelectedUnitPenasehat() {
  return Array.from(
    document.querySelectorAll("#filterUnitPenasehat input[type=checkbox]:checked")
  ).map(cb => cb.value);
}


async function loadGuru() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('data_guru')
      .select('id, Nama, Bagian, Kelas, Kamar, Alamat, Hp')
      .order('Kelas', { ascending: true });

    if (error) throw error;

    allGuruData = data;

    // Simpan ke IndexedDB
    await saveToDB('data_guru', data);

    // isi dropdown kelas unik
    const kelasSet = [...new Set(allGuruData.map(g => g.Kelas).filter(Boolean))];
    const kelasSelect = document.getElementById('guruFilterKelas');
    kelasSelect.innerHTML = '<option value="">Semua</option>';
    kelasSet.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = k;
      kelasSelect.appendChild(opt);
    });

    filterGuru();
  } catch (err) {
    console.warn("Gagal load data_guru dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('data_guru');
    if (cached.length > 0) {
      allGuruData = cached;

      // isi dropdown kelas unik dari cache
      const kelasSet = [...new Set(allGuruData.map(g => g.Kelas).filter(Boolean))];
      const kelasSelect = document.getElementById('guruFilterKelas');
      kelasSelect.innerHTML = '<option value="">Semua</option>';
      kelasSet.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        kelasSelect.appendChild(opt);
      });

      filterGuru();
    } else {
      showError("Tidak ada data Guru offline.");
    }
  } finally {
    showLoading(false);
  }
}



function filterGuru() {
  const term = document.getElementById('guruSearchNama').value.toLowerCase();
  const kelas = document.getElementById('guruFilterKelas').value;

  guruFiltered = allGuruData.filter(g => {
    const matchNama = g.Nama?.toLowerCase().includes(term);
    const matchKelas = !kelas || g.Kelas === kelas;
    return matchNama && matchKelas;
  });

  // urutkan: kelas mengikuti kelasOrder, lalu Bagian abjad
  guruFiltered.sort((a, b) => {
    const idxA = kelasOrderGuru.indexOf(a.Kelas);
    const idxB = kelasOrderGuru.indexOf(b.Kelas);
    if (idxA !== idxB) return idxA - idxB;
    return (a.Bagian || '').localeCompare(b.Bagian || '');
  });

  guruCurrentPage = 1;
  renderGuruTable();
}

function renderGuruTable() {
  const table = document.getElementById('guru-table');
  table.innerHTML = '';

  const header = `
    <thead>
      <tr>
        <th>No.</th>
        <th class="nama">Nama</th>
        <th>Bagian</th>
        <th>Kelas</th>
        <th>Kamar</th>
        <th>Alamat</th>
        <th>Hp</th>
      </tr>
    </thead>
  `;

  const start = (guruCurrentPage - 1) * guruRowsPerPage;
  const end = start + guruRowsPerPage;
  const pageData = guruFiltered.slice(start, end);

  let rows = '';
  pageData.forEach((g, i) => {
    let hpLink = '-';
    if (g.Hp) {
      const cleanHp = g.Hp.toString().replace(/\D/g, '');
      hpLink = `<a href="https://wa.me/${cleanHp}" target="_blank">${g.Hp}</a>`;
    }

    rows += `
      <tr>
        <td>${start + i + 1}</td>
        <td class="nama">${g.Nama || '-'}</td>
        <td>${g.Bagian || '-'}</td>
        <td>${g.Kelas || '-'}</td>
        <td>${g.Kamar || '-'}</td>
        <td>${g.Alamat || '-'}</td>
        <td>${hpLink}</td>
      </tr>
    `;
  });

  table.innerHTML = header + `<tbody>${rows}</tbody>`;
  updateGuruPagination();
}


function updateGuruPagination() {
  const totalPages = Math.ceil(guruFiltered.length / guruRowsPerPage);
  const info = document.getElementById('guruPaginationInfo');
  const controls = document.getElementById('guruPaginationControls');

  info.textContent = `Menampilkan ${guruFiltered.length} data (Halaman ${guruCurrentPage} dari ${totalPages})`;
  controls.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === guruCurrentPage) btn.classList.add('active');
    btn.onclick = () => { guruCurrentPage = i; renderGuruTable(); };
    controls.appendChild(btn);
  }
}

async function loadInfo() {
  showLoading(true);
  try {	
    const { data, error } = await supabaseClient
      .from('informasi')
      .select('*')
      .order('Tanggal', { ascending: false });

    if (error) throw error;

    allInfoData = data || [];
    infoFiltered = allInfoData;

    // Simpan ke IndexedDB
    await saveToDB('informasi', allInfoData);

    renderInfoTable(infoFiltered, 1);
  } catch (err) {
    console.warn("Gagal load informasi dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('informasi');
    if (cached.length > 0) {
      allInfoData = cached;
      infoFiltered = cached;
      renderInfoTable(infoFiltered, 1);
    } else {
      showError("Tidak ada data Informasi offline.");
    }
  } finally {
    showLoading(false);
  }
}


function filterInfo() {
  const search = document.getElementById('infoSearchIsi').value.toLowerCase();
  infoFiltered = allInfoData.filter(i =>
    (i.Jenis_Informasi || '').toLowerCase().includes(search) ||
    (i.Isi_Informasi || '').toLowerCase().includes(search) ||
    (i.Penulis || '').toLowerCase().includes(search)
  );
  renderInfoTable(infoFiltered, 1);
}

function renderInfoTable(data, page = 1) {
  const table = document.getElementById('info-table');
  table.innerHTML = '';

  const totalRecords = data.length;
  const totalPages = Math.max(1, Math.ceil(totalRecords / infoRowsPerPage));
  const start = (page - 1) * infoRowsPerPage;
  const end = Math.min(start + infoRowsPerPage, totalRecords);
  const paginated = data.slice(start, end);

  // ðŸ”¹ Header tabel (kolom Aksi hanya muncul jika admin)
  const header = `
    <thead>
      <tr>
        <th>No.</th>
        <th>Tgl</th>
        <th>Jenis Informasi</th>
        <th>Isi Informasi</th>
        <th>Penulis</th>
        ${userRole === "admin" ? "<th>Aksi</th>" : ""}
      </tr>
    </thead>
  `;

  let rows = "";
  paginated.forEach((d, i) => {
    const tanggal = d.Tanggal ? new Date(d.Tanggal).toLocaleDateString('id-ID') : '-';

    // ðŸ”¹ Tombol hanya jika admin
    const aksi = userRole === "admin"
	  ? `
		<td style="text-align:center;">
		  <button class="crud-btn-save" data-id="${d.id}" onclick="openEditInfo(this.dataset.id)">âœï¸</button>
		  <button class="crud-btn-cancel" data-id="${d.id}" onclick="deleteInfo(this.dataset.id)">ðŸ—‘ï¸</button>
		</td>
	  `
	  : "";


    rows += `
      <tr>
        <td>${start + i + 1}</td>
        <td>${tanggal}</td>
        <td>${d.Jenis_Informasi || '-'}</td>
        <td style="text-align:left">${d.Isi_Informasi || '-'}</td>
        <td>${d.Penulis || '-'}</td>
        ${aksi}
      </tr>
    `;
  });

  table.innerHTML = header + `<tbody>${rows}</tbody>`;

  document.getElementById('infoPaginationInfo').textContent =
    totalRecords === 0
      ? 'Menampilkan 0 data'
      : `Menampilkan ${start + 1} - ${end} dari ${totalRecords} data`;

  updateInfoPagination(totalPages, page, data);
}


function updateInfoPagination(totalPages, currentPage, data) {
  const controls = document.getElementById('infoPaginationControls');
  controls.innerHTML = '';
  if (totalPages <= 1) return;

  if (currentPage > 1) {
    const prev = document.createElement('button');
    prev.textContent = 'Sebelumnya';
    prev.onclick = () => renderInfoTable(data, currentPage - 1);
    controls.appendChild(prev);
  }

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === currentPage) btn.classList.add('active');
    btn.onclick = () => renderInfoTable(data, i);
    controls.appendChild(btn);
  }

  if (currentPage < totalPages) {
    const next = document.createElement('button');
    next.textContent = 'Berikutnya';
    next.onclick = () => renderInfoTable(data, currentPage + 1);
    controls.appendChild(next);
  }
}

function openAddInfo() {
  document.getElementById("infoId").value = "";
  document.getElementById("infoModalTitle").textContent = "Tambah Informasi";
  document.getElementById("infoForm").reset();
  document.getElementById("infoModal").style.display = "flex";
}

function openEditInfo(id) {
  const info = allInfoData.find(i => i.id == id);
  if (!info) return;

  document.getElementById("infoId").value = info.id;
  document.getElementById("infoTanggal").value = info.Tanggal?.split('T')[0] || "";
  document.getElementById("infoJenis").value = info.Jenis_Informasi || "";
  document.getElementById("infoIsi").value = info.Isi_Informasi || "";
  document.getElementById("infoPenulis").value = info.Penulis || "";

  document.getElementById("infoModalTitle").textContent = "Edit Informasi";
  document.getElementById("infoModal").style.display = "flex";
}


function closeInfoModal() {
  document.getElementById("infoModal").style.display = "none";
}

async function saveInfo(event) {
  event.preventDefault();
  const id = document.getElementById("infoId").value;
  const newData = {
    Tanggal: document.getElementById("infoTanggal").value,
    Jenis_Informasi: document.getElementById("infoJenis").value,
    Isi_Informasi: document.getElementById("infoIsi").value,
    Penulis: document.getElementById("infoPenulis").value
  };

  try {
    if (id) {
      // UPDATE
      const { error } = await supabaseClient
        .from("informasi")
        .update(newData)
        .eq("id", id);
      if (error) throw error;
      showToast("âœ… Informasi berhasil diperbarui!");
    } else {
      // INSERT
      const { error } = await supabaseClient
        .from("informasi")
        .insert([newData]);
      if (error) throw error;
      showToast("âœ… Informasi berhasil ditambahkan!");
    }

    closeInfoModal();
    await loadInfo();
  } catch (err) {
    console.error("Gagal simpan informasi:", err);
    showToast("âŒ Gagal menyimpan data!", true);
  }
}

async function deleteInfo(id) {
  if (!confirm("Yakin ingin menghapus informasi ini?")) return;
  try {
    const { error } = await supabaseClient
      .from("informasi")
      .delete()
      .eq("id", id);
    if (error) throw error;
    showToast("ðŸ—‘ï¸ Informasi berhasil dihapus!");
    await loadInfo();
  } catch (err) {
    console.error("Gagal hapus informasi:", err);
    showToast("âŒ Gagal menghapus data!", true);
  }
}

 // Fungsi untuk memeriksa session dan mengarahkan ke login jika belum login
    async function checkAuth() {
      showLoading(true);
      
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.error('Error checking session:', error);
          window.location.href = 'index.html';
          return;
        }
        
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        
        // Simpan info user yang sedang login
        currentUser = session.user;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Load data setelah auth berhasil
        await loadDashboardData();
        await loadDropdowns();
        await loadData();
        
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = 'index.html';
      } finally {
        showLoading(false);
      }
    }

    // Fungsi logout
    async function logout() {
      showLoading(true);
      
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error('Error logging out:', error);
        }
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'index.html';
      } finally {
        showLoading(false);
      }
    }

    // Listener untuk perubahan auth state
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) {
        window.location.href = 'index.html';
      }
    });
	

	// Tangani navigasi back
	window.addEventListener('popstate', function (event) {
	  const anyModuleActive = document.querySelector('.module-container.active');

	  if (anyModuleActive) {
		// Kalau sedang di dalam modul â†’ kembali ke menu utama
		showMainGrid();
		// Jangan biarkan langsung keluar
		history.pushState(null, null, location.href);
	  } else {
		// Kalau sudah di menu utama â†’ tampilkan konfirmasi keluar
		if (confirm("Yakin ingin keluar dari aplikasi?")) {
		  // Benar-benar keluar (browser back)
		  history.back();
		} else {
		  // Batalkan keluar, tetap di halaman
		  history.pushState(null, null, location.href);
		}
	  }
	});

	// Tambahkan state awal supaya tidak langsung keluar
	window.addEventListener('DOMContentLoaded', () => {
	  history.pushState(null, null, location.href);
	});
		
	// create/open IDB (replace existing dbPromise block)
	const dbPromise = idb.openDB('KharismaDB', 1, {
	  upgrade(db) {
		const stores = [
		  'santri_kharisma','inventaris','pelanggaran','absensi1',
		  'data_guru','informasi','nilai1','penasehat','referensi_unit_ndalem'
		];
		stores.forEach(s => {
		  if (!db.objectStoreNames.contains(s)) {
			db.createObjectStore(s, { keyPath: 'id' });
		  }
		});
	  }
	});

	// helper
	async function saveToDB(storeName, data) {
	  const db = await dbPromise;
	  if (!db.objectStoreNames.contains(storeName)) return;
	  data.forEach(item => db.put(storeName, item));
	}
	async function getFromDB(storeName) {
	  const db = await dbPromise;
	  if (!db.objectStoreNames.contains(storeName)) return [];
	  return await db.getAll(storeName);
	}


// ================= HANDLER =================
function handleDownload() {
  const format = document.getElementById("downloadFormat").value;
  if (format === "pdf") downloadNilaiPDF();
  else downloadNilaiHTML();
}

// ================= CSS modul (dipakai untuk HTML export) =================
const nilaiCSS = `
/* minimal styling yang diperlukan agar HTML export mirip tampilan app */
.nilai-card { border:1px solid #e6e6e6;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.08);overflow:hidden;margin-bottom:18px;}
.nilai-card-header { background:#1a73e8;color:#fff;padding:12px 16px;font-weight:700; display:flex; flex-direction:column; gap:4px;}
.nilai-card-header span { font-size:0.85rem; font-weight:400; opacity:0.95; }
.nilai-card-body { padding:12px 14px; overflow-x:auto; }
.nilai-subtable { width:100%; border-collapse:collapse; font-size:0.9rem; }
.nilai-subtable th, .nilai-subtable td { border:1px solid #f0f0f0; padding:6px 10px; }
.nilai-subtable th { background:#f8fafc; font-weight:600; text-align:center; }
`;

// ================= BUILD CONTENT (dipakai HTML & PDF) =================
function buildNilaiExportContent(ext = "html") {
  const today = new Date();
  const grafikTab = document.querySelector(".nilai-tab[data-nilai-tab='grafik']");
  const isGrafik = grafikTab && grafikTab.classList.contains("active");

  // ambil filter
  let sem, th, unit, kelas, jenisGrafik;
  if (isGrafik) {
    sem = document.getElementById("nilaiGraphSemester")?.value;
    th  = document.getElementById("nilaiGraphTahun")?.value;
    unit = ""; kelas = "";
    const activeGraphTab = document.querySelector(".nilai-graph-tab.active");
    if (activeGraphTab) {
      const label = activeGraphTab.textContent.trim();
      if (/kelas/i.test(label)) jenisGrafik = "Top Kelas";
      else if (/unit/i.test(label)) jenisGrafik = "Top Unit Ndalem";
      else if (/nama/i.test(label)) jenisGrafik = "Top Nama";
      else jenisGrafik = label;
    }
  } else {
    sem   = document.getElementById("nilaiSearchSemester")?.value;
    th    = document.getElementById("nilaiSearchTahun")?.value;
    unit  = document.getElementById("nilaiSearchUnit")?.value;
    kelas = document.getElementById("nilaiSearchKelas")?.value;
  }

  // kosongkan kalau "semua"
  if (sem?.toLowerCase() === "semua") sem = "";
  if (th?.toLowerCase() === "semua") th = "";
  if (unit?.toLowerCase().includes("semua")) unit = "";
  if (kelas?.toLowerCase().includes("semua")) kelas = "";

  // filename seragam
  const filters = {};
  if (sem) filters.semester = `Sem${sem}`;
  if (th)  filters.tahun    = th;
  if (isGrafik && jenisGrafik) {
    filters.jenis = jenisGrafik.replace(/\s+/g, "-");
  } else {
    if (unit)  filters.unit  = unit.replace(/\s+/g, "_");
    if (kelas) filters.kelas = kelas.replace(/\s+/g, "_");
  }
  const prefix = isGrafik ? "Nilai_Grafik" : "Nilai_Tabel";
  const filename = getExportFileName(prefix, ext, filters);

  // isi utama
  let bodyContent = "";
  if (isGrafik) {
    const canvas = document.getElementById("nilai-chart");
    if (!canvas) throw new Error("Grafik tidak tersedia!");
    const imgData = canvas.toDataURL("image/png");
    bodyContent = `<div style="text-align:center;"><img src="${imgData}" style="max-width:100%;border:1px solid #ccc;border-radius:6px;"></div>`;
  } else {
    const cards = document.querySelectorAll(".nilai-card");
    if (!cards.length) throw new Error("Data nilai santri belum ada!");
    cards.forEach(c => bodyContent += c.outerHTML);
  }

  // filter info
  let filterParts = [];
  if (sem)   filterParts.push(`Semester: ${sem}`);
  if (th)    filterParts.push(`Tahun Ajaran: ${th}`);
  if (unit)  filterParts.push(`Unit: ${unit}`);
  if (kelas) filterParts.push(`Kelas: ${kelas}`);
  if (isGrafik && jenisGrafik) filterParts.push(`Jenis Grafik: ${jenisGrafik}`);
  let filterInfo = filterParts.join(" | ");

  const judul = isGrafik ? "LAPORAN GRAFIK NILAI" : "LAPORAN TABEL NILAI";
  

  // html utuh
  const content = `
<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><title>${judul}</title>
<style>
${nilaiCSS}
body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa;}
.kop{position:relative;margin-bottom:10px;}
.kop img{position:absolute;left:0;top:50%;transform:translateY(-50%);height:60px;}
.identitas{text-align:center;}
.identitas h1{margin:0;font-size:22px;color:#003366;}
.identitas h2{margin:0;font-size:16px;}
.identitas p{margin:0;font-size:11px;font-style:italic;}
hr{border:1px solid #000;margin:20px 0 20px;}
.footer{margin-top:30px;font-size:11px;color:gray;text-align:right;font-style:italic;}
.filter-info{font-size:11px;margin:5px 0;text-align:left;}
</style>
</head><body>
<div class="kop">
  <img src="https://i.imgur.com/Irgu32G.png">
  <div class="identitas">
    <h1>KHUDAMA' KHARISMA</h1>
    <h2>Pondok Pesantren Lirboyo Kota Kediri Jawa Timur</h2>
    <p>Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri</p>
  </div>
</div>
<hr>
<h2 style="text-align:center;font-size:16px;margin:10px 0;">${judul}</h2>
${filterInfo ? `<div class="filter-info">${filterInfo}</div>` : ""}
${bodyContent}
<div class="footer">Admin â€“ Simponi Kharisma â€“ ${today.toLocaleDateString("id-ID")} ${today.toLocaleTimeString("id-ID")}</div>
</body></html>`;

  return { content, filename, judul };
}

async function downloadNilaiHTML() {
  try {
    const { content, filename } = buildNilaiExportContent("html");
    const blob = new Blob([content], { type: "text/html;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
  } catch (err) {
    console.error("HTML export failed:", err);
    alert(err.message || "Gagal membuat HTML");
  }
}

async function downloadNilaiPDF() {
  try {
    const { content, filename, judul } = buildNilaiExportContent("pdf");

    // Buat elemen off-screen
    const tempElement = document.createElement("div");
    tempElement.style.position = "absolute";
    tempElement.style.left = "-9999px";
    tempElement.style.top = "0";
    tempElement.style.width = "auto";
    tempElement.style.padding = "10px";
    tempElement.style.background = "#fff";
    tempElement.innerHTML = content;
    document.body.appendChild(tempElement);

    // Deteksi apakah tab TABEL
    const isTabel = /TABEL/i.test(judul);

    // === Tambahkan CSS override khusus untuk TABEL ===
    if (isTabel) {
      const style = document.createElement("style");
      style.textContent = `
        .kop img { height: 24px !important; }
        .identitas h1 { font-size: 12px !important; }
        .identitas h2 { font-size: 9px !important; }
        .identitas p { font-size: 7px !important; }
        hr { margin: 6px 0 !important; }
        h2 { font-size: 11px !important; }
        .filter-info { font-size: 7px !important; }
        .footer { font-size: 7px !important; }
        .nilai-card-header { font-size: 10px !important; padding: 4px 6px !important; }
        .nilai-card-header span { font-size: 8px !important; }
        .nilai-card-body { padding: 4px 6px !important; }
        .nilai-subtable { font-size: 8px !important; }
        .nilai-subtable th, .nilai-subtable td { padding: 2px 3px !important; }
      `;
      tempElement.appendChild(style);
    }

    // Tunggu semua gambar selesai load
    await Promise.all(
      Array.from(tempElement.querySelectorAll("img")).map(
        img =>
          new Promise(res => {
            if (img.complete && img.naturalHeight > 0) return res();
            img.onload = res;
            img.onerror = res;
          })
      )
    );

    // Render ke canvas
    const canvas = await html2canvas(tempElement, {
      scale: 3,
      useCORS: true,
      backgroundColor: "#fff"
    });

    document.body.removeChild(tempElement);

    // Hitung ukuran PDF
    const pdfWidth = 794; // A4 px width
    const margin = 20;
    const scaleFactor = (pdfWidth - margin * 2) / canvas.width;
    const pdfHeight = Math.ceil(canvas.height * scaleFactor + margin * 2);

    // Safety fallback
    if (pdfHeight > 20000) {
      const blob = new Blob([content], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      URL.revokeObjectURL(url);
      alert("Konten terlalu panjang untuk PDF, dibuka sebagai HTML.");
      return;
    }

    // Buat PDF
    const pdf = new window.jspdf.jsPDF({
      unit: "px",
      format: [pdfWidth, pdfHeight]
    });
    pdf.addImage(
      canvas.toDataURL("image/jpeg", 0.95),
      "JPEG",
      margin,
      margin,
      pdfWidth - margin * 2,
      pdfHeight - margin * 2
    );

    pdf.save(filename);
  } catch (err) {
    console.error("âŒ PDF export failed:", err);
    alert("Gagal membuat PDF: " + (err.message || err));
  }
}


function openAddNilai() {
  openModal("Tambah Data Nilai", async (formData) => {
    try {
      const { error } = await supabaseClient.from("nilai1").insert([formData]);
      if (error) throw error;
      showPopup("Data nilai berhasil ditambahkan!");
      // reload current page
      await loadNilaiData(nilaiCurrentPage);
    } catch (err) {
      showError("Gagal tambah nilai: " + (err.message || err));
    }
  });
}

async function editNilai(id) {
  try {
    // fetch single row to populate modal
    const { data, error: fetchErr } = await supabaseClient.from('nilai1').select('*').eq('id', id).single();
    if (fetchErr) { showError("Gagal ambil data: " + fetchErr.message); return; }
    openModal("Edit Data Nilai", async (formData) => {
      const { error } = await supabaseClient.from("nilai1").update(formData).eq("id", id);
      if (error) { showError("Gagal update nilai: " + error.message); return; }
      showPopup("Data nilai berhasil diperbarui!");
      await loadNilaiData(nilaiCurrentPage);
    }, data);
  } catch (err) {
    console.error("editNilai error:", err);
    showError("Terjadi kesalahan saat edit nilai.");
  }
}

async function deleteNilai(id) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  try {
    const { error } = await supabaseClient.from("nilai1").delete().eq("id", id);
    if (error) throw error;
    showPopup("Data nilai berhasil dihapus!");
    await loadNilaiData(nilaiCurrentPage);
  } catch (err) {
    console.error("deleteNilai error:", err);
    showError("Gagal hapus nilai: " + (err.message || err));
  }
}

// ========= Helper Modal ========= //
function openModal(title, onSave, data = {}) {
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = `
    <div class="modal-box">
      <h3>${title}</h3>
      <form id="modalForm">
        <label>Mata Pelajaran</label>
        <input name="Mata_Pelajaran" value="${data.Mata_Pelajaran || ""}" required>
        <label>Nilai</label>
        <input name="Nilai" type="number" value="${data.Nilai || ""}" required>
        <label>Stambuk</label>
        <input name="Stambuk" value="${data.Stambuk || ""}" required>
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel">Batal</button>
          <button type="submit" class="modal-btn save">Simpan</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.querySelector(".cancel").onclick = () => overlay.remove();
  overlay.querySelector("#modalForm").onsubmit = async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());
    await onSave(formData);
    overlay.remove();
  };
}

// ================= HELPER: Load Image â†’ Base64 =================
async function loadImageToBase64(url, maxSize = 150) {
  try {
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.crossOrigin = "Anonymous";
      i.onload = () => resolve(i);
      i.onerror = () => reject(new Error("Image load error"));
      i.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
    });

    let w = img.naturalWidth || img.width;
    let h = img.naturalHeight || img.height;
    if (w > maxSize) {
      h = Math.round((maxSize / w) * h);
      w = maxSize;
    }

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    return { base64: canvas.toDataURL("image/png"), w, h };
  } catch (err) {
    console.warn("loadImageToBase64 failed:", err?.message || err);
    return null;
  }
}

function sectionTitle(doc, text, x, y) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(11);
  doc.setTextColor(0, 102, 204);

  doc.text(text, x, y);

  const textWidth = doc.getTextWidth(text);

  const FIX_RIGHT = 2.5; // kompensasi glyph jsPDF

  doc.setDrawColor(0, 102, 204);
  doc.setLineWidth(0.8);
  doc.line(
    x,
    y + 2,
    x + textWidth + FIX_RIGHT,
    y + 2
  );

  doc.setTextColor(0);
}



// ===== KONSTANTA POSISI PDF =====
const FIRST_PAGE_START_Y = 140;
const NEXT_PAGE_START_Y  = 60;
const TITLE_TO_FILTER_GAP = 30; // jarak judul â†’ filter


function checkPage(doc, y, need = 260) {
  const h = doc.internal.pageSize.getHeight();
  if (y + need > h - 60) {
    doc.addPage();
    return 120;
  }
  return y;
}

function drawLabelValue(doc, x, y, label, value) {
  const labelW = 140;
  const rowH = 18;

  doc.setDrawColor(180);
  doc.setLineWidth(0.3);

  doc.rect(x, y - 13, labelW, rowH);
  doc.rect(x + labelW, y - 13, 300, rowH);

  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text(label, x + 5, y);

  doc.setFont("helvetica", "normal");
  doc.text(value || "-", x + labelW + 5, y);
}

function drawFilterInfo(doc, unit, kelas, startY) {
  if (!unit && !kelas) return startY;

  doc.setFont("helvetica", "italic");
  doc.setFontSize(11);

  let txt = [];
  if (unit) txt.push(`Unit: ${unit}`);
  if (kelas) txt.push(`Kelas: ${kelas}`);

  doc.text(txt.join("   |   "), 40, startY);
  return startY + 20;
}

function drawIcon(doc, x, y, text) {
  doc.setFillColor(0, 102, 204);
  doc.rect(x, y - 10, 14, 14, "F");

  doc.setTextColor(255);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(8);
  doc.text(text, x + 4, y);

  doc.setTextColor(0);
}

function drawRow(doc, x, y, label, value) {
  doc.setFont("helvetica", "bold");
  doc.setFontSize(10);
  doc.text(label, x, y);

  doc.setFont("helvetica", "normal");
  doc.text(": " + (value || "-"), x + 120, y);
}

async function drawSantriCard(doc, s, nomor, startY, options = {}) {
  const { withPhoto = true } = options;
  const marginX = 40;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();

  const cardW = pageW - marginX * 2;
  const photoW = withPhoto ? 110 : 0;
  const lineGap = 16;

  // pindah halaman jika mepet
  if (startY > pageH - 200) {
  doc.addPage();
  startY = NEXT_PAGE_START_Y;
}


  const contentStartY = startY + 18;
  let y = contentStartY;

  // ================= NO (BACKGROUND BIRU) =================
const noBoxW = 28;
const noBoxH = 18;
const noBoxX = marginX + 4;
const noBoxY = y - 13;

// kotak biru terang
doc.setFillColor(0, 122, 204);
doc.roundedRect(noBoxX, noBoxY, noBoxW, noBoxH, 4, 4, "F");

// teks nomor
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.setTextColor(255, 255, 255);
doc.text(
  String(nomor),
  noBoxX + noBoxW / 2,
  noBoxY + 13,
  { align: "center" }
);

// reset warna
doc.setTextColor(0);

y += 22;

  // ================= FOTO =================
  const photoX = marginX + cardW - photoW - 12;
  const photoY = y;

  const photoH = 140;

  // foto nanti, sekarang simpan posisi

  let x = marginX + 12;
  const contentW = withPhoto
  ? cardW - photoW - 40
  : cardW - 24;


  // ================= DATA MADRASAH =================
  sectionTitle(doc, "Madrasah", x, y);
  y += lineGap;

  drawRow(doc, x, y, "Nama Lengkap", s.Nama_Lengkap); y += lineGap;
drawRow(doc, x, y, "Stambuk", s.Stambuk); y += lineGap;
drawRow(doc, x, y, "Kelas", s.Kelas); y += lineGap;
drawRow(doc, x, y, "Bagian", s.Bagian); y += lineGap;


drawRow(doc, x, y, "Mustahiq", s.guru?.Nama || "-"); y += lineGap;
drawRow(doc, x, y, "No. Kontak", s.guru?.Hp || "-"); y += lineGap + 6;

// ================= DATA HIMPUNAN =================
  sectionTitle(doc, "Himpunan Pelajar", x, y);
  y += lineGap;

drawRow(doc, x, y, "Himpunan", s.Himpunan); 
y += lineGap;

drawRow(doc, x, y, "Asal Daerah", s.Asal_Daerah); y += lineGap;
drawRow(doc, x, y, "Kamar", s.Kamar); y += lineGap;

drawRow(doc, x, y, "Dewan Himpunan", s.himpunanDetail?.nama || "-");
y += lineGap;

drawRow(doc, x, y, "No. Kontak", s.himpunanDetail?.wa || "-");
y += lineGap;

drawRow(doc, x, y, "Nama Wali", s.Nama_Wali); y += lineGap;
drawRow(doc, x, y, "No. Kontak", s.No_Wali); y += lineGap + 6;


  // ================= DATA NDALEM =================
  sectionTitle(doc, "Ndalem", x, y);
  y += lineGap;
  
  drawRow(doc, x, y, "Unit Ndalem", s.Unit_Ndalem); y += lineGap;
  drawRow(doc, x, y, "Posisi Tugas", s.Posisi_Tugas); y += lineGap;
  drawRow(doc, x, y, "Shift", s.Shift); y += lineGap;
  drawRow(doc, x, y, "Jam Tugas", s.Jam_Tugas); y += lineGap;
  drawRow(doc, x, y, "Masa Khidmah", calculateMasaKhidmah(s.Mulai_Ngabdi)); y += lineGap; 
  drawRow(doc, x, y, "Kategori", s.Kategori); y += lineGap + 6;
  
  // ================= DATA NGAJI =================
  sectionTitle(doc, "Mengaji Al-qur'an", x, y);
  y += lineGap;

  drawRow(doc, x, y, "Tempat", s.ngaji?.tempat_ngaji); y += lineGap;
  drawRow(doc, x, y, "Kelas/Metode", s.ngaji?.Kelas_ngaji);

  const contentEndY = withPhoto
  ? Math.max(y, photoY + photoH)
  : y;

  const cardH = contentEndY - startY + 14;

  // ================= BORDIR LUAR (SETELAH ISI) =================
  doc.setDrawColor(0, 102, 204);
  doc.setLineWidth(0.8);
  doc.rect(marginX, startY, cardW, cardH);


  // ================= FOTO (DI DALAM BORDIR) =================
  
  if (withPhoto) {
  doc.setLineWidth(0.5);
  doc.rect(photoX, photoY, photoW, photoH);

  if (s.Foto) {
    try {
      const foto = await loadImageToBase64(s.Foto);
      if (foto?.base64) {
        doc.addImage(
          foto.base64,
          "PNG",
          photoX + 2,
          photoY + 2,
          photoW - 4,
          photoH - 4
        );
      }
    } catch {}
  }
}


  return startY + cardH + 18;
}


async function downloadSantriPDF() {
  const exportData = (lastFilteredData && lastFilteredData.length)
  ? lastFilteredData
  : allSantriData;

  if (!exportData.length) {
    alert("Tidak ada data!");
    return;
  }
 
  // ================= RANGE NOMOR =================
  const startInput = prompt("Mulai dari nomor berapa?", "1");
  if (startInput === null) return;

  const endInput = prompt("Sampai nomor berapa?", "");
  if (endInput === null) return;

  const startNo = parseInt(startInput) || 1;
  const endNo   = parseInt(endInput) || exportData.length;
  
  // ================= OPSI FOTO =================
	const withPhoto = confirm(
	  "Download PDF DENGAN FOTO?\n\nOK = Dengan Foto\nCancel = Tanpa Foto"
	);


  if (startNo < 1 || endNo < startNo || startNo > exportData.length) {
    alert("Nomor tidak valid");
    return;
  }

  let slicedData = exportData.slice(startNo - 1, endNo);
  
  slicedData = slicedData.filter(s => s.Status === "aktif");


  // ================= FILTER (CHECKBOX) =================
  const kelas = Array.from(
  document.querySelectorAll('#filterKelas input[type="checkbox"]:checked')
).map(cb => cb.value);

const unit = Array.from(
  document.querySelectorAll('#filterUnit input[type="checkbox"]:checked')
).map(cb => cb.value);


  // ðŸ”´ INI YANG SEBELUMNYA TIDAK ADA
  slicedData = slicedData.filter(s => {
    const okKelas = !kelas.length || kelas.includes(s.Kelas);
    const okUnit  = !unit.length  || unit.includes(s.Unit_Ndalem);
    return okKelas && okUnit;
  });

  if (!slicedData.length) {
    alert("Data kosong setelah difilter!");
    return;
  }
  

  // ================= PRELOAD RELASI =================
  const { data: guruList = [] } = await supabaseClient
    .from("data_guru")
    .select("Nama, Hp, Bagian, Kelas");

  const guruMap = {};
  guruList.forEach(g => {
    guruMap[`${g.Bagian}__${g.Kelas}`] = g;
  });

  const { data: himpunanList = [] } = await supabaseClient
    .from("himpunan")
    .select("himpunan, nama, wa");

  const himpunanMap = {};
  himpunanList.forEach(h => {
    himpunanMap[h.himpunan] = h;
  });

  // ================= ENRICH DATA =================
  const data = slicedData.map(s => ({
    ...s,
    guru: guruMap[`${s.Bagian}__${s.Kelas}`] || null,
    himpunanDetail: himpunanMap[s.Himpunan] || null
  }));

  // ================= INIT PDF =================
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("portrait", "pt", "a4");
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();

// ================= HEADER =================
try {
  const logo = await loadImageToBase64("https://i.imgur.com/Irgu32G.png");
  if (logo) doc.addImage(logo.base64, "PNG", 40, 40, 60, 60);
} catch {}

doc.setFont("helvetica", "bold");
doc.setFontSize(18);
doc.text("KHUDAMA' KHARISMA", pageW / 2, 60, { align: "center" });

doc.setFont("helvetica", "normal");
doc.setFontSize(13);
doc.text(
  "Pondok Pesantren Lirboyo Kota Kediri Jawa Timur",
  pageW / 2,
  80,
  { align: "center" }
);

// ðŸ‘‰ TAMBAHKAN INI
doc.setFont("helvetica", "italic");
doc.setFontSize(10);
doc.text(
  "Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri",
  pageW / 2,
  95,
  { align: "center" }
);

doc.setLineWidth(1);
doc.line(40, 110, pageW - 40, 110);


  // ================= JUDUL =================
  let y = FIRST_PAGE_START_Y;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("LAPORAN DATA SISWA LENGKAP", pageW / 2, y, { align: "center" });

  y += TITLE_TO_FILTER_GAP;

  // ================= FILTER TEXT (HALAMAN 1) =================
  if (unit.length || kelas.length) {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);

    const txt = [];
    if (unit.length)  txt.push(`Unit: ${unit.join(", ")}`);
    if (kelas.length) txt.push(`Kelas: ${kelas.join(", ")}`);

    doc.text(txt.join("   |   "), 40, y);
    y += 16;
  }

  // ================= ISI DATA =================
  for (let i = 0; i < data.length; i++) {
    if (i > 0) {
      doc.addPage();
      y = NEXT_PAGE_START_Y;
    }

    y = await drawSantriCard(
	  doc,
	  data[i],
	  startNo + i,
	  y,
	  { withPhoto }
	);

  }

// ==== FOOTER HALAMAN (RAPI & AMAN) ====
const pageCount = doc.internal.getNumberOfPages();

for (let i = 1; i <= pageCount; i++) {
  doc.setPage(i);

  // reset font & warna
  doc.setFont("helvetica", "normal");
  doc.setFontSize(9);
  doc.setTextColor(0, 0, 0);

  const footerY = pageH - 22;

  // garis footer
  doc.setDrawColor(200);
  doc.setLineWidth(0.5);
  doc.line(40, footerY - 10, pageW - 40, footerY - 10);

  // teks halaman (semua halaman)
  doc.text(
    `Halaman ${i} dari ${pageCount}`,
    pageW / 2,
    footerY,
    { align: "center" }
  );

  // admin (hanya halaman terakhir)
  if (i === pageCount) {
    doc.setFont("helvetica", "italic");
    doc.setFontSize(8);
    doc.setTextColor(120, 120, 120);

    doc.text(
      `Admin KHARISMA â€¢ ${new Date().toLocaleString("id-ID")}`,
      pageW - 40,
      footerY,
      { align: "right" }
    );

    doc.setTextColor(0, 0, 0);
  }
}


  
  // ==== SIMPAN FILE (DENGAN FILTER) ====
const filters = {};

if (unit.length)  filters.unit  = unit.join("-");
if (kelas.length) filters.kelas = kelas.join("-");

const filename = getExportFileName(
  "Laporan_Data_Siswa_Lengkap",
  "pdf",
  filters
);

doc.save(filename);

}



// ================= DOWNLOAD SANTRI PDF CUSTOM (Fix Filter Penasehat) =================
async function downloadSantriPDFCustom() {
  const exportData = (lastFilteredData && lastFilteredData.length)
  ? lastFilteredData
  : allSantriData;

  if (!exportData.length) return alert("Tidak ada data untuk diunduh!");

  const startInput = prompt("Mulai dari nomor berapa? (Kosongkan untuk mulai dari 1)", "1");
  if (startInput === null) return;
  const endInput = prompt("Sampai nomor berapa? (Kosongkan untuk semua)", "");
  if (endInput === null) return;

  let startNo = parseInt(startInput) || 1;
  let endNo = parseInt(endInput) || exportData.length;
  if (startNo < 1 || endNo < startNo || startNo > exportData.length) return alert("Nomor tidak valid!");

  const limitedData = exportData.slice(startNo - 1, endNo);
  
  // ===== FILTER SANTRI: HANYA STATUS AKTIF =====
	const filteredSantri = limitedData.filter(s =>
	  String(s.Status || "").toLowerCase() === "aktif"
	);


  const selectedUnit = Array.from(
	  document.querySelectorAll('#filterUnit input[type="checkbox"]:checked')
	).map(cb => cb.value);

	const selectedKelas = Array.from(
	  document.querySelectorAll('#filterKelas input[type="checkbox"]:checked')
	).map(cb => cb.value);


  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "pt", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let currentY = 130;

  // ==== HEADER ====
  try {
    const logoUrl = "https://i.imgur.com/Irgu32G.png";
    const logoData = await loadImageToBase64(logoUrl);
    if (logoData) doc.addImage(logoData.base64, "PNG", 40, 40, 60, 60);
  } catch (e) { console.warn("Logo gagal dimuat:", e); }

  doc.setFont("helvetica", "bold"); doc.setFontSize(20);
  doc.text("KHUDAMA' KHARISMA", pageWidth / 2, 55, { align: "center" });
  doc.setFont("helvetica", "normal"); doc.setFontSize(13);
  doc.text("Pondok Pesantren Lirboyo Kota Kediri Jawa Timur", pageWidth / 2, 75, { align: "center" });
  doc.setFont("helvetica", "italic"); doc.setFontSize(10);
  doc.text("Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri", pageWidth / 2, 95, { align: "center" });
  doc.setLineWidth(1);
  doc.line(40, 110, pageWidth - 40, 110);

  doc.setFont("helvetica", "bold"); 
  doc.setFontSize(15);
  doc.text("LAPORAN DATA PENASEHAT, SISWA & INVENTARIS", pageWidth / 2, 135, { align: "center" });

  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  if (selectedUnit.length || selectedKelas.length) {
  const info = [];
  if (selectedUnit.length) {
    info.push(`Unit: ${selectedUnit.join(", ")}`);
  }
  if (selectedKelas.length) {
    info.push(`Kelas: ${selectedKelas.join(", ")}`);
  }

  doc.text(info.join("   |   "), 40, 180);
  currentY = 200;
} else {
  currentY = 155;
}


  // ==== QUERY PENASEHAT (Status aktif + dapat bisyaroh) ====
  try {
    console.log("ðŸŸ¡ Menjalankan query penasehat (aktif + bisyaroh)...");
    const unitFilterName = selectedUnit.length === 1
  ? selectedUnit[0]
  : null;


    let query = supabaseClient
      .from("penasehat")
      .select("*, referensi_unit_ndalem(Nama_Unit)")
      .eq("Status", "aktif")
      .eq("Status_Bisyaroh", "dapat");

    if (unitFilterName && unitFilterName !== "semua") {
      query = query.eq("referensi_unit_ndalem.Nama_Unit", unitFilterName);
    }

    const { data: penasehatData, error } = await query;
    if (error) console.error("âŒ Error ambil penasehat:", error);

    const daftarPenasehat = (penasehatData || [])
    .filter(p => !unitFilterName || p.referensi_unit_ndalem?.Nama_Unit === unitFilterName)
    .sort((a, b) => {
      const dateA = a.Mulai_Ngabdi ? new Date(a.Mulai_Ngabdi) : null;
      const dateB = b.Mulai_Ngabdi ? new Date(b.Mulai_Ngabdi) : null;

      if (!dateA && !dateB) return 0;
      if (!dateA) return 1;
      if (!dateB) return -1;

      return dateA - dateB;
    });

    doc.setFont("helvetica", "normal"); doc.setFontSize(13);
    doc.text("Daftar Penasehat", 40, currentY);
    currentY += 5;

    if (daftarPenasehat.length === 0) {
      doc.setFont("helvetica", "italic"); doc.setFontSize(10);
      doc.text("(Tidak ada data penasehat)", pageWidth / 8.5, currentY + 15, { align: "center" }); 
      currentY += 40;
    } else {
      doc.autoTable({
        head: [["No", "Nama", "Organisasi", "Pengajar", "Mutakhorijin", "Masa Khidmah"]],
        body: daftarPenasehat.map((p, i) => [
          i + 1,
          p.Nama || "-",
          p.Status_Penasehat || "-",
          p.Status_Pengajar || "-",
          p.Mutakhorijin || "-",   
          calculateMasaKhidmah(p.Mulai_Ngabdi)
        ]),
        startY: currentY + 5,
        margin: { left: 40, right: 40 },
        tableWidth: "wrap",
        styles: { 
          fontSize: 9,
          halign: "center",
          valign: "middle",
          lineWidth: 0.5,
          lineColor: [0, 0, 0],
          cellPadding: 5,
          overflow: "linebreak",
          fillColor: [255, 255, 255],
          textColor: [0, 0, 0]
        },
        headStyles: { 
          fillColor: [0, 102, 204],
          textColor: [255, 255, 255],
          fontStyle: "bold",
          halign: "center",
          valign: "middle",
          lineWidth: 0.5,
          lineColor: [0, 0, 0]
        },
        bodyStyles: {
          fillColor: [255, 255, 255],
          textColor: [0, 0, 0],
          lineWidth: 0.5,
          lineColor: [0, 0, 0]
        },
        alternateRowStyles: { fillColor: [255, 255, 255] },
        columnStyles: {
          1: { halign: "left" },
		  2: { halign: "left" },
		  3: { halign: "left" },
        }
      });

      currentY = doc.lastAutoTable.finalY + 30;
    }
  } catch (err) {
    console.error("ðŸš¨ Gagal ambil data penasehat:", err);
  }
  
  // ==== TABEL SANTRI ====
  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);
  doc.text("Daftar Siswa", 40, currentY);
  currentY += 5;

  const headers = [
    "No","Foto","Nama","Kelas","Asal Daerah","Kategori","Usia",
    "Posisi Tugas","Shift","Jam Tugas","Masa Khidmah"
  ];

  const rows = await Promise.all(filteredSantri.map(async (s, i) => {

    let foto = null;
    if (s.Foto) {
      try { foto = await loadImageToBase64(s.Foto); } 
      catch (e) { console.warn("Gagal load foto:", s.Foto); }
    }
    return [
      i + 1,   
      foto,
      s.Nama_Lengkap || "-", s.Kelas || "-",s.Asal_Daerah || "-", s.Kategori || "-",calculateUsia(s.Tgl_Lahir),      
      s.Posisi_Tugas || "-", s.Shift || "-", s.Jam_Tugas || "-",      
      calculateMasaKhidmah(s.Mulai_Ngabdi)
    ];
  }));

  doc.autoTable({
    head: [headers],
    body: rows,
    startY: currentY + 5,
    margin: { left: 40, right: 40 },
    tableWidth: "wrap",
    scaleFactor: 0.99,

    styles: {
      fontSize: 9,
      halign: "center",
      valign: "middle",
      minCellHeight: 15,
      lineWidth: 0.5,
      lineColor: [0, 0, 0],
      cellPadding: 5,
      overflow: "linebreak",
      fillColor: [255, 255, 255],
      textColor: [0, 0, 0],
    },

    headStyles: {
      fillColor: [0, 102, 204],
      textColor: [255, 255, 255],
      fontStyle: "bold",
      halign: "center",
      valign: "middle",
      lineWidth: 0.6,
      lineColor: [0, 0, 0],
    },

    bodyStyles: {
      fillColor: [255, 255, 255],
      textColor: [0, 0, 0],
      lineWidth: 0.5,
      lineColor: [0, 0, 0],
    },

    alternateRowStyles: {
      fillColor: [255, 255, 255],
    },

    columnStyles: {
      0: { cellWidth: 25 },
      1: { cellWidth: 35 },
      2: { cellWidth: 100, halign: "left" },
      3: { cellWidth: 80 },
      4: { cellWidth: 80 },
      5: { cellWidth: 70 },
      6: { cellWidth: 70 },
      7: { cellWidth: 100 },
      8: { cellWidth: 50 },
      9: { cellWidth: 70 },
      10:{ cellWidth: 70 },
    },

    rowPageBreak: "avoid",

    willDrawCell(data) {
      if (data.section === "body" && data.column.index === 1) {
        data.cell.text = [""];
      }
    },

    didDrawCell(data) {
      if (data.section === "body" && data.column.index === 1) {
        const foto = data.cell.raw;
        if (foto && foto.base64) {
          const pad = 2;
          const cw = data.cell.width - pad * 2;
          const ch = data.cell.height - pad * 2;
          const ratio = Math.min(cw / foto.w, ch / foto.h);
          const nw = foto.w * ratio;
          const nh = foto.h * ratio;
          const x = data.cell.x + (data.cell.width - nw) / 2;
          const y = data.cell.y + (data.cell.height - nh) / 2;
          try {
            doc.addImage(foto.base64, "PNG", x, y, nw, nh);
          } catch {}
        }
      }
    },
  });

  // ==== FUNGSI CEK KETERSEDIAAN RUANG ====
  function cekRuangTersedia(tinggiTabelEstimasi) {
    const marginBawah = 50;
    const posisiSekarang = doc.lastAutoTable.finalY;
    return (posisiSekarang + tinggiTabelEstimasi + marginBawah) < pageHeight;
  }

  // ==== TABEL INVENTARIS UNIT (DENGAN NAMA PENANGGUNG JAWAB) ====
  try {
    const unitFilterName =
  selectedUnit.length === 1 ? selectedUnit[0] : null;


    if (unitFilterName && unitFilterName !== "semua") {
      const { data: unitRows } = await supabaseClient
        .from("referensi_unit_ndalem")
        .select("Kode_Unit")
        .eq("Nama_Unit", unitFilterName)
        .maybeSingle();

      const kodeUnit = unitRows?.Kode_Unit || null;

      if (kodeUnit) {
        const { data: invData } = await supabaseClient
          .from("inventaris")
          .select("*")
          .eq("Kode_Unit", kodeUnit);

        // Estimasi tinggi tabel inventaris unit
        const estimasiTinggiUnit = invData && invData.length > 0 ? 
          (invData.length * 20 + 100) : 50;

        // CEK APAKAH PERLU PINDAH HALAMAN BARU
        if (!cekRuangTersedia(estimasiTinggiUnit)) {
          doc.addPage();
          doc.lastAutoTable.finalY = 40; // Reset posisi Y di halaman baru
        }

        doc.setFont("helvetica", "normal");
        doc.setFontSize(13);
        doc.text("Daftar Inventaris Kendaraan", 40, doc.lastAutoTable.finalY + 30);

        if (!invData || invData.length === 0) {
          doc.setFont("helvetica", "italic");
          doc.setFontSize(10);
          doc.text("(Tidak ada inventaris kendaraan untuk unit ini)", 40, doc.lastAutoTable.finalY + 60);
        } else {
          const stambukList = invData
            .filter(r => r.Penanggung_Jawab_Tipe === "santri")
            .map(r => r.Penanggung_Jawab_ID);

          const penasehatList = invData
            .filter(r => r.Penanggung_Jawab_Tipe === "penasehat")
            .map(r => r.Penanggung_Jawab_ID);

          let santriMap = {};
          if (stambukList.length > 0) {
            const { data: santriRows } = await supabaseClient
              .from("santri_kharisma")
              .select("Stambuk, Nama_Lengkap")
              .in("Stambuk", stambukList);

            santriRows?.forEach(s => {
              santriMap[s.Stambuk] = s.Nama_Lengkap;
            });
          }

          let penasehatMap = {};
          if (penasehatList.length > 0) {
            const { data: penRows } = await supabaseClient
              .from("penasehat")
              .select("id_penasehat, Nama")
              .in("id_penasehat", penasehatList);

            penRows?.forEach(p => {
              penasehatMap[p.id_penasehat] = p.Nama;
            });
          }

          doc.autoTable({
            startY: doc.lastAutoTable.finalY + 40,
            head: [["No", "Jenis", "Merk", "NOPOL", "Tahun", "Keterangan", "STNK", "BPKB", "Penanggung Jawab", "Tanggal Pajak"]],
            body: invData.map((row, i) => {
              let pjName = "-";

              if (row.Penanggung_Jawab_Tipe === "santri") {
                pjName = santriMap[row.Penanggung_Jawab_ID] || "(Santri tidak ditemukan)";
              }
              if (row.Penanggung_Jawab_Tipe === "penasehat") {
                pjName = penasehatMap[row.Penanggung_Jawab_ID] || "(Penasehat tidak ditemukan)";
              }

              return [
                i + 1,
                row.Jenis_Kendaraan ?? "-",
                row.Merk ?? "-",
                row.NOPOL ?? "-",
				row.Tahun_Produksi ?? "-",
                row.Keterangan ?? "-",
                row.STNK ?? "-",
                row.BPKB ?? "-",
                pjName,
                formatTanggalDMY(row.Update_Tgl) ?? "-"
              ];
            }),

            margin: { left: 40, right: 40 },
            tableWidth: "wrap",

            styles: { 
              fontSize: 9,
              halign: "center",
              valign: "middle",
              lineWidth: 0.5,
              lineColor: [0, 0, 0],
              cellPadding: 5,
              overflow: "linebreak",
              fillColor: [255, 255, 255], 
              textColor: [0, 0, 0]
            },

            headStyles: { 
              fillColor: [0, 102, 204],
              textColor: [255, 255, 255],
              fontStyle: "bold",
              halign: "center",
              valign: "middle",
              lineWidth: 0.5,
              lineColor: [0, 0, 0]
            },

            bodyStyles: {
              fillColor: [255, 255, 255],
              textColor: [0, 0, 0],
              lineWidth: 0.5,
              lineColor: [0, 0, 0]
            },

            alternateRowStyles: { fillColor: [255, 255, 255] },

            columnStyles: {
              7: { halign: "left" },
              1: { halign: "left" },
              2: { halign: "left" },
              3: { halign: "left" }
            }
          });
        }
      }
    }
  } catch(e){
    console.error("Gagal membuat tabel inventaris:", e);
  }

  // ==== TABEL INVENTARIS HANDPHONE (FORMAT SERAGAM) ====
  try {
    const unitFilterName =
  selectedUnit.length === 1 ? selectedUnit[0] : null;


    if (unitFilterName && unitFilterName !== "semua") {
      const { data: unitRows } = await supabaseClient
        .from("referensi_unit_ndalem")
        .select("Kode_Unit")
        .eq("Nama_Unit", unitFilterName)
        .maybeSingle();

      const kodeUnit = unitRows?.Kode_Unit || null;

      if (kodeUnit) {
        const { data: hpData } = await supabaseClient
          .from("inventaris_handphone")
          .select("*")
          .eq("kode_unit", kodeUnit);

        // Estimasi tinggi tabel inventaris handphone
        const estimasiTinggiHP = hpData && hpData.length > 0 ? 
          (hpData.length * 20 + 100) : 50;

        // CEK APAKAH PERLU PINDAH HALAMAN BARU
        if (!cekRuangTersedia(estimasiTinggiHP)) {
          doc.addPage();
          doc.lastAutoTable.finalY = 40; // Reset posisi Y di halaman baru
        }

        doc.setFont("helvetica", "normal");
        doc.setFontSize(13);
        const hpTitleY = doc.lastAutoTable.finalY + 30;  
        doc.text("Daftar Inventaris Handphone", 40, hpTitleY);

        if (!hpData || hpData.length === 0) {
          doc.setFont("helvetica", "italic");
          doc.setFontSize(10);
          doc.text("(Tidak ada inventaris handphone untuk unit ini)", 40, doc.lastAutoTable.finalY + 50);
        } else {
          const stambukList = hpData
            .filter(r => r.penanggung_jawab_tipe === "santri")
            .map(r => r.penanggung_jawab_id);

          const penasehatList = hpData
            .filter(r => r.penanggung_jawab_tipe === "penasehat")
            .map(r => r.penanggung_jawab_id);

          let santriMap = {};
          if (stambukList.length > 0) {
            const { data: santriRows } = await supabaseClient
              .from("santri_kharisma")
              .select("Stambuk, Nama_Lengkap")
              .in("Stambuk", stambukList);

            santriRows?.forEach(s => {
              santriMap[s.Stambuk] = s.Nama_Lengkap;
            });
          }

          let penasehatMap = {};
          if (penasehatList.length > 0) {
            const { data: penRows } = await supabaseClient
              .from("penasehat")
              .select("id_penasehat, Nama")
              .in("id_penasehat", penasehatList);

            penRows?.forEach(p => {
              penasehatMap[p.id_penasehat] = p.Nama;
            });
          }

          doc.autoTable({
            startY: hpTitleY + 10,
            head: [["No", "Merk", "IMEI", "No. Kontak", "Penanggung Jawab"]],
            body: hpData.map((row, i) => {
              let pjName = "-";

              if (row.penanggung_jawab_tipe === "santri") {
                pjName = santriMap[row.penanggung_jawab_id] || "(Santri tidak ditemukan)";
              }

              if (row.penanggung_jawab_tipe === "penasehat") {
                pjName = penasehatMap[row.penanggung_jawab_id] || "(Penasehat tidak ditemukan)";
              }

              return [
                i + 1,
                row.merk ?? "-",
                row.imei ?? "-",
                row.no_kontak ?? "-",
                pjName
              ];
            }),

            margin: { left: 40, right: 40 },
            tableWidth: "wrap",

            styles: {
              fontSize: 9,
              halign: "center",
              valign: "middle",
              cellPadding: 4,
              lineWidth: 0.5,
              lineColor: [0,0,0],
              fillColor: [255,255,255],
              textColor: [0,0,0],
            },

            headStyles: {
              fillColor: [0,102,204],
              textColor: [255,255,255],
              fontStyle: "bold",
              halign: "center",
              valign: "middle",
              lineWidth: 0.5,
              lineColor: [0,0,0],
            },

            bodyStyles: {
              fillColor: [255,255,255],
              textColor: [0,0,0],
              lineWidth: 0.5,
              lineColor: [0,0,0]
            },

            alternateRowStyles: {
              fillColor: [255,255,255]
            },

            columnStyles: {
              4: { halign: "left" }
            }
          });
        }
      }
    }
  } catch (e) {
    console.error("Gagal membuat tabel inventaris handphone:", e);
  }

  // ==== FOOTER HALAMAN ====
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFont("helvetica", "normal"); doc.setFontSize(9);
    doc.text(`Halaman ${i} dari ${pageCount}`, pageWidth / 2, pageHeight - 20, { align: "center" });
    if (i === pageCount) {
      doc.setFont("helvetica", "italic");
      doc.setTextColor(120);
      doc.text(`Admin â€“ Simponi Kharisma â€“ ${new Date().toLocaleString("id-ID")}`,
        pageWidth - 40, pageHeight - 20, { align: "right" });
      doc.setTextColor(0);
    }
  }

  // ==== SIMPAN FILE ====
  const filters = {};
  const filename = getExportFileName(`Laporan_Unit`, "pdf", filters);
  doc.save(filename);
}


function formatTanggalDMY(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  if (isNaN(d)) return "-";

  const bulan = [
    "Januari","Februari","Maret","April","Mei","Juni",
    "Juli","Agustus","September","Oktober","November","Desember"
  ];

  const dd = String(d.getDate()).padStart(2, "0");
  const mm = bulan[d.getMonth()];
  const yyyy = d.getFullYear();

  return `${dd} ${mm} ${yyyy}`;
}





// ====== Dropdown Options ======
function loadKelasOptions(selected = "") {
  const kelasSelect = document.getElementById("Kelas");
  kelasSelect.innerHTML = "";

  // default option
  const def = document.createElement("option");
  def.value = "";
  def.textContent = "-- Pilih Kelas --";
  kelasSelect.appendChild(def);

  // isi dari kelasOrder
  kelasOrder.forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = k;
    if (k === selected) o.selected = true;
    kelasSelect.appendChild(o);
  });

  // fallback kalau data lama tidak ada di kelasOrder
  if (selected && !kelasOrder.includes(selected)) {
    const extra = document.createElement("option");
    extra.value = selected;
    extra.textContent = selected + " (lama)";
    extra.selected = true;
    kelasSelect.appendChild(extra);
  }
}

async function loadUnitNdalemOptions(selected = "") {
  try {
    const { data, error } = await supabaseClient
      .from("santri_kharisma")
      .select("Unit_Ndalem")
      .order("Unit_Ndalem", { ascending: true });

    if (error) throw error;

    const unitSelect = document.getElementById("Unit_Ndalem");
    unitSelect.innerHTML = "";

    // default option
    const def = document.createElement("option");
    def.value = "";
    def.textContent = "-- Pilih Unit --";
    unitSelect.appendChild(def);

    // unik & urut abjad
    const unitSet = new Set();
    data.forEach(row => {
      if (row.Unit_Ndalem) unitSet.add(row.Unit_Ndalem.trim());
    });

    Array.from(unitSet).sort().forEach(u => {
      const o = document.createElement("option");
      o.value = u;
      o.textContent = u;
      if (u === selected) o.selected = true;
      unitSelect.appendChild(o);
    });

    // fallback kalau data lama tidak ada di list
    if (selected && !unitSet.has(selected)) {
      const extra = document.createElement("option");
      extra.value = selected;
      extra.textContent = selected + " (lama)";
      extra.selected = true;
      unitSelect.appendChild(extra);
    }
  } catch (err) {
    console.error("Gagal load Unit Ndalem:", err.message);
  }
}

// ====== Buka Modal Tambah ======
async function openAddSantri() {
  document.getElementById("santriModalTitle").textContent = "Tambah Santri";
  document.getElementById("santriForm").reset();
  document.getElementById("santriId").value = "";
  document.getElementById("fotoPreview").style.display = "none";

  loadKelasOptions();           // default kosong
  await loadUnitNdalemOptions();// default kosong

  document.getElementById("santriModal").style.display = "block";
}

// ====== Buka Modal Edit ======
async function openEditSantri(id) {
  document.getElementById("santriModalTitle").textContent = "Edit Santri";
  document.getElementById("santriId").value = id;

  const s = allSantriData.find(x => x.id === id);
  if (!s) return alert("âŒ Data tidak ditemukan");

  loadKelasOptions(s.Kelas || "");
  await loadUnitNdalemOptions(s.Unit_Ndalem || "");

  [
    "Nama_Lengkap","Bagian","Stambuk","Stambuk_Ndalem","Kode_Unit",
    "Asal_Daerah","Himpunan","Kamar","Tgl_Lahir","Mulai_Ngabdi","Tgl_Keluar",
    "Status","Posisi_Tugas","Jam_Tugas","Shift","Foto"
  ].forEach(f => {
    if (document.getElementById(f)) {
      document.getElementById(f).value = s[f] || "";
    }
  });

  // foto preview
  if (s.Foto) {
    document.getElementById("fotoPreview").src = s.Foto;
    document.getElementById("fotoPreview").style.display = "block";
  } else {
    document.getElementById("fotoPreview").style.display = "none";
  }

  document.getElementById("santriModal").style.display = "block";
}

// ====== Tutup Modal ======
function closeSantriModal() {
  document.getElementById("santriModal").style.display = "none";
}

// ====== Simpan (Tambah / Edit) - ONE robust handler ======
document.getElementById("santriForm").onsubmit = async function(e) {
  e.preventDefault();

  // helper sleep
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  try {
    const idRaw = document.getElementById("santriId").value;
    const id = idRaw ? String(idRaw) : null;

    // kumpulkan form data
    const formData = {};
    [
      "Nama_Lengkap","Kelas","Bagian","Stambuk","Stambuk_Ndalem","Unit_Ndalem","Kode_Unit",
      "Asal_Daerah","Himpunan","Kamar","Tgl_Lahir","Mulai_Ngabdi","Tgl_Keluar",
      "Status","Posisi_Tugas","Jam_Tugas","Shift","Foto"
    ].forEach(f => {
      const el = document.getElementById(f);
      formData[f] = el ? (el.value?.trim() || null) : null;
    });

    // validasi wajib
    if (!formData.Nama_Lengkap) throw new Error("Nama lengkap wajib diisi!");
    if (!formData.Kelas) throw new Error("Kelas wajib dipilih!");
    if (!formData.Unit_Ndalem) throw new Error("Unit Ndalem wajib dipilih!");

    // lakukan save ke Supabase (pakai select('*').single() agar kita dapat data lengkap kembali)
    let savedData = null;
    if (id) {
      const { data, error } = await supabaseClient
        .from("santri_kharisma")
        .update(formData)
        .eq("id", id)
        .select("*")
        .single();

      if (error) throw error;
      savedData = data;
      lastEditedId = Number(data.id);
    } else {
      const { data, error } = await supabaseClient
        .from("santri_kharisma")
        .insert([formData])
        .select("*")
        .single();

      if (error) throw error;
      savedData = data;
      lastEditedId = Number(data.id);
    }

    // update memori (allSantriData) langsung supaya UI bisa menampilkan instan
    if (!Array.isArray(window.allSantriData)) window.allSantriData = [];
    const idx = window.allSantriData.findIndex(s => String(s.id) === String(lastEditedId));
    if (idx >= 0) {
      window.allSantriData[idx] = savedData;
    } else {
      window.allSantriData.push(savedData);
    }

    // tutup modal & tampilkan toast sukses
    closeSantriModal();
    showToast("âœ… Data berhasil disimpan!", "success");

    // beri jeda 2 detik supaya toast terlihat
    await sleep(2000);

    // tampilkan loading dan sinkronisasi ulang (fetch terbaru)
    try {
      showLoading(true);
      await loadInitialData();   // loadInitialData async â€” akan mengembalikan ketika selesai
      // setelah sinkron ulang, refresh tampilan
      filterSantri();
    } catch (syncErr) {
      console.error("Sync error setelah simpan:", syncErr);
      // tetap jalankan filter agar data lokal tetap tampil
      filterSantri();
      showToast("âš ï¸ Sinkronisasi gagal, data lokal sudah diperbarui.", "error");
    } finally {
      showLoading(false);
    }

    // scroll ke baris yang baru disimpan (jika ada di tabel data)
    setTimeout(() => {
      const activeTab = document.querySelector('.tab-item.active')?.dataset.tab;
      if (activeTab === "data" && lastEditedId) {
        const row = document.querySelector(`tr[data-id='${lastEditedId}']`);
        if (row) row.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }, 300);

  } catch (err) {
    console.error("Gagal simpan:", err);
    showToast("âŒ Gagal simpan: " + (err.message || err), "error");
  }
};


// === Preview Foto ===
function previewFoto() {
  const url = document.getElementById("Foto").value.trim();
  const preview = document.getElementById("fotoPreview");
  if (url && (url.endsWith(".jpg") || url.endsWith(".jpeg") || url.endsWith(".png") || url.endsWith(".gif") || url.startsWith("http"))) {
    preview.src = url;
    preview.style.display = "block";
  } else {
    preview.style.display = "none";
  }
}

// ========== HAPUS ==========
async function removeSantri(id) {
  if (!confirm("Yakin hapus data ini?")) return;

  const { error } = await supabaseClient.from("santri_kharisma").delete().eq("id", id);
  if (error) {
    alert("âŒ Gagal hapus: " + error.message);
  } else {
    alert("âœ… Data dihapus!");
    lastEditedId = null;

    await loadInitialData();
    filterSantri();
  }
}

// === Isi datalist dari allSantriData ===
function populateSuggestions() {
  const fields = [
    { key: "Nama_Lengkap", listId: "listNama" },
    { key: "Bagian", listId: "listBagian" },
    { key: "Asal_Daerah", listId: "listDaerah" },
    { key: "Himpunan", listId: "listHimpunan" },
    { key: "Kamar", listId: "listKamar" }
  ];

  fields.forEach(f => {
    const datalist = document.getElementById(f.listId);
    if (!datalist) return;

    const values = [...new Set((allSantriData || []).map(s => s[f.key]).filter(Boolean))];
    datalist.innerHTML = values.map(v => `<option value="${v}"></option>`).join("");
  });
}

// === Fuzzy match sederhana ===
function fuzzyMatch(query, str) {
  query = query.toLowerCase();
  str = str.toLowerCase();
  let qi = 0, si = 0;
  while (qi < query.length && si < str.length) {
    if (query[qi] === str[si]) qi++;
    si++;
  }
  return qi === query.length;
}

function getUniqueValues(field) {
  return [...new Set((allSantriData || []).map(s => s[field]).filter(Boolean))];
}

// === Autocomplete fuzzy untuk input tertentu ===
function setupAutocomplete(inputId, field) {
  const input = document.getElementById(inputId);
  if (!input) return;

  const wrapper = document.createElement("div");
  wrapper.className = "autocomplete-wrapper";
  input.parentNode.insertBefore(wrapper, input);
  wrapper.appendChild(input);

  const listBox = document.createElement("div");
  listBox.className = "autocomplete-list";
  wrapper.appendChild(listBox);

  input.addEventListener("input", () => {
    const val = input.value.trim();
    listBox.innerHTML = "";
    if (!val) return;

    const candidates = getUniqueValues(field);
    const matches = candidates.filter(c => fuzzyMatch(val, c));

    matches.slice(0, 10).forEach(m => {
      const item = document.createElement("div");
      item.className = "autocomplete-item";
      item.textContent = m;
      item.onclick = () => {
        input.value = m;
        listBox.innerHTML = "";
      };
      listBox.appendChild(item);
    });
  });

  document.addEventListener("click", (e) => {
    if (!wrapper.contains(e.target)) {
      listBox.innerHTML = "";
    }
  });
}

// === Inisialisasi setelah data di-load ===
function initSantriAutocomplete() {
  setupAutocomplete("Posisi_Tugas", "Posisi_Tugas");
  setupAutocomplete("Jam_Tugas", "Jam_Tugas");
  setupAutocomplete("Shift", "Shift");
}
// === Notifikasi Toast ===
function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = "toast-message " + (type === "error" ? "error" : "");
  toast.textContent = message;
  document.body.appendChild(toast);
  // insert delay supaya transisi CSS berjalan
  setTimeout(() => toast.classList.add("show"), 50);
  setTimeout(() => toast.classList.remove("show"), 2500);
  setTimeout(() => toast.remove(), 2800);
}

async function handleDownloadSantri(type) {
  // Pilih tombol sesuai jenis
  const btn = type === 'pdf' ? document.getElementById('btnSantriPDF')
            : type === 'pdfcustom' ? document.getElementById('btnSantriCustom')
            : document.getElementById('btnSantriHTML');

  // Simpan label asli
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> Sedang mengunduh...`;

  try {
    if (type === 'pdf') {
      await downloadSantriPDF();           // ðŸ”¹ versi full A3
    } else if (type === 'pdfcustom') {
      await downloadSantriPDFCustom();     // ðŸ”¹ versi custom A4
    } else {
      await downloadSantriHTML();          // ðŸ”¹ versi HTML lama
    }
  } catch (err) {
    console.error("Download error:", err);
    alert("Gagal download: " + err.message);
  } finally {
    // Kembalikan tampilan tombol
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

async function handleDownloadAbsensiMerahPDF() {
  const btn = document.getElementById('btnDownloadAbsensiMerahPDF');
  const originalHTML = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> Sedang mengunduh...`;

  try {
    await downloadAbsensiMerahTrendPDF(); // ðŸ”¹ fungsi asli milikmu
  } catch (err) {
    console.error("Download error:", err);
    alert("Gagal download: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}


async function handleDownloadNilai() {
  const btn = document.getElementById('btnNilaiDownload');
  const format = document.getElementById('downloadFormat').value;

  // Simpan tampilan asli
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> Sedang mengunduh...`;

  try {
    if (format === "pdf") {
      await downloadNilaiPDF();   // fungsi download PDF nilai
    } else {
      await downloadNilaiHTML();  // fungsi download HTML nilai
    }
  } catch (err) {
    console.error("Download error:", err);
    alert("Gagal download: " + err.message);
  } finally {
    // Kembalikan tombol
    btn.disabled = false;
    btn.innerHTML = originalHTML;
  }
}

// === Load Unit ke <select> ===
async function loadUnitOptions(targetId = "Kode_Unit_inventaris", preselect = "") {
  try {
    let data = window.allUnitData;

    if (!Array.isArray(data) || data.length === 0) {
      const { data: fetched, error } = await supabaseClient
        .from("referensi_unit_ndalem")
        .select("Kode_Unit, Nama_Unit")
        .order("Nama_Unit", { ascending: true });

      if (error) throw error;
      data = fetched || [];
      window.allUnitData = data;

      try { await saveToDB("referensi_unit_ndalem", data); }
      catch (e) { console.warn("Gagal cache referensi_unit_ndalem:", e); }
    }

    const el = document.getElementById(targetId);
    if (!el || !(el instanceof HTMLSelectElement)) return data;

    el.innerHTML = '<option value="">-- Pilih Unit --</option>';
    data.forEach((u) => {
      const opt = document.createElement("option");
      opt.value = u.Kode_Unit;
      opt.textContent = u.Nama_Unit;
      el.appendChild(opt);
    });

    if (preselect && Array.from(el.options).some(o => o.value === preselect)) {
      el.value = preselect;
    }

    return data;
  } catch (err) {
    console.error("Gagal load unit:", err);
    return [];
  }
}

// === Load Penanggung Jawab (Santri + Penasehat) ===
async function loadPenanggungJawabOptions(unitKode, targetId = "Penanggung_Jawab", preselect = null) {
  try {
    if (!unitKode) return;

    let namaUnit = null;
    if (window.allUnitData) {
      const found = window.allUnitData.find(u => u.Kode_Unit === unitKode);
      namaUnit = found ? found.Nama_Unit : null;
    }

    const { data: santri, error: err1 } = await supabaseClient
      .from("santri_kharisma")
      .select("Stambuk, Nama_Lengkap, Unit_Ndalem")
      .eq("Unit_Ndalem", namaUnit)
      .order("Nama_Lengkap", { ascending: true });
    if (err1) throw err1;

    const { data: penasehat, error: err2 } = await supabaseClient
      .from("penasehat")
      .select("id_penasehat, Nama, Kode_Unit")
      .eq("Kode_Unit", unitKode)
      .order("Nama", { ascending: true });
    if (err2) throw err2;

    const select = document.getElementById(targetId);
    if (!select) return;
    select.innerHTML = '<option value="">-- Pilih Penanggung Jawab --</option>';

    santri.forEach(s => {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ tipe: "santri", id: s.Stambuk });
      opt.textContent = `[Santri] ${s.Nama_Lengkap}`;
      select.appendChild(opt);
    });

    penasehat.forEach(p => {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ tipe: "penasehat", id: p.id_penasehat });
      opt.textContent = `[Penasehat] ${p.Nama}`;
      select.appendChild(opt);
    });

    if (preselect) {
      let targetValue = null;
      try {
        if (typeof preselect === "object" && preselect.tipe && preselect.id) {
          targetValue = JSON.stringify(preselect);
        } else if (typeof preselect === "string" && preselect.trim().startsWith("{")) {
          targetValue = preselect;
        } else {
          const foundOpt = Array.from(select.options).find(opt => {
            try { return String(JSON.parse(opt.value).id) === String(preselect); }
            catch { return false; }
          });
          if (foundOpt) targetValue = foundOpt.value;
        }
      } catch (err) {
        console.warn("Preselect error:", err);
      }
      if (targetValue && Array.from(select.options).some(o => o.value === targetValue)) {
        select.value = targetValue;
      }
    }
  } catch (err) {
    console.error("Gagal load Penanggung Jawab:", err);
  }
}

document.getElementById("Kode_Unit_inventaris").addEventListener("change", (e) => {
  loadPenanggungJawabOptions(e.target.value, "Penanggung_Jawab");
});

// Ganti fungsi renderTable yang ada dengan versi ini
function renderTable(tableId, rows, columns) {
  const table = document.getElementById(tableId);
  if (!table) return console.warn('renderTable: element not found', tableId);

  // kosongkan dulu
  table.innerHTML = '';

  if (!rows || rows.length === 0) {
    // buat tbody kosong dengan pesan
    const wrapper = document.createElement('div');
    wrapper.innerHTML = '<table class="data-table"><tbody><tr><td colspan="' + (columns.length + 1) + '">Tidak ada data</td></tr></tbody></table>';
    table.appendChild(wrapper.firstElementChild);
    return;
  }

  // buat elemen table (DOM-based, bukan string)
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');

  // kolom No
  const thNo = document.createElement('th');
  thNo.textContent = 'No';
  trHead.appendChild(thNo);

  columns.forEach(col => {
    const th = document.createElement('th');
    th.style.cursor = 'pointer';
    th.textContent = col.label ?? col.key;

    // (jika fungsi sort diimplementasikan di state table, pertahankan)
    th.addEventListener('click', () => {
      // jika ada state sort di table, gunakan; fallback sederhana: sort by key
      try {
        if (!table._sortState) table._sortState = { key: col.key, asc: true };
        if (table._sortState.key === col.key) table._sortState.asc = !table._sortState.asc;
        else { table._sortState.key = col.key; table._sortState.asc = true; }

        rows.sort((a,b) => {
          let va = a[col.key] ?? '';
          let vb = b[col.key] ?? '';
          if (typeof va === 'string') va = va.toLowerCase();
          if (typeof vb === 'string') vb = vb.toLowerCase();
          if (va < vb) return table._sortState.asc ? -1 : 1;
          if (va > vb) return table._sortState.asc ? 1 : -1;
          return 0;
        });

        // rerender
        renderTable(tableId, rows, columns);
      } catch (e) {
        console.error('renderTable: sort error', e);
      }
    });

    trHead.appendChild(th);
  });

  thead.appendChild(trHead);
  table.appendChild(thead);

  // body
  const tbody = document.createElement('tbody');

  rows.forEach((row, index) => {
    const tr = document.createElement('tr');

    const tdNo = document.createElement('td');
    tdNo.textContent = index + 1;
    tr.appendChild(tdNo);

    columns.forEach(col => {
      const td = document.createElement('td');

      try {
        // Prioritas: col.render(row) -> col.format(value,row) -> row[col.key] -> '-'
        if (typeof col.render === 'function') {
          const out = col.render(row);

          // jika render mengembalikan elemen DOM, append langsung
          if (out instanceof Element) {
            td.appendChild(out);
          } else if (typeof out === 'string') {
            // string bisa berupa HTML (tombol), gunakan innerHTML
            td.innerHTML = out;
          } else if (out == null || out === '') {
            td.textContent = '-';
          } else {
            td.textContent = String(out);
          }

        } else if (typeof col.format === 'function') {
          const formatted = col.format(row[col.key], row);
          if (formatted instanceof Element) td.appendChild(formatted);
          else if (typeof formatted === 'string' && /<[^>]+>/.test(formatted)) td.innerHTML = formatted;
          else td.textContent = (formatted == null || formatted === '') ? '-' : formatted;
        } else {
          const value = row[col.key];
          td.textContent = (value == null || value === '') ? '-' : value;
        }
      } catch (e) {
        console.error('renderTable: error formatting column', e);
        td.textContent = row[col.key] ?? '-';
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // ganti/append tbody (jaga element table bila sudah ada)
  // jika table sudah diisi thead langsung (kita buat di atas), append tbody
  table.appendChild(tbody);
}



/* === Load Inventaris dari Supabase (manual join, PascalCase, clean) === */
async function loadInventaris() {
  showLoading(true);
  try {
    // 1) Ambil inventaris
    const { data: inv, error: errInv } = await supabaseClient
      .from("inventaris")
      .select("id, Kode_Unit, Jenis_Kendaraan, Merk, NOPOL, Tahun_Produksi, Keterangan, STNK, BPKB, Update_Tgl, Penanggung_Jawab_Tipe, Penanggung_Jawab_ID");

    if (errInv) throw errInv;
    if (!inv || inv.length === 0) {
      showError("Tidak ada data Inventaris");
      return;
    }

    // 2) Ambil santri & penasehat
    const [{ data: santri }, { data: penasehat }] = await Promise.all([
      supabaseClient.from("santri_kharisma").select("Stambuk, Nama_Lengkap, Unit_Ndalem"),
      supabaseClient.from("penasehat").select("id_penasehat, Nama, Kode_Unit")
    ]);

    // 3) Ambil referensi unit
    const { data: unitData } = await supabaseClient
      .from("referensi_unit_ndalem")
      .select("Kode_Unit, Nama_Unit");

    // 4) Mapping inventaris + join manual
    const mapped = inv.map(row => {
      const rawDate = row.Update_Tgl || null;
      let isoDate = "";
      if (rawDate) {
        const d = new Date(rawDate);
        if (!isNaN(d)) isoDate = d.toISOString().split("T")[0];
      }

      // cari unit
      const unit = unitData?.find(u => u.Kode_Unit === row.Kode_Unit);

      // cari penanggung jawab (nama saja untuk tabel)
      let pjText = "-";
      if (row.Penanggung_Jawab_Tipe === "santri") {
        const s = santri?.find(x => String(x.Stambuk) === String(row.Penanggung_Jawab_ID));
        if (s) pjText = s.Nama_Lengkap;
      } else if (row.Penanggung_Jawab_Tipe === "penasehat") {
        const p = penasehat?.find(x => String(x.id_penasehat) === String(row.Penanggung_Jawab_ID));
        if (p) pjText = p.Nama;
      }

      return {
        id: row.id,
        Kode_Unit: row.Kode_Unit ?? "",
        Nama_Unit: unit?.Nama_Unit ?? "-",
        Jenis_Kendaraan: row.Jenis_Kendaraan ?? "-",
        Merk: row.Merk ?? "-",
        NOPOL: row.NOPOL ?? "-",
		Tahun_Produksi: row.Tahun_Produksi ?? "-",
        Penanggung_Jawab: pjText, // nama saja di tabel
        Penanggung_Jawab_Tipe: row.Penanggung_Jawab_Tipe || null,
        Penanggung_Jawab_ID: row.Penanggung_Jawab_ID || null,
        Keterangan: row.Keterangan ?? "-",
        STNK: row.STNK ?? "-",
        BPKB: row.BPKB ?? "-",
        Update_Tgl_display: formatDate(rawDate),
        Update_Tgl_iso: isoDate
      };
    });
	
	// 4b) Urutkan default by Nama_Unit ASC
	mapped.sort((a, b) => a.Nama_Unit.localeCompare(b.Nama_Unit));
	
	// 5) Buat ringkasan
	const summary = {
	  layak: mapped.filter(x => x.Keterangan?.toLowerCase() === "layak").length,
	  tidakLayak: mapped.filter(x => x.Keterangan?.toLowerCase() === "tidak layak").length,

	  stnkHidup: mapped.filter(x => x.STNK?.toLowerCase() === "hidup").length,
	  stnkMati: mapped.filter(x => x.STNK?.toLowerCase() === "mati").length,
	  stnkTidakAda: mapped.filter(x => x.STNK?.toLowerCase() === "tidak ada" || !x.STNK || x.STNK === "-").length,

	  bpkbNdalem: mapped.filter(x => x.BPKB?.toLowerCase() === "ndalem").length,
	  bpkbUnit: mapped.filter(x => x.BPKB?.toLowerCase() === "unit").length,
	  bpkbTidakAda: mapped.filter(x => x.BPKB?.toLowerCase() === "tidak ada" || !x.BPKB || x.BPKB === "-").length,
	};

	// 6) Render ringkasan ke HTML
	const summaryEl = document.getElementById("inventaris-summary");
	if (summaryEl) {
	  summaryEl.innerHTML = `
		<div class="inventaris-summary-box">
		  <strong>Keterangan:</strong> Layak: ${summary.layak}, Tidak Layak: ${summary.tidakLayak}<br>
		  <strong>STNK:</strong> Hidup: ${summary.stnkHidup}, Mati: ${summary.stnkMati}, Tidak Ada: ${summary.stnkTidakAda}<br>
		  <strong>BPKB:</strong> Ndalem: ${summary.bpkbNdalem}, Unit: ${summary.bpkbUnit}, Tidak Ada: ${summary.bpkbTidakAda}
		</div>
	  `;
	}


    await saveToDB("inventaris", mapped);
    renderTable("inventaris-table", mapped, getInventarisCols());

  } catch (err) {
    const cached = await getFromDB("inventaris");
    if (cached && cached.length > 0) {
      renderTable("inventaris-table", cached, getInventarisCols());
    } else {
      showError("Tidak ada data Inventaris offline.");
    }
  } finally {
    showLoading(false);
  }
}


/* === Kolom Inventaris (PascalCase) === */
function getInventarisCols() {
  const userRole = localStorage.getItem("userRole") || "user";

  const cols = [
    { key: "Nama_Unit", label: "Unit Ndalem" },
    { key: "Jenis_Kendaraan", label: "Jenis" },
    { key: "Merk", label: "Merk" },
    { key: "NOPOL", label: "NOPOL" },
	{ key: "Tahun_Produksi", label: "Tahun" },
    { key: "Penanggung_Jawab", label: "Penanggung Jawab" },
    { key: "Keterangan", label: "Keterangan" },
    { key: "STNK", label: "STNK" },
    { key: "BPKB", label: "BPKB" },
    { key: "Update_Tgl_display", label: "Tanggal Pajak" }
  ];

  if (userRole === "admin") {
    cols.push({
      key: "Aksi",
      label: "Aksi",
      format: (v, row) => {
        const safeRow = encodeURIComponent(JSON.stringify(row));
        return `
          <button class="crud-btn-save" data-row="${safeRow}" onclick="handleEditInventaris(this)">âœï¸</button>
          <button class="crud-btn-cancel" onclick='deleteInventaris("${row.id}")'>ðŸ—‘ï¸</button>
        `;
      }
    });
  }

  return cols;
}



/* === Simpan Offline ke IndexedDB === */
async function saveToDB(storeName, data) {
  const db = await dbPromise;
  if (!db.objectStoreNames.contains(storeName)) return;

  const tx = db.transaction(storeName, 'readwrite');
  const store = tx.objectStore(storeName);

  for (const item of data) {
    if (!item.id) {
      item.id = crypto.randomUUID(); // fallback id
    }
    try {
      await store.put(item);
    } catch (e) {
      console.warn(`saveToDB: gagal simpan ke ${storeName}`, e);
    }
  }

  await tx.done;
}

/* === Hapus Inventaris === */
async function deleteInventaris(id) {
  if (!id) return showToast("ID Inventaris tidak valid", true);
  if (!confirm("Yakin hapus data inventaris ini?")) return;

  try {
    const { error } = await supabaseClient
      .from("inventaris")
      .delete()
      .eq("id", id);

    if (error) throw error;

    // hapus cache IndexedDB
    try {
      const db = await dbPromise;
      const tx = db.transaction("inventaris", "readwrite");
      tx.objectStore("inventaris").delete(id);
      await tx.done;
    } catch (e) {
      console.warn("IndexedDB delete gagal:", e);
    }

    showToast("Data inventaris berhasil dihapus");
    loadInventaris();
  } catch (err) {
    console.error("Gagal hapus inventaris:", err);
    showToast("Gagal hapus data inventaris", true);
  }
}

/* === Edit Inventaris === */
function handleEditInventaris(btn) {
  try {
    const raw = btn.getAttribute("data-row");
    if (!raw) throw new Error("data-row kosong");
    const row = JSON.parse(decodeURIComponent(raw));
    openEditInventaris(row);
  } catch (e) {
    console.error("Gagal parse row inventaris:", e);
    showToast("Error membuka data inventaris", true);
  }
}
/* === Handler Edit Inventaris === */
async function openEditInventaris(row) {
  document.getElementById("inventarisModalTitle").textContent = "Edit Inventaris";
  document.getElementById("inventarisId").value = row.id || '';

  // isi dropdown Unit
  await loadUnitOptions("Kode_Unit_inventaris", row.Kode_Unit || "");

  // isi dropdown Penanggung Jawab
  await loadPenanggungJawabOptions(
    row.Kode_Unit,
    "Penanggung_Jawab",
    { tipe: row.Penanggung_Jawab_Tipe, id: row.Penanggung_Jawab_ID }
  );

  // isi input lain
  document.getElementById("Jenis_Kendaraan").value = row.Jenis_Kendaraan || "";
  document.getElementById("Merk").value = row.Merk || "";
  document.getElementById("NOPOL").value = row.NOPOL || "";
  document.getElementById("Tahun_Produksi").value = row.Tahun_Produksi || "";
  document.getElementById("Keterangan").value = row.Keterangan || "";
  document.getElementById("STNK").value = row.STNK || "";
  document.getElementById("BPKB").value = row.BPKB || "";
  document.getElementById("Update_Tgl").value = row.Update_Tgl_iso || "";

  document.getElementById("inventarisModal").style.display = "block";
}

/* === Handler Tambah Inventaris === */
async function openAddInventaris() {
  document.getElementById("inventarisModalTitle").textContent = "Tambah Inventaris";
  document.getElementById("inventarisForm").reset();
  document.getElementById("inventarisId").value = "";

  // isi dropdown Unit
  await loadUnitOptions("Kode_Unit_inventaris", "");
  document.getElementById("Kode_Unit_inventaris").value = "";

  // kosongkan dropdown penanggung jawab
  const pjSelect = document.getElementById("Penanggung_Jawab");
  pjSelect.innerHTML = '<option value="">-- Pilih Penanggung Jawab --</option>';

  document.getElementById("inventarisModal").style.display = "block";
}



/* === Submit Form Inventaris === */
document.getElementById("inventarisForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const hiddenId = document.getElementById("inventarisId").value; // id PK
  const selectUnit = document.getElementById("Kode_Unit_inventaris");
  const selectedKode = selectUnit ? selectUnit.value : null;
  const pjSelect = document.getElementById("Penanggung_Jawab");
  let pjData = pjSelect && pjSelect.value ? JSON.parse(pjSelect.value) : null;

  const payload = {
    Kode_Unit: selectedKode || null,
    Jenis_Kendaraan: document.getElementById("Jenis_Kendaraan").value?.trim() || null,
    Merk: document.getElementById("Merk").value?.trim() || null,
    NOPOL: document.getElementById("NOPOL").value?.trim() || null,
	Tahun_Produksi: document.getElementById("Tahun_Produksi").value?.trim() || null,
    Keterangan: document.getElementById("Keterangan").value?.trim() || null,
    STNK: document.getElementById("STNK").value?.trim() || null,
    BPKB: document.getElementById("BPKB").value?.trim() || null,
    Update_Tgl: document.getElementById("Update_Tgl").value || null,
    Penanggung_Jawab_Tipe: pjData ? pjData.tipe : null,
    Penanggung_Jawab_ID: pjData ? pjData.id : null
  };  

  try {
    if (hiddenId) {
      const { error } = await supabaseClient
        .from("inventaris")
        .update(payload)
        .eq("id", hiddenId); // pakai id PK
      if (error) throw error;
      showToast("Inventaris berhasil diupdate");
    } else {
      const { error } = await supabaseClient
        .from("inventaris")
        .insert([payload]);
      if (error) throw error;
      showToast("Inventaris berhasil ditambahkan");
    }

    closeInventarisModal();
    loadInventaris();
  } catch (err) {
    console.error("Gagal simpan inventaris:", err);
    showToast("Gagal simpan inventaris", true);
  }
});

/* === Tutup Modal Inventaris === */
function closeInventarisModal() {
  const modal = document.getElementById("inventarisModal");
  if (modal) modal.style.display = "none";
}

// ================= DOWNLOAD PENASEHAT PDF =================
async function downloadPenasehatPDF() {
  try {
    const exportData = (penasehatFiltered?.length ? penasehatFiltered : allPenasehatData) || [];
    if (!exportData.length) return alert("Tidak ada data Penasehat untuk diunduh!");

    const { jsPDF } = window.jspdf;
    if (!jsPDF) return alert("Library jsPDF belum ter-load.");

    // === A4 landscape ===
    const pdf = new jsPDF("l", "pt", "a4");
    if (typeof pdf.autoTable !== "function") {
      return alert("Plugin jspdf-autotable belum terpasang.");
    }

    const pageWidth  = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin     = 40;
    const today      = new Date();

    // ==== Kop (logo + identitas) ====
    try {
      const logoUrl = "https://i.imgur.com/Irgu32G.png";
      const logoData = await loadImageToBase64(logoUrl);
      if (logoData?.base64 || logoData) {
        const img = logoData.base64 || logoData;
        pdf.addImage(img, "PNG", 40, 40, 60, 60);
      }
    } catch (e) { console.warn("Logo gagal dimuat:", e); }

    pdf.setFont("helvetica", "bold"); pdf.setFontSize(22);
    pdf.text("KHUDAMA' KHARISMA", pageWidth / 2, 60, { align: "center" });

    pdf.setFont("helvetica", "normal"); pdf.setFontSize(14);
    pdf.text("Pondok Pesantren Lirboyo Kota Kediri Jawa Timur", pageWidth / 2, 80, { align: "center" });

    pdf.setFont("helvetica", "italic"); pdf.setFontSize(11);
    pdf.text("Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri", pageWidth / 2, 100, { align: "center" });

    pdf.setLineWidth(1);
    pdf.line(margin, 120, pageWidth - margin, 120);

    // ==== Judul ====
    let y = 150;
    pdf.setFont("helvetica", "bold"); pdf.setFontSize(16);
    pdf.text("LAPORAN DATA PENASEHAT", pageWidth / 2, y, { align: "center" });
    y += 18;

    // ==== Tabel ====
    const headers = ["No","Nama","Organisasi","Pengajar","Unit Ndalem","Mutakhorijin","Masa Khidmah","Hp"];
    const rows = exportData.map((p, i) => {
      const masa = (typeof calculateMasaKhidmah === "function") ? calculateMasaKhidmah(p.Mulai_Ngabdi) : (p.Mulai_Ngabdi || "-");
      const unitName = (p.referensi_unit_ndalem?.Nama_Unit) || p.Kode_Unit || "-";
      return [
        i + 1,
        p.Nama || "-",
        p.Status_Penasehat || "-",
        p.Status_Pengajar || "-",
        unitName,
        p.Mutakhorijin || "-",
        masa,
        p.Hp || "-"
      ];
    });

    pdf.autoTable({
      head: [headers],
      body: rows,
      startY: y,
      theme: "grid",
      styles: { fontSize: 9, halign: "left", valign: "middle" }, // isi rata kiri
      headStyles: { halign: "center", fillColor: [26,115,232], textColor: 255 }, // header rata tengah
      alternateRowStyles: { fillColor: [240,246,255] },
      margin: { left: margin, right: margin },
      tableWidth: pageWidth - margin * 2,
    });

    // ==== Footer hanya di halaman terakhir ====
    const totalPages = pdf.internal.getNumberOfPages();
    pdf.setFont("helvetica", "italic");
    pdf.setFontSize(9);
    pdf.setTextColor(120);
    pdf.setPage(totalPages);
    pdf.text(
      `Admin â€“ Simponi Kharisma â€“ ${today.toLocaleDateString("id-ID")} ${today.toLocaleTimeString("id-ID")}`,
      pageWidth - margin,
      pageHeight - 20,
      { align: "right" }
    );
    pdf.setTextColor(0);

    // ==== Nama file ====
    const filename = (typeof getExportFileName === "function")
      ? getExportFileName("Penasehat", "pdf", {})
      : `Penasehat_${today.toISOString().replace(/[:T]/g,"-").split(".")[0]}.pdf`;

    pdf.save(filename);

  } catch (err) {
    console.error("âŒ Gagal export Penasehat PDF:", err);
    alert("Terjadi kesalahan saat membuat PDF Penasehat. Cek console.");
  }
}

// ====================== MODUL INFORMASI ======================

// Fungsi bantu: cek apakah angka
function isNumberLike(val) {
  return typeof val === "number" || (!isNaN(parseFloat(val)) && isFinite(val));
}

// ðŸ”¹ Load Dropdown Tahun Ajaran
async function loadDropdownOptions() {
  const tahunDropdown = document.getElementById("filterTahunAjaran");
  if (!tahunDropdown) return;

  tahunDropdown.innerHTML = '<option value="">Semua Tahun Ajaran</option>';

  try {
    // Ambil data tahun_ajaran dari nilai1 dan absensi1
    const [{ data: d1, error: e1 }, { data: d2, error: e2 }] = await Promise.all([
      supabaseClient.from("nilai1").select("tahun_ajaran").not("tahun_ajaran", "is", null),
      supabaseClient.from("absensi1").select("tahun_ajaran").not("tahun_ajaran", "is", null),
    ]);

    if (e1) console.warn("warn load nilai1 tahun_ajaran:", e1);
    if (e2) console.warn("warn load absensi1 tahun_ajaran:", e2);

    const arrAll = [...(d1 || []), ...(d2 || [])]
      .map((r) => r.tahun_ajaran)
      .filter(Boolean);

    // Normalisasi format (hapus spasi di sekitar "-")
    function normalize(s) {
      return s
        .replace(/\s*-\s*/g, " - ")
        .replace(/\s+/g, " ")
        .trim();
    }

    const normalizedMap = new Map();
    for (const raw of arrAll) {
      const norm = normalize(raw);
      if (!normalizedMap.has(norm)) normalizedMap.set(norm, raw);
    }

    const tahunArr = Array.from(normalizedMap.keys());

    // Sort berdasarkan akhir tahun (desc)
    function parseYearKey(s) {
      const m = s.match(/(20\d{2})(?:[^\d]+(20\d{2}))?/);
      if (m) return Number(m[2] || m[1]);
      const h = s.match(/(14\d{2})(?:[^\d]+(14\d{2}))?/);
      if (h) return Number(h[2] || h[1]) - 500;
      return 0;
    }

    tahunArr.sort((a, b) => parseYearKey(b) - parseYearKey(a));

    tahunArr.forEach((norm) => {
      const orig = normalizedMap.get(norm);
      const opt = document.createElement("option");
      opt.value = orig;
      opt.textContent = norm;
      tahunDropdown.appendChild(opt);
    });
  } catch (err) {
    console.error("Gagal load dropdown tahun ajaran:", err);
  }
}


async function renderAbsensiChart() {
  console.log("ðŸ“Š Memuat data tren absen merah gabungan...");

  const { data, error } = await supabaseClient
    .from("absensi_merah_tren_gabungan")
    .select("bulan, status_tren, jumlah");

  if (error) {
    console.error("âŒ Gagal ambil data tren:", error);
    return;
  }
  
  if (!data?.length) {
    console.warn("âš ï¸ Tidak ada data tren absen merah ditemukan.");
    return;
  }

  // ðŸ” Gunakan urutan global agar sama dengan tabel PDF
  const bulanAbsensi = Array.isArray(window.AB_TREND_MONTHS)
    ? window.AB_TREND_MONTHS
    : [
        "Syawal", "Dzulqo'dah", "Dzulhijjah",
        "Muharam", "Shofar", "Robi'ul Awal", "Robi'ul Akhir",
        "Jumadal Ula", "Jumadal Tsaniyah", "Rajab", "Sya'ban"
      ];

  const statusList = ["Baru Merah", "Masih Merah", "Membaik"];

  // ðŸ”„ Filter dan urutkan bulan
  const bulanList = bulanAbsensi.filter(b => data.some(d => d.bulan === b));

  // ðŸ”¢ Group data dengan nilai default 0
  const groupedData = statusList.reduce((acc, status) => {
    acc[status] = bulanList.map(bulan => {
      const item = data.find(
        item => item.bulan === bulan && 
        item.status_tren.trim().toLowerCase() === status.toLowerCase()
      );
      return item ? Number(item.jumlah) : 0;
    });
    return acc;
  }, {});

  // ðŸ”µ Hitung total merah (baru + masih)
  const totalMerah = bulanList.map((_, index) => 
    (groupedData["Baru Merah"][index] || 0) + 
    (groupedData["Masih Merah"][index] || 0)
  );
  
  // âœ… Tambahkan di sini
  const isPortraitMobile = window.innerWidth < 700 && window.innerHeight > window.innerWidth;

  const xAxisLabelOptions = isPortraitMobile
    ? {
        interval: 0,
        fontSize: 11,
        color: '#334155',
        formatter: function (value, index) {
          return index % 2 === 0 ? `{top|${value}}` : `\n{bottom|${value}}`;
        },
        rich: {
          top: { padding: [0, 0, 6, 0] },
          bottom: { padding: [6, 0, 0, 0] }
        }
      }
    : {
        interval: 0,
        fontSize: 12,
        color: '#334155'
      };

  // === RENDER CHART MODERN ===
  const chartDom = document.getElementById("absensiChartCanvas");
  
  // Hapus chart lama jika ada
  if (window.absensiChartInstance) {
    window.absensiChartInstance.dispose();
  }
  
  const chart = echarts.init(chartDom);
  // ðŸ” Deteksi orientasi (portrait/landscape)
	function isPortraitMode() {
	  return window.innerWidth < 700 && window.innerHeight > window.innerWidth;
	}

	// ðŸ” Update label bulan dengan animasi halus
	function updateXAxisLabelsSmooth(chartInstance) {
	  const portrait = isPortraitMode();
	  const xAxisLabelOptions = portrait
		? {
			interval: 0,
			fontSize: 11,
			color: '#334155',
			formatter: function (value, index) {
			  return index % 2 === 0 ? `{top|${value}}` : `\n{bottom|${value}}`;
			},
			rich: {
			  top: { padding: [0, 0, 6, 0] },
			  bottom: { padding: [6, 0, 0, 0] }
			}
		  }
		: {
			interval: 0,
			fontSize: 12,
			color: '#334155'
		  };

	  const option = chartInstance.getOption();

	  // Terapkan label baru dengan transisi halus
	  chartInstance.setOption(
		{
		  xAxis: [
			{
			  ...option.xAxis[0],
			  axisLabel: xAxisLabelOptions,
			},
		  ],
		  animationDurationUpdate: 600, // durasi transisi
		  animationEasingUpdate: 'cubicOut',
		},
		false
	  );

	  // Resize grafik dengan sedikit delay agar posisi stabil
	  clearTimeout(window._resizeTimeout);
	  window._resizeTimeout = setTimeout(() => {
		chartInstance.resize();
	  }, 1200);
	}

  window.absensiChartInstance = chart;

  // Warna sesuai permintaan
  const colors = {
    baruMerah: '#ff6b6b',      // Merah muda (parah)
    masihMerah: '#c92a2a',     // Merah tua (sangat parah)
    membaik: '#40c057',        // Hijau
    total: '#800000'           // Maroon tua
  };

  // Konfigurasi chart modern
  const option = {
    animation: {
      duration: 1200,
      easing: 'cubicOut'
    },
    grid: {
      left: '3%',
      right: '3%',
      bottom: '15%',
      top: '15%',
      containLabel: true
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      },
      backgroundColor: 'rgba(255,255,255,0.95)',
      borderColor: '#e2e8f0',
      borderWidth: 1,
      borderRadius: 8,
      shadowBlur: 10,
      shadowColor: 'rgba(0,0,0,0.1)',
      textStyle: {
        color: '#1e293b',
        fontSize: 12
      },
      formatter: function (params) {
        const bulan = params[0].name;
        let content = `<div class="font-semibold text-sm mb-2" style="color: #1e293b;">${bulan}</div>`;
        
        params.forEach(param => {
          const icon = param.seriesType === 'line' ? 'ðŸ”´' : 
                      param.color === colors.baruMerah ? 'ðŸŸ ' :
                      param.color === colors.masihMerah ? 'ðŸ”´' : 'ðŸŸ¢';
          content += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 4px 0;">
              <span style="color: #475569;">${icon} ${param.seriesName}</span>
              <span style="font-weight: 600; margin-left: 16px; color: #1e293b;">${param.value}</span>
            </div>
          `;
        });
        
        return content;
      }
    },
    legend: {
      top: 0,
      type: 'scroll',
      textStyle: {
        color: '#475569',
        fontSize: 11
      },
      itemGap: 20,
      pageTextStyle: {
        color: '#64748b'
      }
    },
    xAxis: [
	  {
		type: 'category',
		data: bulanList,
		axisLabel: xAxisLabelOptions,
		axisLine: { lineStyle: { color: '#e2e8f0' } },
		axisTick: { alignWithLabel: true, lineStyle: { color: '#e2e8f0' } }
	  },
      {
        // Axis kedua untuk garis pemisah antar bulan
        type: 'category',
        data: bulanList,
        position: 'bottom',
        axisLine: {
          show: false
        },
        axisTick: {
          // Garis pemisah antar bulan
          alignWithLabel: true,
          length: 30,
          lineStyle: {
            color: '#cbd5e1',
            type: 'dashed',
            width: 1
          },
          interval: 0
        },
        axisLabel: {
          show: false
        },
        splitLine: {
          show: false
        }
      }
    ],
    yAxis: {
      type: 'value',
      minInterval: 1,
      axisLabel: {
        color: '#64748b',
        fontSize: 11
      },
      axisLine: {
        show: false
      },
      axisTick: {
        show: false
      },
      splitLine: {
        lineStyle: {
          color: '#f1f5f9',
          type: 'solid'
        }
      }
    },
    series: [
	  {
		name: 'Baru Merah',
		type: 'bar',
		color: colors.baruMerah,   // âœ… tambahkan ini
		barWidth: 20,
		data: groupedData["Baru Merah"].map(value => ({
		  value,
		  itemStyle: { color: colors.baruMerah }
		})),
		itemStyle: {
		  borderRadius: [4, 4, 0, 0],
		  borderWidth: 0
		},
		label: {
		  show: true,
		  position: 'top',
		  distance: 8,
		  color: colors.baruMerah,
		  fontWeight: 'bold',
		  fontSize: 10,
		  formatter: '{c}'
		},
		emphasis: {
		  itemStyle: {
			shadowColor: 'rgba(255,107,107,0.3)',
			shadowBlur: 8
		  }
		}
	  },
	  {
		name: 'Masih Merah',
		type: 'bar',
		color: colors.masihMerah,   // âœ… tambahkan ini
		barWidth: 20,
		data: groupedData["Masih Merah"].map(value => ({
		  value,
		  itemStyle: { color: colors.masihMerah }
		})),
		itemStyle: {
		  borderRadius: [4, 4, 0, 0],
		  borderWidth: 0
		},
		label: {
		  show: true,
		  position: 'top',
		  distance: 8,
		  color: colors.masihMerah,
		  fontWeight: 'bold',
		  fontSize: 10,
		  formatter: '{c}'
		},
		emphasis: {
		  itemStyle: {
			shadowColor: 'rgba(201,42,42,0.3)',
			shadowBlur: 8
		  }
		}
	  },
	  {
		name: 'Membaik',
		type: 'bar',
		color: colors.membaik,   // âœ… tambahkan ini
		barWidth: 20,
		data: groupedData["Membaik"].map(value => ({
		  value,
		  itemStyle: { color: colors.membaik }
		})),
		itemStyle: {
		  borderRadius: [4, 4, 0, 0],
		  borderWidth: 0
		},
		label: {
		  show: true,
		  position: 'top',
		  distance: 8,
		  color: colors.membaik,
		  fontWeight: 'bold',
		  fontSize: 10,
		  formatter: '{c}'
		},
		emphasis: {
		  itemStyle: {
			shadowColor: 'rgba(64,192,87,0.3)',
			shadowBlur: 8
		  }
		}
	  },
	  {
		name: 'Total Absen Merah',
		type: 'line',
		smooth: true,
		symbol: 'circle',
		symbolSize: 8,
		color: colors.total,   // âœ… biarkan tetap di sini
		data: totalMerah.map(value => ({
		  value,
		  itemStyle: { color: colors.total }
		})),
		lineStyle: {
		  color: colors.total,
		  width: 3,
		  shadowColor: 'rgba(128,0,0,0.3)',
		  shadowBlur: 8
		},
		itemStyle: {
		  color: colors.total,
		  borderColor: '#ffffff',
		  borderWidth: 2
		},
		label: {
		  show: true,
		  position: 'top',
		  distance: 15,
		  color: colors.total,
		  fontWeight: 'bold',
		  fontSize: 10,
		  backgroundColor: 'rgba(255,255,255,0.9)',
		  borderColor: colors.total,
		  borderWidth: 1,
		  borderRadius: 4,
		  padding: [2, 4],
		  formatter: '{c}'
		},
		z: 5,
		emphasis: {
		  scale: true,
		  itemStyle: {
			borderWidth: 3,
			shadowColor: 'rgba(128,0,0,0.5)',
			shadowBlur: 12
		  }
		}
	  }
	]

  };

  chart.setOption(option);
  
  // ðŸ’¡ Jalankan pertama kali
  updateXAxisLabelsSmooth(chart);

  // ðŸ”„ Dengarkan event resize / rotasi layar
  window.addEventListener('resize', () => {
    updateXAxisLabelsSmooth(chart);
  });


  // Responsive
  const handleResize = () => chart.resize();
  window.addEventListener('resize', handleResize);

  // ðŸ§¾ Ringkasan cepat bulan terakhir dengan warna baru
  const lastIndex = bulanList.length - 1;
  const summaryHTML = `
    <div class="flex flex-wrap gap-4 justify-center text-sm">
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded" style="background-color: ${colors.baruMerah}"></span>
        Baru Merah: <strong>${groupedData["Baru Merah"][lastIndex] || 0}</strong>
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded" style="background-color: ${colors.masihMerah}"></span>
        Masih Merah: <strong>${groupedData["Masih Merah"][lastIndex] || 0}</strong>
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded" style="background-color: ${colors.membaik}"></span>
        Membaik: <strong>${groupedData["Membaik"][lastIndex] || 0}</strong>
      </span>
      <span class="flex items-center gap-1">
        <span class="w-3 h-3 rounded" style="background-color: ${colors.total}"></span>
        Total: <strong>${totalMerah[lastIndex] || 0}</strong>
      </span>
    </div>
  `;
  
  const summaryElement = document.getElementById("absensiTrendSummary");
  if (summaryElement) {
    summaryElement.innerHTML = summaryHTML;
  }

  console.log("âœ… Grafik tren absen merah modern berhasil dirender.");
}

// Tambahan CSS untuk styling yang lebih modern
const modernStyles = `
  #absensiChartCanvas {
    border-radius: 12px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  
  .absensi-trend-summary {
    background: white;
    border-radius: 8px;
    padding: 12px 16px;
    margin-top: 16px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid #e2e8f0;
  }
`;

// Inject styles
if (!document.querySelector('#absensi-chart-styles')) {
  const styleSheet = document.createElement('style');
  styleSheet.id = 'absensi-chart-styles';
  styleSheet.textContent = modernStyles;
  document.head.appendChild(styleSheet);
}


// panggil fungsi ini setiap kali modal dibuka
function openAbsensiChart() {
  document.getElementById('absensiChartModal').style.display = 'block';
  setTimeout(() => renderAbsensiChart(), 150); // beri jeda kecil agar modal sudah tampil
}

function closeAbsensiChart() {
  document.getElementById('absensiChartModal').style.display = 'none';
}

// Event listener untuk close button
document.addEventListener('DOMContentLoaded', function() {
  const closeBtn = document.querySelector('#absensiChartModal .close-btn');
  const modal = document.getElementById('absensiChartModal');
  
  if (closeBtn) {
    closeBtn.addEventListener('click', closeAbsensiChart);
  }
  
  // Close modal ketika klik di luar content
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeAbsensiChart();
      }
    });
  }
  
  // Close dengan ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.style.display === 'block') {
      closeAbsensiChart();
    }
  });
});

function getAbsensiChartHTML() {
  console.log("ðŸŸ¦ [getAbsensiChartHTML] Dipanggil");

  // pastikan instance sudah dibuat saat renderAbsensiChart()
  const chartInstance = window.absensiChartInstance;
  if (!chartInstance) {
    console.warn("âš ï¸ Belum ada instance grafik (window.absensiChartInstance kosong)");
    return "";
  }

  try {
    // ambil gambar dari instance
    const imgData = chartInstance.getDataURL({
      type: "png",
      pixelRatio: 2,
      backgroundColor: "#ffffff"
    });

    console.log("ðŸ“Š Panjang base64 chart:", imgData.length);

    const htmlChart = `
      <div style="text-align:center; margin:25px 0;">
        <h3 style="font-size:12px; color:#ef4444; margin-bottom:6px;">
          Grafik Absensi Merah per Bulan
        </h3>
        <img src="${imgData}" alt="Grafik Absensi Merah"
             style="width:90%; max-width:700px; border:1px solid #ccc; border-radius:6px;">
      </div>
    `;

    console.log("âœ… [getAbsensiChartHTML] Chart siap disisipkan");
    return htmlChart;
  } catch (err) {
    console.error("âŒ Gagal ambil dataURL grafik:", err);
    return "";
  }
}

// ====== Constants & helpers ======
const AB_TREND_MONTHS = ['Syawal','Dzulqo\'dah','Dzulhijjah','Muharam','Shofar',"Robi'ul Awal","Robi'ul Akhir","Jumadal Ula","Jumadal Tsaniyah","Rajab","Sya'ban"];

function monthIndex(bulan) {
  const i = AB_TREND_MONTHS.indexOf(bulan);
  return i === -1 ? 999 : i;
}
function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

async function fetchAbsensiMerahTrenDetail() {
  if (window._cachedAbsensiMerahTrend && (Date.now() - window._cachedAbsensiMerahTrend._ts < 1000*60*3)) {
    return window._cachedAbsensiMerahTrend.rows;
  }

  try {
    const allData = [];
    let from = 0;
    const limit = 1000;

    while (true) {
      const { data, error } = await supabaseClient
        .rpc('get_absensi_merah_tren_detail', {}, { count: 'exact' })
        .range(from, from + limit - 1);

      if (error) throw error;
      if (!data || data.length === 0) break;
      allData.push(...data);
      if (data.length < limit) break;
      from += limit;
    }

    console.log(`âœ… RPC get_absensi_merah_tren_detail memuat ${allData.length} record`);
    window._cachedAbsensiMerahTrend = { rows: allData, _ts: Date.now() };
    return allData;

  } catch (err) {
    console.error('fetchAbsensiMerahTrenDetail RPC error', err);
    showError && showError('Gagal memuat trend absen merah: ' + (err.message || err));
    return [];
  }
}

// --- SATU DEFINISI TUNGAL: show/hide Trend Absensi Merah (Gunakan class 'active') ---
function showAbsensiMerahTrendModule() { 
  // 1) sembunyikan MAIN GRID (jika ada)
  const mainGrid = document.getElementById('main-grid');
  if (mainGrid) mainGrid.style.display = 'none';

  // 2) sembunyikan semua module-container aktif (bersihkan class active)
  document.querySelectorAll('.module-container.active').forEach(m => {
    m.classList.remove('active');
  });

  // 3) jika ada inline style display:block dari implementasi lain, hapus juga
  document.querySelectorAll('.module-container').forEach(m => {
    m.style.display = ''; // kosongkan inline display supaya CSS .active yang mengatur
  });

  // 4) tampilkan modul target dengan class active
  const trendModule = document.getElementById('absensi-merah-trend-module');
  if (!trendModule) {    
    return;
  }
  trendModule.classList.add('active');
  trendModule.scrollTop = 0;

  // 5) render data jika fungsi tersedia (log jika error)
  if (typeof renderAbsensiMerahTrend === 'function') {
    try {
      renderAbsensiMerahTrend(1);      
    } catch (err) {      
    }
  } else {    
  }
}

function hideAbsensiMerahTrendModule() {
  // sembunyikan detail trend
  const trendModule = document.getElementById('absensi-merah-trend-module');
  if (trendModule) {
    trendModule.classList.remove('active');
    trendModule.style.display = ''; // bersihkan inline just in case
  }

  // tampilkan modul absensi utama (jika ada)
  const absensiModule = document.getElementById('absensi-module');
  if (absensiModule) {
    // sembunyikan modul lain dulu
    document.querySelectorAll('.module-container.active').forEach(m => m.classList.remove('active'));
    absensiModule.classList.add('active');
  } else {
    // kalau tidak ada absensi-module, tampilkan main grid
    const mainGrid = document.getElementById('main-grid');
    if (mainGrid) mainGrid.style.display = 'grid';
  }
}



// ====== Core: render grid grouped by student ======
async function renderAbsensiMerahTrend(page = 1) {
  const PAGE_SIZE = 20;
  const container = document.getElementById('absensiMerahTrendContainer');
  const paginationEl = document.getElementById('absensiMerahTrendPagination');
  container.innerHTML = '<div class="small-note">Memuat dataâ€¦</div>';

  try {
    const allRows = await fetchAbsensiMerahTrenDetail(); // data RPC yang sudah lengkap
    // group by stambuk
    const groups = {};
    for (const r of allRows) {
      const s = r.stambuk || r.stambuk?.toString?.() || '#unknown';
      groups[s] = groups[s] || {        
        nama: r.nama_lengkap || '',
        unit: r.unit_ndalem || '',
        bagian: r.bagian || r.bagian_santri || '-',  // jika ada kolom bagian
        kelas: r.kelas || r.kelas_santri || '-',
        foto: r.foto || r.foto_santri || '',          // kalau ada URL foto di view/relasi
        months: {},
        anyMerah: false,
        lastStatus: null,
        lastTanpa: 0,
      };
      groups[s].months[r.bulan] = {
        tanpa_izin: Number(r.tanpa_izin || 0),
        status_tren: r.status_tren || 'Normal',
        bulan_urut: Number(r.bulan_urut || 0),
      };
      if (Number(r.tanpa_izin || 0) >= 3) groups[s].anyMerah = true;
      if (!groups[s].lastMonth || (Number(r.bulan_urut || 0) >= (groups[s].lastMonth || 0))) {
        groups[s].lastMonth = Number(r.bulan_urut || 0);
        groups[s].lastStatus = r.status_tren;
        groups[s].lastTanpa = Number(r.tanpa_izin || 0);
      }
    }

    // filter: hanya santri yg pernah merah
    let items = Object.values(groups).filter(g => g.anyMerah);

    // filter tambahan (masih merah)
    const onlyStill = document.getElementById('trendOnlyMasihMerah')?.checked;
    if (onlyStill) {
      items = items.filter(g => ['Baru Merah', 'Masih Merah'].includes(g.lastStatus));
    }

    // pencarian
    const q = (document.getElementById('trendSearch')?.value || '').trim().toLowerCase();
    if (q) items = items.filter(g => (g.stambuk + ' ' + g.nama + ' ' + g.unit + ' ' + g.kelas).toLowerCase().includes(q));

    // urut
    items.sort((a, b) => {
	  const idxA = kelasOrder.indexOf(a.kelas);
	  const idxB = kelasOrder.indexOf(b.kelas);
	  if (idxA !== -1 && idxB !== -1 && idxA !== idxB) return idxA - idxB;
	  if (idxA !== -1 && idxB === -1) return -1;
	  if (idxA === -1 && idxB !== -1) return 1;
	  return (a.unit || '').localeCompare(b.unit || '') || (a.nama || '').localeCompare(b.nama || '');
	});

    const total = items.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    const start = (page - 1) * PAGE_SIZE;
    const pageItems = items.slice(start, start + PAGE_SIZE);

    // buat tabel
    const table = document.createElement('table');
    table.className = 'trend-table';

    // === header ===
    const thead = document.createElement('thead');
    let headHtml = `
      <tr>
        <th>No.</th>      
        <th>Foto</th>
        <th>Nama</th>
        <th>Kelas</th>
        <th>Bagian</th>
        <th>Unit Ndalem</th>
    `;
    for (const m of AB_TREND_MONTHS) {
      headHtml += `<th>${escapeHtml(m)}</th>`;
    }
    headHtml += `<th>Status</th></tr>`;
    thead.innerHTML = headHtml;
    table.appendChild(thead);

    // === body ===
    const tbody = document.createElement('tbody');
    pageItems.forEach((g, idx) => {
      const tr = document.createElement('tr');
      let fotoCell = '-';
      if (g.foto) {
        fotoCell = `<img src="${escapeHtml(g.foto)}" alt="foto">`;
      }
      let rowHtml = `
        <td>${start + idx + 1}</td>     
        <td>${fotoCell}</td>
        <td style="text-align:left;">${escapeHtml(g.nama)}</td>
        <td>${escapeHtml(g.kelas)}</td>
        <td>${escapeHtml(g.bagian)}</td>
        <td>${escapeHtml(g.unit)}</td>
      `;
      for (const m of AB_TREND_MONTHS) {
        const cell = g.months[m];
        if (!cell) {
          rowHtml += `<td>-</td>`;
        } else {
          const ti = Number(cell.tanpa_izin || 0);
          const st = cell.status_tren || 'Normal';
          let cls = '';
          if (st === 'Baru Merah') cls = 'trend-cell-baru';
          if (st === 'Masih Merah') cls = 'trend-cell-masih';
          if (st === 'Membaik') cls = 'trend-cell-membaik';
          if (ti >= 3 && !cls) cls = 'trend-cell-merah';
          rowHtml += `<td class="${cls}" title="${escapeHtml(st)}">${ti >= 3 ? `<b>${ti}</b> ðŸ”´` : ti}</td>`;
        }
      }
      const lastLabel = `${escapeHtml(g.lastStatus || '')}`;
      rowHtml += `<td>${escapeHtml(lastLabel)}</td>`;
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);

    // tampilkan tabel
    container.innerHTML = '';
    container.appendChild(table);

    // pagination
    let pgHtml = `<div style="margin-bottom:6px;">Menampilkan ${Math.min(total, start + 1)} - ${Math.min(total, start + PAGE_SIZE)} dari ${total} santri</div>`;
    pgHtml += '<div class="pagination-controls">';
    if (page > 1) pgHtml += `<button onclick="renderAbsensiMerahTrend(${page - 1})">â€¹ Prev</button>`;
    for (let p = 1; p <= totalPages; p++) {
      if (totalPages > 9 && p > 1 && p < totalPages && Math.abs(p - page) > 3) {
        if (p === page - 4) pgHtml += ' <span>...</span> ';
        continue;
      }
      pgHtml += ` <button ${p === page ? 'class="active"' : ''} onclick="renderAbsensiMerahTrend(${p})">${p}</button> `;
    }
    if (page < totalPages) pgHtml += `<button onclick="renderAbsensiMerahTrend(${page + 1})">Next â€º</button>`;
    pgHtml += '</div>';
    paginationEl.innerHTML = pgHtml;
  } catch (err) {
    console.error('renderAbsensiMerahTrend error', err);
    container.innerHTML = '<div class="small-note">Gagal memuat data trend absen merah.</div>';
  }
}

// ===================== FINAL FIX: downloadAbsensiMerahTrendPDF (dengan urutan kelas) =====================
async function downloadAbsensiMerahTrendPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
	  orientation: "landscape",
	  unit: "pt",
	  format: [935, 612] // F4 ukuran landscape (tinggi jadi lebar)
	});

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const marginX = 40;
  let currentY = 130;
  
  // ==== STATUS TOMBOL ====
  const btn = document.getElementById('btnDownloadAbsensiTrendPDF') || document.querySelector('.btn-download-trend');
  let originalHTML = '';
  if (btn) {
    originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('downloading');
    btn.innerHTML = `<span class="spinner" style="
      display:inline-block;
      width:16px; height:16px;
      border:2px solid #fff;
      border-top-color:transparent;
      border-radius:50%;
      margin-right:6px;
      animation:spin 0.8s linear infinite;
    "></span> Sedang mengunduh...`;
  }

  // ==== HEADER ====
  try {
    const logoUrl = "https://i.imgur.com/Irgu32G.png";
    const logoData = await loadImageToBase64(logoUrl);
    if (logoData?.base64) {
      const fmt = logoData.base64.includes("image/jpeg") ? "JPEG" : "PNG";
      doc.addImage(logoData.base64, fmt, marginX, 40, 60, 60);
    }
  } catch (e) {
    console.warn("Logo gagal dimuat:", e);
  }

  doc.setFont("helvetica", "bold").setFontSize(20);
  doc.text("KHUDAMA' KHARISMA", pageWidth / 2, 55, { align: "center" });
  doc.setFont("helvetica", "normal").setFontSize(13);
  doc.text("Pondok Pesantren Lirboyo Kota Kediri Jawa Timur", pageWidth / 2, 75, { align: "center" });
  doc.setFont("helvetica", "italic").setFontSize(10);
  doc.text("Sekretariat: Kantor KHARISMA Gedung Nafis Lt. 02 Lirboyo Kota Kediri", pageWidth / 2, 95, { align: "center" });
  doc.setLineWidth(1);
  doc.line(marginX, 110, pageWidth - marginX, 110);

  doc.setFont("helvetica", "bold").setFontSize(15);
  doc.text("LAPORAN MONITORING & PROGRES ABSENSI MERAH", pageWidth / 2, 135, { align: "center" });
  
  // ==== CHART ABSENSI ====
  const chartCanvas = document.querySelector("#absensiChartCanvas canvas");
  if (chartCanvas) {
    const chartData = chartCanvas.toDataURL("image/png", 1.0);
    const maxChartWidth = pageWidth - marginX * 2;
    const chartWidth = maxChartWidth * 0.6;
    const chartHeight = chartWidth * 0.8;
    const chartX = (pageWidth - chartWidth) / 2;
    const chartY = 180;
    doc.addImage(chartData, "PNG", chartX, chartY, chartWidth, chartHeight);
    currentY = chartY + chartHeight + 60;
  } else {
    currentY = 200;
  }

  // ==== AMBIL SEMUA DATA ====
  let allRows = [];
  try {
    allRows = await fetchAbsensiMerahTrenDetail();
    if (!Array.isArray(allRows)) allRows = [];
  } catch (err) {
    console.error("Gagal fetch data:", err);
    return alert("Gagal memuat data untuk export PDF.");
  }

  // ==== GROUPING BY STAMBUK ====
  const groups = {};
  for (const r of allRows) {
    const s = r.stambuk || "#unknown";
    groups[s] ??= {
      stambuk: s,
      nama: r.nama_lengkap || "",
      unit: r.unit_ndalem || "",
      bagian: r.bagian || r.bagian_santri || "-",
      kelas: r.kelas || r.kelas_santri || "-",
      foto: r.foto || r.foto_santri || "",
      months: {},
      anyMerah: false,
      lastStatus: null,
      lastMonth: null,
      lastTanpa: 0,
    };
    groups[s].months[r.bulan] = {
      tanpa_izin: +r.tanpa_izin || 0,
      status_tren: r.status_tren || "Normal",
      bulan_urut: +r.bulan_urut || 0,
    };
    if (+r.tanpa_izin >= 3) groups[s].anyMerah = true;
    if (!groups[s].lastMonth || (+r.bulan_urut >= groups[s].lastMonth)) {
      groups[s].lastMonth = +r.bulan_urut;
      groups[s].lastStatus = r.status_tren;
      groups[s].lastTanpa = +r.tanpa_izin || 0;
    }
  }

  // ==== FILTER SESUAI UI ====
  let items = Object.values(groups).filter(g => g.anyMerah);
  const onlyStill = document.getElementById("trendOnlyMasihMerah")?.checked;
  if (onlyStill) items = items.filter(g => ["Baru Merah", "Masih Merah"].includes(g.lastStatus));
  const q = (document.getElementById("trendSearch")?.value || "").trim().toLowerCase();
  if (q) items = items.filter(g =>
    (g.stambuk + " " + g.nama + " " + g.unit + " " + g.kelas).toLowerCase().includes(q)
  );

  // ==== URUTKAN SESUAI KELAS ORDER ====
  const kelasOrder = [
    'V Ibtidaiyah', 'VI Ibtidaiyah',
    'I Tsanawiyah', 'II Tsanawiyah', 'III Tsanawiyah',
    'I Aliyah', 'II Aliyah', 'III Aliyah',
    "I-II Ma'had Aly", "III-IV Ma'had Aly", "V-VI Ma'had Aly",
    "I'dadiyah I", "I'dadiyah II", "I'dadiyah III"
  ];

  items.sort((a, b) => {
    const idxA = kelasOrder.indexOf(a.kelas);
    const idxB = kelasOrder.indexOf(b.kelas);
    if (idxA !== -1 && idxB !== -1 && idxA !== idxB) return idxA - idxB;
    if (idxA !== -1 && idxB === -1) return -1;
    if (idxA === -1 && idxB !== -1) return 1;
    return (a.unit || '').localeCompare(b.unit || '') || (a.nama || '').localeCompare(b.nama || '');
  });

  // ==== HEADER KOLOM ====
  const months = Array.isArray(AB_TREND_MONTHS) ? AB_TREND_MONTHS : [];
  const headers = ["No", "Foto", "Nama", "Kelas", "Bag", "Unit", ...months, "Status"];

  // ==== HELPER: LOAD IMAGE ====
  async function loadImagesWithLimit(list, limit = 6) {
    const results = new Array(list.length);
    let idx = 0;
    async function worker() {
      while (idx < list.length) {
        const i = idx++;
        const url = list[i].foto;
        if (url) {
          try { results[i] = await loadImageToBase64(url); } 
          catch { results[i] = null; }
        } else results[i] = null;
      }
    }
    await Promise.all(Array.from({ length: Math.min(limit, list.length) }, worker));
    return results;
  }
  const imgs = await loadImagesWithLimit(items, 6);

  // ==== BODY TABEL ====
  const body = items.map((g, i) => {
    const row = [
      i + 1,    
      imgs[i] || null,
      g.nama || "-",
      g.kelas || "-",
      g.bagian || "-",
      g.unit || "-",
    ];
    for (const m of months) {
      const cell = g.months[m];
      row.push(cell ? `${+cell.tanpa_izin || 0}` : "-");
    }
    row.push(`${g.lastStatus || "-"}`);
    return row;
  });

  // ==== CETAK TABEL ====
  doc.autoTable({
    head: [headers],
    body,
    startY: currentY,
    margin: { left: marginX, right: marginX },
    tableWidth: "auto",
    styles: {
      fontSize: 8.5,
      halign: "center",
      valign: "middle",
      minCellHeight: 40,
      cellPadding: 4,
      lineWidth: 0.3,
      lineColor: [0, 0, 0],
      overflow: "linebreak",
    },
    headStyles: { fillColor: [26, 115, 232], textColor: 255, fontStyle: "bold", lineColor: [0, 0, 0] },
    columnStyles: {
      1: { cellWidth: 38 },
      2: { halign: "left", cellWidth: 70 },
	  3: { cellWidth: 55 },	
      5: { halign: "left", cellWidth: 70 },
	  11: { cellWidth: 50 },
	  12: { cellWidth: 50 },
	  13: { cellWidth: 45 },
	  14: { cellWidth: 45 },
    },
    didParseCell(data) {
      if (data.section === "body") {
        const rowIndex = data.row.index;
        const colIndex = data.column.index;
        const g = items[rowIndex];
        if (!g) return;
        const monthStartIndex = 6;
        const monthEndIndex = monthStartIndex + months.length - 1;
        if (colIndex >= monthStartIndex && colIndex <= monthEndIndex) {
		  const monthLabel = months[colIndex - monthStartIndex];
		  const monthData = g.months?.[monthLabel];
		  if (monthData) {
			const status = monthData.status_tren || "";
			if (status === "Baru Merah") data.cell.styles.fillColor = [255, 107, 107];   // merah muda
			else if (status === "Masih Merah") data.cell.styles.fillColor = [201, 42, 42]; // merah tua
			else if (status === "Membaik") data.cell.styles.fillColor = [64, 192, 87];     // hijau
		  }
		}
      }
    },
    willDrawCell(data) {
      if (data.section === "body" && data.column.index === 1) data.cell.text = [""];
    },
    didDrawCell(data) {
      if (data.section === "body" && data.column.index === 1) {
        const foto = data.cell.raw;
        if (foto?.base64) {
          const base = foto.base64;
          const fmt = base.includes("image/jpeg") ? "JPEG" : "PNG";
          const pad = 2;
          const cw = data.cell.width - pad * 2;
          const ch = data.cell.height - pad * 2;
          const ratio = Math.min(cw / (foto.w || cw), ch / (foto.h || ch));
          const nw = (foto.w || cw) * ratio;
          const nh = (foto.h || ch) * ratio;
          const x = data.cell.x + (data.cell.width - nw) / 2;
          const y = data.cell.y + (data.cell.height - nh) / 2;
          try { doc.addImage(foto.base64, fmt, x, y, nw, nh); } catch {}
        }
      }
    },
    rowPageBreak: 'avoid',
    pageBreak: 'auto',
  });

  // ==== FOOTER ====
  const totalPages = doc.internal.getNumberOfPages();
  for (let p = 1; p <= totalPages; p++) {
    doc.setPage(p);
    doc.setFont("helvetica", "normal").setFontSize(9);
    doc.text(`Halaman ${p} dari ${totalPages}`, pageWidth / 2, pageHeight - 20, { align: "center" });
    if (p === totalPages) {
      doc.setFont("helvetica", "italic").setTextColor(120);
      doc.text(`Admin â€“ Simponi Kharisma â€“ ${new Date().toLocaleString("id-ID")}`,
        pageWidth - 40, pageHeight - 20, { align: "right" });
      doc.setTextColor(0);
    }
  }

  // ==== SIMPAN ====
  doc.save(`Rekap_Absensi_Merah_${new Date().toISOString().slice(0, 10)}.pdf`);

  // ==== KEMBALIKAN TOMBOL ====
  if (btn) {
    btn.disabled = false;
    btn.classList.remove('downloading');
    btn.innerHTML = originalHTML;
  }
}

// ===== Inventaris: Tab switching =====
function bindInventarisTabs() {
  document.querySelectorAll('.inventaris-tab').forEach(tab => {
    tab.onclick = async function () {
      // reset active btn
      document.querySelectorAll('.inventaris-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.inventaris-tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');

      const name = tab.dataset.inventarisTab;
      document.getElementById('inventaris-tab-' + name).classList.add('active');

      if (name === 'kendaraan') {
        // jika ingin refresh ketika kembali ke kendaraan, panggil loadInventaris()
        if (typeof loadInventaris === 'function') loadInventaris();
      } else if (name === 'handphone') {
        // panggil fungsi load inventaris handphone (baru)
        if (typeof loadInventarisHP === 'function') {
          await loadInventarisHP();
        } else {
          console.warn('loadInventarisHP() belum didefinisikan');
        }
      }
    };
  });
}
// bind sekali pada DOM ready
document.addEventListener('DOMContentLoaded', () => {
  bindInventarisTabs();
});

async function loadInventarisHP(page = 1) {
  showLoading(true);
  try {
    const userRole = localStorage.getItem("userRole") || "user";

    const { data: hpData, error: hpErr } = await supabaseClient
      .from("inventaris_handphone")
      .select("*")
      .order("id", { ascending: true });
    if (hpErr) throw hpErr;

    const { data: unitData } = await supabaseClient
      .from("referensi_unit_ndalem")
      .select("Kode_Unit, Nama_Unit");

    const { data: santriData } = await supabaseClient
      .from("santri_kharisma")
      .select("Stambuk, Nama_Lengkap");

    const mapped = (hpData || []).map(r => {
      const unit = unitData?.find(u => u.Kode_Unit === r.kode_unit);
      const santri = santriData?.find(s => s.Stambuk == r.penanggung_jawab_id);

      return {
        id: r.id,
        Kode_Unit: r.kode_unit,
        Nama_Unit: unit?.Nama_Unit || "-",
        Merk: r.merk,
        IMEI: r.imei,
        No_Kontak: r.no_kontak,
        PJ_Tipe: r.penanggung_jawab_tipe,
        PJ_ID: r.penanggung_jawab_id,
        Nama_Lengkap: santri?.Nama_Lengkap || "(Tidak ditemukan)"
      };
    });

    const hpCols = [
      { key: "Nama_Unit", label: "Unit" },
      { key: "Merk", label: "Merk HP" },
      { key: "IMEI", label: "IMEI" },
      { key: "No_Kontak", label: "No. Kontak" },
      { key: "Nama_Lengkap", label: "Penanggung Jawab" }
      
    ];

    if (userRole === "admin") {
      hpCols.push({
        key: "Aksi",
        label: "Aksi",
        format: (v, row) => {
          const safeRow = encodeURIComponent(JSON.stringify(row));
          return `
            <button class="crud-btn-save" data-row="${safeRow}" onclick="handleEditInventarisHP(this)">âœï¸</button>
            <button class="crud-btn-cancel" onclick='deleteInventarisHP("${row.id}")'>ðŸ—‘ï¸</button>
          `;
        }
      });
    }

    renderTable("inventaris-hp-table", mapped, hpCols);

  } catch (err) {
    console.error("Gagal loadInventarisHP:", err);
  } finally {
    showLoading(false);
  }
}

/* === Handler Tambah/Edit Inventaris HP (perbaikan) === */
async function openAddInventarisHP() {
  document.getElementById("inventarisHpModalTitle").textContent = "Tambah Handphone";
  // reset form seperti kendaraan
  const form = document.getElementById("inventarisHpForm");
  if (form) form.reset();
  document.getElementById("inventarisHpId").value = "";

  // isi dropdown Unit (gunakan await agar options terisi sebelum user berinteraksi)
  await loadUnitOptions("Kode_Unit_hp", "");
  const kodeUnitEl = document.getElementById("Kode_Unit_hp");
  if (kodeUnitEl) kodeUnitEl.value = "";

  // kosongkan dropdown penanggung jawab (khusus HP)
  const pjHp = document.getElementById("Penanggung_Jawab_hp");
  if (pjHp) pjHp.innerHTML = '<option value="">-- Pilih Penanggung Jawab --</option>';

  // pastikan saat user ganti unit, PJ untuk HP ter-load
  if (kodeUnitEl) {
    kodeUnitEl.onchange = async function () {
      const unitKode = this.value;
      // loadPenanggungJawabOptions menerima targetId
      await loadPenanggungJawabOptions(unitKode, "Penanggung_Jawab_hp", null);
    };
  }

  document.getElementById("inventarisHpModal").style.display = "block";
}

/* === Submit Form Inventaris HP (baru) === */
document.getElementById("inventarisHpForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const hiddenId = document.getElementById("inventarisHpId").value; // id PK jika edit
  const selectUnit = document.getElementById("Kode_Unit_hp");
  const selectedKode = selectUnit ? selectUnit.value : null;

  const pjSelect = document.getElementById("Penanggung_Jawab_hp");
  // nilai option pj harus di-JSON-kan sama cara kendaraan (jika Anda pilih JSON earlier)
  let pjData = null;
  if (pjSelect && pjSelect.value) {
    try { pjData = JSON.parse(pjSelect.value); } catch (err) { pjData = null; }
  }

  const payload = {
    kode_unit: selectedKode || null,
    merk: document.getElementById("Merk_hp").value?.trim() || null,
    imei: document.getElementById("IMEI_hp").value?.trim() || null,
    no_kontak: document.getElementById("No_Kontak_hp").value?.trim() || null,
    penanggung_jawab_tipe: pjData ? pjData.tipe : null,
    penanggung_jawab_id: pjData ? pjData.id : null
  };

  try {
    if (hiddenId) {
      // update
      const { error } = await supabaseClient
        .from("inventaris_handphone")
        .update(payload)
        .eq("id", hiddenId);
      if (error) throw error;
      showToast("Data handphone berhasil diupdate");
    } else {
      // insert
      const { error } = await supabaseClient
        .from("inventaris_handphone")
        .insert([payload]);
      if (error) throw error;
      showToast("Data handphone berhasil ditambahkan");
    }

    // tutup modal dan refresh tabel HP
    closeInventarisHpModal();
    if (typeof loadInventarisHP === "function") await loadInventarisHP();
  } catch (err) {
    console.error("Gagal menyimpan inventaris HP:", err);
    alert("Gagal menyimpan: " + (err.message || err));
  }
});


function closeInventarisHpModal() {
  document.getElementById("inventarisHpModal").style.display = "none";
}

function handleEditInventarisHP(btn) {
  if (localStorage.getItem("userRole") !== "admin") return;

  const raw = btn.getAttribute("data-row");
  const row = JSON.parse(decodeURIComponent(raw));

  openEditInventarisHP(row);
}

async function openEditInventarisHP(row) {
  document.getElementById("inventarisHpModalTitle").textContent = "Edit Handphone";
  document.getElementById("inventarisHpId").value = row.id || "";

  // Set dropdown Unit
  await loadUnitOptions("Kode_Unit_hp", row.Kode_Unit || "");

  // Set Penanggung Jawab berdasarkan unit
  await loadPenanggungJawabOptions(
    row.Kode_Unit,
    "Penanggung_Jawab_hp",
    { tipe: row.PJ_Tipe, id: row.PJ_ID }
  );

  // Set field lainnya
  document.getElementById("Merk_hp").value = row.Merk || "";
  document.getElementById("IMEI_hp").value = row.IMEI || "";
  document.getElementById("No_Kontak_hp").value = row.No_Kontak || "";

  // Ambil nama unit
  const found = (window.allUnitData || []).find(u => u.Kode_Unit === row.Kode_Unit);
  document.getElementById("Nama_Unit_hp").value = found?.Nama_Unit || "";

  document.getElementById("inventarisHpModal").style.display = "block";
}


document.getElementById("Kode_Unit_hp").addEventListener("change", async (e) => {
  const kode = e.target.value;

  // Ambil nama unit
  const found = (window.allUnitData || []).find(u => u.Kode_Unit === kode);
  document.getElementById("Nama_Unit_hp").value = found?.Nama_Unit || "";

  // Reset Penanggung Jawab dulu biar tidak salah pilih
  const pjSelect = document.getElementById("Penanggung_Jawab_hp");
  pjSelect.innerHTML = `<option value="">-- Pilih Penanggung Jawab --</option>`;

  // Load ulang Penanggung Jawab berdasarkan unit terpilih
  await loadPenanggungJawabOptions(kode, "Penanggung_Jawab_hp");
});


document.getElementById("inventarisHpForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = document.getElementById("inventarisHpId").value;

  const payload = {
    kode_unit: document.getElementById("Kode_Unit_hp").value,
    merk: document.getElementById("Merk_hp").value.trim(),
    imei: document.getElementById("IMEI_hp").value.trim(),
    no_kontak: document.getElementById("No_Kontak_hp").value.trim(),
  };

  const pjSel = document.getElementById("Penanggung_Jawab_hp");
  const pjData = pjSel.value ? JSON.parse(pjSel.value) : null;

  payload.penanggung_jawab_tipe = pjData?.tipe || null;
  payload.penanggung_jawab_id = pjData?.id || null;

  console.log("PAYLOAD HP:", payload); // debug

  try {
    let result;
    if (id) {
      result = await supabaseClient
        .from("inventaris_handphone")
        .update(payload)
        .eq("id", id);
    } else {
      result = await supabaseClient
        .from("inventaris_handphone")
        .insert([payload]);
    }

    if (result.error) throw result.error;

    showToast("Data handphone berhasil disimpan");
    closeInventarisHpModal();
    loadInventarisHP();

  } catch (err) {
    console.error("ERROR SAVE HP:", err);
    showToast("Gagal menyimpan data handphone", true);
  }
});


async function deleteInventarisHP(id) {
  if (localStorage.getItem("userRole") !== "admin") return;

  if (!confirm("Hapus data handphone ini?")) return;

  try {
    const { error } = await supabaseClient
      .from("inventaris_handphone")
      .delete()
      .eq("id", id);

    if (error) throw error;

    showToast("Data handphone berhasil dihapus");
    loadInventarisHP();
  } catch (err) {
    console.error(err);
    showToast("Gagal menghapus handphone", true);
  }
}

async function handleDownloadInventarisKendaraan(btn) {
  btn.classList.add("loading");
  btn.querySelector("span").textContent = "Membuat PDF...";
  try {
    await downloadInventarisPDF("kendaraan");
  } finally {
    btn.classList.remove("loading");
    btn.querySelector("span").textContent = "Download PDF";
  }
}

async function handleDownloadInventarisHP(btn) {
  btn.classList.add("loading");
  btn.querySelector("span").textContent = "Membuat PDF...";
  try {
    await downloadInventarisPDF("handphone");
  } finally {
    btn.classList.remove("loading");
    btn.querySelector("span").textContent = "Download PDF";
  }
}

function applyFilterKendaraan() {
  const key = document.getElementById("searchKendaraan").value.toLowerCase();
  const rows = document.querySelectorAll("#inventaris-table tbody tr");

  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(key) ? "" : "none";
  });
}

function applyFilterHP() {
  const key = document.getElementById("searchHP").value.toLowerCase();
  const rows = document.querySelectorAll("#inventaris-hp-table tbody tr");

  rows.forEach(row => {
    const text = row.innerText.toLowerCase();
    row.style.display = text.includes(key) ? "" : "none";
  });
}

/* =====================================================
   ðŸ”„ PWA UPDATE HANDLER (FINAL & BULLETPROOF)
   ===================================================== */

let updateNotificationShown = false;
const UPDATE_ACCEPTED_KEY = "pwa_update_accepted";

/* ================= REGISTER SERVICE WORKER ================= */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      const reg = await navigator.serviceWorker.register("/service-worker.js");
      console.log("âœ… SW registered:", reg.scope);

      // ðŸ”¥ JIKA SUDAH ADA SW BARU MENUNGGU
      if (reg.waiting && navigator.serviceWorker.controller) {
        showUpdatePopupOnce();
      }

      // Deteksi update baru
      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener("statechange", () => {
          if (
            newWorker.state === "installed" &&
            navigator.serviceWorker.controller
          ) {
            showUpdatePopupOnce();
          }
        });
      });

      // ðŸ”„ Saat SW baru aktif â†’ reload paksa (fresh)
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        window.location.replace(window.location.href);
      });
    } catch (err) {
      console.error("âŒ SW registration failed:", err);
    }
  });
}

/* ================= SHOW POPUP (ONCE ONLY) ================= */
function showUpdatePopupOnce() {
  if (updateNotificationShown) return;
  if (sessionStorage.getItem(UPDATE_ACCEPTED_KEY)) return;

  updateNotificationShown = true;
  showPopupUpdate("Ada pembaruan aplikasi tersedia");
}

/* ================= POPUP UI ================= */
function showPopupUpdate(msg) {
  document.getElementById("updatePopup")?.remove();

  const div = document.createElement("div");
  div.id = "updatePopup";
  div.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #1a73e8;
    color: #fff;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    z-index: 9999;
    font-size: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0;
    transform: translateY(20px);
    transition: all .3s ease;
  `;

  div.innerHTML = `
    <div style="font-weight:600;display:flex;align-items:center;gap:8px;">
      ðŸ”” ${msg}
    </div>
    <div style="display:flex;justify-content:flex-end;">
      <button id="btnReloadApp"
        style="
          background:#ea4335;
          color:#fff;
          border:none;
          padding:8px 14px;
          border-radius:8px;
          cursor:pointer;
          font-weight:500;
        ">
        Reload Aplikasi
      </button>
    </div>
  `;

  document.body.appendChild(div);

  requestAnimationFrame(() => {
    div.style.opacity = "1";
    div.style.transform = "translateY(0)";
  });

  /* ================= BUTTON ACTION ================= */
  div.querySelector("#btnReloadApp").onclick = () => {
    div.remove();
    sessionStorage.setItem(UPDATE_ACCEPTED_KEY, "1");

    // ðŸ‘‰ Aktifkan SW baru
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: "SKIP_WAITING",
      });
    }
  };

  /* ================= AUTO HIDE ================= */
  setTimeout(() => {
    if (document.body.contains(div)) {
      div.style.opacity = "0";
      div.style.transform = "translateY(20px)";
      setTimeout(() => div.remove(), 300);
    }
  }, 30000);
}


</script>
<div class="app-footer">
  <img src="https://img.shields.io/badge/version-v2.2.2-orange" alt="Version">
  <img src="https://img.shields.io/badge/license-Proprietary-red" alt="License">
  <img src="https://img.shields.io/badge/status-Internal%20Use-blue" alt="Status">
  <img src="https://img.shields.io/badge/%C2%A9%202025%20Ndalem%20Kharisma-Semua%20hak%20dilindungi%20undang%E2%80%90undang-red" 
       alt="Copyright">
</div>

</body>
</html>
