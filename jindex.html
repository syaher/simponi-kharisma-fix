<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Simponi Kharisma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Ganti dengan Font Awesome untuk ikon yang lebih modern -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- letakkan di <head> (pastikan tidak ada duplicate) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
 
  <!-- Favicon utama -->
  <link rel="icon" type="image/png" href="icons/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
 
  <!-- PWA manifest & meta -->
  <meta name="theme-color" content="#2b6cb0">
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">

  <!-- iOS Support -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-title" content="Simponi Kharisma">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <style>
    :root {
      --primary-color: #1a73e8;
      --primary-light: #e8f0fe;
      --secondary-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --border-radius: 16px;
      --box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --card-gradient: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      --hover-gradient: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      padding: 16px;
    }

    /* Header modern dengan gradient biru */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      padding: 14px 18px;
      background: linear-gradient(135deg, #1a73e8 0%, #3f51b5 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: white;
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-logo-img {
      height: 42px;
      width: 42px;
      border-radius: 10px;
      object-fit: contain;
      background: white;
      padding: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    .logout-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 8px 14px;
      color: white;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(5px);
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    /* Grid Layout Modern - 2 kolom, 4 baris dengan warna penuh */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .grid-item {
      border-radius: var(--border-radius);
      padding: 20px 12px;
      text-align: center;
      box-shadow: var(--box-shadow);
      transition: var(--transition);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      position: relative;
      overflow: hidden;
      color: white;
    }

    .grid-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--item-color-1), var(--item-color-2));
      z-index: -1;
      transition: var(--transition);
    }

    .grid-item:hover::before {
      transform: scale(1.05);
    }

    .grid-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    /* Bordir melingkar pada ikon */
	.grid-item i {
	  font-size: 2rem;
	  margin-bottom: 10px;
	  filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
	  transition: var(--transition);
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  width: 50px;
	  height: 50px;
	  border-radius: 50%;
	  background: rgba(255, 255, 255, 0.2);
	  backdrop-filter: blur(5px);
	  border: 2px solid rgba(255, 255, 255, 0.3);
	  box-shadow: 
		inset 0 0 10px rgba(255, 255, 255, 0.3),
		0 0 15px rgba(0, 0, 0, 0.2);
	}

	.grid-item:hover i {
	  transform: scale(1.15);
	  background: rgba(255, 255, 255, 0.25);
	  border-color: rgba(255, 255, 255, 0.5);
	  box-shadow: 
		inset 0 0 15px rgba(255, 255, 255, 0.4),
		0 0 20px rgba(0, 0, 0, 0.3);
	}

    .grid-item span {
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      transition: var(--transition);
    }

    /* Warna khusus untuk setiap item */
    .grid-item[data-module="guru"] {
      --item-color-1: #4caf50;
      --item-color-2: #2e7d32;
    }

    .grid-item[data-module="penasehat"] {
      --item-color-1: #9c27b0;
      --item-color-2: #6a1b9a;
    }

    .grid-item[data-module="santri"] {
      --item-color-1: #2196f3;
      --item-color-2: #1565c0;
    }

    .grid-item[data-module="absensi"] {
      --item-color-1: #ff9800;
      --item-color-2: #ef6c00;
    }

    .grid-item[data-module="pelanggaran"] {
      --item-color-1: #f44336;
      --item-color-2: #c62828;
    }

    .grid-item[data-module="inventaris"] {
      --item-color-1: #607d8b;
      --item-color-2: #37474f;
    }

    .grid-item[data-module="info"] {
      --item-color-1: #795548;
      --item-color-2: #4e342e;
    }

    .grid-item[data-module="nilai"] {
      --item-color-1: #00bcd4;
      --item-color-2: #00838f;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .app-header {
        padding: 12px 14px;
        margin-bottom: 20px;
      }
      
      .app-logo-img {
        height: 38px;
        width: 38px;
      }
      
      .app-title {
        font-size: 1.2rem;
      }
      
      .logout-btn {
        padding: 7px 12px;
        font-size: 0.85rem;
      }
      
      .grid-container {
        gap: 14px;
      }
      
      .grid-item {
        padding: 18px 10px;
        min-height: 110px;
      }
      
      .grid-item i {
        font-size: 1.8rem;
        margin-bottom: 8px;
		width: 45px;
		height: 45px;
      }
      
      .grid-item span {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 350px) {
      .grid-container {
        gap: 12px;
      }
      
      .grid-item {
        padding: 16px 8px;
        min-height: 100px;
      }
      
      .grid-item i {
        font-size: 1.7rem;
		width: 40px;
		height: 40px;
      }
      
      .grid-item span {
        font-size: 0.8rem;
      }
    }

    /* Efek Ripple untuk grid items */
    .ripple-effect {
      position: absolute;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.4);
      transform: scale(0);
      animation: ripple 0.6s linear;
    }

    @keyframes ripple {
      to {
        transform: scale(2.5);
        opacity: 0;
      }
    }

    /* Module containers */
    .module-container { 
      display: none; 
      background: white;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
    }
    
    .module-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tab navigation */
    .tab-nav {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .tab-item {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab-item.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Back button */
    .back-button {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      color: var(--primary-color);
      cursor: pointer;
      font-weight: 500;
    }

    .back-button i {
      margin-right: 8px;
    }

    /* Filter Container */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      justify-content: center;
      align-items: center;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      font-weight: 600;
      color: #444;
      margin-bottom: 0.4rem;
      display: block;
    }
    
    .filter-group input, .filter-group select {
      width: 100%;
      padding: 0.6rem 0.9rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.25);
      background: #fefefe;
    }

    /* Santri Cards */
    .santri-card {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-image: linear-gradient(to bottom, #a7c7e7, #F5F5F5);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      overflow: hidden;
      max-width: 380px;
      width: 100%;
      margin: 5px auto;
    }
    
    .santri-info {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 5px;
    }
    
    .photo {
      flex-shrink: 0;
      height: 130px;
      width: 100px;
      object-fit: cover;
      border-radius: 5px;
      border: 1px solid #ddd;
      display: block;
    }

    .info {
      font-size: 13px; 
      line-height: 1.2; 
      color: #000; 
      flex-grow: 1; 
      padding-right: 5px;
    }

    .info p, .info h3 {
      display: grid;
      grid-template-columns: 95px 2px auto;
      gap: 5px;
      margin: 2px 0;
    }

    .info h3 {
      color: #1a73e8;
      margin-bottom: 5px;
    }
    
    .status-badge {
	  position: absolute;
	  top: 8px;
	  right: 8px;
	  background: rgba(220, 53, 69, 0.95); /* merah danger */
	  color: #fff;
	  font-size: 12px;
	  font-weight: bold;
	  padding: 4px 10px;
	  border-radius: 12px;
	  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
	  z-index: 5;
	}
	/* Efek abu-abu dengan overlay */
	.santri-card.tidak-aktif::after {
	  content: "";
	  position: absolute;
	  inset: 0;
	  background: rgba(200, 200, 200, 0.4); /* lapisan abu-abu semi transparan */
	  z-index: 2; /* di atas isi, tapi di bawah badge */
	  pointer-events: none;
	}
    
    .santri-card.tidak-aktif {
      filter: grayscale(80%);
      opacity: 0.85;
    }
    
    .santri-card:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0, 123, 255, 0.6);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .santri-card.active {
      border: 3px solid rgb(0, 0, 139);
      box-shadow: 0 0 10px 5px rgba(0, 123, 255, 0.5);
      animation: borderAnimation 1.5s infinite;
    }
    
    @keyframes borderAnimation {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5); }
      50% { box-shadow: 0 0 10px 5px rgba(0, 123, 255, 0.7); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5); }
    }

    /* Unit Group */
    .unit-group { width: 100%; }
    
    .unit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary-color);
      color: white;
      padding: 8px 12px;
      font-weight: bold;
      font-size: 16px;
      border-radius: 5px;
      margin-top: 15px;
      cursor: pointer;
    }
    
    .unit-name { flex: 1; }
    
    .unit-total {
      font-weight: normal;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .triangle {
      display: inline-block;
      margin-right: 8px;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid white;
      transition: transform 0.3s ease;
    }
    
    .unit-header.collapsed .triangle { transform: rotate(-90deg); }
    
    .unit-cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 5px;
      padding: 5px 0;
    }
    
    .unit-cards.hidden { display: none; }

    

    /* Loading indicators */
    #loadingIndicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #f1f1f1;
      z-index: 1000;
      display: none;
    }
    
    #loadingIndicator .progress {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.3s;
    }
    
    #loading-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: rgba(255,255,255,0.9);
      position: fixed;
      inset: 0;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 6px solid #ddd;
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error and popup messages */
    .error-message {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: var(--danger-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      z-index: 1000;
      display: none;
      box-shadow: var(--box-shadow);
    }
    
    .popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary-color);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s;
      box-shadow: var(--box-shadow);
    }


    
	
	.logolembaga {
	  width: 100%;
	  height: auto;
	  object-fit: contain;
	  background-color: #f8f9fa;
	  padding: 0;
	  border-bottom: 1px solid #e9ecef;
	}
	
	/* Pagination */
.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 1.5rem 0;
  padding: 0.5rem;
  background-color: white;
  border-radius: var(--border-radius);
  box-shadow: var(--box-shadow);
}
.pagination-info { font-size: 0.9rem; }
.pagination-controls {
  display: flex;
  gap: 0.5rem;
}

/* Tombol lebih cantik */
button {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  border: none;
  border-radius: 30px;
  padding: 0.6rem 1.2rem;
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}
button:hover {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

/* Tombol aktif (current page) */
button.active {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: #000;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
  transform: scale(1.1);
}

/* Efek klik pada tombol */
button:active {
  transform: scale(0.95);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: transform 0.1s ease;
}

/* Tombol khusus untuk pagination controls */
.pagination-controls button {
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

/* Tombol navigasi (sebelumnya/berikutnya) */
.pagination-controls button:first-child,
.pagination-controls button:last-child {
  min-width: 80px;
  padding: 0.6rem 1.2rem;
}

/* Responsive untuk mode portrait (‚â§600px) */
@media (max-width: 600px) {
  .pagination {
    flex-direction: column;   /* ‚úÖ ditumpuk ke bawah */
    gap: 0.5rem;
    align-items: center;      /* center semua */
    padding: 0.8rem;
  }

  .pagination-info {
    font-size: 0.8rem;        /* sedikit lebih kecil */
    text-align: center;
  }

  .pagination-controls {
    flex-wrap: wrap;          /* tombol bisa pindah baris kalau sempit */
    justify-content: center;
    gap: 0.4rem;
  }

  .pagination-controls button {
    min-width: 35px;
    height: 35px;
    font-size: 0.8rem;
  }

  /* Tombol navigasi (prev/next) lebih ramping di portrait */
  .pagination-controls button:first-child,
  .pagination-controls button:last-child {
    min-width: 70px;
    padding: 0.5rem 0.8rem;
    font-size: 0.8rem;
  }
}

/* --- Container scroll kalau kepanjangan --- */
.data-table-container {
  overflow-x: auto;
  margin-top: 16px;
}

/* --- Base table --- */
.data-table {
  border-collapse: separate;
  border-spacing: 0;
  table-layout: auto;
  width: max-content;   /* melebar sesuai isi */
  min-width: 100%;      /* minimal penuh layar */
  background-color: white;
  box-shadow: var(--box-shadow);
}

/* --- Cell umum --- */
.data-table th,
.data-table td {
  padding: 0.75rem;
  text-align: left;
  border: 1px solid #e6e6e6;
  background: #fff;
  font-size: 13px;
  vertical-align: middle;

  white-space: normal;      /* biar kata turun */
  word-break: break-word;
  line-height: 1.3;
}

/* --- Sticky header (biru + teks putih) --- */
.data-table th {
  position: sticky;
  top: 0;
  background-color: #1a73e8;
  color: #fff;
  font-weight: 600;
  z-index: 12;
  text-align: center;
  cursor: pointer;
}

/* --- Sticky left Nama --- */
.data-table th.nama,
.data-table td.nama {
  position: sticky;
  left: 0;
  z-index: 20;
  background: #fff;
  text-align: left;
  padding-left: 10px;
  min-width: 140px;
  max-width: 300px;
}

.data-table th.nama {
  z-index: 25;
  background: #1a73e8;
  color: #fff;
  text-align:center
}

/* --- Foto --- */
.data-table td:nth-child(2) img {
  width: 60px;
  height: 80px;
  object-fit: cover;
  border-radius: 2px;
  display: block;
  margin: auto;
}

/* --- Sorting indicator --- */
.sortable {
  position: relative;
  padding-right: 24px;
}

.sort-indicator {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  color: #fff;              /* ‚úÖ indikator putih */
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.2s;
}

.sortable.sorted .sort-indicator { opacity: 1; }
.sortable.sorted-asc .sort-indicator::after { content: "‚ñ≤"; }
.sortable.sorted-desc .sort-indicator::after { content: "‚ñº"; }

/* --- State sorted: tetap header biru, teks putih --- */
.sorted {
  background-color: #1a73e8 !important;
  color: #fff !important;
  font-weight: bold;
}

/* --- Android portrait: kolom diperkecil, wrap --- */
@media screen and (max-width: 768px) and (orientation: portrait) {
  .data-table td:nth-child(2){   
    width: 50px;
    text-align: left;
  }  
  .data-table th:nth-child(2) {
    width: 50px;
    text-align: center;
  }
  .data-table td:nth-child(2) img {
    width: 45px;
    height: 65px;
  }
  .data-table th.nama,
  .data-table td.nama {
    min-width: 80px;
    max-width: 120px;
  }
  .data-table th,
  .data-table td {
    max-width: 100px;
    font-size: 12px;
  }
}


/* Styling Absensi Table per Santri */
#absensi-container .santri-box {
  border: 2px solid #1a73e8;       /* bordir biru */
  border-radius: 12px;             /* kotak santri tetap melengkung */
  padding: 15px;
  margin-bottom: 25px;
  background: #ffffff;
  box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);
}

/* Table umum */
#absensi-container table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
  margin: auto;
}

/* Header atas (nama, kelas, unit) */
#absensi-container table thead tr:first-child th {
  background: #1a73e8;
  color: white;
  font-size: 13px;
  text-align: center;
  border: 1px solid #1a73e8;
  /* üîπ Hapus sudut melengkung */
  border-radius: 0;
}

/* Foto baris */
#absensi-container table thead tr:nth-child(2) td {
  text-align: center;
  padding: 10px;
}

/* Header bulan (No, Bulan, Sakit, Izin, Tanpa Izin) */
#absensi-container table thead tr:nth-child(3) th {
  background: #e3f0ff;
  font-weight: bold;
  text-align: center;
  border: 1px solid #1a73e8;
}

/* Sel isi tabel */
#absensi-container table tbody td {
  border: 1px solid #cce0ff;
  padding: 6px;
  font-size: 13px;
}


/* Sel isi tabel */
#absensi-container table tbody td {
  border: 1px solid #cce0ff;
  padding: 6px;
  font-size: 13px;
  text-align: center; /* default semua tetap center */
}

/* üîπ Khusus kolom Bulan (kolom ke-2) dibuat rata kiri */
#absensi-container table tbody td:nth-child(2) {
  text-align: left;
  padding-left: 10px;
}

/* ======== MODUL NILAI (namespace .nilai-*) ======== */

/* Tab navigasi */
.nilai-tabs,
.nilai-graph-tabs {
  display: flex;
  gap: 0.7rem;
  margin: 0.7rem 0 0.7rem;
  flex-wrap: wrap;
}
.nilai-tab,
.nilai-graph-tab {
  background: #fff;
  border: 1px solid #cfe0ff;
  color: #1a73e8;
  padding: 0.55rem 1rem;
  border-radius: 0.7rem;
  cursor: pointer;
  font-size: 0.7rem;
  transition: all 0.2s ease;
  font-weight: 500;
}
.nilai-tab:hover:not(.active),
.nilai-graph-tab:hover:not(.active) {
  background: #e8f0fe; /* biru terang saat hover */
}
.nilai-tab.active,
.nilai-graph-tab.active {
  background: #1a73e8;
  color: #fff;
  border-color: #1a73e8;
}

.nilai-tab-content {
  display: none;
}
.nilai-tab-content.active {
  display: block;
}

/* Filter bar */
.nilai-filter-row {
  display: flex;
  gap: 0.7rem;
  flex-wrap: wrap;
  align-items: end;
  background: #fff;
  padding: 0.7rem;
  border-radius: 0.7rem;
  box-shadow: var(--box-shadow);
}
.nilai-filter-group {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}
.nilai-filter-group label {
  font-size: 0.7rem;
  font-weight: 500;
  color: #1a73e8; /* biru seragam */
}
.nilai-filter-group input,
.nilai-filter-group select {
  border: 1px solid #e2e8f0;
  border-radius: 0.7rem;
  padding: 0.55rem 0.7rem;
  min-width: 12rem; /* ~180px */
  font-size: 0.7rem;
  transition: border-color 0.2s;
}
.nilai-filter-group input:focus,
.nilai-filter-group select:focus {
  outline: none;
  border-color: #1a73e8;
}

/* Chart header */
.nilai-chart-header {
  text-align: center;
  font-weight: bold;
  font-size: 0.8rem;
  color: #1a73e8;
  margin: 0.5rem 0.7rem 0.5rem;
  padding-bottom: 0.4rem;
  border-bottom: 2px solid #1a73e8;
}

/* Chart container */
.nilai-chart-container {
  margin-top: 0.5rem;
}


/* === Tampilan kartu per siswa === */
.nilai-list-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 16px;
}

.nilai-card {
  border: 1px solid #e6e6e6;
  border-radius: 12px;
  background: #fff;
  box-shadow: var(--box-shadow);
  overflow: hidden;
  transition: transform .2s, box-shadow .2s;
}


.nilai-card-header {
  background: #1a73e8;
  color: #fff;
  padding: 12px 16px;
  font-weight: bold;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.nilai-card-header span {
  font-size: 0.85rem;
  font-weight: normal;
  opacity: .95;
}

.nilai-card-body {
  padding: 12px 14px;
  overflow-x: auto;
}

.nilai-subtable {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
.nilai-subtable th,
.nilai-subtable td {
  border: 1px solid #f0f0f0;
  padding: 6px 10px;
}
.nilai-subtable th {
  background: #f8fafc;
  font-weight: 600;
  text-align: center; /* header center */
}
.nilai-subtable td:first-child {
  text-align: center; /* kolom No */
  width: 50px;
}
.nilai-subtable td:last-child {
  text-align: center; /* kolom Nilai */
  font-weight: 500;
  width: 80px;
}
.nilai-subtable td:nth-child(2) {
  text-align: left; /* Mata Pelajaran */
}

/* Grafik */
.nilai-chart-container {
  width: 100%;
  max-width: 1100px;
  margin: 20px auto 0;
}
.nilai-chart-container canvas {
  width: 100%;
  height: auto;
  min-height: 500px;   /* tinggi dasar */
}


/* Pagination */
.nilai-pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  margin: 20px 0;
  flex-wrap: wrap;
}
.nilai-pagination button {
  border: 1px solid #d1d5db;
  background: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: .85rem;
  transition: all .2s;
}
.nilai-pagination button:hover:not(:disabled) {
  background: #f3f4f6;
}
.nilai-pagination button.active {
  background: #1a73e8;
  color: #fff;
  border-color: #1a73e8;
}
.nilai-pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Responsive tweaks */
@media (max-width: 768px) {
  .nilai-card-header {
    font-size: .95rem;
  }
  .nilai-card-header span {
    font-size: 0.8rem;
  }
  .nilai-filter-group input,
  .nilai-filter-group select {
    min-width: 140px;
  }
}

.nilai-total {
  font-weight: bold;
  background: #fff;
  padding: 2px 6px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  color: #1a73e8;
  display: inline-block;
}

.nilai-separator {
  font-weight: bold;
  color: #fff;       /* putih, sama dengan background header */
  margin: 0 4px;     /* kasih jarak kanan-kiri */
}

/* Container pagination Nilai */
.nilai-pagination {
  display: flex;
  flex-direction: column; /* info di atas, tombol di bawah */
  justify-content: center;
  align-items: center;
  margin: 1.5rem 0;
  gap: 0.6rem;
}

/* Info teks di atas tombol */
.nilai-pagination .pagination-info {
  font-size: 0.85rem;
  text-align: center;
  color: #444;
  font-weight: 500;
}

/* Kontrol tombol */
.nilai-pagination .pagination-controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
}

/* Tombol pagination */
.nilai-pagination button {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  border: none;
  border-radius: 30px;
  padding: 0.6rem 1.2rem;
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  transition: all 0.3s ease;
}

/* Hover */
.nilai-pagination button:hover:not(:disabled):not(.active) {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

/* Aktif (halaman sekarang) */
.nilai-pagination button.active {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  color: #000;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
  transform: scale(1.1);
}

/* Disabled */
.nilai-pagination button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Titik-titik (...) */
.nilai-pagination span {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 30px;
  height: 40px;
  font-size: 1rem;
  font-weight: bold;
  color: #555;
}

/* ================= Responsive Android kecil (‚â§600px) ================= */
@media (max-width: 600px) {
  .nilai-pagination {
    gap: 0.4rem;
    margin: 1rem 0;
  }

  .nilai-pagination .pagination-info {
    font-size: 0.75rem;
  }

  .nilai-pagination button {
    min-width: 32px;
    height: 34px;
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
  }

  .nilai-pagination button:first-child,
  .nilai-pagination button:last-child {
    min-width: 60px;
    font-size: 0.7rem;
    padding: 0.4rem 0.6rem;
  }

  .nilai-pagination span {
    min-width: 20px;
    height: 34px;
    font-size: 0.75rem;
  }
}
/* Footer dengan container putih dan tulisan biru kecil rata kiri */
.app-footer {
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
  padding: 10px 14px;
  margin-top: 18px;
  text-align: left;
}

.app-footer img {
  height: 20px;
  margin: 3px 6px 3px 0;
  vertical-align: middle;
}

/* Responsive adjustments untuk footer */
@media (max-width: 480px) {
  .app-footer {
    padding: 8px 12px;
    margin-top: 15px;
  }
  .app-footer img {
    height: 18px;
    margin: 2px 4px 2px 0;
  }
}

/* ==== Scroll khusus grafik nilai ==== */
.nilai-chart-scroll-wrapper {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth di Android/iOS */
}



.nilai-chart-scroll-inner canvas {
  width: 100%;
  height: auto;
  min-height: 500px;
}

/* Responsive untuk layar kecil */
@media (max-width: 600px) {
  .nilai-chart-scroll-inner {
    min-width: 400px; /* lebih panjang biar ada scrollbar horizontal */
  }
}

@media (max-width: 600px) {
  .nilai-chart-header {
    font-size: 12px;    
	margin-top: 5px;
  }
}
.user-info-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 10px 14px;
  margin: -10px 0 15px 0;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.user-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 2px solid #1a73e8;
  object-fit: cover;
}

.user-details {
  display: flex;
  flex-direction: column;
  line-height: 1.3;
}

#userRoleText {
  font-size: 0.8rem;
  font-weight: 600;
  color: #1a73e8;
}


#userEmail {
  font-size: 0.8rem;
  color: #555;
}

.logout-btn {
  background: #e53935;
  color: #fff;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: background 0.2s;
}

.logout-btn:hover {
  background: #c62828;
}

/* ===== Modal Form Admin ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-box {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  width: 95%;
  max-width: 480px;
  padding: 20px;
  animation: fadeInScale 0.3s ease;
}

.modal-box h3 {
  margin-bottom: 15px;
  color: #1a73e8;
  font-size: 1.2rem;
  text-align: center;
}

.modal-box form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.modal-box label {
  font-weight: 600;
  font-size: 0.9rem;
  color: #333;
}

.modal-box input,
.modal-box select,
.modal-box textarea {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.9rem;
  transition: border 0.2s, box-shadow 0.2s;
}

.modal-box input:focus,
.modal-box select:focus,
.modal-box textarea:focus {
  outline: none;
  border-color: #1a73e8;
  box-shadow: 0 0 0 3px rgba(26,115,232,0.25);
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 15px;
}

.modal-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  transition: background 0.2s, transform 0.2s;
}

.modal-btn.save {
  background: linear-gradient(135deg, #1a73e8, #3f51b5);
  color: #fff;
}

.modal-btn.save:hover {
  background: linear-gradient(135deg, #0d5bba, #283593);
  transform: scale(1.05);
}

.modal-btn.cancel {
  background: #ddd;
  color: #333;
}

.modal-btn.cancel:hover {
  background: #ccc;
}

/* Animasi modal */
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Overlay gelap */
.crud-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

/* Kotak modal */
.crud-modal-content {
  background: #fff;
  margin: 30px auto;
  padding: 20px;
  border-radius: 10px;
  width: 95%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  position: relative;
  animation: crud-fadeIn 0.3s ease;
}

/* Animasi */
@keyframes crud-fadeIn {
  from {opacity: 0; transform: scale(0.95);}
  to {opacity: 1; transform: scale(1);}
}

/* Tombol close (X) */
.crud-close {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 24px;
  font-weight: bold;
  color: #666;
  cursor: pointer;
}
.crud-close:hover {
  color: #000;
}

/* Form styling */
.crud-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.crud-form label {
  font-weight: bold;
  font-size: 14px;
}

.crud-form input, 
.crud-form select {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

/* Tombol aksi */
.crud-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap; /* biar rapi di layar kecil */
}

.crud-btn-save {
  flex: 1;
  padding: 10px;
  background: #28a745;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
.crud-btn-save:hover {
  background: #218838;
}

.crud-btn-cancel {
  flex: 1;
  padding: 10px;
  background: #dc3545;
  border: none;
  border-radius: 6px;
  color: white;
  font-size: 16px;
  cursor: pointer;
}
.crud-btn-cancel:hover {
  background: #c82333;
}

/* Responsif untuk layar kecil */
@media (max-width: 600px) {
  .crud-modal-content {
    margin: 10px;
    padding: 15px;
    width: 95%;
    max-height: 85vh;
  }
  .crud-form label {
    font-size: 13px;
  }
  .crud-btn-save, .crud-btn-cancel {
    font-size: 14px;
    padding: 8px;
  }
}
// ========== HIGHLIGHT ROW ==========
/* CSS di style.css
.highlight-row {
  animation: highlightFade 3s ease forwards;
}
@keyframes highlightFade {
  0%   { background-color: #fff3cd; }
  100% { background-color: transparent; }
}



  </style>
</head>
<body>
  <div id="loadingIndicator"><div class="progress"></div></div>
  <div id="loading-screen"><div class="loading-spinner"></div><p>Memuat data...</p></div>
  <div id="error-message" class="error-message"></div>

   <!-- Main Grid View -->
<div id="main-grid">
  <!-- üîπ Header Atas -->
  <div class="app-header">
    <div class="app-header-left">
      <img src="icons/logo.png" alt="Logo" class="app-logo-img">
      <span class="app-title">Simponi Kharisma</span>
    </div>
  </div>

<!-- üîπ User Info Bar -->
<div class="user-info-bar">
  <div class="user-left">      
    <div class="user-details">
  <span id="userRoleText">User</span>
  <span id="userEmail">-</span>
</div>

  </div>
  <button class="logout-btn" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Logout
  </button>
</div>




    <div class="grid-container">
      <div class="grid-item" data-module="guru">
        <i class="material-icons">supervisor_account</i>
        <span>Mustahiq</span>
      </div>
      <div class="grid-item" data-module="penasehat">
        <i class="material-icons">diversity_3</i>
        <span>Penasehat</span>
      </div>
      <div class="grid-item" data-module="santri">
        <i class="material-icons">school</i>
        <span>Santri</span>
      </div>
      <div class="grid-item" data-module="absensi">
        <i class="material-icons">event_available</i>
        <span>Absensi</span>
      </div>
      <div class="grid-item" data-module="nilai">
        <i class="material-icons">grading</i>
        <span>Nilai</span>
      </div>      
	  <div class="grid-item" data-module="inventaris">
	  <i class="material-icons">inventory_2</i>
	  <span>Inventaris</span>
	</div>
	<div class="grid-item" data-module="pelanggaran">
	  <i class="material-icons">report_problem</i>
	  <span>Pelanggaran</span>
	</div>
	<div class="grid-item" data-module="info">
        <i class="material-icons">info</i>
        <span>Informasi</span>
      </div>
    </div>
  </div>
  

  <!-- ================== SANTRI MODULE ================== -->
<div id="santri-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  
  <h2>Data Santri</h2>
  
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <div class="tab-item active" data-tab="kartu">Tampilan Kartu</div>
    <div class="tab-item" data-tab="data">Data Lengkap</div>
  </div>
  
  <!-- Filter Section -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="searchNama">Cari Nama:</label>
      <input id="searchNama" placeholder="Cari Nama Santri..." oninput="filterSantri()">
    </div>
    
    <div class="filter-group">
      <label for="searchKelas">Kelas:</label>
      <select id="searchKelas" onchange="filterSantri()">
        <option value="semua">Semua Kelas</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="searchUnit">Unit Ndalem:</label>
      <select id="searchUnit" onchange="filterSantri()">
        <option value="semua">Semua Unit</option>
      </select>
    </div>
  </div>

  <!-- Tab Content: Kartu -->
  <div id="tab-kartu" class="tab-content active">
    <div id="santri-container"></div>
  </div>
  
  <!-- Tab Content: Data Lengkap -->
  <div id="tab-data" class="tab-content">
    <!-- Admin Tools khusus Data Lengkap -->
    <div class="admin-tools">
      <button class="admin-only" onclick="openAddSantri()">‚ûï Tambah</button>
      <button class="admin-only" onclick="downloadSantriPDF()">‚¨áÔ∏è Download PDF</button>
      <button class="admin-only" onclick="downloadSantriHTML()">‚¨áÔ∏è Download HTML</button>
    </div>

    <!-- Table -->
    <div class="data-table-container">
      <div id="santri-table-container"></div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <div id="paginationInfo" class="pagination-info">Menampilkan 0 data</div>
      <div id="paginationControls" class="pagination-controls"></div>
    </div>
  </div>
</div>

<!-- ========== MODAL FORM SANTRI (POPUP CRUD) ========== -->
<div id="santriModal" class="crud-modal">
  <div class="crud-modal-content">
    <span class="crud-close" onclick="closeSantriModal()">&times;</span>
    <h2 id="santriModalTitle">Tambah/Edit Santri</h2>
    
    <form id="santriForm" class="crud-form">
      <input type="hidden" id="santriId">

      <label>Nama Lengkap *</label>
      <input type="text" id="Nama_Lengkap" required>

      <label>Kelas</label>
      <input type="text" id="Kelas">

      <label>Bagian</label>
      <input type="text" id="Bagian">

      <label>Stambuk</label>
      <input type="text" id="Stambuk">

      <label>Stambuk Ndalem</label>
      <input type="text" id="Stambuk_Ndalem">

      <label>Unit Ndalem</label>
      <input type="text" id="Unit_Ndalem">

      <label>Kode Unit</label>
      <input type="text" id="Kode_Unit">

      <label>Asal Daerah</label>
      <input type="text" id="Asal_Daerah">

      <label>Himpunan</label>
      <input type="text" id="Himpunan">

      <label>Kamar</label>
      <input type="text" id="Kamar">

      <label>Tgl Lahir</label>
      <input type="date" id="Tgl_Lahir">

      <label>Mulai Ngabdi</label>
      <input type="date" id="Mulai_Ngabdi">

      <label>Tgl Keluar</label>
      <input type="date" id="Tgl_Keluar">

      <label>Status</label>
      <select id="Status">
        <option value="aktif">Aktif</option>
        <option value="tidak aktif">Tidak Aktif</option>
      </select>

      <label>Posisi Tugas</label>
      <input type="text" id="Posisi_Tugas">

      <label>Jam Tugas</label>
      <input type="text" id="Jam_Tugas">

      <label>Shift</label>
      <input type="text" id="Shift">

      <label>Foto (URL)</label>
      <input type="text" id="Foto" oninput="previewFoto()">

      <div style="margin:10px 0;">
        <img id="fotoPreview" src="" alt="Preview Foto" style="max-height:120px;display:none;">
      </div>

      <div class="crud-actions">
        <button type="submit" class="crud-btn-save">üíæ Simpan</button>
        <button type="button" class="crud-btn-cancel" onclick="closeSantriModal()">‚ùå Batal</button>
      </div>
    </form>
  </div>
</div>



 <!-- Absensi Module -->
  <div id="absensi-module" class="module-container">
    <div class="back-button" onclick="showMainGrid()">
      <i class="material-icons">arrow_back</i>
      <span>Kembali ke Menu Utama</span>
    </div>
    
    <h2>Data Absensi</h2>
	
	<div class="admin-tools">
	  <button class="admin-only" onclick="openAddAbsensi()">‚ûï Tambah</button>
	  <button class="admin-only" onclick="downloadAbsensiPDF()">‚¨áÔ∏è Download PDF</button>
	</div>
    
    <div class="filter-row">
      <div class="filter-group">
        <label for="absensiSearchNama">Cari Nama:</label>
        <input id="absensiSearchNama" placeholder="Cari Nama Santri..." oninput="loadAbsensiData()">
      </div>
      
      <div class="filter-group">
        <label for="absensiSearchKelas">Kelas:</label>
        <select id="absensiSearchKelas" onchange="loadAbsensiData()">
          <option value="semua">Semua Kelas</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="absensiSearchUnit">Unit Ndalem:</label>
        <select id="absensiSearchUnit" onchange="loadAbsensiData()">
          <option value="semua">Semua Unit</option>
        </select>
      </div>
    </div>
    
    <label>
      <input type="checkbox" id="filterMerahCheckbox" onchange="loadAbsensiData()"> 
      üî¥ Tampilkan Absen Merah Saja
    </label>
    
    <div id="absensi-container" style="margin-top: 20px;"></div>
  </div>

  
 <div id="guru-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Mustahiq</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddGuru()">‚ûï Tambah</button>
    <button class="admin-only" onclick="downloadGuruPDF()">‚¨áÔ∏è Download PDF</button>
  </div>


  <!-- Filter -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="guruSearchNama">Cari Nama:</label>
      <input id="guruSearchNama" placeholder="Cari Nama Guru..." oninput="filterGuru()">
    </div>
    <div class="filter-group">
      <label for="guruFilterKelas">Filter Kelas:</label>
      <select id="guruFilterKelas" onchange="filterGuru()">
        <option value="">Semua</option>
      </select>
    </div>
  </div>

  <!-- Tabel -->
  <div class="data-table-container">
    <table class="data-table" id="guru-table"></table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div id="guruPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="guruPaginationControls" class="pagination-controls"></div>
  </div>
</div>


 <div id="penasehat-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Penasehat</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddPenasehat()">‚ûï Tambah</button>
    <button class="admin-only" onclick="downloadPenasehatPDF()">‚¨áÔ∏è Download PDF</button>
  </div>

  <!-- Filter -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="penasehatSearchNama">Cari Nama:</label>
      <input id="penasehatSearchNama" placeholder="Cari Nama Penasehat..." oninput="filterPenasehat()">
    </div>
  </div>

  <!-- Tabel -->
  <div class="data-table-container">
    <table class="data-table" id="penasehat-table"></table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div id="penasehatPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="penasehatPaginationControls" class="pagination-controls"></div>
  </div>
</div>

<div id="nilai-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>

  <h2>Data Nilai</h2>
  
  <div class="admin-tools">
  <button class="admin-only" onclick="openAddNilai()">‚ûï Tambah</button>

  <!-- üîΩ Dropdown download -->
  <select id="downloadFormat" class="admin-only">
	<option value="html">‚¨áÔ∏è Download HTML</option>
    <option value="pdf">‚¨áÔ∏è Download PDF</option>    
  </select>
  <button class="admin-only" onclick="handleDownload()">Download</button>
</div>



  <!-- Tab utama -->
  <div class="nilai-tabs">
    <button class="nilai-tab active" data-nilai-tab="kelas">Tabel</button>
    <button class="nilai-tab" data-nilai-tab="grafik">Grafik</button>
  </div>

  <!-- TAB: KELAS -->
  <div id="nilai-tab-kelas" class="nilai-tab-content active">
    <div class="nilai-filter-row">
      <div class="nilai-filter-group">
        <label for="nilaiSearchNama">Cari Nama:</label>
        <input id="nilaiSearchNama" placeholder="Ketik nama‚Ä¶" />
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchKelas">Kelas:</label>
        <select id="nilaiSearchKelas">
          <option value="semua">Semua Kelas</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchUnit">Unit Ndalem:</label>
        <select id="nilaiSearchUnit">
          <option value="semua">Semua Unit</option>
        </select>
      </div>
      <!-- Tambahan -->
      <div class="nilai-filter-group">
        <label for="nilaiSearchSemester">Semester:</label>
        <select id="nilaiSearchSemester">
          <option value="semua">Semua</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiSearchTahun">Tahun Ajaran:</label>
        <select id="nilaiSearchTahun">
          <option value="semua">Semua</option>
        </select>
      </div>
    </div>  

    <div class="nilai-list-container" id="nilai-list"></div>
  </div>

  <!-- TAB: GRAFIK -->
  <div id="nilai-tab-grafik" class="nilai-tab-content">
    <div class="nilai-graph-tabs">
      <button class="nilai-graph-tab active" data-graph="kelas">Top Kelas</button>
      <button class="nilai-graph-tab" data-graph="unit">Top Unit Ndalem</button>
      <button class="nilai-graph-tab" data-graph="individu">Top Nama</button>
    </div>	

    <!-- Tambahan filter grafik -->
    <div class="nilai-filter-row">
      <div class="nilai-filter-group">
        <label for="nilaiGraphSemester">Semester:</label>
        <select id="nilaiGraphSemester">
          <option value="semua">Semua</option>
        </select>
      </div>
      <div class="nilai-filter-group">
        <label for="nilaiGraphTahun">Tahun Ajaran:</label>
        <select id="nilaiGraphTahun">
          <option value="semua">Semua</option>
        </select>
      </div>
    </div>
	
	<!-- ‚úÖ Header grafik dipisah -->
  <div class="nilai-chart-header" id="nilai-chart-header">
    Semester - | Tahun Ajaran -
  </div>

    <div class="nilai-chart-container">
      <div class="nilai-chart-scroll-wrapper">
        <div class="nilai-chart-scroll-inner">
          <canvas id="nilai-chart"></canvas>
        </div>
      </div>
    </div>
  </div> <!-- ‚úÖ tutup nilai-tab-grafik -->
</div> <!-- ‚úÖ tutup nilai-module -->

<!-- Inventaris Module -->
<div id="inventaris-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Inventaris</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddInventaris()">‚ûï Tambah</button>
    <button class="admin-only" onclick="downloadInventarisPDF()">‚¨áÔ∏è Download PDF</button>
  </div>

  <div class="simple-table-container">
    <table class="simple-table" id="inventaris-table"></table>
  </div>
</div>

<!-- Pelanggaran Module -->
<div id="pelanggaran-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Pelanggaran</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddPelanggaran()">‚ûï Tambah</button>
    <button class="admin-only" onclick="downloadPelanggaranPDF()">‚¨áÔ∏è Download PDF</button>
  </div>

  <div class="simple-table-container">
    <table class="simple-table" id="pelanggaran-table"></table>
  </div>
</div>

<!-- Info Module -->
<div id="info-module" class="module-container">
  <div class="back-button" onclick="showMainGrid()">
    <i class="material-icons">arrow_back</i>
    <span>Kembali ke Menu Utama</span>
  </div>
  <h2>Data Informasi</h2>
  
  <div class="admin-tools">
    <button class="admin-only" onclick="openAddInfo()">‚ûï Tambah</button>
    <button class="admin-only" onclick="downloadInfoPDF()">‚¨áÔ∏è Download PDF</button>
  </div>


  <!-- Filter -->
  <div class="filter-row">
    <div class="filter-group">
      <label for="infoSearchIsi">Cari Informasi:</label>
      <input id="infoSearchIsi" placeholder="Cari isi informasi..." oninput="filterInfo()">
    </div>
  </div>

  <!-- Tabel -->
  <div class="data-table-container">
    <table class="data-table" id="info-table"></table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <div id="infoPaginationInfo" class="pagination-info">Menampilkan 0 data</div>
    <div id="infoPaginationControls" class="pagination-controls"></div>
  </div>
</div>


  <script>
   
document.addEventListener("DOMContentLoaded", () => {
  const userRole = localStorage.getItem("userRole") || "user";

  supabaseClient.auth.getUser().then(({ data }) => {
    if (data.user) {
      // Role ditampilkan di atas
      document.getElementById("userRoleText").textContent =
        (userRole === "admin") ? "Admin" : "User";

      // Email ditampilkan di bawah
      document.getElementById("userEmail").textContent = data.user.email;
    }
  });
});


  
  const userRole = localStorage.getItem("userRole") || "user";

document.addEventListener("DOMContentLoaded", () => {
  if (userRole === "admin") {
    document.querySelectorAll(".admin-only").forEach(btn => btn.style.display = "inline-block");
  } else {
    document.querySelectorAll(".admin-only").forEach(btn => btn.style.display = "none");
  }
});

  
 

    // Konfigurasi Supabase
    const SUPABASE_URL = "https://oflkibeaesvwzdzyvdfy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbGtpYmVhZXN2d3pkenl2ZGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDIyOTQsImV4cCI6MjA3MDQxODI5NH0.MMcdx7g54R9kqFdfkDPP57gNPCnxGLKWHhexTAcJ2io";

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Variabel global
	const pageSize = 50;
	let allSantriData = [];
	let allAbsensiData = [];
	let allPenasehatData = [];
	let penasehatCurrentPage = 1;
	const penasehatRowsPerPage = 50;
	let penasehatFiltered = [];
	let allGuruData = [];
	let guruFiltered = [];
	let guruCurrentPage = 1;
	const guruRowsPerPage = 50;
	let allInfoData = [];
	let infoFiltered = [];
	let infoCurrentPage = 1;
	const infoRowsPerPage = 50;
	let santriDict = {};            // dictionary: key = Stambuk
	let allNilaiData = [];          // semua data nilai
	let nilaiFilteredStudents = [];
	let nilaiCurrentPage = 1;
	const nilaiRowsPerPage = 10;
	let nilaiChartInstance = null;
	let lastActiveData = [];        // untuk download
	let lastEditedId = null;        // simpan id terakhir ditambah/diubah
	let lastFilteredData = [];      // simpan hasil filter terakhir
	let currentSortColumn = null;
	let sortDirection = 'asc';


    
    const kelasOrder = [
      'SP', 'V Ibtidaiyah', 'VI Ibtidaiyah',
      'I Tsanawiyah', 'II Tsanawiyah', 'III Tsanawiyah', 
      'I Aliyah', 'II Aliyah', 'III Aliyah',
      "I-II Ma'had Aly", "III-IV Ma'had Aly", "V-VI Ma'had Aly"
    ];
	
	const kelasOrderGuru = [
	  'I Ibtidaiyah', 'II Ibtidaiyah', 'III Ibtidaiyah', 'IV Ibtidaiyah', 'V Ibtidaiyah', 'VI Ibtidaiyah',
	  'I Tsanawiyah', 'II Tsanawiyah', 'III Tsanawiyah', 
	  'I Aliyah', 'II Aliyah', 'III Aliyah',
	  "I-II Ma'had Aly", "III-IV Ma'had Aly", "V-VI Ma'had Aly"
	];

	
	// Bulan untuk absensi
    const bulanAbsensi = [
      "Syawal", "Dzulqo'dah", "Dzulhijjah", 
      "Muharam", "Shofar", "Robi'ul Awal", "Robi'ul Akhir", "Jumadal Ula", "Jumadal Tsaniyah", "Rajab", "Sya'ban"
    ];

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', async () => {
      // Setup grid item clicks dengan efek ripple
      document.querySelectorAll('.grid-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Efek ripple
          const ripple = document.createElement('span');
          ripple.classList.add('ripple-effect');
          const rect = this.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          const x = e.clientX - rect.left - size/2;
          const y = e.clientY - rect.top - size/2;
          
          ripple.style.width = ripple.style.height = `${size}px`;
          ripple.style.left = `${x}px`;
          ripple.style.top = `${y}px`;
          this.appendChild(ripple);
          
          // Hapus ripple setelah animasi selesai
          setTimeout(() => {
            ripple.remove();
          }, 600);
          
          // Buka modul
          const module = item.dataset.module;
          showModule(module);
        });
      });
      
      // Setup tab clicks
      document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs
          document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab
          tab.classList.add('active');
          const tabName = tab.dataset.tab;
          document.getElementById(`tab-${tabName}`).classList.add('active');
          
          // If data tab is selected, render the table
          if (tabName === 'data') {
            renderFullTable(allSantriData);
          }
        });
      });
      
      // Load initial data
      await loadInitialData();
    });
    
    // Fungsi untuk menampilkan modul tertentu
	function showModule(moduleName) {
	  // Sembunyikan grid utama
	  document.getElementById('main-grid').style.display = 'none';
	  
	  // Sembunyikan semua modul
	  document.querySelectorAll('.module-container').forEach(module => {
		module.classList.remove('active');
	  });
	  
	  // Tampilkan modul yang dipilih
	  const moduleElement = document.getElementById(`${moduleName}-module`);
	  if (moduleElement) {
		moduleElement.classList.add('active');

		if (moduleName === 'santri') {
		  renderSantriCards(allSantriData);
		} else if (moduleName === 'absensi') {
		  loadAbsensiData();
		} else if (moduleName === 'inventaris') {
		  loadInventaris();
		} else if (moduleName === 'pelanggaran') {
		  loadPelanggaran();		
		} else if (moduleName === 'nilai') {
		  loadNilai();
		} else if (moduleName === 'penasehat') {
		  loadPenasehat();	
		} else if (moduleName === 'guru') {
		  loadGuru();
		} else if (moduleName === 'info') {
		  loadInfo();
		}
	  }
	}

    
    // Fungsi untuk kembali ke grid utama
    function showMainGrid() {
      // Sembunyikan semua modul
      document.querySelectorAll('.module-container').forEach(module => {
        module.classList.remove('active');
      });
      
      // Tampilkan grid utama
      document.getElementById('main-grid').style.display = 'block';
    }
    
    // Fungsi untuk memuat data awal dari Supabase dengan fallback IndexedDB
	async function loadInitialData() {
	  showLoading(true);
	  try {
		// === Ambil data santri ===
		const { data: santriData, error: santriError } = await supabaseClient
		  .from('santri_kharisma')
		  .select('*, Mulai_Ngabdi');
		
		if (santriError) throw santriError;
		allSantriData = santriData;

		// Simpan ke IndexedDB
		await saveToDB('santri_kharisma', santriData);

		// === Ambil data absensi ===
		const { data: absensiData, error: absensiError } = await supabaseClient
		  .from('absensi')
		  .select('*');
		
		if (absensiError) throw absensiError;
		allAbsensiData = absensiData;

		// Simpan ke IndexedDB
		await saveToDB('absensi', absensiData);

		// Isi dropdown Kelas dan Unit Ndalem
		populateDropdowns();

	  } catch (error) {
		console.warn("Gagal load Supabase, coba dari IndexedDB:", error);

		// === Fallback ambil data dari IndexedDB ===
		const cachedSantri = await getFromDB('santri_kharisma');
		if (cachedSantri.length > 0) {
		  allSantriData = cachedSantri;
		}

		const cachedAbsensi = await getFromDB('absensi');
		if (cachedAbsensi.length > 0) {
		  allAbsensiData = cachedAbsensi;
		}

		// Kalau masih kosong semua, tampilkan error
		if (cachedSantri.length === 0 && cachedAbsensi.length === 0) {
		  showError("Tidak ada data offline tersimpan. Silakan login saat online dulu.");
		} else {
		  populateDropdowns();
		}

	  } finally {
		showLoading(false);
	  }
	}


    // ========== POPULATE DROPDOWNS (TIDAK RESET PILIHAN) ==========
function populateDropdowns() {
  const kelasDropdown = document.getElementById('searchKelas');
  const unitDropdown = document.getElementById('searchUnit');
  const absensiKelasDropdown = document.getElementById('absensiSearchKelas');
  const absensiUnitDropdown = document.getElementById('absensiSearchUnit');

  // simpan pilihan lama
  const prevKelas = kelasDropdown.value;
  const prevUnit = unitDropdown.value;
  const prevAbsensiKelas = absensiKelasDropdown.value;
  const prevAbsensiUnit = absensiUnitDropdown.value;

  // reset isi
  kelasDropdown.innerHTML = '<option value="semua">Semua Kelas</option>';
  unitDropdown.innerHTML = '<option value="semua">Semua Unit</option>';
  absensiKelasDropdown.innerHTML = '<option value="semua">Semua Kelas</option>';
  absensiUnitDropdown.innerHTML = '<option value="semua">Semua Unit</option>';

  // kelas unik
  const kelasSet = new Set(allSantriData.map(s => s.Kelas).filter(Boolean));
  const sortedKelas = Array.from(kelasSet).sort((a, b) => {
    const indexA = kelasOrder.indexOf(a);
    const indexB = kelasOrder.indexOf(b);
    return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
  });

  sortedKelas.forEach(kelas => {
    const count = allSantriData.filter(s => s.Kelas === kelas).length;
    const option = new Option(`${kelas} (${count})`, kelas);
    kelasDropdown.appendChild(option);
    absensiKelasDropdown.appendChild(new Option(option.text, option.value));
  });

  // unit unik
  const unitSet = new Set(allSantriData.map(s => s.Unit_Ndalem).filter(Boolean));
  const sortedUnits = Array.from(unitSet).sort();

  sortedUnits.forEach(unit => {
    const count = allSantriData.filter(s => s.Unit_Ndalem === unit).length;
    const option = new Option(`${unit} (${count})`, unit);
    unitDropdown.appendChild(option);
    absensiUnitDropdown.appendChild(new Option(option.text, option.value));
  });

  // restore pilihan lama
  if ([...kelasDropdown.options].some(o => o.value === prevKelas)) kelasDropdown.value = prevKelas;
  if ([...unitDropdown.options].some(o => o.value === prevUnit)) unitDropdown.value = prevUnit;
  if ([...absensiKelasDropdown.options].some(o => o.value === prevAbsensiKelas)) absensiKelasDropdown.value = prevAbsensiKelas;
  if ([...absensiUnitDropdown.options].some(o => o.value === prevAbsensiUnit)) absensiUnitDropdown.value = prevAbsensiUnit;
}

    // ========== SANTRI MODULE FUNCTIONS ==========
    function renderSantriCards(list) {
      const container = document.getElementById('santri-container');
      container.innerHTML = '';

      // Urutkan data
      list.sort((a, b) => {
        const unitCompare = (a.Unit_Ndalem || '').localeCompare(b.Unit_Ndalem || '');
        if (unitCompare !== 0) return unitCompare;
        const kelasA = kelasOrder.indexOf(a.Kelas) === -1 ? 999 : kelasOrder.indexOf(a.Kelas);
        const kelasB = kelasOrder.indexOf(b.Kelas) === -1 ? 999 : kelasOrder.indexOf(b.Kelas);
        if (kelasA !== kelasB) return kelasA - kelasB;
        return (a.Nama_Lengkap || '').localeCompare(b.Nama_Lengkap || '');
      });

      // Kelompokkan berdasarkan unit
      const groupedByUnit = {};
      list.forEach(santri => {
        const unit = santri.Unit_Ndalem || 'Tidak Diketahui';
        if (!groupedByUnit[unit]) groupedByUnit[unit] = [];
        groupedByUnit[unit].push(santri);
      });

      // Render setiap unit
      for (const unit in groupedByUnit) {
        const unitDiv = document.createElement('div');
        unitDiv.className = 'unit-group';

        const unitHeader = document.createElement('div');
        unitHeader.className = 'unit-header';
        unitHeader.innerHTML = `
          <span class="triangle"></span>
          <span class="unit-name">${unit}</span>
          <span class="unit-total">${groupedByUnit[unit].length} santri</span>
        `;
        unitHeader.onclick = () => toggleUnit(unitHeader);

        const unitCards = document.createElement('div');
        unitCards.className = 'unit-cards';

        groupedByUnit[unit].forEach(santri => {
          const card = createSantriCard(santri);
          unitCards.appendChild(card);
        });

        unitDiv.appendChild(unitHeader);
        unitDiv.appendChild(unitCards);
        container.appendChild(unitDiv);
      }
    }

    function createSantriCard(santri) {
	  const card = document.createElement('div');
	  card.className = `santri-card ${santri.Status === 'tidak aktif' ? 'tidak-aktif' : ''}`;
	  card.onclick = () => selectSantri(santri, card);

	  // Gunakan foto santri jika ada, jika tidak gunakan placeholder
	  const imgUrl = santri.Foto || 'img/placeholder.png';

	  card.innerHTML = `
		<!-- Logo Lembaga -->
		<img src="img/lembaga.png" class="logolembaga" alt="Logo Lembaga">

		<div class="santri-info">
		  <img class="photo" 
			   src="${imgUrl}" 
			   alt="${santri.Nama_Lengkap || 'Santri'}"
			   onerror="this.src='img/placeholder.png'">

		  <div class="info">
			<h3><span>Nama</span>: <span>${santri.Nama_Lengkap || '-'}</span></h3>
			<p><span>Kelas</span>: <span>${santri.Kelas || '-'}</span></p>
			<p><span>Bagian</span>: <span>${santri.Bagian || '-'}</span></p>
			<p><span>Stambuk</span>: <span>${santri.Stambuk || '-'}</span></p>
			<p><span>Asal</span>: <span>${santri.Asal_Daerah || '-'}</span></p>
			<p><span>Kamar</span>: <span>${santri.Kamar || '-'}</span></p>
			<p><span>Unit Ndalem</span>: <span>${santri.Unit_Ndalem || '-'}</span></p>
		  </div>
		</div>

		${santri.Status === 'tidak aktif' ? '<div class="status-badge">TIDAK AKTIF</div>' : ''}
	  `;

	  return card;
	}


    function toggleUnit(header) {
      header.classList.toggle('collapsed');
      const cards = header.nextElementSibling;
      cards.classList.toggle('hidden');
    }
  
// ========== FILTER ==========
function filterSantri() {
  const searchTerm = document.getElementById('searchNama').value.toLowerCase();
  const selectedKelas = document.getElementById('searchKelas').value;
  const selectedUnit = document.getElementById('searchUnit').value;

  lastFilteredData = allSantriData.filter(santri => {
    const namaMatch = santri.Nama_Lengkap?.toLowerCase().includes(searchTerm) || false;
    const kelasMatch = selectedKelas === 'semua' || santri.Kelas === selectedKelas;
    const unitMatch = selectedUnit === 'semua' || santri.Unit_Ndalem === selectedUnit;
    return namaMatch && kelasMatch && unitMatch;
  });

  const activeTab = document.querySelector('.tab-item.active').dataset.tab;
  if (activeTab === 'kartu') {
    renderSantriCards(lastFilteredData);
  } else {
    renderFullTable(lastFilteredData);
  }
}

	
	// ===== Helper: hitung jumlah bulan sejak `start` sampai sekarang =====
function monthsSince(startDate) {
  if (!startDate || isNaN(startDate)) return null; // null = tidak valid
  const now = new Date();
  let years = now.getFullYear() - startDate.getFullYear();
  let months = now.getMonth() - startDate.getMonth();
  if (now.getDate() < startDate.getDate()) months -= 1;
  if (months < 0) { years -= 1; months += 12; }
  return years * 12 + months; // bisa 0, >0
}

// ===== Hitung Masa Khidmah (tampil) =====
function calculateMasaKhidmah(mulaiValue) {
  if (!mulaiValue) return 'Belum terdata'; // sesuai permintaan

  const start = (mulaiValue instanceof Date) ? mulaiValue : new Date(mulaiValue);
  if (isNaN(start)) return 'Belum terdata';

  const totalMonths = monthsSince(start);
  if (totalMonths === null) return 'Belum terdata';
  if (totalMonths <= 0) return '< 1 bln';

  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;

  if (years > 0 && months > 0) return `${years} th, ${months} bln`; // pakai koma
  if (years > 0) return `${years} th`;
  return `${months} bln`;
}

// ========== SORT TABLE ==========
function sortTableBy(column) {
  if (currentSortColumn === column) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortColumn = column;
    sortDirection = 'asc';
  }

  const fieldMap = {
    'Nama': 'Nama_Lengkap',
    'Kelas': 'Kelas',
    'Bagian': 'Bagian',
    'Asal Daerah': 'Asal_Daerah',
    'Kamar': 'Kamar',
    'Unit Ndalem': 'Unit_Ndalem',
    'Posisi Tugas': 'Posisi_Tugas',
    'Shift': 'Shift',
    'Jam Tugas': 'Jam_Tugas',
    'Masa Khidmah': 'Mulai_Ngabdi'
  };
  const field = fieldMap[column];
  if (!field) return;

  if (!lastFilteredData.length) lastFilteredData = [...allSantriData];

  lastFilteredData.sort((a, b) => {
    const rawA = a[field];
    const rawB = b[field];

    if (field === 'Kelas') {
      const idxA = kelasOrder.indexOf(rawA) === -1 ? 999 : kelasOrder.indexOf(rawA);
      const idxB = kelasOrder.indexOf(rawB) === -1 ? 999 : kelasOrder.indexOf(rawB);
      return sortDirection === 'asc' ? idxA - idxB : idxB - idxA;
    }

    if (field === 'Mulai_Ngabdi') {
      const dateA = rawA ? new Date(rawA) : null;
      const dateB = rawB ? new Date(rawB) : null;
      const monthsA = (dateA && !isNaN(dateA)) ? monthsSince(dateA) : null;
      const monthsB = (dateB && !isNaN(dateB)) ? monthsSince(dateB) : null;

      if (monthsA === null && monthsB === null) return 0;
      if (monthsA === null) return sortDirection === 'asc' ? -1 : 1;
      if (monthsB === null) return sortDirection === 'asc' ? 1 : -1;

      return sortDirection === 'asc' ? monthsA - monthsB : monthsB - monthsA;
    }

    const valA = (rawA ?? '').toString().toLowerCase();
    const valB = (rawB ?? '').toString().toLowerCase();
    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  renderFullTable(lastFilteredData);

  // update indikator panah
  document.querySelectorAll('th.sortable').forEach(th => {
    th.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
  });
  const activeTh = document.querySelector(`th.sortable[data-column="${column}"]`);
  if (activeTh) {
    activeTh.classList.add('sorted');
    activeTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
  }
}

// Ambil data terakhir yang sudah difilter + diurutkan
// ========== HELPER EXPORT DATA ==========
function getExportData() {
  // Ambil dataset hasil filter terakhir kalau ada
  let exportData = (typeof lastFilteredData !== "undefined" && lastFilteredData.length)
    ? lastFilteredData
    : allSantriData;

  // Filter hanya santri aktif
  return exportData.filter(s => s.Status && s.Status.toLowerCase() === "aktif");
}



function renderFullTable(data, page = 1) {
  const container = document.getElementById('santri-table-container');
  container.innerHTML = '';

  const activeData = data.filter(s => s.Status && s.Status.toLowerCase() === 'aktif');
  const totalRecords = activeData.length;
  const totalPages = Math.max(1, Math.ceil(totalRecords / pageSize));
  const start = (page - 1) * pageSize;
  const end = Math.min(start + pageSize, totalRecords);
  const paginatedData = activeData.slice(start, end);

  const table = document.createElement('table');
  table.className = 'data-table';

  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  const headers = [
    'No','Foto','Nama','Kelas','Bagian',
    'Asal Daerah','Himpunan','Kamar','Unit Ndalem',
    'Posisi Tugas','Shift','Jam Tugas','Masa Khidmah'
  ];
  if (userRole === "admin") headers.push("Aksi");

  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    th.classList.add('sortable');
    th.dataset.column = h;
    if (h === 'Nama') th.classList.add('nama'); // ‚úÖ sticky Nama
    if (h !== 'Aksi') th.onclick = () => sortTableBy(h);

    const indicator = document.createElement('span');
    indicator.className = 'sort-indicator';
    th.appendChild(indicator);
    headerRow.appendChild(th);
  });

  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  paginatedData.forEach((santri, idx) => {
    const tr = document.createElement('tr');
    const imgUrl = santri.Foto || 'https://i.imgur.com/W3UiaBA.png';

    tr.innerHTML = `
      <td>${start + idx + 1}</td>
      <td><img src="${imgUrl}" alt="${santri.Nama_Lengkap || 'Santri'}"></td>
      <td class="nama">${santri.Nama_Lengkap || '-'}</td>
      <td>${santri.Kelas || '-'}</td>
      <td>${santri.Bagian || '-'}</td>
      <td>${santri.Asal_Daerah || '-'}</td>
      <td>${santri.Himpunan || '-'}</td>
      <td>${santri.Kamar || '-'}</td>
      <td>${santri.Unit_Ndalem || '-'}</td>
      <td>${santri.Posisi_Tugas || '-'}</td>
      <td>${santri.Shift || '-'}</td>
      <td>${santri.Jam_Tugas || '-'}</td>
      <td>${calculateMasaKhidmah(santri.Mulai_Ngabdi)}</td>
    `;

    if (userRole === "admin") {
      const td = document.createElement("td");
      td.innerHTML = `
        <button onclick="openEditSantri(${santri.id})">‚úèÔ∏è Edit</button>
        <button onclick="removeSantri(${santri.id})">üóëÔ∏è Hapus</button>
      `;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  container.appendChild(table);

  document.getElementById('paginationInfo').textContent =
    totalRecords === 0 ? 'Menampilkan 0 data' :
    `Menampilkan ${start + 1} - ${end} dari ${totalRecords} data`;

  updatePaginationControls(totalPages, page, activeData);
}


	
	function updatePaginationControls(totalPages, currentPage, data) {
  const paginationControls = document.getElementById('paginationControls');
  paginationControls.innerHTML = '';

  if (totalPages <= 1) return;

  // Prev button
  if (currentPage > 1) {
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Sebelumnya';
    prevBtn.onclick = () => renderFullTable(data, currentPage - 1);
    paginationControls.appendChild(prevBtn);
  }

  // Page numbers (max 5 tampil)
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
  let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }

  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.textContent = i;
    if (i === currentPage) pageBtn.classList.add('active');
    pageBtn.onclick = () => renderFullTable(data, i);
    paginationControls.appendChild(pageBtn);
  }

  // Next button
  if (currentPage < totalPages) {
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Berikutnya';
    nextBtn.onclick = () => renderFullTable(data, currentPage + 1);
    paginationControls.appendChild(nextBtn);
  }
}


function populateAbsensiDropdowns() {
  const kelasDropdown = document.getElementById('absensiSearchKelas');
  const unitDropdown = document.getElementById('absensiSearchUnit');
  if (!kelasDropdown || !unitDropdown) return;

  // build kelas options from allSantriData
  const kelasSet = new Set();
  allSantriData.forEach(s => { if (s.Kelas) kelasSet.add(s.Kelas); });
  const sortedKelas = Array.from(kelasSet).sort((a,b)=>{
    const ia = kelasOrder.indexOf(a);
    const ib = kelasOrder.indexOf(b);
    return (ia===-1?999:ia)-(ib===-1?999:ib);
  });
  kelasDropdown.innerHTML = '<option value="semua">Semua Kelas</option>';
  sortedKelas.forEach(k=>{
    const count = allSantriData.filter(s=>s.Kelas===k).length;
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = `${k} (${count})`;
    kelasDropdown.appendChild(opt);
  });

  // build unit options from allSantriData
  const unitSet = new Set();
  allSantriData.forEach(s => { if (s.Unit_Ndalem) unitSet.add(s.Unit_Ndalem); });
  const sortedUnits = Array.from(unitSet).sort();
  unitDropdown.innerHTML = '<option value="semua">Semua Unit</option>';
  sortedUnits.forEach(u=>{
    const count = allSantriData.filter(s=>s.Unit_Ndalem===u).length;
    const opt = document.createElement('option');
    opt.value = u;
    opt.textContent = `${u} (${count})`;
    unitDropdown.appendChild(opt);
  });
}

// ========== ABSENSI MODULE FUNCTIONS ==========
    function loadAbsensiData() {
      const filterMerah = document.getElementById('filterMerahCheckbox').checked;
      const searchTerm = document.getElementById('absensiSearchNama').value.toLowerCase();
      const selectedKelas = document.getElementById('absensiSearchKelas').value;
      const selectedUnit = document.getElementById('absensiSearchUnit').value;
      
      // Filter data
      let filteredData = allSantriData.filter(santri => {
        const namaMatch = santri.Nama_Lengkap?.toLowerCase().includes(searchTerm) || false;
        const kelasMatch = selectedKelas === 'semua' || santri.Kelas === selectedKelas;
        const unitMatch = selectedUnit === 'semua' || santri.Unit_Ndalem === selectedUnit;
        
        return namaMatch && kelasMatch && unitMatch;
      });
    
      // Jika filter merah aktif, filter data yang memiliki absensi merah
      if (filterMerah) {
        filteredData = filteredData.filter(santri => {
          const absensi = getAbsensiByStambuk(santri.Stambuk);
          return absensi.some(item => item.tanpaIzin >= 3);
        });
      }

      renderAbsensiTable(filteredData);
    }

    function getAbsensiByStambuk(stambuk) {
      const absensiRecord = allAbsensiData.find(item => item.Stambuk === stambuk);
      if (!absensiRecord) return [];
      
      const absensi = [];
      
      for (let i = 0; i < bulanAbsensi.length; i++) {
        const bulan = bulanAbsensi[i];
        const sakit = absensiRecord[`S_(${bulan})`] || 0;
        const izin = absensiRecord[`I_(${bulan})`] || 0;
        const tanpaIzin = absensiRecord[`T_(${bulan})`] || 0;
        
        // Tampilkan '-' jika nilai 0 atau kosong
        absensi.push({
          bulan: bulan,
          sakit: sakit === 0 || sakit === '' ? '-' : sakit,
          izin: izin === 0 || izin === '' ? '-' : izin,
          tanpaIzin: tanpaIzin === 0 || tanpaIzin === '' ? '-' : tanpaIzin
        });
      }
      
      return absensi;
    }

    function renderAbsensiTable(data) {
  const container = document.getElementById('absensi-container');
  container.innerHTML = '';

  data.forEach((santri, index) => {
    const absensi = getAbsensiByStambuk(santri.Stambuk) || [];
    const imgUrl = santri.Foto || 'https://i.imgur.com/W3UiaBA.png';

    // HTML absensi bulanan
    const absensiHtml = absensi.map((abs, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>${abs.bulan}</td>
        <td>${abs.sakit}</td>
        <td>${abs.izin}</td>
        <td class="${Number(abs.tanpaIzin) >= 3 ? 'merah' : ''}">
          ${abs.tanpaIzin}
        </td>
      </tr>
    `).join('');

    const box = document.createElement('div');
    box.className = 'santri-box';
    box.innerHTML = `
      <!-- Info Santri -->
      <table style="width:100%; border-collapse:collapse; margin-bottom:12px; text-align:center; border:1px solid #cce0ff; table-layout:auto;">
        <thead>
          <tr>
            <th style="width:40px;">No</th>
            <th>Foto</th>
            <th>Nama</th>
            <th>Kls</th>
            <th>Bag</th>
            <th>Unit</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${index + 1}</td>
            <td>
              <img src="${imgUrl}" alt="Foto ${santri.Nama_Lengkap || 'Santri'}"
                   style="width: 70px; height: 95px; object-fit: cover; border: 1px solid #1a73e8;"
                   onerror="this.style.display='none'">
            </td>
            <td>${santri.Nama_Lengkap || '-'}</td>
            <td>${santri.Kelas || '-'}</td>
            <td>${santri.Bagian || '-'}</td>
            <td>${santri.Unit_Ndalem || '-'}</td>
          </tr>
        </tbody>
      </table>

      <!-- Tabel Absensi -->
      <table style="width:100%; border-collapse:collapse; text-align:center; border:1px solid #cce0ff;">
        <thead>
          <tr>
            <th>No</th>
            <th>Bulan</th>
            <th>Sakit</th>
            <th>Izin</th>
            <th>Tanpa Izin</th>
          </tr>
        </thead>
        <tbody>
          ${absensiHtml}
        </tbody>
      </table>
    `;
    container.appendChild(box);
  });

  // CSS khusus nilai merah
  const style = document.createElement('style');
  style.textContent = `
    .merah {
      background-color: #ffcccc !important;
      color: #cc0000 !important;
      font-weight: bold;
    }
  `;
  container.appendChild(style);
}



// ========== UTILITY FUNCTIONS ==========
    function showLoading(show) {
      const loadingScreen = document.getElementById('loading-screen');
      const loadingIndicator = document.getElementById('loadingIndicator');
      
      if (show) {
        loadingScreen.style.display = 'flex';
        loadingIndicator.style.display = 'block';
        setTimeout(() => {
          document.querySelector('#loadingIndicator .progress').style.width = '70%';
        }, 100);
      } else {
        loadingScreen.style.display = 'none';
        document.querySelector('#loadingIndicator .progress').style.width = '100%';
        setTimeout(() => {
          loadingIndicator.style.display = 'none';
          document.querySelector('#loadingIndicator .progress').style.width = '0%';
        }, 300);
      }
    }
    
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }
	
	/* ====== UTIL: CSS untuk mobile-friendly table ====== */
/* ====== UTIL: CSS untuk table Inventaris & Pelanggaran ====== */
(function ensureSimpleTableStylesOnce() {
  if (document.getElementById('simple-table-styles')) return;
  const style = document.createElement('style');
  style.id = 'simple-table-styles';
  style.textContent = `
    .simple-table-container { 
      overflow-x: auto; 
      -webkit-overflow-scrolling: touch; 
      width: 100%;
    }
    .simple-table {
  width: 100%;
  min-width: 800px;         /* biar nggak terjepit */
  border-collapse: collapse;
  background: #fff;
  table-layout: fixed;      /* ‚úÖ kolom sama rata */
}
    /* Header */
.simple-table thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #1a73e8;
  color: #fff;
  text-align: center;
}
    .simple-table th,
.simple-table td {
  border: 1px solid #e6e6e6;
  padding: .6rem .7rem;
  font-size: 13px;
  text-align: left;
  vertical-align: middle;
  word-wrap: break-word;
  white-space: normal;      /* ‚úÖ teks otomatis kebawah */
  overflow-wrap: break-word;
}
    /* Hover effect */
.simple-table tbody tr:hover {
  background: #f9f9f9;
}

/* Kolom pertama (No) kecil saja */
.simple-table th:nth-child(1),
.simple-table td:nth-child(1) {
  width: 50px;
  text-align: center;
}

  `;
  document.head.appendChild(style);
})();


/* ====== GENERIC TABLE RENDERER (custom kolom + label + formatter) ====== */
function renderTable(tableId, rows, columns) {
  const table = document.getElementById(tableId);
  table.innerHTML = '';

  if (!rows || rows.length === 0) {
    table.innerHTML = '<tr><td>Tidak ada data</td></tr>';
    return;
  }

  // Header
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');

  // Tambahkan kolom No.
  const thNo = document.createElement('th');
  thNo.textContent = 'No';
  trHead.appendChild(thNo);

  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label ?? col.key;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);
  table.appendChild(thead);

  // Body
  const tbody = document.createElement('tbody');
  rows.forEach((row, index) => {
    const tr = document.createElement('tr');

    // Kolom No.
    const tdNo = document.createElement('td');
    tdNo.textContent = index + 1;   // otomatis sesuai urutan
    tr.appendChild(tdNo);

    // Kolom lain
    columns.forEach(col => {
      const td = document.createElement('td');
      let value = row[col.key];

      if (col.format && typeof col.format === 'function') {
        value = col.format(value, row);
      } else if (value == null || value === '') {
        value = '-';
      }

      td.textContent = value;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}


/* ====== HELPER UNTUK FORMAT TANGGAL ====== */
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  if (isNaN(d)) return '-';
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}-${month}-${year}`;
}

/* ====== INVENTARIS (custom kolom) ====== */
async function loadInventaris() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('Inventaris')
      .select(`
        Kode_Unit, Jenis_Kendaraan, Merk, NOPOL, Penanggung_Jawab, Keterangan, Update_Tgl,
        unit:Kode_Unit (Nama_Unit)
      `);

    if (error) throw error;

    const mapped = (data || []).map(row => ({
      Nama_Unit: row.unit?.Nama_Unit ?? '-',
      Jenis_Kendaraan: row.Jenis_Kendaraan ?? '-',
      Merk: row.Merk ?? '-',
      NOPOL: row.NOPOL ?? '-',
      Penanggung_Jawab: row.Penanggung_Jawab ?? '-',
      Keterangan: row.Keterangan ?? '-',
      Update_Tgl: formatDate(row.Update_Tgl),
      Kode_Unit: row.Kode_Unit ?? '-'
    }));

    // Simpan ke IndexedDB
    await saveToDB('Inventaris', mapped);

    const cols = [
      { key: 'Nama_Unit', label: 'Unit Ndalem' },
      { key: 'Jenis_Kendaraan', label: 'Jenis' },
      { key: 'Merk', label: 'Merk' },
      { key: 'NOPOL', label: 'NOPOL' },
      { key: 'Penanggung_Jawab', label: 'Penanggung Jawab' },
      { key: 'Keterangan', label: 'Keterangan' },
      { key: 'Update_Tgl', label: 'Update Tgl' }
    ];

    renderTable('inventaris-table', mapped, cols);
  } catch (err) {
    console.warn("Gagal load Inventaris dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('Inventaris');
    if (cached.length > 0) {
      const cols = [
        { key: 'Nama_Unit', label: 'Unit Ndalem' },
        { key: 'Jenis_Kendaraan', label: 'Jenis' },
        { key: 'Merk', label: 'Merk' },
        { key: 'NOPOL', label: 'NOPOL' },
        { key: 'Penanggung_Jawab', label: 'Penanggung Jawab' },
        { key: 'Keterangan', label: 'Keterangan' },
        { key: 'Update_Tgl', label: 'Update Tgl' }
      ];
      renderTable('inventaris-table', cached, cols);
    } else {
      showError("Tidak ada data Inventaris offline.");
    }
  } finally {
    showLoading(false);
  }
}



/* ====== PELANGGARAN (custom kolom) ====== */
async function loadPelanggaran() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('Pelanggaran')
      .select(`
        Tanggal, Stambuk, Kode_Unit, Pelanggaran,
        santri:Stambuk (Nama_Lengkap),
        unit:Kode_Unit (Nama_Unit)
      `);

    if (error) throw error;

    const mapped = (data || []).map(row => ({
      Tanggal: row.Tanggal ?? null,
      Nama_Santri: row.santri?.Nama_Lengkap ?? '-',
      Pelanggaran: row.Pelanggaran ?? '-',
      Nama_Unit: row.unit?.Nama_Unit ?? '-',
      Stambuk: row.Stambuk ?? '-',
      Kode_Unit: row.Kode_Unit ?? '-'
    }));

    // Simpan hasil ke IndexedDB
    await saveToDB('Pelanggaran', mapped);

    const cols = [
      { key: 'Tanggal', label: 'Tanggal', format: (v) => {
        if (!v) return '-';
        try {
          const d = new Date(v);
          if (isNaN(d)) return String(v);
          return d.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch {
          return String(v);
        }
      }},
      { key: 'Nama_Santri', label: 'Nama Santri' },
      { key: 'Nama_Unit', label: 'Unit Ndalem' },
      { key: 'Pelanggaran', label: 'Pelanggaran' }
    ];

    renderTable('pelanggaran-table', mapped, cols);
  } catch (err) {
    console.warn("Gagal load Supabase, coba dari IndexedDB:", err);

    const cached = await getFromDB('Pelanggaran');
    if (cached.length > 0) {
      const cols = [
        { key: 'Tanggal', label: 'Tanggal' },
        { key: 'Nama_Santri', label: 'Nama Santri' },
        { key: 'Nama_Unit', label: 'Unit Ndalem' },
        { key: 'Pelanggaran', label: 'Pelanggaran' }
      ];
      renderTable('pelanggaran-table', cached, cols);
    } else {
      showError("Tidak ada data Pelanggaran offline.");
    }
  } finally {
    showLoading(false);
  }
}

async function loadReferensiUnit() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('referensi_unit_ndalem')
      .select('Kode_Unit, Nama_Unit')
      .order('Nama_Unit', { ascending: true });

    if (error) throw error;

    allUnitData = data;

    // Simpan ke IndexedDB
    await saveToDB('referensi_unit_ndalem', data);

    console.log("‚úÖ referensi_unit_ndalem loaded:", allUnitData.length);
  } catch (err) {
    console.warn("Gagal load referensi_unit_ndalem dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('referensi_unit_ndalem');
    if (cached.length > 0) {
      allUnitData = cached;
      console.log("üì¶ referensi_unit_ndalem dari IndexedDB:", allUnitData.length);
    } else {
      showError("Tidak ada data referensi unit offline.");
    }
  } finally {
    showLoading(false);
  }
}

// ================== LOAD DATA ==================

// 1. Ambil semua santri sekali saja
async function loadSantri() {
  const rows = await fetchAllRows(
    "santri_kharisma",
    "Stambuk, Nama_Lengkap, Kelas, Unit_Ndalem"
  );
  santriDict = {};
  for (const s of rows) {
    santriDict[s.Stambuk] = {
      Nama_Lengkap: s.Nama_Lengkap,
      Kelas: s.Kelas,
      Unit_Ndalem: s.Unit_Ndalem
    };
  }
  console.log("‚úÖ santriDict terisi:", santriDict);
}

// 2. Load nilai + tempelkan Nama_Lengkap, Kelas, Unit dari santriDict
// ================== LOAD NILAI ==================
async function loadNilai() {
  showLoading(true);
  try {
    // --- pastikan santriDict sudah ada ---
    if (!santriDict || Object.keys(santriDict).length === 0) {
      if (Array.isArray(allSantriData) && allSantriData.length) {
        santriDict = {};
        for (const s of allSantriData) {
          if (s.Stambuk) {
            santriDict[s.Stambuk] = {
              Nama_Lengkap: s.Nama_Lengkap || null,
              Kelas: s.Kelas || null,
              Bagian: s.Bagian || null,          // ‚Üê ikut Bagian
              Unit_Ndalem: s.Unit_Ndalem || null
            };
          }
        }
      } else {
        await loadSantri(); // isi dari Supabase langsung
      }
    }

    // --- ambil semua nilai ---
    const rows = await fetchAllRows("nilai", "*");

    // --- merge dengan santriDict supaya ada Nama/Kelas/Bagian/Unit ---
    allNilaiData = (rows || []).map(r => {
      const ref    = santriDict[r.Stambuk] || {};
      const nama   = ref.Nama_Lengkap ?? r.Nama_Lengkap ?? "-";
      const kelas  = ref.Kelas ?? r.Kelas ?? "-";
      const bagian = ref.Bagian ?? r.Bagian ?? "-";
      const unit   = ref.Unit_Ndalem ?? r.Unit_Ndalem ?? "-";

      return {
        ...r,
        Nama_Lengkap: nama,
        Kelas: kelas,
        Bagian: bagian,          // ‚Üê disimpan di allNilaiData
        Unit_Ndalem: unit,
        Nilai: toNumber(r.Nilai),
        __key: r.Stambuk || `${nama}|${kelas}`
      };
    });

    // --- simpan offline di IndexedDB ---
    await saveToDB("nilai", allNilaiData);

    // --- inisialisasi tampilan ---
    initNilaiFilters();
    initSemesterTahunDropdowns();
    bindNilaiTabs();
    renderNilaiTable();
    renderNilaiChart("kelas");

  } catch (err) {
    console.warn("Gagal load nilai dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB("nilai");
    if (cached.length > 0) {
      allNilaiData = cached;
      initNilaiFilters();
      initSemesterTahunDropdowns();
      bindNilaiTabs();
      renderNilaiTable();
      renderNilaiChart("kelas");
    } else {
      showError("Tidak ada data Nilai offline.");
    }
  } finally {
    showLoading(false);
  }
}




// 3. Urutan inisialisasi modul nilai
async function initNilaiModule() {
  try {
    showLoading(true);
    await loadSantri();   // isi dictionary
    await loadNilai();    // isi allNilaiData + merge dict
    initNilaiFilters();   // filter dropdown
    initSemesterTahunDropdowns(); // dropdown semester/tahun
    bindNilaiTabs();      // tab grafik
    renderNilaiChart("kelas"); // grafik awal
  } catch (err) {
    showError(err.message || "Gagal memuat modul nilai");
  } finally {
    showLoading(false);
  }
}

// ================== FILTER ==================
function initNilaiFilters() {
  const kelasSelect = document.getElementById('nilaiSearchKelas');
  const unitSelect  = document.getElementById('nilaiSearchUnit');
  const namaInput   = document.getElementById('nilaiSearchNama');

  // Isi opsi kelas langsung dari kelasOrder (tidak tergantung data)
  kelasSelect.innerHTML = '<option value="semua">Semua Kelas</option>'
    + kelasOrder.map(k => `<option value="${k}">${k}</option>`).join('');

  // isi opsi unit dari data
  const units = Array.from(new Set(allNilaiData.map(r => r.Unit_Ndalem).filter(Boolean))).sort();
  unitSelect.innerHTML = '<option value="semua">Semua Unit</option>'
    + units.map(u => `<option value="${u}">${u}</option>`).join('');

  // event
  [kelasSelect, unitSelect].forEach(el => el.onchange = () => renderNilaiTable());
  namaInput.oninput = () => renderNilaiTable();
}

// ================== GROUPING & AGREGASI ==================
function buildStudentAgg() {
  const agg = new Map(); // key: Stambuk, value: {sum,count,avg, Nama_Lengkap, Kelas, Unit_Ndalem}
  for (const r of allNilaiData) {
    const key = r.Stambuk || `${r.Nama_Lengkap}|${r.Kelas}`;
    if (!agg.has(key)) agg.set(key, { sum:0, count:0, avg:0, Nama_Lengkap: r.Nama_Lengkap, Kelas: r.Kelas, Unit_Ndalem: r.Unit_Ndalem });
    const a = agg.get(key);
    a.sum += (isFinite(r.Nilai) ? r.Nilai : 0);
    a.count += 1;
    a.avg = a.count ? (a.sum / a.count) : 0;
  }
  return agg;
}

// ================== TABEL NILAI ==================
function renderNilaiTable(page = 1) {
  const list = document.getElementById('nilai-list');
  list.innerHTML = "";

  const kelasFilter = document.getElementById('nilaiSearchKelas').value;
  const unitFilter  = document.getElementById('nilaiSearchUnit').value;
  const keyword     = (document.getElementById('nilaiSearchNama').value || '').toLowerCase();

  // === Group by siswa ===
  const grouped = new Map();
  for (const r of allNilaiData) {
    const key = r.__key;
    if (!grouped.has(key)) {
      grouped.set(key, {
        Stambuk: r.Stambuk,
        Nama_Lengkap: r.Nama_Lengkap,
        Kelas: r.Kelas,
        Bagian: r.Bagian,            // ‚Üê ditambahkan
        Unit_Ndalem: r.Unit_Ndalem,
        NilaiList: []
      });
    }
    grouped.get(key).NilaiList.push({ mapel: r.Mata_Pelajaran, nilai: r.Nilai });
  }

  // Hitung jumlah & rata-rata
  const students = [...grouped.values()].map(d => {
    const jumlah = d.NilaiList.reduce((a,b)=> a+(isFinite(b.nilai)?b.nilai:0), 0);
    const rata   = d.NilaiList.length ? (jumlah/d.NilaiList.length) : 0;
    return { ...d, Jumlah: jumlah, Rerata: rata };
  });

  // Filter
  let filtered = students.filter(s => {
    const byKelas = (kelasFilter === 'semua' || s.Kelas === kelasFilter);
    const byUnit  = (unitFilter === 'semua' || s.Unit_Ndalem === unitFilter);
    const byName  = (!keyword || (s.Nama_Lengkap||"").toLowerCase().includes(keyword));
    return byKelas && byUnit && byName;
  });

  // Sort
  filtered.sort((a, b) => {
    if (b.Rerata !== a.Rerata) return b.Rerata - a.Rerata;
    if (b.Jumlah !== a.Jumlah) return b.Jumlah - a.Jumlah;
    return (a.Nama_Lengkap || '').localeCompare(b.Nama_Lengkap || '');
  });

  // Simpan global untuk pagination
  nilaiFilteredStudents = filtered;

  // Hitung pagination
  const totalPages = Math.ceil(filtered.length / nilaiRowsPerPage);
  nilaiCurrentPage = Math.max(1, Math.min(page, totalPages));

  const start = (nilaiCurrentPage - 1) * nilaiRowsPerPage;
  const end   = start + nilaiRowsPerPage;
  const pageData = filtered.slice(start, end);

  // Render kartu per siswa
  pageData.forEach(s => {
    const card = document.createElement("div");
    card.className = "nilai-card";
    card.innerHTML = `
      <div class="nilai-card-header">
        ${s.Nama_Lengkap || "-"} 
        <span>         
          Kelas: ${s.Kelas || "-"} |
          Bagian: ${s.Bagian || "-"} | 
          Unit: ${s.Unit_Ndalem || "-"}
        </span>
        <span>
          <span class="nilai-total">Jumlah: ${isFinite(s.Jumlah) ? Math.round(s.Jumlah) : 0}</span>
          <span class="nilai-separator">|</span>
          <span class="nilai-total">Rata-rata: ${isFinite(s.Rerata) ? s.Rerata.toFixed(2) : "0.00"}</span>
        </span>
      </div>
      <div class="nilai-card-body">
        <table class="nilai-subtable">
          <thead>
            <tr><th>No.</th><th>Mata Pelajaran</th><th>Nilai</th></tr>
          </thead>
          <tbody>
            ${s.NilaiList.map((n,idx)=>`
              <tr>
                <td>${idx+1}</td>
                <td>${n.mapel}</td>
                <td style="text-align:center">${n.nilai}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    list.appendChild(card);
  });

  // Render kontrol pagination
  renderNilaiPagination(totalPages);
}


// ================== PAGINATION ==================
function renderNilaiPagination(totalPages) {
  const containerId = "nilai-pagination";
  let container = document.getElementById(containerId);
  if (!container) {
    container = document.createElement("div");
    container.id = containerId;
    container.className = "nilai-pagination";
    document.getElementById("nilai-tab-kelas").appendChild(container);
  }
  container.innerHTML = "";

  if (totalPages <= 1) return;

  // Hitung range data
  const startIdx = (nilaiCurrentPage - 1) * nilaiRowsPerPage + 1;
  const endIdx   = Math.min(nilaiCurrentPage * nilaiRowsPerPage, nilaiFilteredStudents.length);
  const total    = nilaiFilteredStudents.length;

  // Info teks "Menampilkan ... - ... dari ..."
  const info = document.createElement("div");
  info.className = "pagination-info";
  info.textContent = `Menampilkan ${startIdx} - ${endIdx} dari ${total} data`;
  container.appendChild(info);

  // Kontainer tombol
  const controls = document.createElement("div");
  controls.className = "pagination-controls";
  container.appendChild(controls);

  // Tombol prev
  const prevBtn = document.createElement("button");
  prevBtn.textContent = "‚Äπ Prev";
  prevBtn.disabled = (nilaiCurrentPage === 1);
  prevBtn.onclick = () => renderNilaiTable(nilaiCurrentPage - 1);
  controls.appendChild(prevBtn);

  // Nomor halaman
  for (let i=1; i<=totalPages; i++) {
    if (i > 2 && i < totalPages-1 && Math.abs(i - nilaiCurrentPage) > 2) {
      if (controls.lastChild?.textContent !== "...") {
        const dots = document.createElement("span");
        dots.textContent = "...";
        controls.appendChild(dots);
      }
      continue;
    }
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === nilaiCurrentPage) btn.classList.add("active");
    btn.onclick = () => renderNilaiTable(i);
    controls.appendChild(btn);
  }

  // Tombol next
  const nextBtn = document.createElement("button");
  nextBtn.textContent = "Next ‚Ä∫";
  nextBtn.disabled = (nilaiCurrentPage === totalPages);
  nextBtn.onclick = () => renderNilaiTable(nilaiCurrentPage + 1);
  controls.appendChild(nextBtn);
}



// ======== NILAI: grafik Top 10 ========
function bindNilaiTabs() {
  // tab utama
  document.querySelectorAll('.nilai-tab').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.nilai-tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.nilai-tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`nilai-tab-${btn.dataset.nilaiTab}`).classList.add('active');
    };
  });
  // sub-tab grafik
  document.querySelectorAll('.nilai-graph-tab').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.nilai-graph-tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderNilaiChart(btn.dataset.graph);
    };
  });
}



function renderNilaiChart(mode /* 'kelas'|'unit'|'individu' */) {
  const ctx = document.getElementById('nilai-chart').getContext('2d');
  if (nilaiChartInstance) { 
    nilaiChartInstance.destroy(); 
    nilaiChartInstance = null; 
  }

  const studentAgg = buildStudentAgg();
  let labels = [], values = [];

  // === ambil Semester & Tahun Ajaran dari baris pertama Supabase ===
  const firstRow = allNilaiData.length ? allNilaiData[0] : {};
  const semester = firstRow.Semester || firstRow.semester || "-";
  const tahunAjaran = firstRow.Tahun_Ajaran || firstRow.tahun_ajaran || "-";
  const semTahunLabel = `Semester ${semester} | Tahun Ajaran ${tahunAjaran}`;
  document.getElementById("nilai-chart-header").innerText = semTahunLabel;

  if (mode === 'kelas') {
    const kumpul = new Map();
    for (const r of allNilaiData) {
      const k = r.Kelas || '-';
      if (!kumpul.has(k)) kumpul.set(k, {sum:0,count:0});
      const x = kumpul.get(k);
      x.sum += (isFinite(r.Nilai) ? r.Nilai : 0);
      x.count += 1;
    }
    const arr = [...kumpul.entries()]
      .map(([k,{sum,count}]) => ({k,avg: count? sum/count : 0}))
      .sort((a,b) => b.avg - a.avg);
    labels = arr.map(d => d.k);
    values = arr.map(d => Number(d.avg.toFixed(2)));
  }

  if (mode === 'unit') {
    const kumpul = new Map();
    for (const r of allNilaiData) {
      const u = r.Unit_Ndalem || '-';
      if (!kumpul.has(u)) kumpul.set(u, {sum:0,count:0});
      const x = kumpul.get(u);
      x.sum += (isFinite(r.Nilai) ? r.Nilai : 0);
      x.count += 1;
    }
    const arr = [...kumpul.entries()]
      .map(([u,{sum,count}]) => ({u,avg: count? sum/count : 0}))
      .sort((a,b) => b.avg - a.avg);
    labels = arr.map(d => d.u);
    values = arr.map(d => Number(d.avg.toFixed(2)));
  }

  if (mode === 'individu') {
    const arr = [...studentAgg.values()]
      .map(v => ({ nama: v.Nama_Lengkap, kelas: v.Kelas, avg: v.avg }))
      .sort((a,b) => b.avg - a.avg)
      .slice(0,20);

    // Label jadi multi-line [nama, kelas]
    labels = arr.map(d => [d.nama, `(${d.kelas||'-'})`]);
    values = arr.map(d => Number(d.avg.toFixed(2)));
  }

  // === Label pakai nomor urut ===
  const rankLabels = labels.map((lbl, i) => {
    if (Array.isArray(lbl)) {
      return [`${i+1}. ${lbl[0]}`, lbl[1]]; // baris 1 nomor+nama, baris 2 kelas
    }
    return `${i+1}. ${lbl}`;
  });

  // === Semua batang biru ===
  const barColors = values.map(() => '#4dabf7');

  // === Atur tinggi canvas dinamis sesuai jumlah bar ===
  const rowCount = rankLabels.length;
  const canvas = document.getElementById('nilai-chart');
  canvas.style.height = `${Math.max(400, rowCount * 40)}px`;

  // === Tentukan afterFit per mode ===
  let yAfterFit;
  if (mode === 'kelas') {
    yAfterFit = function(scale) { scale.width = 120; };
  }
  if (mode === 'unit') {
    yAfterFit = function(scale) { scale.width = 210; };
  }
  if (mode === 'individu') {
    yAfterFit = function(scale) { scale.width = 180; };
  }

  
  
 // === Plugin Value Label di dalam batang ===
const valueLabelPlugin = {
  id: 'valueLabelPlugin',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    chart.data.datasets.forEach((dataset, i) => {
      const meta = chart.getDatasetMeta(i);
      meta.data.forEach((bar, index) => {
        const value = dataset.data[index];
        if (value == null) return;

        const { x, y, base } = bar; // posisi bar
        const barWidth = Math.abs(x - base); // panjang batang

        ctx.save();

        // teks
        ctx.font = 'bold 10px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';

        // ukuran teks
        const text = value.toString();
        const textWidth = ctx.measureText(text).width;
        const textPadding = 4;

        // posisi kotak (di dalam ujung batang)
        const boxX = x - textWidth - textPadding * 2;
        const boxY = y - 8;
        const boxWidth = textWidth + textPadding * 2;
        const boxHeight = 16;

        // pastikan masih cukup ruang (kalau batang pendek, pindahkan ke luar)
        const drawInside = barWidth > textWidth + textPadding * 4;

        if (drawInside) {
          // kotak background putih
          ctx.fillStyle = 'white';
          ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

          // border tipis abu
          ctx.strokeStyle = '#ccc';
          ctx.lineWidth = 1;
          ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

          // tulis angka dengan biru
          ctx.fillStyle = '#1a73e8';
          ctx.fillText(text, x - textPadding, y);
        } else {
          // fallback: kalau batang terlalu pendek ‚Üí tulis di luar
          ctx.fillStyle = '#1a73e8';
          ctx.textAlign = 'left';
          ctx.fillText(text, x + 5, y);
        }

        ctx.restore();
      });
    });
  }
};



  // === Buat chart ===
  nilaiChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rankLabels,
      datasets: [{
        label: 'Skor',
        data: values,
        backgroundColor: barColors
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 6 } }, // ruang lebih untuk header
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.x}` } },
        title: { display: false }
      },
      scales: {
        x: { 
          beginAtZero: true, 
          suggestedMax: 100,
          ticks: {
            stepSize: 50 // biar keliatan 0, 50, 100
          }
        },
        y: {
          ticks: {
            autoSkip: false,
            font: { size: 10 },
            padding: 6
          },
          barThickness: 20,
          categoryPercentage: 0.7,
          afterFit: yAfterFit
        }
      }
    },
    plugins: [valueLabelPlugin]
  });
}




// ===== Helpers untuk modul Nilai =====
function cleanStr(s) {
  return (s ?? '')
    .normalize('NFKC')            // normalisasi unicode
    .replace(/[\u2018\u2019\u02BC]/g, "'") // samakan apostrof curly -> '
    .replace(/\s+/g, ' ')         // rapikan spasi rangkap
    .trim();
}
function toNumber(x) {
  if (typeof x === 'number') return isFinite(x) ? x : 0;
  if (typeof x === 'string') {
    const n = parseFloat(x.replace(',', '.'));
    return isFinite(n) ? n : 0;
  }
  return 0;
}

// Ambil semua baris Supabase dengan paging agar tidak ke-limit 1000
async function fetchAllRows(table, columns, pageSize = 1000) {
  let all = [];
  let from = 0;
  while (true) {
    const { data, error } = await supabaseClient
      .from(table)
      .select(columns)
      .range(from, from + pageSize - 1);
    if (error) throw error;
    all = all.concat(data || []);
    if (!data || data.length < pageSize) break;
    from += pageSize;
  }
  return all;
}




function initSemesterTahunDropdowns() {
  const semesterSet = new Set(allNilaiData.map(r => r.Semester || r.semester));
  const tahunSet = new Set(allNilaiData.map(r => r.Tahun_Ajaran || r.tahun_ajaran));

  const fillSelect = (id, values) => {
    const select = document.getElementById(id);
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
  };

  fillSelect("nilaiSearchSemester", semesterSet);
  fillSelect("nilaiGraphSemester", semesterSet);

  fillSelect("nilaiSearchTahun", tahunSet);
  fillSelect("nilaiGraphTahun", tahunSet);
}

function getFilteredData() {
  const semFilter = document.getElementById("nilaiSearchSemester")?.value || "semua";
  const thFilter  = document.getElementById("nilaiSearchTahun")?.value || "semua";

  return allNilaiData.filter(r => {
    const semVal = r.Semester || r.semester;
    const thVal  = r.Tahun_Ajaran || r.tahun_ajaran;
    return (semFilter === "semua" || semVal == semFilter) &&
           (thFilter === "semua"  || thVal == thFilter);
  });
}

async function loadPenasehat() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('penasehat')
      .select('id, Nama, Status_Penasehat, Status_Pengajar, Kode_Unit, Mutakhorijin, Mulai_Ngabdi, Hp, referensi_unit_ndalem(Nama_Unit)')
      .order('Mulai_Ngabdi', { ascending: true });

    if (error) throw error;

    allPenasehatData = data;
    penasehatFiltered = allPenasehatData;

    // Simpan ke IndexedDB
    await saveToDB('penasehat', data);

    renderPenasehatTable();
  } catch (err) {
    console.warn("Gagal load penasehat dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('penasehat');
    if (cached.length > 0) {
      allPenasehatData = cached;
      penasehatFiltered = cached;
      renderPenasehatTable();
    } else {
      showError("Tidak ada data Penasehat offline.");
    }
  } finally {
    showLoading(false);
  }
}



function filterPenasehat() {
  const term = document.getElementById('penasehatSearchNama').value.toLowerCase();
  penasehatFiltered = allPenasehatData.filter(p => p.Nama?.toLowerCase().includes(term));
  penasehatCurrentPage = 1;
  renderPenasehatTable();
}

function renderPenasehatTable() {
  const table = document.getElementById('penasehat-table');
  table.innerHTML = '';

  // Header
  const header = `
    <thead>
      <tr>
        <th>No.</th>
        <th class="nama">Nama</th>
        <th>Status Penasehat</th>
        <th>Status Pengajar</th>
        <th>Unit Ndalem</th>
        <th>Mutakhorijin</th>
        <th>Masa Khidmah</th>
		<th>Hp</th>
      </tr>
    </thead>
  `;
  let rows = '';

  // Pagination
  const start = (penasehatCurrentPage - 1) * penasehatRowsPerPage;
  const end = start + penasehatRowsPerPage;
  const pageData = penasehatFiltered.slice(start, end);

  pageData.forEach((p, i) => {
  const masa = calculateMasaKhidmah(p.Mulai_Ngabdi);

  // bikin link wa kalau ada nomor
  let hpLink = '-';
  if (p.Hp) {
    const cleanHp = p.Hp.replace(/\D/g, ''); // hanya angka
    hpLink = `<a href="https://wa.me/${cleanHp}" target="_blank">${p.Hp}</a>`;
  }

  rows += `
    <tr>
      <td>${start + i + 1}</td>
      <td class="nama">${p.Nama || '-'}</td>
      <td>${p.Status_Penasehat || '-'}</td>
      <td>${p.Status_Pengajar || '-'}</td>
      <td>${p.referensi_unit_ndalem?.Nama_Unit || '-'}</td>
      <td>${p.Mutakhorijin || '-'}</td>
      <td>${masa}</td>
      <td>${hpLink}</td>   <!-- ‚úÖ kolom baru -->
    </tr>
  `;
});


  table.innerHTML = header + `<tbody>${rows}</tbody>`;
  updatePenasehatPagination();
}

function updatePenasehatPagination() {
  const totalPages = Math.ceil(penasehatFiltered.length / penasehatRowsPerPage);
  const info = document.getElementById('penasehatPaginationInfo');
  const controls = document.getElementById('penasehatPaginationControls');
  info.textContent = `Menampilkan ${penasehatFiltered.length} data (Halaman ${penasehatCurrentPage} dari ${totalPages})`;

  controls.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === penasehatCurrentPage) btn.classList.add('active');
    btn.onclick = () => { penasehatCurrentPage = i; renderPenasehatTable(); };
    controls.appendChild(btn);
  }
}


async function loadGuru() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('data_guru')
      .select('id, Nama, Bagian, Kelas, Kamar, Alamat, Hp')
      .order('Kelas', { ascending: true });

    if (error) throw error;

    allGuruData = data;

    // Simpan ke IndexedDB
    await saveToDB('data_guru', data);

    // isi dropdown kelas unik
    const kelasSet = [...new Set(allGuruData.map(g => g.Kelas).filter(Boolean))];
    const kelasSelect = document.getElementById('guruFilterKelas');
    kelasSelect.innerHTML = '<option value="">Semua</option>';
    kelasSet.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = k;
      kelasSelect.appendChild(opt);
    });

    filterGuru();
  } catch (err) {
    console.warn("Gagal load data_guru dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('data_guru');
    if (cached.length > 0) {
      allGuruData = cached;

      // isi dropdown kelas unik dari cache
      const kelasSet = [...new Set(allGuruData.map(g => g.Kelas).filter(Boolean))];
      const kelasSelect = document.getElementById('guruFilterKelas');
      kelasSelect.innerHTML = '<option value="">Semua</option>';
      kelasSet.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        kelasSelect.appendChild(opt);
      });

      filterGuru();
    } else {
      showError("Tidak ada data Guru offline.");
    }
  } finally {
    showLoading(false);
  }
}



function filterGuru() {
  const term = document.getElementById('guruSearchNama').value.toLowerCase();
  const kelas = document.getElementById('guruFilterKelas').value;

  guruFiltered = allGuruData.filter(g => {
    const matchNama = g.Nama?.toLowerCase().includes(term);
    const matchKelas = !kelas || g.Kelas === kelas;
    return matchNama && matchKelas;
  });

  // urutkan: kelas mengikuti kelasOrder, lalu Bagian abjad
  guruFiltered.sort((a, b) => {
    const idxA = kelasOrderGuru.indexOf(a.Kelas);
    const idxB = kelasOrderGuru.indexOf(b.Kelas);
    if (idxA !== idxB) return idxA - idxB;
    return (a.Bagian || '').localeCompare(b.Bagian || '');
  });

  guruCurrentPage = 1;
  renderGuruTable();
}

function renderGuruTable() {
  const table = document.getElementById('guru-table');
  table.innerHTML = '';

  const header = `
    <thead>
      <tr>
        <th>No.</th>
        <th class="nama">Nama</th>
        <th>Bagian</th>
        <th>Kelas</th>
        <th>Kamar</th>
        <th>Alamat</th>
        <th>Hp</th>
      </tr>
    </thead>
  `;

  const start = (guruCurrentPage - 1) * guruRowsPerPage;
  const end = start + guruRowsPerPage;
  const pageData = guruFiltered.slice(start, end);

  let rows = '';
  pageData.forEach((g, i) => {
    let hpLink = '-';
    if (g.Hp) {
      const cleanHp = g.Hp.toString().replace(/\D/g, '');
      hpLink = `<a href="https://wa.me/${cleanHp}" target="_blank">${g.Hp}</a>`;
    }

    rows += `
      <tr>
        <td>${start + i + 1}</td>
        <td class="nama">${g.Nama || '-'}</td>
        <td>${g.Bagian || '-'}</td>
        <td>${g.Kelas || '-'}</td>
        <td>${g.Kamar || '-'}</td>
        <td>${g.Alamat || '-'}</td>
        <td>${hpLink}</td>
      </tr>
    `;
  });

  table.innerHTML = header + `<tbody>${rows}</tbody>`;
  updateGuruPagination();
}


function updateGuruPagination() {
  const totalPages = Math.ceil(guruFiltered.length / guruRowsPerPage);
  const info = document.getElementById('guruPaginationInfo');
  const controls = document.getElementById('guruPaginationControls');

  info.textContent = `Menampilkan ${guruFiltered.length} data (Halaman ${guruCurrentPage} dari ${totalPages})`;
  controls.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === guruCurrentPage) btn.classList.add('active');
    btn.onclick = () => { guruCurrentPage = i; renderGuruTable(); };
    controls.appendChild(btn);
  }
}

async function loadInfo() {
  showLoading(true);
  try {
    const { data, error } = await supabaseClient
      .from('informasi')
      .select('*')
      .order('Tanggal', { ascending: false });

    if (error) throw error;

    allInfoData = data || [];
    infoFiltered = allInfoData;

    // Simpan ke IndexedDB
    await saveToDB('informasi', allInfoData);

    renderInfoTable(infoFiltered, 1);
  } catch (err) {
    console.warn("Gagal load informasi dari Supabase, coba IndexedDB:", err);

    const cached = await getFromDB('informasi');
    if (cached.length > 0) {
      allInfoData = cached;
      infoFiltered = cached;
      renderInfoTable(infoFiltered, 1);
    } else {
      showError("Tidak ada data Informasi offline.");
    }
  } finally {
    showLoading(false);
  }
}


function filterInfo() {
  const search = document.getElementById('infoSearchIsi').value.toLowerCase();
  infoFiltered = allInfoData.filter(i =>
    (i.Jenis_Informasi || '').toLowerCase().includes(search) ||
    (i.Isi_Informasi || '').toLowerCase().includes(search) ||
    (i.Penulis || '').toLowerCase().includes(search)
  );
  renderInfoTable(infoFiltered, 1);
}

function renderInfoTable(data, page = 1) {
  const table = document.getElementById('info-table');
  table.innerHTML = '';

  const totalRecords = data.length;
  const totalPages = Math.max(1, Math.ceil(totalRecords / infoRowsPerPage));
  const start = (page - 1) * infoRowsPerPage;
  const end = Math.min(start + infoRowsPerPage, totalRecords);
  const paginated = data.slice(start, end);

  const thead = `
    <thead>
      <tr>
        <th>No.</th>
        <th>Tgl</th>
        <th>Jenis Informasi</th>
        <th>Isi Informasi</th>
        <th>Penulis</th>
      </tr>
    </thead>`;
  
  let rows = '';
  paginated.forEach((d, i) => {
    rows += `
      <tr>
        <td>${start + i + 1}</td>
        <td class="nama">${d.Tanggal ? new Date(d.Tanggal).toLocaleDateString('id-ID') : '-'}</td>
        <td>${d.Jenis_Informasi || '-'}</td>
        <td style="text-align:left">${d.Isi_Informasi || '-'}</td>
        <td>${d.Penulis || '-'}</td>
      </tr>`;
  });

  table.innerHTML = thead + `<tbody>${rows}</tbody>`;

  document.getElementById('infoPaginationInfo').textContent =
    totalRecords === 0 ? 'Menampilkan 0 data' :
    `Menampilkan ${start + 1} - ${end} dari ${totalRecords} data`;
  updateInfoPagination(totalPages, page, data);
}

function updateInfoPagination(totalPages, currentPage, data) {
  const controls = document.getElementById('infoPaginationControls');
  controls.innerHTML = '';
  if (totalPages <= 1) return;

  if (currentPage > 1) {
    const prev = document.createElement('button');
    prev.textContent = 'Sebelumnya';
    prev.onclick = () => renderInfoTable(data, currentPage - 1);
    controls.appendChild(prev);
  }

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === currentPage) btn.classList.add('active');
    btn.onclick = () => renderInfoTable(data, i);
    controls.appendChild(btn);
  }

  if (currentPage < totalPages) {
    const next = document.createElement('button');
    next.textContent = 'Berikutnya';
    next.onclick = () => renderInfoTable(data, currentPage + 1);
    controls.appendChild(next);
  }
}

 // Fungsi untuk memeriksa session dan mengarahkan ke login jika belum login
    async function checkAuth() {
      showLoading(true);
      
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.error('Error checking session:', error);
          window.location.href = 'index.html';
          return;
        }
        
        if (!session) {
          window.location.href = 'index.html';
          return;
        }
        
        // Simpan info user yang sedang login
        currentUser = session.user;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Load data setelah auth berhasil
        await loadDashboardData();
        await loadDropdowns();
        await loadData();
        
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = 'index.html';
      } finally {
        showLoading(false);
      }
    }

    // Fungsi logout
    async function logout() {
      showLoading(true);
      
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error('Error logging out:', error);
        }
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = 'index.html';
      } finally {
        showLoading(false);
      }
    }

    // Listener untuk perubahan auth state
    supabaseClient.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT' || !session) {
        window.location.href = 'index.html';
      }
    });
	

	// Tangani navigasi back
	window.addEventListener('popstate', function (event) {
	  const anyModuleActive = document.querySelector('.module-container.active');

	  if (anyModuleActive) {
		// Kalau sedang di dalam modul ‚Üí kembali ke menu utama
		showMainGrid();
		// Jangan biarkan langsung keluar
		history.pushState(null, null, location.href);
	  } else {
		// Kalau sudah di menu utama ‚Üí tampilkan konfirmasi keluar
		if (confirm("Yakin ingin keluar dari aplikasi?")) {
		  // Benar-benar keluar (browser back)
		  history.back();
		} else {
		  // Batalkan keluar, tetap di halaman
		  history.pushState(null, null, location.href);
		}
	  }
	});

	// Tambahkan state awal supaya tidak langsung keluar
	window.addEventListener('DOMContentLoaded', () => {
	  history.pushState(null, null, location.href);
	});
	
	// Buat database
	const dbPromise = idb.openDB('KharismaDB', 1, {
	  upgrade(db) {
		if (!db.objectStoreNames.contains('santri_kharisma')) {
		  db.createObjectStore('santri_kharisma', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('Inventaris')) {
		  db.createObjectStore('Inventaris', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('Pelanggaran')) {
		  db.createObjectStore('Pelanggaran', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('absensi')) {
		  db.createObjectStore('absensi', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('data_guru')) {
		  db.createObjectStore('data_guru', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('informasi')) {
		  db.createObjectStore('informasi', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('nilai')) {
		  db.createObjectStore('nilai', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('penasehat')) {
		  db.createObjectStore('penasehat', { keyPath: 'id' });
		}
		if (!db.objectStoreNames.contains('referensi_unit_ndalem')) {
		  db.createObjectStore('referensi_unit_ndalem', { keyPath: 'id' });
		}
	  }
	});

	// Simpan data ke IndexedDB
	async function saveToDB(storeName, data) {
	  const db = await dbPromise;
	  data.forEach(item => db.put(storeName, item));
	}

	// Ambil semua data dari IndexedDB
	async function getFromDB(storeName) {
	  const db = await dbPromise;
	  return await db.getAll(storeName);
	}


// ================= HANDLER =================
function handleDownload() {
  const format = document.getElementById("downloadFormat").value;
  if (format === "pdf") downloadNilaiPDF();
  else downloadNilaiHTML();
}

// ================= CSS modul (dipakai untuk HTML export) =================
const nilaiCSS = `
/* minimal styling yang diperlukan agar HTML export mirip tampilan app */
.nilai-card { border:1px solid #e6e6e6;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.08);overflow:hidden;margin-bottom:18px;}
.nilai-card-header { background:#1a73e8;color:#fff;padding:12px 16px;font-weight:700; display:flex; flex-direction:column; gap:4px;}
.nilai-card-header span { font-size:0.85rem; font-weight:400; opacity:0.95; }
.nilai-card-body { padding:12px 14px; overflow-x:auto; }
.nilai-subtable { width:100%; border-collapse:collapse; font-size:0.9rem; }
.nilai-subtable th, .nilai-subtable td { border:1px solid #f0f0f0; padding:6px 10px; }
.nilai-subtable th { background:#f8fafc; font-weight:600; text-align:center; }
`;

// helper load image ‚Üí base64 (untuk PDF)
async function loadImageToBase64(url) {
  try {
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.crossOrigin = "Anonymous";
      i.onload = () => resolve(i);
      i.onerror = () => reject(new Error("Image load error"));
      i.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
    });
    const canvas = document.createElement("canvas");
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);
    return canvas.toDataURL("image/png");
  } catch (err) {
    console.warn("loadImageToBase64 failed:", err?.message || err);
    return null;
  }
}

// Ambil logo dari halaman, fallback ke imgur
async function getLogoDataOrFallback() {
  const kopImg = document.querySelector(".logolembaga");
  if (kopImg && kopImg.src) {
    const data = await loadImageToBase64(kopImg.src);
    if (data) return data;
  }
  // fallback default
  return await loadImageToBase64("https://i.imgur.com/W3UiaBA.png");
}

// Tag HTML logo (untuk export HTML)
function getLogoHTML() {
  const kopImg = document.querySelector(".logolembaga");
  if (kopImg && kopImg.src) {
    return `<img src="${kopImg.src}" alt="Logo Lembaga">`;
  }
  return `<img src="https://i.imgur.com/W3UiaBA.png" alt="Logo Lembaga">`;
}


// ================= DOWNLOAD HTML =================
async function downloadNilaiHTML() {
  try {
    const today = new Date();
    const grafikTab = document.querySelector(".nilai-tab[data-nilai-tab='grafik']");
    const isGrafik = grafikTab && grafikTab.classList.contains("active");

    let sem, th, unit, kelas, jenisGrafik;
    if (isGrafik) {
      sem = document.getElementById("nilaiGraphSemester")?.value || "Semua";
      th  = document.getElementById("nilaiGraphTahun")?.value || "Semua";
      unit = "SemuaUnit"; kelas = "SemuaKelas";
      const activeGraphTab = document.querySelector(".nilai-graph-tab.active");
      if (activeGraphTab) {
        const label = activeGraphTab.textContent.trim();
        if (/kelas/i.test(label)) jenisGrafik = "Top Kelas";
        else if (/unit/i.test(label)) jenisGrafik = "Top Unit Ndalem";
        else if (/nama/i.test(label)) jenisGrafik = "Top Nama";
        else jenisGrafik = label;
      } else jenisGrafik = "Top Kelas";
    } else {
      sem   = document.getElementById("nilaiSearchSemester")?.value || "Semua";
      th    = document.getElementById("nilaiSearchTahun")?.value || "Semua";
      unit  = document.getElementById("nilaiSearchUnit")?.value || "SemuaUnit";
      kelas = document.getElementById("nilaiSearchKelas")?.value || "SemuaKelas";
    }

    const ts = today.toISOString().replace(/[:T]/g, "-").split(".")[0];
    const filename = `Nilai_${unit}_${kelas}_Sem${sem}_${th}_${ts}.html`;

    let bodyContent = "";
    if (isGrafik) {
      const canvas = document.getElementById("nilai-chart");
      if (!canvas) return alert("Grafik tidak tersedia!");
      const imgData = canvas.toDataURL("image/png");
      bodyContent = `<div style="text-align:center;"><img src="${imgData}" style="max-width:100%;border:1px solid #ccc;border-radius:6px;"></div>`;
    } else {
      const cards = document.querySelectorAll(".nilai-card");
      if (!cards.length) return alert("Data nilai santri belum ada!");
      cards.forEach(c => bodyContent += c.outerHTML);
    }

    const judul = isGrafik ? "LAPORAN GRAFIK NILAI" : "LAPORAN TABEL NILAI";
    const content = `
<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><title>${judul}</title>
<style>
${nilaiCSS}
body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa;}
.kop{text-align:center;margin-bottom:10px;}
.kop img{width:100%;max-width:700px;height:auto;}
hr{border:1px solid #000;margin:10px 0 20px;}
.footer{margin-top:30px;font-size:11px;color:gray;text-align:right;}
</style>
</head><body>
<div class="kop">${getLogoHTML()}<hr></div>
<h2 style="text-align:center">${judul}</h2>
<div style="text-align:center">Semester: ${sem} | Tahun Ajaran: ${th}</div>
${isGrafik ? `<div style="text-align:center;margin-top:5px">Jenis Grafik: ${jenisGrafik}</div>`
          : `<div style="text-align:left;margin-top:5px">Kelas: ${kelas} | Bagian: ${"SemuaBagian"} | Unit: ${unit}</div>`}
${bodyContent}
<div class="footer">Simponi Kharisma ‚Äì dicetak ${today.toLocaleDateString("id-ID")} ${today.toLocaleTimeString("id-ID")}</div>
</body></html>`;

    const blob = new Blob([content], { type: "text/html;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
  } catch (err) {
    console.error("HTML export failed:", err);
    alert("Gagal membuat HTML. Lihat console.");
  }
}

// ================= DOWNLOAD PDF (FINAL: nama+meta + Bagian, kertas F4) =================
async function downloadNilaiPDF() {
  try {
    const jsPDFCtor = window.jspdf?.jsPDF || window.jsPDF || null;
    if (!jsPDFCtor) return alert("Library jsPDF belum ter-load.");
    // F4 = 210mm x 330mm ‚Üí ~595 x 935 pt
    const pdf = new jsPDFCtor("p", "pt", [595.28, 935.43]);

    if (typeof pdf.autoTable !== "function") {
      console.error("autoTable not available.");
      return alert("Plugin jspdf-autotable belum terpasang.");
    }

    const pageWidth  = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin     = 40;
    const today      = new Date();

    // cek tab aktif
    const grafikTab = document.querySelector(".nilai-tab[data-nilai-tab='grafik']");
    const isGrafik  = grafikTab && grafikTab.classList.contains("active");

    let sem, th, unit, kelas, jenisGrafik;
    if (isGrafik) {
      sem   = document.getElementById("nilaiGraphSemester")?.value || "Semua";
      th    = document.getElementById("nilaiGraphTahun")?.value || "Semua";
      unit  = "SemuaUnit"; 
      kelas = "SemuaKelas";
      const activeGraphTab = document.querySelector(".nilai-graph-tab.active");
      if (activeGraphTab) {
        const label = activeGraphTab.textContent.trim();
        if (/kelas/i.test(label)) jenisGrafik = "Top Kelas";
        else if (/unit/i.test(label)) jenisGrafik = "Top Unit Ndalem";
        else if (/nama/i.test(label)) jenisGrafik = "Top Nama";
        else jenisGrafik = label;
      } else jenisGrafik = "Top Kelas";
    } else {
      sem   = document.getElementById("nilaiSearchSemester")?.value || "Semua";
      th    = document.getElementById("nilaiSearchTahun")?.value || "Semua";
      unit  = document.getElementById("nilaiSearchUnit")?.value || "SemuaUnit";
      kelas = document.getElementById("nilaiSearchKelas")?.value || "SemuaKelas";
    }

    const filename   = `Nilai_${unit}_${kelas}_Sem${sem}_${th}_${today.toISOString().replace(/[:T]/g,"-").split(".")[0]}.pdf`;
    const footerText = `Simponi Kharisma ‚Äì dicetak ${today.toLocaleDateString("id-ID")} ${today.toLocaleTimeString("id-ID")}`;

    // ============ Kop Lembaga ============
    const kopData = await getLogoDataOrFallback();
    let headerBottomY = 20;
    if (kopData) {
      try {
        const kp = pdf.getImageProperties(kopData);
        const kopMaxW = Math.min(300, pageWidth - 2 * margin);
        const kopH = (kp.height * kopMaxW) / kp.width;
        pdf.addImage(kopData, "PNG", (pageWidth - kopMaxW) / 2, 20, kopMaxW, kopH);
        headerBottomY = 20 + kopH + 6;
      } catch (e) {
        console.warn("Gagal tambah logo ke PDF:", e);
      }
    }

    // Judul
    let y = headerBottomY + 10;
    pdf.setFontSize(16).setFont(undefined, "bold")
       .text(isGrafik ? "LAPORAN GRAFIK NILAI" : "LAPORAN TABEL NILAI", pageWidth / 2, y, { align: "center" });
    y += 20;
    pdf.setFontSize(11).setFont(undefined, "normal")
       .text(`Semester: ${sem} | Tahun Ajaran: ${th}`, pageWidth / 2, y, { align: "center" });
    y += 18;
    if (isGrafik) {
      pdf.setFontSize(11).text(`Jenis Grafik: ${jenisGrafik}`, pageWidth / 2, y, { align: "center" });
      y += 18;
    } else {
      pdf.setFontSize(11).text(`Unit: ${unit} | Kelas: ${kelas}`, margin, y, { align: "left" });
      y += 18;
    }

    let startY = y + 6;

    // ============ MODE GRAFIK ============
    if (isGrafik) {
      const canvas = document.getElementById("nilai-chart");
      if (!canvas) return alert("Grafik belum tersedia!");
      const imgData = canvas.toDataURL("image/png", 1.0);
      const props   = pdf.getImageProperties(imgData);
      const pdfW    = pageWidth - margin * 2;
      const pdfH    = (props.height * pdfW) / props.width;

      pdf.addImage(imgData, "PNG", margin, startY, pdfW, pdfH);

      pdf.setFontSize(9);
      pdf.text(footerText, pageWidth - margin - pdf.getTextWidth(footerText), pageHeight - 20);
      return pdf.save(filename);
    }

    // ============ MODE TABEL ============
    const cards = Array.from(document.querySelectorAll(".nilai-card"));
    if (!cards.length) return alert("Data nilai santri belum ada!");

    for (let idx = 0; idx < cards.length; idx++) {
      const card     = cards[idx];
      const headerEl = card.querySelector(".nilai-card-header");
      let nama = "Santri";
      let kelasSantri = "-", bagian = "-", unitSantri = "-", jumlah = 0, rata = 0;

      if (headerEl) {
        const h3 = headerEl.querySelector("h3");
        if (h3 && h3.textContent.trim()) {
          nama = h3.textContent.trim();
        } else {
          const lines = headerEl.innerText.split("\n").map(l=>l.trim()).filter(Boolean);
          if (lines.length) nama = lines[0];
        }
      }

      // Ambil detail dari dataset JS (sudah merge santriDict)
      const found = allNilaiData.find(r => r.Nama_Lengkap === nama);
      if (found) {
        kelasSantri = found.Kelas || "-";
        bagian      = found.Bagian || "-";
        unitSantri  = found.Unit_Ndalem || "-";

        const nilaiList = allNilaiData.filter(r => r.Stambuk === found.Stambuk);
        jumlah = nilaiList.reduce((a,b)=> a+(isFinite(b.Nilai)?b.Nilai:0), 0);
        rata   = nilaiList.length ? (jumlah / nilaiList.length) : 0;
      }

      const table = card.querySelector("table, .nilai-subtable");
      if (!table) continue;

      // ambil data dari tabel HTML
      const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.innerText.trim());
      const body    = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
        Array.from(tr.cells).map(td => td.innerText.trim())
      );

      // --- Baris 1: Nama ---
      const nameRow = [{
        content: nama,
        colSpan: headers.length,
        styles: {
          halign: "left",
          fontSize: 12,
          fontStyle: "bold",
          fillColor: [26, 115, 232],   // biru
          textColor: [255, 255, 255]   // putih
        }
      }];

      // --- Baris 2: Meta (Kelas, Bagian, Unit, Jumlah, Rata-rata) ---
      const metaRow = [{
        content: `Kelas: ${kelasSantri} | Bagian: ${bagian} | Unit: ${unitSantri} | Jumlah: ${jumlah} | Rata-rata: ${rata.toFixed(2)}`,
        colSpan: headers.length,
        styles: {
          halign: "left",
          fontSize: 10,
          fillColor: [26, 115, 232],
          textColor: [255, 255, 255]
        }
      }];

      // --- Baris 3: Judul Kolom Tabel ---
      const headerRow = headers.map(h => ({
        content: h,
        styles: {
          halign: "center",
          fontStyle: "bold",
          fillColor: [152, 201, 244],  // biru muda
          textColor: [0, 0, 0]
        }
      }));

      const headRows = [nameRow, metaRow, headerRow];

      pdf.autoTable({
        head: headRows,
        body: body,
        startY: startY,
        theme: "grid",
        styles: { fontSize: 9, halign: "center", valign: "middle" },
        headStyles: { fillColor: [248, 250, 252], textColor: 0 },
        alternateRowStyles: { fillColor: [240, 246, 255] },
        margin: { left: margin, right: margin }
      });

      startY = pdf.lastAutoTable.finalY + 20;
    }

    // footer terakhir
    const lastPage = pdf.getNumberOfPages();
    pdf.setPage(lastPage);
    pdf.setFontSize(9);
    pdf.text(footerText, pageWidth - margin - pdf.getTextWidth(footerText), pageHeight - 20);

    pdf.save(filename);

  } catch (err) {
    console.error("‚ùå Gagal export PDF:", err);
    alert("Terjadi kesalahan saat membuat PDF.");
  }
}


// ============ CRUD NILAI ============ //
// ‚ûï Tambah
function openAddNilai() {
  openModal("Tambah Data Nilai", async (formData) => {
    const { error } = await supabaseClient.from("nilai").insert([formData]);
    if (error) {
      showError("Gagal tambah nilai: " + error.message);
    } else {
      showPopup("Data nilai berhasil ditambahkan!");
      loadNilai();
    }
  });
}

// ‚úèÔ∏è Edit
async function editNilai(id) {
  const row = allNilaiData.find(r => r.id === id);
  if (!row) return;

  openModal("Edit Data Nilai", async (formData) => {
    const { error } = await supabaseClient.from("nilai").update(formData).eq("id", id);
    if (error) {
      showError("Gagal update nilai: " + error.message);
    } else {
      showPopup("Data nilai berhasil diperbarui!");
      loadNilai();
    }
  }, row);
}

// üóëÔ∏è Hapus
async function deleteNilai(id) {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  const { error } = await supabaseClient.from("nilai").delete().eq("id", id);
  if (error) {
    showError("Gagal hapus nilai: " + error.message);
  } else {
    showPopup("Data nilai berhasil dihapus!");
    loadNilai();
  }
}

// ========= Helper Modal ========= //
function openModal(title, onSave, data = {}) {
  const overlay = document.createElement("div");
  overlay.className = "modal-overlay";
  overlay.innerHTML = `
    <div class="modal-box">
      <h3>${title}</h3>
      <form id="modalForm">
        <label>Mata Pelajaran</label>
        <input name="Mata_Pelajaran" value="${data.Mata_Pelajaran || ""}" required>
        <label>Nilai</label>
        <input name="Nilai" type="number" value="${data.Nilai || ""}" required>
        <label>Stambuk</label>
        <input name="Stambuk" value="${data.Stambuk || ""}" required>
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel">Batal</button>
          <button type="submit" class="modal-btn save">Simpan</button>
        </div>
      </form>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.querySelector(".cancel").onclick = () => overlay.remove();
  overlay.querySelector("#modalForm").onsubmit = async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(e.target).entries());
    await onSave(formData);
    overlay.remove();
  };
}

async function downloadSantriPDF() {
  const exportData = getExportData();
  if (!exportData.length) return alert("Tidak ada data untuk diunduh!");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape", "pt", "a3");

  // Kop Lembaga
  const logo = await getLogoDataOrFallback();
  if (logo) {
    try {
      const props = doc.getImageProperties(logo);
      const w = 180, h = (props.height * w) / props.width;
      doc.addImage(logo, "PNG", 40, 20, w, h);
    } catch (e) {
      console.warn("Logo gagal ditambahkan:", e);
    }
  }

  doc.setFontSize(16);
  doc.text("LAPORAN DATA SANTRI", doc.internal.pageSize.getWidth() / 2, 60, { align: "center" });
  doc.setFontSize(10);
  doc.text(`Dicetak: ${new Date().toLocaleString("id-ID")}`, doc.internal.pageSize.getWidth() - 60, 40, { align: "right" });

  const headers = [
    "No","Foto","Nama","Kelas","Bagian",
    "Asal Daerah","Himpunan","Kamar","Unit Ndalem",
    "Posisi Tugas","Shift","Jam Tugas","Masa Khidmah"
  ];

  const rows = await Promise.all(exportData.map(async (s, i) => {
    const masa = calculateMasaKhidmah(s.Mulai_Ngabdi);
    return [
      i + 1,
      s.Foto || "",
      s.Nama_Lengkap || "-",
      s.Kelas || "-",
      s.Bagian || "-",
      s.Asal_Daerah || "-",
      s.Himpunan || "-",
      s.Kamar || "-",
      s.Unit_Ndalem || "-",
      s.Posisi_Tugas || "-",
      s.Shift || "-",
      s.Jam_Tugas || "-",
      masa
    ];
  }));

  doc.autoTable({
    head: [headers],
    body: rows,
    startY: 100,
    styles: { fontSize: 7, cellWidth: "wrap", minCellHeight: 20 },
    columnStyles: { 1: { cellWidth: 40 } }, // kolom Foto kecil
    didDrawCell: async function (data) {
      if (data.section === "body" && data.column.index === 1) {
        const url = data.cell.raw;
        if (url) {
          try {
            const imgData = await loadImageToBase64(url);
            if (imgData) {
              doc.addImage(imgData, "PNG", data.cell.x + 2, data.cell.y + 2, 16, 16);
            }
          } catch (e) {
            console.warn("Gagal load foto:", e);
          }
        }
      }
    }
  });

  doc.save("data_santri.pdf");
}

async function downloadSantriHTML() {
  const exportData = getExportData();
  if (!exportData.length) return alert("Tidak ada data untuk diunduh!");

  const headers = [
    "No","Foto","Nama","Kelas","Bagian",
    "Asal Daerah","Himpunan","Kamar","Unit Ndalem",
    "Posisi Tugas","Shift","Jam Tugas","Masa Khidmah"
  ];

  let html = `
  <!doctype html><html lang="id">
  <head><meta charset="utf-8"><title>Data Santri</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;background:#f8f9fa;}
    h2{text-align:center;}
    table{border-collapse:collapse;width:100%;font-size:12px;}
    th,td{border:1px solid #ccc;padding:6px 8px;text-align:center;}
    th{background:#1a73e8;color:#fff;}
    td img{max-height:60px;}
    .footer{margin-top:20px;font-size:11px;color:gray;text-align:right;}
  </style>
  </head><body>
  <div style="text-align:center;">${getLogoHTML()}<hr></div>
  <h2>LAPORAN DATA SANTRI</h2>
  <table><thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead><tbody>
  `;

  exportData.forEach((s, i) => {
    html += `<tr>
      <td>${i + 1}</td>
      <td>${s.Foto ? `<img src="${s.Foto}" />` : ""}</td>
      <td>${s.Nama_Lengkap || "-"}</td>
      <td>${s.Kelas || "-"}</td>
      <td>${s.Bagian || "-"}</td>
      <td>${s.Asal_Daerah || "-"}</td>
      <td>${s.Himpunan || "-"}</td>
      <td>${s.Kamar || "-"}</td>
      <td>${s.Unit_Ndalem || "-"}</td>
      <td>${s.Posisi_Tugas || "-"}</td>
      <td>${s.Shift || "-"}</td>
      <td>${s.Jam_Tugas || "-"}</td>
      <td>${calculateMasaKhidmah(s.Mulai_Ngabdi)}</td>
    </tr>`;
  });

  html += `</tbody></table>
  <div class="footer">Simponi Kharisma ‚Äì dicetak ${new Date().toLocaleString("id-ID")}</div>
  </body></html>`;

  const blob = new Blob([html], { type: "text/html" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "data_santri.html";
  link.click();
  URL.revokeObjectURL(link.href);
}


// ========== BUKA MODAL TAMBAH ==========
function openAddSantri() {
  document.getElementById("santriModalTitle").textContent = "Tambah Santri";
  document.getElementById("santriForm").reset();
  document.getElementById("santriId").value = "";
  document.getElementById("fotoPreview").style.display = "none";
  document.getElementById("santriModal").style.display = "block";
}

// ========== BUKA MODAL EDIT ==========
function openEditSantri(id) {
  document.getElementById("santriModalTitle").textContent = "Edit Santri";
  document.getElementById("santriId").value = id;

  const s = allSantriData.find(x => x.id === id);
  if (!s) return alert("‚ùå Data tidak ditemukan");

  [
    "Nama_Lengkap","Kelas","Bagian","Stambuk","Stambuk_Ndalem","Unit_Ndalem","Kode_Unit",
    "Asal_Daerah","Himpunan","Kamar","Tgl_Lahir","Mulai_Ngabdi","Tgl_Keluar",
    "Status","Posisi_Tugas","Jam_Tugas","Shift","Foto"
  ].forEach(f => {
    if (document.getElementById(f)) {
      document.getElementById(f).value = s[f] || "";
    }
  });

  if (s.Foto) {
    document.getElementById("fotoPreview").src = s.Foto;
    document.getElementById("fotoPreview").style.display = "block";
  } else {
    document.getElementById("fotoPreview").style.display = "none";
  }

  document.getElementById("santriModal").style.display = "block";
}

// ========== TUTUP MODAL ==========
function closeSantriModal() {
  document.getElementById("santriModal").style.display = "none";
}

// ========== PREVIEW FOTO ==========
function previewFoto() {
  const url = document.getElementById("Foto").value.trim();
  const preview = document.getElementById("fotoPreview");
  if (url && (url.endsWith(".jpg") || url.endsWith(".jpeg") || url.endsWith(".png") || url.endsWith(".gif") || url.startsWith("http"))) {
    preview.src = url;
    preview.style.display = "block";
  } else {
    preview.style.display = "none";
  }
}

// ========== SIMPAN (TAMBAH / EDIT) ==========
document.getElementById("santriForm").onsubmit = async function(e) {
  e.preventDefault();

  const id = document.getElementById("santriId").value;
  const formData = {};
  [
    "Nama_Lengkap","Kelas","Bagian","Stambuk","Stambuk_Ndalem","Unit_Ndalem","Kode_Unit",
    "Asal_Daerah","Himpunan","Kamar","Tgl_Lahir","Mulai_Ngabdi","Tgl_Keluar",
    "Status","Posisi_Tugas","Jam_Tugas","Shift","Foto"
  ].forEach(f => {
    formData[f] = document.getElementById(f).value.trim() || null;
  });

  if (!formData.Nama_Lengkap) return alert("‚ùå Nama lengkap wajib diisi!");

  let result;
  if (id) {
    result = await supabaseClient.from("santri_kharisma").update(formData).eq("id", id);
    lastEditedId = parseInt(id);
  } else {
    result = await supabaseClient.from("santri_kharisma").insert([formData]).select("id").single();
    if (!result.error && result.data) {
      lastEditedId = result.data.id;
    }
  }

  if (result.error) {
    alert("‚ùå Gagal simpan: " + result.error.message);
  } else {
    alert("‚úÖ Data berhasil disimpan!");
    closeSantriModal();

    await loadInitialData();
    filterSantri();

    // scroll ke row terakhir
    setTimeout(() => {
      const activeTab = document.querySelector('.tab-item.active').dataset.tab;
      if (activeTab === "data") {
        const row = document.querySelector(`tr[data-id='${lastEditedId}']`);
        if (row) row.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }, 300);
  }
};

// ========== HAPUS ==========
async function removeSantri(id) {
  if (!confirm("Yakin hapus data ini?")) return;

  const { error } = await supabaseClient.from("santri_kharisma").delete().eq("id", id);
  if (error) {
    alert("‚ùå Gagal hapus: " + error.message);
  } else {
    alert("‚úÖ Data dihapus!");
    lastEditedId = null;

    await loadInitialData();
    filterSantri();
  }
}


  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log("SW registered:", reg.scope))
        .catch(err => console.error("SW registration failed:", err));
    });
  }


</script>
<div class="app-footer">
  <img src="https://img.shields.io/badge/version-v2.1.0-orange" alt="Version">
  <img src="https://img.shields.io/badge/license-Proprietary-red" alt="License">
  <img src="https://img.shields.io/badge/status-Internal%20Use-blue" alt="Status">
  <img src="https://img.shields.io/badge/%C2%A9%202025%20Ndalem%20Kharisma-Semua%20hak%20dilindungi%20undang%E2%80%90undang-red" 
       alt="Copyright">
</div>

</body>
</html>