<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Formulir Santri Kharisma - Modern</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <!-- jsPDF Core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --hover-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
      --border-radius: 16px;
      --border-radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }

    .app-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header Mobile */
    .header-modern {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-radius: var(--border-radius);
      padding: 1rem 0.75rem;
      margin-bottom: 1rem;
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
    }

    .header-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #4cc9f0, #f72585, #7209b7);
    }

    .header-modern .d-flex {
      flex-direction: row;
      text-align: left;
      gap: 0.75rem;
    }

    #logo {
      width: 50px !important;
      height: 50px !important;
      border-radius: var(--border-radius-sm);
      border: 3px solid rgba(255, 255, 255, 0.2);
      margin: 0 !important;
      flex-shrink: 0;
    }

    .header-modern h1 {
      font-size: 1.1rem !important;
      margin-bottom: 0.25rem !important;
      font-weight: 700;
    }

    .header-modern .small {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    /* Card Modern Mobile */
    .card-modern {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      overflow: hidden;
      margin-bottom: 1.5rem;
      background: white;
    }

    .card-header-modern {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 1.25rem 1rem;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .card-body {
      padding: 1.5rem 1rem;
    }

    /* Form Controls Mobile */
    .form-control-modern {
      border-radius: var(--border-radius-sm);
      border: 1.5px solid #e2e8f0;
      padding: 0.875rem 1rem;
      transition: all 0.3s;
      background-color: #f8fafc;
      font-size: 16px;
      width: 100%;
    }

    .form-control-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      background-color: white;
      transform: translateY(-1px);
    }

    .form-label {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      color: var(--dark);
    }

    .input-group {
      border-radius: var(--border-radius-sm);
      overflow: hidden;
    }

    .input-group-text {
      background: #f1f5f9;
      border: 1.5px solid #e2e8f0;
      border-right: none;
      padding: 0.875rem 1rem;
    }

    .form-control-modern.border-start-0 {
      border-left: none;
    }

    /* Buttons Mobile */
    .btn-modern {
      border-radius: var(--border-radius-sm);
      padding: 0.875rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s;
      border: none;
      font-size: 1rem;
    }

    .btn-primary-modern {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-primary-modern:active {
      transform: translateY(0) !important;
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.4) !important;
    }

    .btn-outline-modern {
      border: 2px solid var(--primary);
      color: var(--primary);
      background: transparent;
    }

    .btn-outline-modern:active {
      background: var(--primary);
      color: white;
      transform: translateY(0) !important;
    }

    /* Grid System Mobile */
    .row.g-4 {
      margin: 0 -0.5rem;
    }

    .row.g-4 > [class*="col-"] {
      padding: 0 0.5rem;
    }

    /* Stats Cards Mobile */
    .stats-row {
      display: flex;
      overflow-x: auto;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .stats-row::-webkit-scrollbar {
      display: none;
    }

    .stats-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem 0.75rem;
      box-shadow: var(--card-shadow);
      text-align: center;
      min-width: 120px;
      flex: 0 0 auto;
    }

    .stats-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.2rem;
      line-height: 1.2;
    }

    .stats-label {
      color: #64748b;
      font-size: 0.75rem;
      font-weight: 500;
    }





    /* Card Grid Mobile */
    .card-grid-modern { 
      display: grid; 
      gap: 0.75rem;
      grid-template-columns: 1fr;
    }

    .santri-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem 0.75rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 0.75rem;
      align-items: start;
      min-height: 120px;
      border: 1px solid #f1f5f9;
    }

    .santri-card:active {
      box-shadow: var(--hover-shadow);
      transform: translateY(-2px);
    }

    .santri-photo-container {
      grid-column: 2;
      grid-row: 1 / span 3;
    }

    .santri-photo {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      background: #f8fafc;
    }

    .santri-name {
      grid-column: 1;
      grid-row: 1;
      font-weight: 700;
      font-size: 1rem;
      color: var(--dark);
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }

    .santri-details {
      grid-column: 1;
      grid-row: 2;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .santri-detail {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.25rem;
      color: #64748b;
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .santri-detail i {
      margin-right: 0.5rem;
      color: var(--primary);
      width: 14px;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .action-buttons {
      grid-column: 1 / span 2;
      grid-row: 3;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.25rem;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #e2e8f0;
    }

    .action-btn {
      padding: 0.5rem 0.25rem;
      border-radius: var(--border-radius-sm);
      font-size: 0.7rem;
      text-align: center;
      transition: all 0.2s;
      border: none;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn:active {
      opacity: 0.8;
      transform: scale(0.95);
    }

    .action-btn i {
      margin-right: 0;
      font-size: 0.9rem;
    }

    /* Action Button Colors */
    .action-btn.btn-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .action-btn.btn-dark {
      background: linear-gradient(135deg, #4b5563, #374151);
      color: white;
    }

    .action-btn.btn-success {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .action-btn.btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .action-btn.btn-info {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
    }

    /* Image Preview Mobile */
    .img-preview { 
      width: 70px; 
      height: 70px; 
      object-fit: cover; 
      border-radius: var(--border-radius-sm);
      border: 2px solid #e2e8f0;
    }

    /* Toggle Active State */
    .toggle-active {
      background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
      color: white !important;
      border: none !important;
      box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
    }

    /* Pagination Mobile */
    .card-footer {
      padding: 0.75rem;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
    }

    #pagerInfo {
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    /* Button Groups Mobile */
    .d-flex.gap-2 {
      gap: 0.375rem !important;
    }

    /* Form Layout Mobile */
    .mb-3 {
      margin-bottom: 1rem !important;
    }

    .mb-2 {
      margin-bottom: 0.75rem !important;
    }

    .mt-3 {
      margin-top: 1.25rem !important;
    }

    .mt-4 {
      margin-top: 1.5rem !important;
    }

    /* Alert Mobile */
    .alert {
      border-radius: var(--border-radius-sm);
      padding: 0.875rem;
      margin-bottom: 1rem;
      border: none;
      font-size: 0.85rem;
    }

    /* No Photo State */
    .santri-photo-container .santri-photo.bg-light {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc !important;
    }

    .santri-photo-container .santri-photo.bg-light i {
      font-size: 1.5rem;
      color: #94a3b8;
    }

    /* Status Indicator */
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }

    .status-aktif {
      background: #10b981;
    }

    .status-tidak-aktif {
      background: #ef4444;
    }

    /* Responsive Design - Tablet */
    @media (min-width: 768px) {
      .app-container {
        padding: 1.5rem;
        max-width: 1200px;
      }
      
      .header-modern {
        padding: 1.5rem;
      }
      
      #logo {
        width: 70px !important;
        height: 70px !important;
      }
      
      .header-modern h1 {
        font-size: 1.5rem !important;
      }
      
      .card-grid-modern { 
        grid-template-columns: repeat(2, 1fr); 
      }
      
      .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        overflow-x: visible;
      }
      
      .stats-card {
        min-width: auto;
      }
    }

    /* Responsive Design - Desktop */
    @media (min-width: 1024px) {
      .app-container {
        padding: 2rem;
      }
      
      .card-grid-modern { 
        grid-template-columns: repeat(2, 1fr); 
      }
      
      .header-modern {
        padding: 1.5rem 2rem;
      }
      
      .card-body {
        padding: 2rem 1.5rem;
      }
    }

    /* Very Small Mobile Devices */
    @media (max-width: 360px) {
      .santri-card {
        grid-template-columns: 1fr 70px;
        gap: 0.5rem;
      }

      .santri-photo {
        width: 70px;
        height: 70px;
      }

      .action-buttons {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.2rem;
      }

      .action-btn {
        min-height: 32px;
        padding: 0.375rem 0.2rem;
        font-size: 0.65rem;
      }

      .action-btn i {
        font-size: 0.8rem;
      }

      .santri-name {
        font-size: 0.95rem;
      }

      .santri-detail {
        font-size: 0.75rem;
      }
    }
	
	/* Tambahan CSS untuk info masa khidmah dan usia */
.santri-detail .date-info {
  display: block;
  font-size: 0.75rem;
  color: #64748b;
  margin-top: 2px;
}

/* Untuk PDF styling */
.pdf-date-info {
  font-size: 10px;
  color: #666;
  font-style: italic;
}



/* Batasi zoom di HP */
@media (max-width: 480px) {
  html {
    font-size: 14px;
  }
  .app-container {
    padding: 0.75rem !important;
  }
}
/* Form HP lebih compact */
@media (max-width: 576px) {
  .card-body {
    padding: 1rem !important;
  }
  .form-control-modern,
  .form-select {
    padding: 0.7rem 0.85rem !important;
    font-size: 0.85rem !important;
  }
  label.form-label {
    font-size: 0.78rem !important;
  }
}
@media (max-width: 576px) {
  #logo {
    width: 42px !important;
    height: 42px !important;
  }
  .header-modern h1 {
    font-size: 1rem !important;
  }
  .header-modern .small {
    font-size: 0.7rem !important;
  }
}
@media (max-width: 768px) {
  button,
  .btn {
    height: 36px !important;
    padding: 5px 10px !important;
    font-size: 0.78rem !important;
  }
  .action-btn i {
    font-size: 1rem !important;
  }
}
@media (max-width: 420px) {
  .stats-card {
    min-width: 100px;
    padding: 0.75rem 0.5rem;
  }
  .stats-number {
    font-size: 1.2rem;
  }
}
@media (max-width: 375px) {
  .santri-card {
    grid-template-columns: 1fr 65px;
    padding: 0.75rem !important;
  }
  .santri-photo {
    width: 65px;
    height: 65px;
  }
}

/* ==============================
   FILTER SECTION (CLEAN + RESPONSIVE)
================================== */
.filter-section {
  background: #ffffff;
  border-radius: var(--border-radius);
  padding: 1rem 0.75rem;
  margin-bottom: 1rem;
  box-shadow: var(--card-shadow);
}

/* Input group & select spacing */
.filter-section .row.g-3 > div,
.filter-section .row.mt-3 > div {
  margin-bottom: 0;
}

/* Input + select uniform */
.filter-section .form-control-modern,
.filter-section .form-select {
  min-height: 38px;
  font-size: 0.85rem;
}

/* Tombol */
.filter-section button.btn-sm {
  min-height: 38px;
  font-size: 0.8rem;
  padding: 6px 10px;
}

/* Dropdown perPage selalu kecil */
#perPage {
  width: 100%;
  max-width: 110px;
}

/* ==============================
   MOBILE RESPONSIVE
================================== */
@media (max-width: 768px) {
  .filter-section {
    padding: 0.75rem;
  }

  .filter-section .row.g-3 {
    gap: 0.75rem !important;
  }

  /* buat 4 item input turun 2 kolom */
  .filter-section .row.g-3 > div {
    flex: 0 0 50%;
    max-width: 50%;
  }

  #searchInput {
    flex: 0 0 100%;
    max-width: 100%;
  }

  /* Tombol baris 2 jadi 2 kolom */
  .filter-section .row.mt-3 .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
  }
}

@media (max-width: 450px) {
  /* Semua jadi 1 kolom */
  .filter-section .row.g-3 > div,
  .filter-section .row.mt-3 > div {
    flex: 0 0 100%;
    max-width: 100%;
  }

  #perPage {
    max-width: 100% !important;
  }

  button.btn-sm {
    width: 100%;
    justify-content: center;
  }
}

/* ==========================================
   FILTER SECTION FINAL RESPONSIVE FIX
========================================== */



/* Pastikan input-group tetap satu baris */
.filter-section .input-group {
  display: flex;
  flex-wrap: nowrap;
  width: 100%;
}

/* Input jangan terlalu lebar di HP */
#searchInput {
  flex: 1;
  min-width: 0;
}

/* Style ikon agar tidak memanjang */
.filter-section .input-group-text {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: .55rem .65rem !important;
}

/* Tinggi form lebih ringkas */
.filter-section .form-control-modern,
.filter-section .form-select {
  padding: .55rem .75rem !important;
  font-size: .82rem !important;
}

/* Atur perPage supaya sejajar dan tidak turun */
#perPage {
  width: 100%;
  max-width: 100px;
}

/* HP Layout — Semua 1 kolom, lebih rapi */
@media (max-width: 576px) {
  .filter-section .row > div {
    flex: 0 0 100% !important;
    max-width: 100% !important;
  }

  .filter-section {
    padding: .55rem !important;
  }

  /* Tombol full width lebih ergonomis */
  #togglePaginationBtn,
  #refreshBtn,
  #exportBtn {
    width: 100% !important;
    justify-content: center;
  }

  .filter-section .row.mt-3 {
    gap: .25rem !important;
  }
}

.pdf-btn .btn-spinner { display: none; }
.pdf-btn .btn-icon { display: inline-block; }

.pdf-btn.pdf-spinning .btn-icon { display: none; }
.pdf-btn.pdf-spinning .btn-spinner { display: inline-block; }

/* ==============================
   PERBAIKAN UKURAN FOTO UNTUK HP
================================== */

/* Ukuran foto utama di kartu santri */
.santri-photo {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 12px;
  background: #f8fafc;
}

/* Container foto di kartu */
.santri-photo-container {
  grid-column: 2;
  grid-row: 1 / span 3;
}

/* Layout kartu untuk menampung foto lebih besar */
.santri-card {
  background: white;
  border-radius: var(--border-radius);
  padding: 1rem 0.75rem;
  box-shadow: var(--card-shadow);
  transition: all 0.3s ease;
  display: grid;
  grid-template-columns: 1fr 100px; /* Lebar foto 100px */
  gap: 0.75rem;
  align-items: start;
  min-height: 130px; /* Sedikit lebih tinggi untuk foto lebih besar */
  border: 1px solid #f1f5f9;
}

/* Preview foto di form */
.img-preview { 
  width: 90px; 
  height: 90px; 
  object-fit: cover; 
  border-radius: var(--border-radius-sm);
  border: 2px solid #e2e8f0;
}

/* Responsif untuk tablet */
@media (min-width: 768px) {
  .santri-photo {
    width: 130px;
    height: 130px;
  }
  
  .santri-card {
    grid-template-columns: 1fr 110px;
    min-height: 140px;
  }
  
  .img-preview { 
    width: 100px; 
    height: 100px; 
  }
}

/* Responsif untuk desktop */
@media (min-width: 1024px) {
  .santri-photo {
    width: 100px;
    height: 100px;
  }
  
  .santri-card {
    grid-template-columns: 1fr 120px;
    min-height: 150px;
  }
  
  .img-preview { 
    width: 110px; 
    height: 110px; 
  }
}

/* Penyesuaian untuk HP sangat kecil */
@media (max-width: 360px) {
  .santri-photo {
    width: 90px;
    height: 90px;
  }
  
  .santri-card {
    grid-template-columns: 1fr 90px;
    gap: 0.5rem;
    min-height: 120px;
  }
  
  .img-preview { 
    width: 80px; 
    height: 80px; 
  }
}

/* Penyesuaian untuk HP sangat kecil (kurang dari 375px) */
@media (max-width: 375px) {
  .santri-card {
    grid-template-columns: 1fr 85px;
    padding: 0.75rem !important;
  }
  
  .santri-photo {
    width: 85px;
    height: 85px;
  }
}

/* ==============================
   STATS CARD — RAPIHAN + CENTER
================================== */

/* Style card lebih rapi dan proporsional */
.stats-card {
  background: white;
  border-radius: var(--border-radius-sm);
  padding: 1rem 0.75rem;
  box-shadow: var(--card-shadow);
  text-align: center;
  
  /* Rapikan spacing */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;

  /* Ukuran default */
  min-width: 110px;
}

/* Angka lebih tegas */
.stats-number {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 0.35rem;
  line-height: 1;
}

/* Label lebih rapi */
.stats-label {
  font-size: 0.8rem;
  font-weight: 500;
  color: #475569;
}

/* Center ALL screen sizes */
.stats-row {
  justify-content: center !important;
}

/* ==============================
   MODE TABLET (grid)
================================== */
@media (min-width: 768px) {
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    justify-items: center;
    gap: 1rem;
    overflow-x: visible !important;
  }

  .stats-card {
    width: 100%;
    max-width: 180px; /* biar seragam */
    padding: 1.2rem 1rem;
  }

  .stats-number {
    font-size: 1.6rem;
  }

  .stats-label {
    font-size: 0.85rem;
  }
}

/* ==============================
   MODE DESKTOP
================================== */
@media (min-width: 1024px) {
  .stats-row {
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  }

  .stats-card {
    max-width: 200px;
    padding: 1.3rem 1.2rem;
  }

  .stats-number {
    font-size: 1.8rem;
  }

  .stats-label {
    font-size: 0.9rem;
  }
}

.app-footer {
  background: #ffffff;                     /* putih */
  padding: 1rem 0.75rem;                   /* jarak dalam */
  border-radius: 16px;                     /* biar mengikuti style app */
  box-shadow: 0 4px 20px rgba(0,0,0,0.05); /* shadow halus */
  display: flex;
  justify-content: center;                 /* center kanan–kiri */
  align-items: center;
  flex-wrap: wrap;                         /* biar responsif */
  gap: 0.75rem;                            /* jarak antar badge */
  margin-top: 1.5rem;
}

@media (max-width: 480px) {
  .app-footer {
    padding: 0.75rem;
    gap: 0.5rem;
  }
}

.santri-photo {
  width: 100%;
  height: 170px;          /* tinggi tetap, tidak melar */
  object-fit: cover;     /* potong rapi, tidak gepeng */
  border-radius: 16px 16px 16px 16px;
  background-color: #f1f5f9;
  display: block;
}


@media (max-width: 576px) {
  .santri-photo {
    height: 150px;
  }
}

.santri-card {
  overflow: hidden;      /* FOTO TIDAK BISA KELUAR */
  border-radius: 16px;
}
/* TOOLTIP STYLE */
.tooltip-btn {
  position: relative;
  overflow: visible;
}

.tooltip-btn .tooltip {
  position: absolute;
  top: -40px;
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: #333;
  color: #fff;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: all 0.25s ease;
  z-index: 999;
}

.tooltip-btn .tooltip::before {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 50%;
  transform: translateX(-50%) rotate(45deg);
  width: 8px;
  height: 8px;
  background: #333;
}

/* SHOW ON HOVER */
.tooltip-btn:hover .tooltip {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.btn-warning .tooltip { background:#ffc107; color:#000; }
.btn-warning .tooltip::before { background:#ffc107; }

.btn-success .tooltip { background:#198754; }
.btn-success .tooltip::before { background:#198754; }

.btn-primary .tooltip { background:#0d6efd; }
.btn-primary .tooltip::before { background:#0d6efd; }

.btn-info .tooltip { background:#0dcaf0; color:#000; }
.btn-info .tooltip::before { background:#0dcaf0; }

/* tooltip tampil manual (touch) */
.tooltip-btn.show-tooltip .tooltip {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
.tooltip-btn {
  touch-action: manipulation;
}

.tooltip-btn {
  position: relative;
  touch-action: manipulation;
}

.tooltip {
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.85);
  color: #fff;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease;
  z-index: 999;
}

.tooltip-btn.show-tooltip .tooltip {
  opacity: 1;
}

  </style>
  <link rel="icon" type="image/png" href="https://i.imgur.com/Irgu32G.png">
</head>
<body>
<div class="app-container py-4">
  <!-- Back Button -->
  <div style="margin-bottom: 1rem;">
    <a href="jindex.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); transition: all 0.3s ease; border: none; cursor: pointer;" onmouseover="this.style.boxShadow='0 6px 20px rgba(99, 102, 241, 0.5)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='0 4px 15px rgba(99, 102, 241, 0.3)'; this.style.transform='translateY(0)';">
      <span style="font-size: 1.2rem;">←</span>
      <span>Kembali ke Menu</span>
    </a>
  </div>

  <!-- Header Modern -->
  <header class="header-modern d-flex align-items-center">
    <img id="logo" src="https://i.imgur.com/Irgu32G.png" alt="logo" class="me-3">
    <div class="flex-grow-1">
      <h1 class="h3 mb-1 fw-bold">KHUDAMA' KHARISMA</h1>
      <div class="small opacity-85">Tambah, edit, cari, dan kelola data santri dengan mudah</div>
    </div>
    <div class="d-none d-md-flex align-items-center gap-3">
      <div class="text-end">
        <div class="fw-bold" id="currentDate"></div>
        <div class="small opacity-85" id="currentTime"></div>
      </div>
    </div>
  </header>

  <div class="row g-4">
    <!-- Form Section -->
    <div class="col-lg-4">
      <div class="card-modern">
        <div class="card-header-modern">
          <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Formulir Ndalem Baru</h5>
        </div>
        <div class="card-body p-4">
          <div id="alertBox" class="alert d-none" role="alert"></div>
          <form id="formSantri" novalidate>

  <!-- =================== -->
  <!--     BAGIAN SISWA    -->
  <!-- =================== -->

<h6 class="fw-bold text-primary text-center mb-3 mt-2">— Siswa —</h6>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Nama Lengkap *</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
      <input id="Nama_Lengkap" class="form-control form-control-modern" required>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Kelas *</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-book"></i></span>
      <select id="Kelas" class="form-select form-control-modern" required></select>
    </div>
  </div>

  <div class="row g-2">
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Bagian</label>
      <input id="Bagian" class="form-control form-control-modern">
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Stambuk</label>
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-card-text"></i></span>
        <input id="Stambuk" class="form-control form-control-modern">
      </div>
    </div>
  </div>

<div class="row g-2">
  <div class="col-md-6 mb-3">
    <label class="form-label small fw-semibold">Asal Daerah</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-geo-alt"></i></span>
      <input id="Asal_Daerah" class="form-control form-control-modern">
    </div>
  </div>

  <div class="col-md-6 mb-3">
    <label class="form-label small fw-semibold">Himpunan</label>
    <input id="Himpunan" class="form-control form-control-modern">
  </div>
</div>


  <div class="row g-2">
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Kamar</label>
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-door-closed"></i></span>
        <input id="Kamar" class="form-control form-control-modern">
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Tgl Lahir</label>
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-calendar-event"></i></span>
        <input id="Tgl_Lahir" type="date" class="form-control form-control-modern">
      </div>
   </div>
 </div>

<h6 class="fw-bold text-primary text-center mb-3 mt-4">— Ngaji —</h6>

<!-- ================== NGAJI ================== -->
<div class="mb-3">
  <label for="Ngaji" class="form-label">Ngaji</label>
  <select id="Ngaji" class="form-select">
    <option value="">-- Pilih Ngaji --</option>
  </select>
</div>

  <!-- =================== -->
  <!--     BAGIAN NDIALEM  -->
  <!-- =================== -->
  
<h6 class="fw-bold text-primary text-center mb-3 mt-4">— Ndalem —</h6>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Unit Ndalem *</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-building"></i></span>
      <select id="Unit_Ndalem" class="form-select form-control-modern" required></select>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Posisi Tugas</label>
    <input id="Posisi_Tugas" class="form-control form-control-modern">
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Jam Tugas</label>
    <input id="Jam_Tugas" class="form-control form-control-modern">
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Shift</label>
    <input id="Shift" class="form-control form-control-modern">
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Mulai Ngabdi</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-calendar-check"></i></span>
      <input id="Mulai_Ngabdi" type="date" class="form-control form-control-modern">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">Nama Wali</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
      <input id="Nama_Wali" class="form-control form-control-modern">
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label small fw-semibold">No. Wali (62…)</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-telephone"></i></span>
      <input id="No_Wali" class="form-control form-control-modern" placeholder="62…">
    </div>
  </div>
  
  <div class="mb-3">
  <label class="form-label small fw-semibold">Kategori</label>
  <select id="Kategori" class="form-select form-control-modern">
    <option value="Tanpa SKTM">Tanpa SKTM</option>
    <option value="SKTM">SKTM</option>
  </select>
</div>


  <div class="row g-2">
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Status</label>
      <select id="Status" class="form-select form-control-modern">
        <option value="">-- Pilih --</option>
        <option>aktif</option>
        <option>tidak aktif</option>
      </select>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label small fw-semibold">Tgl Keluar</label>
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-calendar-x"></i></span>
        <input id="Tgl_Keluar" type="date" class="form-control form-control-modern">
      </div>
    </div>
  </div>

  <!-- FOTO -->
  <div class="mb-3 mt-3">
    <label class="form-label small fw-semibold">Foto (upload)</label>
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-camera"></i></span>
      <input id="Foto" type="file" accept="image/*" class="form-control form-control-modern">
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="mb-3 d-flex align-items-center gap-3">
    <img id="fotoPreview" class="img-preview d-none" alt="preview">
    <div class="small text-muted">Preview foto akan muncul di sini</div>
  </div>

  <!-- BUTTON -->
  <div class="d-flex gap-2 mt-4">
    <button id="submitBtn" class="btn btn-modern btn-primary-modern flex-fill">
      <i class="bi bi-check-lg me-2"></i>Simpan
    </button>
    <button id="resetBtn" type="button" class="btn btn-modern btn-outline-modern">
      <i class="bi bi-arrow-clockwise me-2"></i>Reset
    </button>
  </div>

</form>

        </div>
      </div>
    </div>

    <!-- Table & Controls Section -->
    <div class="col-lg-8">
      <!-- Stats Cards -->
      <div class="stats-row">        
        <div class="stats-card">
          <div class="stats-number" id="aktifSantri">0</div>
          <div class="stats-label">Siswa Aktif</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="kelasCount">0</div>
          <div class="stats-label">Kelas</div>
        </div>
        <div class="stats-card">
          <div class="stats-number" id="unitCount">0</div>
          <div class="stats-label">Unit</div>
        </div>
      </div>
      
      <!-- Filter Section -->
      <div class="filter-section">
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
              <input id="searchInput" class="form-control form-control-modern border-start-0" placeholder="Cari nama atau stambuk...">
            </div>
          </div>
          <div class="col-md-3">
            <select id="filterKelas" class="form-select form-control-modern">
              <option value="">Semua Kelas</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="filterUnit" class="form-select form-control-modern">
              <option value="">Semua Unit</option>
            </select>
          </div>
          <div class="col-md-2 d-flex gap-2 justify-content-end">
            <select id="perPage" class="form-select form-control-modern" style="width:110px">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>
        
        <div class="row mt-3 align-items-center">
          <div class="col-md-6 d-flex gap-2">
            <button id="togglePaginationBtn" class="btn btn-modern btn-outline-modern btn-sm">
              <i class="bi bi-list-ul me-1"></i>Tampilkan semua
            </button>
          </div>
          <div class="col-md-6 d-flex gap-2 justify-content-end">
            <button id="refreshBtn" class="btn btn-modern btn-outline-modern btn-sm">
              <i class="bi bi-arrow-repeat me-1"></i>Refresh
            </button>
            <button id="exportBtn" class="btn btn-modern btn-outline-modern btn-sm">
              <i class="bi bi-download me-1"></i>Export
            </button>
          </div>
        </div>
      </div>

      <!-- Data Display Area -->
      <div id="listArea">
        <!-- Card View -->
        <div id="cardGrid" class="card-grid-modern"></div>

        <!-- Pagination -->
        <div class="card-modern">
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div id="pagerInfo" class="small text-muted"></div>
            <div>
              <button id="prevBtn" class="btn btn-modern btn-outline-modern btn-sm">
                <i class="bi bi-chevron-left me-1"></i>Prev
              </button>
              <button id="nextBtn" class="btn btn-modern btn-outline-modern btn-sm">
                Next<i class="bi bi-chevron-right ms-1"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "https://oflkibeaesvwzdzyvdfy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9mbGtpYmVhZXN2d3pkenl2ZGZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDIyOTQsImV4cCI6MjA3MDQxODI5NH0.MMcdx7g54R9kqFdfkDPP57gNPCnxGLKWHhexTAcJ2io";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// data lists
const kelasOrder = [
  'V Ibtidaiyah','VI Ibtidaiyah',
  'I Tsanawiyah','II Tsanawiyah','III Tsanawiyah',
  'I Aliyah','II Aliyah','III Aliyah',
  "I-II Ma'had Aly","III-IV Ma'had Aly","V-VI Ma'had Aly",
  "I'dadiyah I","I'dadiyah II","I'dadiyah III"
];
const unitNdalemList = [
  'Al-amanah cell','Al-amanah Toko','Catering Arham (Pak Din)','Catering P3TQ',
  'Frozen Food','Gorengan & Kost SPBE','Gus Shohib','Kandang Kambing',
  'Kandang Sapi','KBR P3TQ','Kolam Koi','Kost P3TQ','Laundry P3TQ',
  'Mandiri Grabah (Andika)','Mandiri Grabah (Gudang & Bandar)',
  'Mandiri Grabah (Pasar Campurejo)','Mandiri Grabah (SMK)',
  'Mandiri Grabah (Tembakau)','Ndalem Barat','Ndalem Timur',
  'Pabrik Tahu & Tempe','Pangkas Rambut','PULP P3TQ',
  'Rahmatuka I (Maqom)','Rahmatuka II (Pasar Campurejo)',
  'Rizquna Baby & Fashion','Rizquna Bangunan','Rizqua Galon Barat',
  'Rizqua Galon Timur','Rizquna Juwet','Rizquna Laundry',
  'Selepan','Sopir','Toko Nafisah','Warung Nafis','Rizquna Bakso'
];


const ngajiData = [
  { id: 1, label: "MMQ - Jet Tempur" },
  { id: 2, label: "MMQ - Ibtidaiyah" },
  { id: 3, label: "MMQ - Tsanawiyah" },
  { id: 4, label: "MMQ - Aliyah" },
  { id: 5, label: "MMQ - Takhtiman" },
  { id: 6, label: "Maunah Sari - Setoran" },
  { id: 7, label: "Kamar - Setoran" },
  { id: 8, label: "Talaqi - Setoran" }
];



// DOM refs
const Kelas = document.getElementById('Kelas');
const Unit_Ndalem = document.getElementById('Unit_Ndalem');
const Ngaji = document.getElementById('Ngaji');
const filterKelas = document.getElementById('filterKelas');
const filterUnit = document.getElementById('filterUnit');
const cardGrid = document.getElementById('cardGrid');
const searchInput = document.getElementById('searchInput');
const perPage = document.getElementById('perPage');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pagerInfo = document.getElementById('pagerInfo');
const fotoInput = document.getElementById('Foto');
const fotoPreview = document.getElementById('fotoPreview');
const alertBox = document.getElementById('alertBox');
const submitBtn = document.getElementById('submitBtn');
const resetBtn = document.getElementById('resetBtn');
const refreshBtn = document.getElementById('refreshBtn');
const togglePaginationBtn = document.getElementById('togglePaginationBtn');
const exportBtn = document.getElementById('exportBtn');
const aktifSantri = document.getElementById('aktifSantri');
const kelasCount = document.getElementById('kelasCount');
const unitCount = document.getElementById('unitCount');
const currentDate = document.getElementById('currentDate');
const currentTime = document.getElementById('currentTime');
const Kategori = document.getElementById('Kategori');

// populate selects

// KELAS
Kelas.add(new Option('-- Pilih --', ''));
filterKelas.add(new Option('Semua Kelas', ''));

kelasOrder.forEach(k => { 
  Kelas.add(new Option(k, k)); 
  filterKelas.add(new Option(k, k)); 
});

// UNIT NDALEM
Unit_Ndalem.add(new Option('-- Pilih --', ''));
filterUnit.add(new Option('Semua Unit', ''));

unitNdalemList.forEach(u => { 
  Unit_Ndalem.add(new Option(u, u)); 
  filterUnit.add(new Option(u, u)); 
});

window.spinPDF = function(btn) {
  if (!btn) return;
  btn.classList.add("pdf-spinning");
  btn.disabled = true;
};

window.stopSpinPDF = function(btn) {
  if (!btn) return;
  btn.classList.remove("pdf-spinning");
  btn.disabled = false;
};

const PDF_PASSWORD = "imamfatoni24"; // ganti sesuai keinginan

// state
let page = 1;
let pageSize = parseInt(perPage.value,10);
let totalRows = 0;
let editId = null;
let usePagination = true;
let allData = [];

// Update date and time
function updateDateTime() {
  const now = new Date();
  currentDate.textContent = now.toLocaleDateString('id-ID', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  currentTime.textContent = now.toLocaleTimeString('id-ID');
}
setInterval(updateDateTime, 1000);
updateDateTime();

// helper show msg
function showAlert(text, type='success') {
  alertBox.textContent = text;
  alertBox.className = 'alert alert-dismissible ' + (type==='error' ? 'alert-danger' : 'alert-success');
  alertBox.classList.remove('d-none');
  
  if (!alertBox.querySelector('.btn-close')) {
    const closeBtn = document.createElement('button');
    closeBtn.type = 'button';
    closeBtn.className = 'btn-close';
    closeBtn.setAttribute('data-bs-dismiss', 'alert');
    alertBox.appendChild(closeBtn);
  }
  
  setTimeout(()=> {
    if (alertBox.classList.contains('show')) return;
    alertBox.classList.add('d-none');
  }, 3500);
}

// preview foto function
function previewFoto() {
  const urlInput = fotoURLInput.value.trim();
  const file = fotoInput.files[0];

  if (urlInput !== '') {
    const validExt = ['.jpg','.jpeg','.png','.gif'];
    const low = urlInput.toLowerCase();
    if (low.startsWith('http') && validExt.some(e=>low.endsWith(e))) {
      fotoPreview.src = urlInput;
      fotoPreview.classList.remove('d-none');
      return;
    }
  }
  if (file) {
    fotoPreview.src = URL.createObjectURL(file);
    fotoPreview.classList.remove('d-none');
    return;
  }
  fotoPreview.src = '';
  fotoPreview.classList.add('d-none');
}
fotoInput.addEventListener('change', previewFoto);


// upload foto to Supabase storage
async function uploadFotoToStorage(file) {
  if (!file) return null;
  try {
    const fileName = `foto_${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
    const { error } = await supabase.storage.from('foto').upload(fileName, file);
    if (error) {
      console.warn('Storage upload error:', error);
      showAlert('Upload foto gagal: ' + error.message, 'error');
      return null;
    }
    const { data } = supabase.storage.from('foto').getPublicUrl(fileName);
    return data.publicUrl;
  } catch (err) {
    console.error(err);
    return null;
  }
}

// Update stats
function updateStats(data) {
  
  const aktif = data.filter(r => r.Status === 'aktif').length;
  aktifSantri.textContent = aktif;
  
  const uniqueKelas = [...new Set(data.map(r => r.Kelas))].filter(k => k);
  kelasCount.textContent = uniqueKelas.length;
  
  const uniqueUnit = [...new Set(data.map(r => r.Unit_Ndalem))].filter(u => u);
  unitCount.textContent = uniqueUnit.length;
}

// load data
async function loadData() {
  pageSize = parseInt(perPage.value,10);
  const q = searchInput.value.trim().toLowerCase();
  const kelas = filterKelas.value;
  const unit = filterUnit.value;

  const { data, error } = await supabase.from('santri_kharisma').select('*').order('id',{ascending:false});
  if (error) { 
    console.error(error); 
    showAlert('Gagal memuat data: '+error.message,'error'); 
    return; 
  }
  
  allData = data || [];
  updateStats(allData);
  
  let rows = [...allData];

  if (q) rows = rows.filter(r => 
    (r.Nama_Lengkap||'').toLowerCase().includes(q) || 
    (r.Stambuk||'').toLowerCase().includes(q)
  );
  if (kelas) rows = rows.filter(r => r.Kelas === kelas);
  if (unit) rows = rows.filter(r => r.Unit_Ndalem === unit);

  totalRows = rows.length;
  const start = (page-1)*pageSize;
  const end = start + pageSize;
  const pageRows = usePagination ? rows.slice(start,end) : rows;

  renderList(pageRows);
  pagerInfo.textContent = `Menampilkan ${usePagination ? (start+1) : 1} - ${usePagination ? Math.min(end,totalRows) : totalRows} dari ${totalRows} entri`;
}

function renderList(rows) {
  cardGrid.innerHTML = '';
  if (!rows.length) {
    cardGrid.innerHTML = '<div class="col-12 text-center text-muted p-5"><i class="bi bi-inbox display-4 d-block mb-3"></i>Tidak ada data yang sesuai dengan filter.</div>';
  } else {
    rows.forEach(r => {
      const div = document.createElement('div');
      div.className = 'santri-card';
      
      // Hitung masa khidmah dan usia
      const masaKhidmah = calculateMasaKhidmah(r.Mulai_Ngabdi);
      const usia = calculateUsia(r.Tgl_Lahir);
      
      div.innerHTML = `
        <div class="santri-photo-container">
          ${r.Foto 
            ? `<img src="${r.Foto}" class="santri-photo" alt="${r.Nama_Lengkap}">` 
            : `<div class="santri-photo bg-light d-flex align-items-center justify-content-center text-muted">
                 <i class="bi bi-person display-4"></i>
               </div>`}
        </div>
        
        <div class="santri-name">
          <span class="status-indicator ${r.Status === 'aktif' ? 'status-aktif' : 'status-tidak-aktif'}"></span>
          ${r.Nama_Lengkap || '-'}
        </div>
        
        <div class="santri-details">
          <div class="santri-detail">
            <i class="bi bi-book"></i>
            <span>${r.Kelas || '-'}</span>
          </div>
          <div class="santri-detail">
            <i class="bi bi-building"></i>
            <span>${r.Unit_Ndalem || '-'}</span>
          </div>
          <div class="santri-detail">
            <i class="bi bi-geo-alt"></i>
            <span>${r.Asal_Daerah || '-'}</span>
          </div>
          <div class="santri-detail">
            <i class="bi bi-calendar-check"></i>
            <span>${r.Mulai_Ngabdi ? new Date(r.Mulai_Ngabdi).toLocaleDateString('id-ID') : '-'} (${masaKhidmah})</span>
          </div>
          <div class="santri-detail">
            <i class="bi bi-person"></i>
            <span>${r.Tgl_Lahir ? new Date(r.Tgl_Lahir).toLocaleDateString('id-ID') : '-'} (${usia})</span>
          </div>
        </div>
        
       <div class="action-buttons">

  <button class="btn btn-sm btn-warning action-btn tooltip-btn"
    data-action="edit"
    data-id="${r.id}">
    <span class="tooltip">Edit Data</span>
    <i class="bi bi-pencil"></i>
  </button>

  <button class="btn btn-sm btn-dark action-btn tooltip-btn"
    data-action="guru"
    data-id="${r.id}">
    <span class="tooltip">Mustahiq</span>
    <i class="bi bi-person-check"></i>
  </button>

  <button class="btn btn-sm btn-success action-btn tooltip-btn"
    data-action="wa"
    data-id="${r.id}">
    <span class="tooltip">WA Wali</span>
    <i class="bi bi-whatsapp"></i>
  </button>

  <button class="btn btn-sm btn-primary action-btn tooltip-btn"
    data-action="hp"
    data-id="${r.id}">
    <span class="tooltip">Telepon</span>
    <i class="bi bi-telephone"></i>
  </button>

  <button class="btn btn-sm btn-info action-btn tooltip-btn pdf-btn"
    data-action="pdf"
    data-id="${r.id}">
    <span class="tooltip">Download PDF</span>

    <span class="btn-icon">
      <i class="bi bi-file-earmark-pdf"></i>
    </span>
    <div class="btn-spinner spinner-border spinner-border-sm"></div>
  </button>

</div>


      `;
      cardGrid.appendChild(div);
    });
  }
}

window.onEdit = async function(id) {
  const { data, error } = await supabase.from('santri_kharisma').select('*').eq('id',id).single();
  if (error) { 
    showAlert('Gagal mengambil data: '+error.message,'error'); 
    return; 
  }
  editId = id;

  Kelas.value = data.Kelas || '';
  document.getElementById('Bagian').value = data.Bagian || '';
  document.getElementById('Nama_Lengkap').value = data.Nama_Lengkap || '';
  document.getElementById('Stambuk').value = data.Stambuk || '';
  Unit_Ndalem.value = data.Unit_Ndalem || '';
  Ngaji.value = data.Ngaji || '';
  Kategori.value = data.Kategori || 'Tanpa SKTM';
  document.getElementById('Asal_Daerah').value = data.Asal_Daerah || '';
  document.getElementById('Himpunan').value = data.Himpunan || '';
  document.getElementById('Kamar').value = data.Kamar || '';
  document.getElementById('Tgl_Lahir').value = data.Tgl_Lahir || '';
  document.getElementById('Mulai_Ngabdi').value = data.Mulai_Ngabdi || '';
  document.getElementById('Tgl_Keluar').value = data.Tgl_Keluar || '';
  document.getElementById('Status').value = data.Status || '';
  document.getElementById('Posisi_Tugas').value = data.Posisi_Tugas || '';
  document.getElementById('Jam_Tugas').value = data.Jam_Tugas || '';
  document.getElementById('Shift').value = data.Shift || '';
  document.getElementById('Nama_Wali').value = data.Nama_Wali || '';
  document.getElementById('No_Wali').value = data.No_Wali || '';

  // =========================
  // PREVIEW FOTO DITEMPATKAN DI SINI
  // =========================
  if (data.Foto) {
    fotoPreview.src = data.Foto;
    fotoPreview.classList.remove("d-none");
  } else {
    fotoPreview.src = "";
    fotoPreview.classList.add("d-none");
  }
  // =========================

  submitBtn.textContent = 'Update Data';
  submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Data';
  window.scrollTo({top:0,behavior:'smooth'});
};


// delete handler
window.onDelete = async function(id){
  if (!confirm('Hapus data ini?')) return;
  const { error } = await supabase.from('santri_kharisma').delete().eq('id',id);
  if (error) { 
    showAlert('Gagal hapus: '+error.message,'error'); 
    return; 
  }
  showAlert('Data dihapus');
  await loadData();
};

// reset form
resetBtn.addEventListener('click', () => {
  document.getElementById('formSantri').reset();
  fotoPreview.src=''; 
  fotoPreview.classList.add('d-none');
  editId = null; 
  submitBtn.textContent='Simpan';
  submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Simpan';
});

// submit form
document.getElementById('formSantri').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm me-2"></i>Menyimpan...';

  const file = fotoInput.files[0];
 let finalFoto = null;

if (file) {
  finalFoto = await uploadFotoToStorage(file);
} else if (editId) {
  // kalau update dan tidak pilih foto baru, jangan ubah foto
} else {
  finalFoto = null;
}


  const payload = {
    Kelas: Kelas.value || null,
	Kategori: Kategori.value || 'Tanpa SKTM',
    Bagian: document.getElementById('Bagian').value || null,
    Nama_Lengkap: document.getElementById('Nama_Lengkap').value || null,
    Foto: finalFoto,
    Stambuk: document.getElementById('Stambuk').value || null,
    Unit_Ndalem: Unit_Ndalem.value || null,
    Ngaji: Ngaji.value ? parseInt(Ngaji.value) : null,
    Asal_Daerah: document.getElementById('Asal_Daerah').value || null,
    Himpunan: document.getElementById('Himpunan').value || null,
    Kamar: document.getElementById('Kamar').value || null,
    Tgl_Lahir: document.getElementById('Tgl_Lahir').value || null,
    Mulai_Ngabdi: document.getElementById('Mulai_Ngabdi').value || null,
    Tgl_Keluar: document.getElementById('Tgl_Keluar').value || null,
    Status: document.getElementById('Status').value || null,
    Posisi_Tugas: document.getElementById('Posisi_Tugas').value || null,
    Jam_Tugas: document.getElementById('Jam_Tugas').value || null,
    Shift: document.getElementById('Shift').value || null,
	Nama_Wali: document.getElementById('Nama_Wali').value || null,
    No_Wali: document.getElementById('No_Wali').value || null,
    Kode_Unit: null,
    Masa_Khidmah: null
  };

  try {
    if (editId) {
      if (!('Foto' in payload) || payload.Foto === null) delete payload.Foto;
      const { error } = await supabase.from('santri_kharisma').update(payload).eq('id', editId);
      if (error) { 
        showAlert('Gagal update: '+error.message,'error'); 
        submitBtn.disabled=false; 
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Data';
        return; 
      }
      showAlert('Data berhasil diupdate');
      editId = null;
      submitBtn.textContent='Simpan';
      submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Simpan';
    } else {
      const { error } = await supabase.from('santri_kharisma').insert([payload]);
      if (error) { 
        showAlert('Gagal menyimpan: '+error.message,'error'); 
        submitBtn.disabled=false; 
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Simpan';
        return; 
      }
      showAlert('Data berhasil disimpan');
    }
    document.getElementById('formSantri').reset();
    fotoPreview.src=''; 
    fotoPreview.classList.add('d-none');
    await loadData();
  } catch (err) {
    console.error(err);
    showAlert('Terjadi error','error');
  } finally {
    submitBtn.disabled = false;
    if (editId) {
      submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Update Data';
    } else {
      submitBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Simpan';
    }
  }
});

// interactions
perPage.addEventListener('change', ()=>{ page=1; loadData(); });
searchInput.addEventListener('input', ()=>{ page=1; loadData(); });
filterKelas.addEventListener('change', ()=>{ page=1; loadData(); });
filterUnit.addEventListener('change', ()=>{ page=1; loadData(); });
prevBtn.addEventListener('click', ()=>{ if (page>1){ page--; loadData(); }});
nextBtn.addEventListener('click', ()=>{ if (page*pageSize < totalRows){ page++; loadData(); }});

togglePaginationBtn.addEventListener('click', ()=>{ 
  usePagination=!usePagination; 
  page=1; 
  loadData(); 
  togglePaginationBtn.innerHTML = usePagination 
    ? '<i class="bi bi-list-ul me-1"></i>Tampilkan semua' 
    : '<i class="bi bi-list-ul me-1"></i>Paginasi';
});

refreshBtn.addEventListener('click', ()=>loadData());

// Export functionality
exportBtn.addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape', 'pt', 'a4');
  
  doc.setFontSize(18);
  doc.setTextColor(40, 40, 40);
  doc.text('DATA SANTRI KHUDAMA\' KHARISMA', 40, 40);
  
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text(`Dicetak pada: ${new Date().toLocaleString('id-ID')}`, 40, 60);
  
  const headers = [['No', 'Nama Lengkap', 'Kelas', 'Unit Ndalem', 'Asal Daerah', 'Status']];
  const data = allData.map((s, i) => [
    i + 1,
    s.Nama_Lengkap || '-',
    s.Kelas || '-',
    s.Unit_Ndalem || '-',
    s.Asal_Daerah || '-',
    s.Status || '-'
  ]);
  
  doc.autoTable({
    head: headers,
    body: data,
    startY: 80,
    styles: { fontSize: 9 },
    headStyles: { fillColor: [67, 97, 238] }
  });
  
  doc.save(`data_santri_kharisma_${new Date().toISOString().slice(0,10)}.pdf`);
});

// ===============================
// PDF FINAL FIX + SPINNER SUPPORT
// ===============================
window.downloadSantriPDF = async function(id, btn) {
  btn.classList.add("loading");

const input = prompt("Masukkan sandi:");
if (input === null) {
  btn.classList.remove("loading");
  return;
}

if (input !== PDF_PASSWORD) {
  alert("Sandi salah!");
  btn.classList.remove("loading");
  return;
}

  
  // Mulai spinner
  if (btn) spinPDF(btn);

  const { jsPDF } = window.jspdf;

  try {
    // ======================
    // 1. Ambil data santri
    // ======================
    const { data: s, error } = await supabase
      .from("santri_kharisma")
      .select("*")
      .eq("id", id)
      .single();

    if (error || !s) {
      alert("Gagal mengambil data santri");
      return;
    }
	
	// Mustahiq
	const { data: guru } = await supabase
	  .from("data_guru")
	  .select("Nama, Hp")
	  .eq("Bagian", s.Bagian)
	  .eq("Kelas", s.Kelas)
	  .single();

	// Himpunan
	const { data: hp } = await supabase
	  .from("himpunan")
	  .select("nama, wa")
	  .eq("himpunan", s.Himpunan)
	  .single();


    // Ambil Sekretaris
    const sekretaris = await getKetuaTiga();

    // Dokumen
    const doc = new jsPDF("portrait", "pt", "a4");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    const isKeluar = s.Status && s.Status.toLowerCase() !== "aktif";
    const title = isKeluar
      ? "DATA KETERANGAN NDALEM KELUAR"
      : "DATA PENDAFTARAN NDALEM BARU";


    // ======================
    // 2. Watermark
    // ======================
    try {
      const wmUrl = "https://oflkibeaesvwzdzyvdfy.supabase.co/storage/v1/object/public/foto/watermark_logo.png";
      const wmBase64 = await loadImageBase64(wmUrl);

      if (wmBase64) {
        doc.setGState(new doc.GState({ opacity: 0.25 }));

        const wmSize = 250;
        const wmX = (pageWidth - wmSize) / 2;
        const wmY = (pageHeight - wmSize) / 2;

        doc.addImage(wmBase64, "PNG", wmX, wmY, wmSize, wmSize);

        doc.setGState(new doc.GState({ opacity: 1 }));
      }
    } catch (e) {
      console.warn("Watermark gagal dimuat:", e);
    }


    // ======================
    // 3. Header + Logo
    // ======================
    try {
      const logoUrl = "https://i.imgur.com/Irgu32G.png";
      const logoData = await loadImageToBase64(logoUrl);
      if (logoData) doc.addImage(logoData.base64, "PNG", 40, 40, 60, 60);
    } catch (e) {
      console.warn("Logo gagal dimuat:", e);
    }

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("KHUDAMA' KHARISMA", pageWidth / 2, 55, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text("Pondok Pesantren Lirboyo – Kota Kediri, Jawa Timur", pageWidth / 2, 75, { align: "center" });

    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.text("Sekretariat: Kantor KHARISMA, Gedung Nafis Lt. 2", pageWidth / 2, 95, { align: "center" });

    doc.setLineWidth(2);
    doc.line(40, 120, pageWidth - 40, 120);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text(title, pageWidth / 2, 150, { align: "center" });


    // ======================
    // 4. Foto Santri
    // ======================
    let y = 185;

    if (s.Foto) {
      try {
        const foto = await loadImageBase64(s.Foto);
        if (foto) {
          doc.addImage(foto, "PNG", pageWidth - 195, 180, 120, 150);
        }
      } catch {}
    }


    // ======================
    // 5. Data Santri
    // ======================
    const masaKhidmahPDF = calculateMasaKhidmah(s.Mulai_Ngabdi);
    const usiaPDF = calculateUsia(s.Tgl_Lahir);

	const dataList = [
	  ["Nama Lengkap", s.Nama_Lengkap || "-"],
	  ["Kelas", s.Kelas || "-"],
	  ["Bagian", s.Bagian || "-"],
	  ["Stambuk", s.Stambuk || "-"],
	  ["Tanggal Lahir", s.Tgl_Lahir ? `${new Date(s.Tgl_Lahir).toLocaleDateString('id-ID')} (${usiaPDF})` : "-"],	       
	  ["Asal Daerah", s.Asal_Daerah || "-"],
	  ["Kamar", s.Kamar || "-"],
	  ["Himpunan", s.Himpunan || "-"],
	  
	  ["__SEPARATOR__", ""],
	  
	  ["Unit Ndalem", s.Unit_Ndalem || "-"],
	  ["Posisi Tugas", s.Posisi_Tugas || "-"],
	  ["Shift", s.Shift || "-"],
	  ["Jam Tugas", s.Jam_Tugas || "-"],	  
	  ["Masa Khidmah", s.Mulai_Ngabdi ? `${new Date(s.Mulai_Ngabdi).toLocaleDateString('id-ID')} (${masaKhidmahPDF})` : "-"],	  
	  ["Status", s.Status || "-"],  
	  
	  ["__SEPARATOR__", ""],

	  ["Mustahiq", guru?.Nama || "-"],
	  ["No. Kontak", guru?.Hp || "-"], 
	  ["Dewan Himpunan", hp?.nama || "-"],
	  ["No. Kontak", hp?.wa || "-"], 
	  ["Nama Wali", s.Nama_Wali || "-"],
	  ["No. Kontak", s.No_Wali || "-"]	  
	];



    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);

    dataList.forEach(([label, value]) => {

	  if (label === "__SEPARATOR__") {

		const lineStart = 40;         // kiri (label)
		const lineEnd   = 180 + 195;  // sebelah kanan value
		
		doc.setLineWidth(1);
		doc.line(lineStart, y - 10, lineEnd, y - 10);
		
		y += 10; 
		return;
	  }

	  doc.setFont("helvetica", "bold");
	  doc.text(label, 40, y);

	  doc.setFont("helvetica", "normal");
	  doc.text(": " + value, 180, y);

	  y += 22;
	});




    // ======================
    // 6. Tanda Tangan Sekretaris
    // ======================
    if (sekretaris) {
      const ttY = 620;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);

      const tgl = new Date().toLocaleDateString("id-ID", {
        day: "numeric",
        month: "long",
        year: "numeric"
      });

      doc.text("Kediri, " + tgl, pageWidth - 200, ttY);
      doc.text("Mengetahui,", pageWidth - 200, ttY + 20);
      doc.text(sekretaris.Status_Penasehat, pageWidth - 200, ttY + 40);

      // tanda tangan digital
      if (sekretaris.Ttd_Url) {
        try {
          const ttd = await loadImageBase64(sekretaris.Ttd_Url);
          if (ttd) {
            doc.addImage(ttd, "PNG", pageWidth - 200, ttY + 50, 140, 70);
          }
        } catch (e) {
          console.warn("Tanda tangan gagal dimuat:", e);
        }
      }

      doc.setFont("helvetica", "bold");
      doc.text(bersihkanNama(sekretaris.Nama), pageWidth - 200, ttY + 150);
    }


    // ======================
    // 7. Footer
    // ======================
    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text(
      "Dicetak dari SIMPONI KHARISMA – " + new Date().toLocaleString("id-ID"),
      pageWidth - 40,
      820,
      { align: "right" }
    );


    // ======================
    // 8. Simpan File
    // ======================
    const filename = isKeluar
      ? `Data_Keluar_${s.Nama_Lengkap.replace(/\s+/g, "_")}.pdf`
      : `Daftar_Baru_${s.Nama_Lengkap.replace(/\s+/g, "_")}.pdf`;

    doc.save(filename);

  } catch (e) {
    console.error("PDF error:", e);
    alert("Gagal membuat PDF!");
  }

  // Matikan spinner apapun hasilnya
  if (btn) stopSpinPDF(btn);
  btn.classList.remove("loading");
};


async function loadImageBase64(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = function () {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/png"));
    };
    img.onerror = () => resolve(null);
    img.src = url;
  });
}

async function loadImageToBase64(url, maxSize = 150) {
  try {
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.crossOrigin = "Anonymous";
      i.onload = () => resolve(i);
      i.onerror = () => reject(new Error("Image load error"));
      i.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Date.now();
    });

    let w = img.naturalWidth || img.width;
    let h = img.naturalHeight || img.height;
    if (w > maxSize) {
      h = Math.round((maxSize / w) * h);
      w = maxSize;
    }

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    return { base64: canvas.toDataURL("image/png"), w, h };
  } catch (err) {
    console.warn("loadImageToBase64 failed:", err?.message || err);
    return null;
  }
}

async function urlToBase64(url) {
  const res = await fetch(url);
  const blob = await res.blob();
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

function bersihkanNama(nama) {
  if (!nama) return "-";

  // hapus awalan umum: Bpk, Bp, Bapak, Ust, Ustadz, Ustdz, Ust.
  return nama.replace(/^(Bpk\.?|Bp\.?|Bapak|Ust\.?|Ustadz|Ustdz|Ustad)\s+/i, "").trim();
}

// Spinner helpers untuk tombol PDF
function spinPDF(btn) {
  if (!btn) return;
  btn.classList.add('pdf-spinning');
  // optional: disable sementara supaya user tidak klik berkali-kali
  btn.disabled = true;
}

function stopSpinPDF(btn) {
  if (!btn) return;
  btn.classList.remove('pdf-spinning');
  btn.disabled = false;
}


async function getKetuaTiga() {
  const { data, error } = await supabase
    .from("penasehat")
    .select("Nama, Status_Penasehat")
    .eq("Status_Penasehat", "Ketua Tiga KHARISMA")
    .eq("Status", "aktif")
    .single();

  if (error || !data) return null;

  // Tambahkan URL TTD manual di sini
  data.Ttd_Url = "https://oflkibeaesvwzdzyvdfy.supabase.co/storage/v1/object/public/foto/ttd-david.png";

  return data;
}

// ===== Helper: Hitung selisih bulan dari tanggal hingga sekarang =====
function monthsSince(date) {
  if (!date || isNaN(date)) return null;
  
  const now = new Date();
  const startDate = new Date(date);
  
  let months = (now.getFullYear() - startDate.getFullYear()) * 12;
  months -= startDate.getMonth();
  months += now.getMonth();
  
  // Adjust for days in month
  if (now.getDate() < startDate.getDate()) {
    months--;
  }
  
  return months >= 0 ? months : 0;
}

// ===== Hitung Masa Khidmah (tampil) =====
function calculateMasaKhidmah(mulaiValue) {
  if (!mulaiValue) return 'Belum terdata';

  const start = (mulaiValue instanceof Date) ? mulaiValue : new Date(mulaiValue);
  if (isNaN(start)) return 'Belum terdata';

  const totalMonths = monthsSince(start);
  if (totalMonths === null) return 'Belum terdata';
  if (totalMonths <= 0) return '< 1 bln';

  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;

  if (years > 0 && months > 0) return `${years} th, ${months} bln`;
  if (years > 0) return `${years} th`;
  return `${months} bln`;
}

// ===== Hitung Usia (tampil, mirip Masa Khidmah) =====
function calculateUsia(tglLahirValue) {
  if (!tglLahirValue) return 'Belum terdata';

  const born = (tglLahirValue instanceof Date) ? tglLahirValue : new Date(tglLahirValue);
  if (isNaN(born)) return 'Belum terdata';

  const totalMonths = monthsSince(born);
  if (totalMonths === null) return 'Belum terdata';
  if (totalMonths <= 0) return '< 1 bln';

  const years = Math.floor(totalMonths / 12);
  const months = totalMonths % 12;

  if (years > 0 && months > 0) return `${years} th, ${months} bln`;
  if (years > 0) return `${years} th`;
  return `${months} bln`;
}

ngajiData.forEach(n => {
  const opt = document.createElement("option");
  opt.value = n.id;       // ← INI YANG MASUK DB
  opt.textContent = n.label;
  Ngaji.appendChild(opt);
});

// WhatsApp functions
window.onWA = async function(id) {
  const { data, error } = await supabase
    .from("santri_kharisma")
    .select("Nama_Lengkap, Kelas, No_Wali")
    .eq("id", id)
    .single();

  if (error || !data) {
    alert("Nomor wali tidak ditemukan!");
    return;
  }

  let nomor = (data.No_Wali || "").toString().trim();

  if (!nomor.startsWith("62")) {
    alert("Format nomor wali harus 62xxxxxxxx");
    return;
  }

  const pesan = `Assalamualaikum, kami pengurus khudama' kharisma ingin menginformasikan mengenai santri *${data.Nama_Lengkap}*, kelas *${data.Kelas}*.`;
  const url = `https://wa.me/${nomor}?text=${encodeURIComponent(pesan)}`;

  window.open(url, "_blank");
};


window.onHP = async function(id) {
  const { data: santri, error: err1 } = await supabase
    .from("santri_kharisma")
    .select("Nama_Lengkap, Kelas, Bagian, Himpunan")
    .eq("id", id)
    .single();

  if (err1 || !santri) {
    return alert("Data santri tidak ditemukan!");
  }

  if (!santri.Himpunan) {
    return alert("Santri ini tidak memiliki Himpunan.");
  }

  const { data: hp, error: err2 } = await supabase
    .from("himpunan")
    .select("wa")
    .eq("himpunan", santri.Himpunan)
    .single();

  if (err2 || !hp) {
    return alert("Data WA himpunan tidak ditemukan!");
  }

  let nomor = (hp.wa || "").toString().trim();

  if (!nomor.startsWith("62")) {
    return alert("Nomor WA himpunan harus dimulai 62xxxx");
  }

  const pesan =
    `Assalamualaikum, kami pengurus khudama' kharisma ingin menghubungi Himpunan *${santri.Himpunan}* ` +
    `terkait siswa *${santri.Nama_Lengkap}*, ` +
    `kelas *${santri.Kelas}*, bagian *${santri.Bagian}*.`;

  const url = `https://wa.me/${nomor}?text=${encodeURIComponent(pesan)}`;
  window.open(url, "_blank");
};

window.onGuru = async function(id) {
  const { data: santri, error: err1 } = await supabase
    .from("santri_kharisma")
    .select("Nama_Lengkap, Kelas, Bagian")
    .eq("id", id)
    .single();

  if (err1 || !santri) {
    return alert("Data santri tidak ditemukan!");
  }

  if (!santri.Kelas || !santri.Bagian) {
    return alert("Santri belum memiliki Kelas atau Bagian yang lengkap.");
  }

  const { data: guru, error: err2 } = await supabase
    .from("data_guru")
    .select("Nama, Hp")
    .eq("Kelas", santri.Kelas)
    .eq("Bagian", santri.Bagian)
    .single();

  if (err2 || !guru) {
    return alert(`Guru untuk Kelas: ${santri.Kelas} & Bagian: ${santri.Bagian} tidak ditemukan!`);
  }

  let nomor = (guru.Hp || "").toString().trim();

  if (!nomor.startsWith("62")) {
    return alert("Nomor HP guru harus mulai dengan 62xxxx");
  }

  const pesan =
    `Assalamualaikum *${guru.Nama}*. ` +
    `Kami pengurus khudama' kharisma ingin menginformasikan terkait siswa *${santri.Nama_Lengkap}*, ` +
    `kelas *${santri.Kelas}*, bagian *${santri.Bagian}*.`;

  const url = `https://wa.me/${nomor}?text=${encodeURIComponent(pesan)}`;
  window.open(url, "_blank");
};

// initial load
loadData();

let lastTapBtn = null;
let lastTapTime = 0;
const DOUBLE_TAP_DELAY = 400; // ms (ideal HP)

document.addEventListener("click", function (e) {
  const btn = e.target.closest(".tooltip-btn");
  if (!btn) return;

  const now = Date.now();

  // ===== TAP PERTAMA =====
  if (
    lastTapBtn !== btn ||
    now - lastTapTime > DOUBLE_TAP_DELAY
  ) {
    e.preventDefault();

    // tutup tooltip lain
    document
      .querySelectorAll(".tooltip-btn.show-tooltip")
      .forEach(b => b.classList.remove("show-tooltip"));

    btn.classList.add("show-tooltip");

    lastTapBtn = btn;
    lastTapTime = now;

    // auto hide tooltip (biar rapi)
    setTimeout(() => {
      btn.classList.remove("show-tooltip");
    }, 1500);

    return;
  }

  // ===== TAP KEDUA =====
  btn.classList.remove("show-tooltip");
  lastTapBtn = null;
  lastTapTime = 0;

  const id = btn.dataset.id;
  const action = btn.dataset.action;

  switch (action) {
    case "edit":
      onEdit(id);
      break;
    case "guru":
      onGuru(id);
      break;
    case "wa":
      onWA(id);
      break;
    case "hp":
      onHP(id);
      break;
    case "pdf":
      downloadSantriPDF(id, btn);
      break;
  }
});


</script>
<div class="app-footer">
  <img src="https://img.shields.io/badge/version-v2.1.5-orange" alt="Version">
  <img src="https://img.shields.io/badge/license-Proprietary-red" alt="License">
  <img src="https://img.shields.io/badge/status-Internal%20Use-blue" alt="Status">
  <img src="https://img.shields.io/badge/%C2%A9%202025%20Ndalem%20Kharisma-Semua%20hak%20dilindungi%20undang%E2%80%90undang-red" 
       alt="Copyright">
</div>
</body>
</html>